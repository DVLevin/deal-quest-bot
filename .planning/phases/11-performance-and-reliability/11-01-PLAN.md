---
phase: 11-performance-and-reliability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/webapp/src/main.tsx
  - packages/webapp/package.json
  - packages/webapp/src/features/leads/hooks/useLead.ts
  - packages/webapp/src/features/leads/hooks/useLeadActivities.ts
autonomous: true

must_haves:
  truths:
    - "Eruda debug console does NOT load in production builds"
    - "Eruda debug console DOES load in development mode"
    - "Lead detail query fetches only the columns used by LeadDetail component"
    - "Lead activity query fetches only the columns used by ActivityTimeline component"
  artifacts:
    - path: "packages/webapp/src/main.tsx"
      provides: "DEV-gated eruda import"
      contains: "import.meta.env.DEV"
    - path: "packages/webapp/package.json"
      provides: "eruda in devDependencies"
    - path: "packages/webapp/src/features/leads/hooks/useLead.ts"
      provides: "Explicit column selection for lead detail"
    - path: "packages/webapp/src/features/leads/hooks/useLeadActivities.ts"
      provides: "Explicit column selection for lead activities"
  key_links:
    - from: "packages/webapp/src/main.tsx"
      to: "eruda"
      via: "conditional dynamic import"
      pattern: "import\\.meta\\.env\\.DEV.*import\\('eruda'\\)"
    - from: "packages/webapp/src/features/leads/hooks/useLead.ts"
      to: "lead_registry"
      via: "explicit column list"
      pattern: "\\.select\\('[^*]"
---

<objective>
TMA production hardening: gate eruda debug console behind DEV check and optimize lead queries with explicit column selection.

Purpose: Remove debug tooling from production bundle (eruda adds ~300KB) and reduce query payload size by selecting only needed columns.
Output: Cleaner production builds and more efficient PostgREST queries.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-performance-and-reliability/11-RESEARCH.md

@packages/webapp/src/main.tsx
@packages/webapp/package.json
@packages/webapp/src/features/leads/hooks/useLead.ts
@packages/webapp/src/features/leads/hooks/useLeadActivities.ts
@packages/webapp/src/types/tables.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Gate eruda behind import.meta.env.DEV and move to devDependencies</name>
  <files>packages/webapp/src/main.tsx, packages/webapp/package.json</files>
  <action>
In `packages/webapp/src/main.tsx`:
- Replace the bare `import('eruda').then((m) => m.default.init());` on line 7 with a DEV-gated version:
  ```typescript
  if (import.meta.env.DEV) {
    import('eruda').then((m) => m.default.init());
  }
  ```
- Update the comment on line 6 from "temporarily for production debugging" to "Development-only debug console" since this is now properly gated.

In `packages/webapp/package.json`:
- Move `"eruda": "^3.4.3"` from `dependencies` to `devDependencies`.
- This is cosmetic (Vite bundles based on imports, not dependency type) but signals intent correctly.

Why this works: Vite statically replaces `import.meta.env.DEV` with `false` in production builds, so the entire `if` block including the dynamic `import('eruda')` is dead-code eliminated during tree-shaking.
  </action>
  <verify>
1. Run `cd packages/webapp && npx vite build 2>&1 | tail -5` -- build should succeed.
2. Run `ls -la packages/webapp/dist/assets/ | grep -i eruda` -- should return NO matches (eruda not in production bundle).
3. Grep the source: `grep 'import.meta.env.DEV' packages/webapp/src/main.tsx` -- should show the guard.
  </verify>
  <done>
- `import.meta.env.DEV` guard wraps the eruda import in main.tsx
- eruda is listed under devDependencies in package.json
- Production build does NOT contain eruda chunks in dist/assets/
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace select('*') with explicit columns in lead hooks</name>
  <files>packages/webapp/src/features/leads/hooks/useLead.ts, packages/webapp/src/features/leads/hooks/useLeadActivities.ts</files>
  <action>
In `packages/webapp/src/features/leads/hooks/useLead.ts` (line 22):
- Replace `.select('*')` with an explicit column list. The LeadDetail component uses these fields:
  `id, user_id, telegram_id, prospect_name, prospect_first_name, prospect_last_name, prospect_title, prospect_company, prospect_geography, photo_url, photo_key, prospect_analysis, closing_strategy, engagement_tactics, draft_response, status, notes, input_type, web_research, engagement_plan, lead_source, created_at, updated_at`
- Exclude `original_context` (large text blob not displayed in LeadDetail), `last_contacted`, `next_followup`, `followup_count` (not used in the current detail view).
- Format as a single string: `.select('id, user_id, telegram_id, prospect_name, prospect_first_name, prospect_last_name, prospect_title, prospect_company, prospect_geography, photo_url, photo_key, prospect_analysis, closing_strategy, engagement_tactics, draft_response, status, notes, input_type, web_research, engagement_plan, lead_source, created_at, updated_at')`

In `packages/webapp/src/features/leads/hooks/useLeadActivities.ts` (line 19):
- Replace `.select('*')` with explicit columns: `.select('id, lead_id, telegram_id, activity_type, content, ai_response, created_at')`
- All 7 columns of LeadActivityRow are used by ActivityTimeline, so list them all explicitly. This protects against future column additions silently bloating payloads.
  </action>
  <verify>
1. Run `cd packages/webapp && npx tsc --noEmit` -- TypeScript should compile without errors (column selection doesn't affect TS types since we cast the result).
2. Grep: `grep "select('\*')" packages/webapp/src/features/leads/hooks/useLead.ts packages/webapp/src/features/leads/hooks/useLeadActivities.ts` -- should return NO matches.
  </verify>
  <done>
- useLead.ts uses explicit column list (23 columns, excludes original_context and follow-up fields)
- useLeadActivities.ts uses explicit column list (all 7 columns)
- No select('*') remains in either lead hook file
- TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. Production build succeeds: `cd packages/webapp && npx vite build`
2. No eruda in production bundle: `ls packages/webapp/dist/assets/ | grep -i eruda` returns nothing
3. TypeScript passes: `cd packages/webapp && npx tsc --noEmit`
4. No select('*') in lead hooks: `grep "select('\*')" packages/webapp/src/features/leads/hooks/useLead.ts packages/webapp/src/features/leads/hooks/useLeadActivities.ts` returns nothing
</verification>

<success_criteria>
- PERF-V11-01: Eruda loads only in DEV mode, absent from production builds
- PERF-V11-05: Lead detail and activity queries use explicit column selection
- All TypeScript compiles cleanly
- Production build succeeds without eruda artifacts
</success_criteria>

<output>
After completion, create `.planning/phases/11-performance-and-reliability/11-01-SUMMARY.md`
</output>
