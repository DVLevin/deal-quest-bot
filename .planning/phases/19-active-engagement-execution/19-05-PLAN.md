---
phase: 19-active-engagement-execution
plan: 05
type: execute
wave: 2
depends_on: ["19-03", "19-04"]
files_modified:
  - packages/webapp/src/features/leads/hooks/useGenerateDraft.ts
  - packages/webapp/src/features/leads/components/DraftCopyCard.tsx
  - packages/webapp/src/features/leads/components/StepActionScreen.tsx
  - packages/webapp/src/features/leads/components/LeadDetail.tsx
  - packages/webapp/src/shared/stores/toastStore.ts
  - functions/generate-draft/deploy.js
autonomous: false

must_haves:
  truths:
    - "TMA generates drafts via DB message bus (insert row -> poll for result) instead of edge function"
    - "Draft options appear as a tabbed/segmented control (Short, Medium, Detailed) — one visible at a time"
    - "Regeneration replaces current draft with Undo toast to restore previous"
    - "Copying a draft shows a Done nudge toast with action button to complete the step"
    - "Edge function generate-draft is removed (bot agent is the single source of truth)"
  artifacts:
    - path: "packages/webapp/src/features/leads/hooks/useGenerateDraft.ts"
      provides: "DB message bus mutation with polling for completion"
      contains: "draft_requests"
    - path: "packages/webapp/src/features/leads/components/DraftCopyCard.tsx"
      provides: "Tabbed draft display with segmented control"
      contains: "activeTab"
    - path: "packages/webapp/src/features/leads/components/StepActionScreen.tsx"
      provides: "Post-copy Done nudge integration"
      contains: "Done"
  key_links:
    - from: "packages/webapp/src/features/leads/hooks/useGenerateDraft.ts"
      to: "draft_requests table"
      via: "insforge.database.from('draft_requests').insert()"
      pattern: "draft_requests"
    - from: "packages/webapp/src/features/leads/components/DraftCopyCard.tsx"
      to: "toastStore"
      via: "useToast for Done nudge after copy"
      pattern: "useToast"
    - from: "packages/webapp/src/features/leads/components/StepActionScreen.tsx"
      to: "DraftCopyCard"
      via: "passes structured options and onMarkDone callback"
      pattern: "onMarkDone"
---

<objective>
Migrate the TMA from edge function to DB message bus for draft generation, redesign DraftCopyCard with tabbed view for multiple options, add undo toast for regeneration, and post-copy "Done — I posted it" nudge. Remove the obsolete edge function.

Purpose: This completes the migration from a hardcoded edge function to the bot's agent pipeline. Users now see structured draft options in a segmented control, can regenerate with undo capability, and get nudged to complete the step after copying. The edge function is removed to eliminate the maintenance burden of dual implementations.

Output: Working end-to-end flow: TMA uploads screenshot -> inserts DB request -> bot processes -> TMA polls for result -> displays tabbed options -> user copies -> "Done" nudge appears.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-active-engagement-execution/19-RESEARCH.md
@.planning/phases/19-active-engagement-execution/19-01-SUMMARY.md
@.planning/phases/19-active-engagement-execution/19-02-SUMMARY.md

@packages/webapp/src/features/leads/hooks/useGenerateDraft.ts
@packages/webapp/src/features/leads/components/DraftCopyCard.tsx
@packages/webapp/src/features/leads/components/StepActionScreen.tsx
@packages/webapp/src/features/leads/components/LeadDetail.tsx
@packages/webapp/src/shared/stores/toastStore.ts
@packages/webapp/src/lib/insforge.ts
@packages/webapp/src/lib/queries.ts
@functions/generate-draft/deploy.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite useGenerateDraft for DB message bus and upgrade DraftCopyCard with tabbed view</name>
  <files>
    packages/webapp/src/features/leads/hooks/useGenerateDraft.ts
    packages/webapp/src/features/leads/components/DraftCopyCard.tsx
    packages/webapp/src/shared/stores/toastStore.ts
  </files>
  <action>
**1. Rewrite `useGenerateDraft.ts`** to use the DB message bus pattern:

Replace the entire file content. The hook now:
1. Inserts a row into `draft_requests` table via InsForge
2. Polls every 3 seconds until status is 'completed' or 'failed'
3. Returns structured draft options (not a single string)

```typescript
/**
 * Mutation hook for AI-powered draft generation from screenshots.
 *
 * Uses the DB message bus pattern:
 * 1. TMA inserts a row into draft_requests table
 * 2. Bot poller picks it up, processes via CommentGeneratorAgent
 * 3. TMA polls until status is 'completed' or 'failed'
 * 4. Returns structured options (short/medium/detailed)
 */

import { useMutation, useQueryClient } from '@tanstack/react-query';
import { getInsforge } from '@/lib/insforge';
import { queryKeys } from '@/lib/queries';

export interface DraftOption {
  label: string;
  length: string;
  text: string;
}

export interface DraftResult {
  platform: string;
  content_type: string;
  options: DraftOption[];
}

interface GenerateDraftVars {
  proofUrl: string;
  leadId: number;
  stepId: number;
  telegramId: number;
  leadName?: string;
  leadTitle?: string;
  leadCompany?: string;
  leadStatus?: string;
  webResearch?: string | null;
}

const POLL_INTERVAL = 3000; // 3 seconds
const POLL_TIMEOUT = 90_000; // 90 seconds (vision models can be slow)

async function pollForCompletion(requestId: number): Promise<DraftResult> {
  const start = Date.now();

  while (Date.now() - start < POLL_TIMEOUT) {
    const { data, error } = await getInsforge()
      .database.from('draft_requests')
      .select('status, result')
      .eq('id', requestId)
      .single();

    if (error) throw new Error(`Poll error: ${error.message}`);

    if (data?.status === 'completed' && data.result) {
      return data.result as DraftResult;
    }

    if (data?.status === 'failed') {
      const errorMsg = (data.result as { error?: string })?.error || 'Draft generation failed';
      throw new Error(errorMsg);
    }

    // Wait before next poll
    await new Promise((r) => setTimeout(r, POLL_INTERVAL));
  }

  throw new Error('Draft generation timed out. Please try again.');
}

export function useGenerateDraft() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async ({
      proofUrl,
      leadId,
      stepId,
      telegramId,
      leadName,
      leadTitle,
      leadCompany,
      leadStatus,
      webResearch,
    }: GenerateDraftVars): Promise<DraftResult> => {
      // 1. Insert request row into draft_requests
      const { data, error } = await getInsforge()
        .database.from('draft_requests')
        .insert({
          lead_id: leadId,
          step_id: stepId,
          telegram_id: telegramId,
          proof_url: proofUrl,
          lead_context: {
            name: leadName || null,
            title: leadTitle || null,
            company: leadCompany || null,
            status: leadStatus || null,
            web_research: webResearch || null,
          },
          status: 'pending',
        })
        .select()
        .single();

      if (error) throw new Error(`Failed to create draft request: ${error.message}`);
      if (!data?.id) throw new Error('No request ID returned');

      // 2. Poll for completion
      return pollForCompletion(data.id);
    },
    onSettled: (_data, _err, vars) => {
      queryClient.invalidateQueries({
        queryKey: queryKeys.leads.detail(vars.leadId),
      });
    },
  });
}
```

**2. Upgrade `DraftCopyCard.tsx`** with tabbed/segmented control view:

Replace the entire file. The new DraftCopyCard:
- Accepts structured `DraftOption[]` for tabbed display
- Falls back to single-text display for legacy `draftText` prop (backward compat)
- Has segmented control to switch between Short/Medium/Detailed
- Shows only the active tab's text
- Fires `onCopy` callback after successful copy (for parent to show nudge)
- Fires `onRegenerate` callback with undo capability

```typescript
/**
 * DraftCopyCard — displays AI-generated draft options in a tabbed view.
 *
 * Supports two modes:
 * 1. Structured options (DraftOption[]) — tabbed segmented control
 * 2. Legacy single text (string) — simple text display (backward compat)
 *
 * After copy, fires onCopy callback so parent can show "Done" nudge.
 */

import { useState, useCallback } from 'react';
import { Copy, Check, RefreshCw, Loader2 } from 'lucide-react';
import type { DraftOption } from '../hooks/useGenerateDraft';

// ---------------------------------------------------------------------------
// Clipboard helper (Telegram WebView fallback)
// ---------------------------------------------------------------------------

async function copyToClipboard(text: string): Promise<boolean> {
  try {
    await navigator.clipboard.writeText(text);
    return true;
  } catch {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    textarea.style.left = '-9999px';
    document.body.appendChild(textarea);
    textarea.select();
    try {
      document.execCommand('copy');
      return true;
    } catch {
      return false;
    } finally {
      document.body.removeChild(textarea);
    }
  }
}

// ---------------------------------------------------------------------------
// Props
// ---------------------------------------------------------------------------

interface DraftCopyCardProps {
  /** Structured draft options from CommentGeneratorAgent */
  options?: DraftOption[];
  /** Legacy: single draft text (backward compat) */
  draftText?: string;
  /** Detected platform (shown as badge) */
  platform?: string;
  /** Called after successful copy with the copied text */
  onCopy?: (text: string) => void;
  /** Called when user wants to regenerate */
  onRegenerate?: () => void;
  /** Whether regeneration is in progress */
  isRegenerating?: boolean;
}

// ---------------------------------------------------------------------------
// Platform display name
// ---------------------------------------------------------------------------

const PLATFORM_LABELS: Record<string, string> = {
  linkedin: 'LinkedIn',
  email: 'Email',
  twitter: 'Twitter/X',
  slack: 'Slack',
  facebook: 'Facebook',
  whatsapp: 'WhatsApp',
  telegram: 'Telegram',
  other: 'General',
};

// ---------------------------------------------------------------------------
// DraftCopyCard
// ---------------------------------------------------------------------------

export function DraftCopyCard({
  options,
  draftText,
  platform,
  onCopy,
  onRegenerate,
  isRegenerating,
}: DraftCopyCardProps) {
  const [activeTab, setActiveTab] = useState(0);
  const [copied, setCopied] = useState(false);

  // Determine display mode
  const hasOptions = options && options.length > 0;
  const displayText = hasOptions ? options[activeTab]?.text : draftText;

  const handleCopy = useCallback(async () => {
    if (!displayText) return;
    const success = await copyToClipboard(displayText);
    if (success) {
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
      onCopy?.(displayText);
    }
  }, [displayText, onCopy]);

  if (!displayText) return null;

  return (
    <div className="rounded-xl border border-surface-secondary bg-surface-secondary/30 p-3">
      {/* Header row */}
      <div className="mb-2 flex items-center justify-between">
        <div className="flex items-center gap-2">
          <span className="text-xs font-semibold text-text-secondary">
            Draft Message
          </span>
          {platform && PLATFORM_LABELS[platform] && (
            <span className="rounded-full bg-accent/10 px-2 py-0.5 text-[10px] font-medium text-accent">
              {PLATFORM_LABELS[platform]}
            </span>
          )}
        </div>
        <div className="flex items-center gap-1">
          {onRegenerate && (
            <button
              type="button"
              onClick={onRegenerate}
              disabled={isRegenerating}
              className="flex items-center justify-center rounded-md p-1 text-text-hint transition-colors active:scale-95 active:bg-surface-secondary disabled:opacity-50"
              aria-label="Regenerate draft"
            >
              {isRegenerating ? (
                <Loader2 className="h-3.5 w-3.5 animate-spin" />
              ) : (
                <RefreshCw className="h-3.5 w-3.5" />
              )}
            </button>
          )}
          <button
            type="button"
            onClick={handleCopy}
            className="flex items-center justify-center rounded-md p-1 text-text-hint transition-colors active:scale-95 active:bg-surface-secondary"
            aria-label="Copy draft"
          >
            {copied ? (
              <Check className="h-3.5 w-3.5 text-success" />
            ) : (
              <Copy className="h-3.5 w-3.5" />
            )}
          </button>
        </div>
      </div>

      {/* Segmented control tabs (only for structured options) */}
      {hasOptions && options.length > 1 && (
        <div className="mb-3 flex rounded-lg bg-surface-secondary/50 p-0.5">
          {options.map((opt, i) => (
            <button
              key={opt.label}
              type="button"
              onClick={() => setActiveTab(i)}
              className={`flex-1 rounded-md px-3 py-1.5 text-xs font-medium transition-all ${
                activeTab === i
                  ? 'bg-surface text-text shadow-sm'
                  : 'text-text-hint'
              }`}
            >
              {opt.label}
            </button>
          ))}
        </div>
      )}

      {/* Draft text */}
      <pre className="whitespace-pre-wrap font-sans text-sm leading-relaxed text-text">
        {displayText}
      </pre>

      {/* Full-width copy button */}
      <button
        type="button"
        onClick={handleCopy}
        className="mt-3 flex w-full items-center justify-center gap-1.5 rounded-lg bg-accent/15 px-3 py-2 text-sm font-medium text-accent transition-colors active:scale-95 active:bg-accent/25"
      >
        {copied ? (
          <>
            <Check className="h-4 w-4" />
            Copied!
          </>
        ) : (
          <>
            <Copy className="h-4 w-4" />
            Copy Draft
          </>
        )}
      </button>
    </div>
  );
}
```

**3. Extend the toast store** (`packages/webapp/src/shared/stores/toastStore.ts`):

Add an optional `duration` field to the `Toast` interface and the `addToast` Omit type. This allows specific toasts to override the default 4-second auto-dismiss (needed for the "Done" nudge which should stay longer — 8 seconds):

In the `Toast` interface, add after the `action` field:
```typescript
  /** Custom auto-dismiss duration in ms (default: 4000) */
  duration?: number;
```

In the `addToast` method, update the setTimeout to use the custom duration:
```typescript
    // Auto-dismiss (custom duration or default 4 seconds)
    setTimeout(() => {
      get().dismissToast(id);
    }, toast.duration ?? 4000);
```

This is a backward-compatible change — existing toasts without `duration` still dismiss after 4 seconds.
  </action>
  <verify>
Run `cd packages/webapp && npx tsc --noEmit` — zero errors.
Verify `useGenerateDraft.ts` imports `getInsforge` and uses `database.from('draft_requests')`.
Verify `DraftCopyCard.tsx` has `activeTab` state and segmented control rendering.
Verify `DraftCopyCard.tsx` accepts `options?: DraftOption[]` prop.
Verify `DraftCopyCard.tsx` has `onCopy` and `onRegenerate` callbacks.
Verify `toastStore.ts` has `duration` field in Toast interface.
  </verify>
  <done>
useGenerateDraft uses DB message bus (insert + poll) instead of edge function. DraftCopyCard supports tabbed view with segmented control for structured options, backward-compatible single-text mode, platform badge, copy callback, and regenerate button. Toast store supports custom duration for extended nudge toasts. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire StepActionScreen with tabbed drafts, undo toast, post-copy nudge, and remove edge function</name>
  <files>
    packages/webapp/src/features/leads/components/StepActionScreen.tsx
    packages/webapp/src/features/leads/components/LeadDetail.tsx
    functions/generate-draft/deploy.js
  </files>
  <action>
**1. Update `StepActionScreen.tsx`** to support the new draft format and add post-copy nudge:

The StepActionScreen needs these changes:

**a. Add imports:**
```typescript
import type { DraftOption, DraftResult } from '../hooks/useGenerateDraft';
```
Add `useToast` import:
```typescript
import { useToast } from '@/shared/stores/toastStore';
```

**b. Update the props interface** to accept structured draft data:

Replace the existing `StepActionScreenProps` with:
```typescript
interface StepActionScreenProps {
  step: EngagementPlanStep;
  leadName: string;
  leadCompany?: string;
  onComplete: () => void;
  onCantPerform: (reason: string) => void;
  onUploadProof: (file: File) => Promise<void>;
  onGenerateDraft: () => void;
  onClose: () => void;
  isUpdating: boolean;
  isUploading: boolean;
  isGeneratingDraft: boolean;
  /** Structured draft result from CommentGeneratorAgent */
  draftResult?: DraftResult | null;
  /** Previous draft result for undo (set before regeneration) */
  previousDraftResult?: DraftResult | null;
  /** Called to restore previous draft (undo) */
  onUndoRegenerate?: () => void;
}
```

**c. Inside the component function** (pending state section), add toast hook:
```typescript
const { toast } = useToast();
```

**d. Add state tracking for whether user copied** (used for "Done" nudge emphasis):
```typescript
const [hasCopied, setHasCopied] = useState(false);
```
Add `import { useState } from 'react';` at the top if not already imported.

**e. Add handleDraftCopy callback:**
```typescript
const handleDraftCopy = useCallback((text: string) => {
  setHasCopied(true);
  toast({
    type: 'success',
    message: 'Draft copied to clipboard!',
    action: {
      label: 'Done — I posted it',
      onClick: onComplete,
    },
    duration: 8000, // Extended duration for nudge
  });
}, [toast, onComplete]);
```
Add `import { useCallback } from 'react';` at the top if not already imported.

**f. Add handleRegenerate callback:**
```typescript
const handleRegenerate = useCallback(() => {
  onGenerateDraft();
}, [onGenerateDraft]);
```

**f2. Add useEffect to detect regeneration completion and show undo toast:**

When a regeneration completes (i.e., `draftResult` has changed and `previousDraftResult` is present), show an undo toast that lets the user restore the previous draft:

```typescript
// Track previous draftResult reference to detect changes
const prevDraftResultRef = useRef(draftResult);

useEffect(() => {
  // Detect regeneration completion: draftResult changed AND previousDraftResult exists
  if (
    draftResult &&
    previousDraftResult &&
    draftResult !== prevDraftResultRef.current
  ) {
    toast({
      type: 'info',
      message: 'Draft regenerated',
      action: {
        label: 'Undo',
        onClick: () => onUndoRegenerate?.(),
      },
      duration: 6000,
    });
  }
  prevDraftResultRef.current = draftResult;
}, [draftResult, previousDraftResult, toast, onUndoRegenerate]);
```

Add `import { useRef } from 'react';` at the top if not already imported.

**f3. Wire undo toast from parent (LeadDetail.tsx):**

The parent component (LeadDetail) is responsible for storing the previous draft before regeneration and implementing the undo callback. Update `LeadDetail.tsx`:

1. Add `previousDraftResult` state:
```typescript
const [previousDraftResult, setPreviousDraftResult] = useState<DraftResult | null>(null);
```

2. Import `DraftResult` type:
```typescript
import type { DraftResult } from '../hooks/useGenerateDraft';
```

3. Update `handleGenerateDraft` to store the current draft before regenerating:
```typescript
const handleGenerateDraft = useCallback(
  (stepId: number) => {
    if (!lead || !telegramId) return;
    const plan = parseEngagementPlan(lead.engagement_plan);
    const step = plan.find((s) => s.step_id === stepId);
    if (!step?.proof_url) return;

    // Store current draft result before regeneration (for undo)
    if (draftMutation.data) {
      setPreviousDraftResult(draftMutation.data);
    }

    draftMutation.mutate({ /* ... existing vars ... */ });
  },
  [lead, telegramId, draftMutation, stepMutation, toast],
);
```

4. Add `handleUndoRegenerate` callback:
```typescript
const handleUndoRegenerate = useCallback(() => {
  if (previousDraftResult) {
    // Reset mutation data to previousDraftResult by re-triggering with cached result
    // The simplest approach: store draftResult in local state instead of relying
    // solely on mutation.data, so undo can swap it back.
    draftMutation.reset();
    setPreviousDraftResult(null);
    toast({ type: 'success', message: 'Previous draft restored' });
  }
}, [previousDraftResult, draftMutation, toast]);
```

Note: The executor should evaluate whether `draftMutation.data` can be directly overridden or whether a local `draftResult` state wrapper is needed. The cleanest approach is to maintain a `const [activeDraftResult, setActiveDraftResult] = useState<DraftResult | null>(null)` that gets set in `onSuccess` of the mutation and can be swapped back by `handleUndoRegenerate`. Pass `activeDraftResult` (not `draftMutation.data`) to StepActionScreen.

5. Pass the new props to StepActionScreen:
```tsx
<StepActionScreen
  step={step}
  leadName={...}
  leadCompany={...}
  onComplete={() => handleStepComplete(step.step_id)}
  onCantPerform={(reason) => handleCantPerform(step.step_id, reason)}
  onUploadProof={(file) => handleUploadProof(step.step_id, file)}
  onGenerateDraft={() => handleGenerateDraft(step.step_id)}
  onClose={() => setActiveStepId(null)}
  isUpdating={stepMutation.isPending}
  isUploading={uploadMutation.isPending}
  isGeneratingDraft={draftMutation.isPending}
  draftResult={activeDraftResult}
  previousDraftResult={previousDraftResult}
  onUndoRegenerate={handleUndoRegenerate}
/>
```

**g. Replace the draft section** in the pending state JSX. Replace the existing `{/* Draft section */}` block (the isGeneratingDraft / step.suggested_text / "No draft" ternary) with:

```tsx
{/* Draft section */}
{isGeneratingDraft ? (
  <div className="space-y-2 rounded-xl border border-surface-secondary bg-surface-secondary/30 p-3">
    <div className="flex items-center gap-2">
      <Loader2 className="h-3.5 w-3.5 animate-spin text-accent" />
      <span className="text-xs font-semibold text-text-secondary">Generating draft...</span>
    </div>
    <div className="space-y-1.5">
      <div className="h-3 w-full animate-pulse rounded bg-surface-secondary" />
      <div className="h-3 w-4/5 animate-pulse rounded bg-surface-secondary" />
      <div className="h-3 w-3/5 animate-pulse rounded bg-surface-secondary" />
    </div>
  </div>
) : draftResult?.options ? (
  <DraftCopyCard
    options={draftResult.options}
    platform={draftResult.platform}
    onCopy={handleDraftCopy}
    onRegenerate={step.proof_url ? handleRegenerate : undefined}
    isRegenerating={isGeneratingDraft}
  />
) : step.suggested_text ? (
  <DraftCopyCard
    draftText={step.suggested_text}
    onCopy={handleDraftCopy}
  />
) : (
  <p className="text-center text-xs text-text-hint">
    No draft available for this step
  </p>
)}
```

**h. Update the "Mark Done" button** to pulse after copy:

In the action buttons section, update the Mark Done button's className to add a visual pulse when hasCopied is true:
```tsx
<button
  type="button"
  onClick={onComplete}
  disabled={isUpdating}
  className={`flex flex-1 items-center justify-center gap-1.5 rounded-lg bg-success px-3 py-2.5 text-sm font-semibold text-white transition-colors active:scale-95 disabled:opacity-50 ${
    hasCopied ? 'ring-2 ring-success/40 animate-pulse' : ''
  }`}
>
  <Check className="h-4 w-4" />
  {isUpdating ? 'Updating...' : hasCopied ? 'Done — I posted it' : 'Mark Done'}
</button>
```

This changes the button label from "Mark Done" to "Done — I posted it" after the user copies a draft, providing a persistent visual nudge alongside the toast.

**2. Delete the edge function** `functions/generate-draft/deploy.js`:

Delete the file entirely. The bot's CommentGeneratorAgent + draft poller now handle all draft generation. The edge function had a hardcoded model (`moonshotai/kimi-k2.5`), no Langfuse tracing, and a LinkedIn-only prompt. All of these limitations are resolved by the bot agent migration.

Note for the executor: Use `rm functions/generate-draft/deploy.js` via Bash, then also remove the `functions/generate-draft/` directory if it's now empty (`rmdir functions/generate-draft/` or `rm -rf functions/generate-draft/`).
  </action>
  <verify>
Run `cd packages/webapp && npx tsc --noEmit` — zero errors.
Run `cd packages/webapp && npx vite build` — build succeeds.
Verify StepActionScreen accepts `draftResult`, `previousDraftResult`, and `onUndoRegenerate` props.
Verify StepActionScreen has a useEffect that detects regeneration completion (draftResult changed + previousDraftResult present) and shows an undo toast.
Verify StepActionScreen has `handleDraftCopy` that shows toast with "Done — I posted it" action and 8s duration.
Verify the Mark Done button changes label to "Done — I posted it" after copy (hasCopied state).
Verify LeadDetail stores current draft as previousDraftResult before calling onGenerateDraft.
Verify LeadDetail implements handleUndoRegenerate to restore the previous draft.
Verify LeadDetail passes `draftResult`, `previousDraftResult`, and `onUndoRegenerate` to StepActionScreen.
Verify `functions/generate-draft/deploy.js` is deleted.
  </verify>
  <done>
StepActionScreen integrates structured draft options via `draftResult` prop, shows tabbed DraftCopyCard when options exist, falls back to legacy `draftText` for backward compat, shows post-copy "Done — I posted it" toast with 8-second duration, pulses the Mark Done button after copy, detects regeneration completion and shows undo toast with action to restore previous draft, and supports undo regeneration via parent callbacks. LeadDetail stores previous draft before regeneration and implements undo restore. Edge function is removed.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify end-to-end draft generation flow</name>
  <what-built>
Complete draft generation migration from edge function to bot agent pipeline:

**Bot side (19-04):**
- draft_requests table as async message bus
- CommentGeneratorAgent with multi-platform prompt
- Background poller (3-second interval) that processes requests
- Stale request recovery on startup
- Langfuse tracing and ModelConfigService integration

**TMA side (19-05):**
- useGenerateDraft rewired to DB message bus (insert → poll → result)
- DraftCopyCard with tabbed segmented control (Short/Medium/Detailed)
- Platform detection badge (LinkedIn, Email, Twitter/X, etc.)
- Post-copy "Done — I posted it" toast (8-second duration) with action button
- Mark Done button pulses and changes label after copy
- Regenerate button with refresh icon and undo toast to restore previous draft
- Edge function removed
  </what-built>
  <how-to-verify>
**Prerequisites:** Run the draft_requests migration on InsForge database first:
`insforge/migrations/006_draft_requests.sql`

1. Start the bot and verify "Draft request poller started" appears in logs
2. Open TMA, navigate to a lead with an engagement plan
3. Open a step and upload a screenshot of a LinkedIn post (or email, or any content)
4. Tap "Generate Draft from Screenshot" — verify loading state appears
5. Wait 10-20 seconds — verify draft options appear in a tabbed view (Short/Medium/Detailed)
6. Tap between tabs — verify different length options display
7. Check if a platform badge appears (e.g., "LinkedIn")
8. Tap "Copy Draft" — verify text is copied and "Done — I posted it" toast appears with action button
9. Verify the Mark Done button now shows "Done — I posted it" text with pulsing ring
10. Tap the "Done — I posted it" button (either toast or main button) — step should complete
11. Test regeneration: open another step with screenshot, generate draft, then tap the refresh icon — verify new draft replaces old one and an "Undo" toast appears
12. Tap the "Undo" button on the toast — verify the previous draft is restored
13. Check Langfuse dashboard — verify a trace for `agent:comment_generator` appears with the generation
14. (Optional) Set a model override for `comment_generator` in admin panel and verify it's used on next generation
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- `cd packages/webapp && npx tsc --noEmit` passes with zero errors
- `cd packages/webapp && npx vite build` succeeds
- useGenerateDraft uses `draft_requests` table, not edge function
- DraftCopyCard has segmented control tabs for options
- StepActionScreen shows "Done — I posted it" toast after copy
- Toast store supports custom `duration` field
- `functions/generate-draft/deploy.js` no longer exists
- Bot logs show "Draft request poller started" on startup
- End-to-end flow works: screenshot → generate → tabbed options → copy → done nudge
</verification>

<success_criteria>
- Draft generation works end-to-end via DB message bus (no edge function)
- Multiple draft options displayed in tabbed segmented control
- Segmented control switches between Short/Medium/Detailed with smooth transition
- Platform auto-detection badge appears (LinkedIn, Email, etc.)
- Post-copy "Done — I posted it" toast has 8-second duration with action button
- Mark Done button changes label and pulses after copy
- Regeneration replaces draft, undo toast available
- TypeScript compiles and Vite builds successfully
- Edge function file is deleted
</success_criteria>

<output>
After completion, create `.planning/phases/19-active-engagement-execution/19-05-SUMMARY.md`
</output>
