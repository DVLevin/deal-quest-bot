---
phase: 19-active-engagement-execution
plan: 03
type: execute
wave: 2
depends_on: ["19-01", "19-02"]
files_modified:
  - packages/webapp/src/features/leads/components/LeadDetail.tsx
  - packages/webapp/src/features/leads/components/LeadCard.tsx
  - packages/webapp/src/pages/Dashboard.tsx
autonomous: false

must_haves:
  truths:
    - "Tapping a step row in LeadDetail expands it into the StepActionScreen with full context"
    - "Deep link ?step=X auto-expands the step into action mode (not just highlight)"
    - "User can upload proof, copy draft, mark done, or can't-perform from the action screen"
    - "Closing the action screen returns to compact step list view"
    - "TodayActions dashboard widget taps navigate to lead with step auto-expanded in action mode"
    - "LeadCard shows a proof count indicator when any steps have uploaded proof screenshots"
  artifacts:
    - path: "packages/webapp/src/features/leads/components/LeadDetail.tsx"
      provides: "Step expand/collapse logic, StepActionScreen rendering, deep link auto-expand"
      contains: "StepActionScreen"
    - path: "packages/webapp/src/features/leads/components/LeadCard.tsx"
      provides: "Proof indicator on cards with completed proof steps"
      contains: "proof"
  key_links:
    - from: "packages/webapp/src/features/leads/components/LeadDetail.tsx"
      to: "StepActionScreen"
      via: "conditional render based on activeStepId state"
      pattern: "activeStepId.*StepActionScreen"
    - from: "packages/webapp/src/features/leads/components/LeadDetail.tsx"
      to: "useUploadProof"
      via: "hook call and onUploadProof callback"
      pattern: "useUploadProof"
    - from: "packages/webapp/src/features/leads/components/LeadDetail.tsx"
      to: "deep link ?step= query param"
      via: "useEffect sets activeStepId from highlightStepId"
      pattern: "setActiveStepId.*highlightStepId"
---

<objective>
Integrate the StepActionScreen into LeadDetail, wire up all hooks (upload, step update with proof/can't-perform), upgrade deep link behavior so ?step=X opens the step in action mode, and add proof indicators to LeadCard.

Purpose: This is the integration plan that brings everything together -- the types/hooks from Plan 01 and the UI components from Plan 02 are now wired into the existing LeadDetail and LeadCard. Deep link behavior is upgraded from highlight-only to action-mode-open. This is the plan that makes the feature actually work end-to-end.

Output: Working step action screens in LeadDetail, proof upload flow, can't-perform flow, deep link auto-expand, and proof indicators on LeadCard.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-active-engagement-execution/19-RESEARCH.md
@.planning/phases/19-active-engagement-execution/19-01-SUMMARY.md
@.planning/phases/19-active-engagement-execution/19-02-SUMMARY.md

@packages/webapp/src/features/leads/components/LeadDetail.tsx
@packages/webapp/src/features/leads/components/LeadCard.tsx
@packages/webapp/src/features/leads/hooks/useUpdatePlanStep.ts
@packages/webapp/src/features/leads/hooks/useUploadProof.ts
@packages/webapp/src/features/leads/types.ts
@packages/webapp/src/types/tables.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire StepActionScreen into LeadDetail with deep link auto-expand, add proof indicators to LeadCard</name>
  <files>
    packages/webapp/src/features/leads/components/LeadDetail.tsx
    packages/webapp/src/features/leads/components/LeadCard.tsx
  </files>
  <action>
Modify LeadDetail.tsx to replace the compact step rows with an expandable action screen pattern, and modify LeadCard.tsx to show proof indicators.

**LeadDetail.tsx changes:**

1. **Add new imports at the top:**
   - `import { StepActionScreen } from './StepActionScreen';`
   - `import { useUploadProof } from '../hooks/useUploadProof';`

2. **Add activeStepId state** (alongside existing state):
   ```typescript
   const [activeStepId, setActiveStepId] = useState<number | null>(null);
   ```

3. **Initialize useUploadProof hook:**
   ```typescript
   const uploadMutation = useUploadProof();
   ```

4. **Upgrade the deep link effect** (the existing `useEffect` that handles `highlightStepId`):
   - Change it to ALSO set `activeStepId` so the step auto-expands into action mode when arriving via deep link:
   ```typescript
   useEffect(() => {
     if (highlightStepId && !isLoading && lead) {
       setActiveSection('plan');
       setActiveStepId(highlightStepId);  // NEW: auto-expand into action mode
       const timer = setTimeout(() => {
         stepRefs.current[highlightStepId]?.scrollIntoView({
           behavior: 'smooth',
           block: 'center',
         });
       }, 150);
       return () => clearTimeout(timer);
     }
   }, [highlightStepId, isLoading, lead]);
   ```

5. **Add handler callbacks for the action screen:**
   ```typescript
   const handleStepComplete = useCallback((stepId: number) => {
     if (!lead || !telegramId) return;
     stepMutation.mutate(
       { leadId: lead.id, stepId, newStatus: 'done', telegramId },
       {
         onSuccess: () => {
           toast({ type: 'success', message: `Step ${stepId} completed!` });
           setActiveStepId(null); // Close action screen after completion
         },
         onError: () => {
           toast({ type: 'error', message: 'Failed to complete step' });
         },
       },
     );
   }, [lead, telegramId, stepMutation, toast]);

   const handleCantPerform = useCallback((stepId: number, reason: string) => {
     if (!lead || !telegramId) return;
     stepMutation.mutate(
       { leadId: lead.id, stepId, newStatus: 'skipped', telegramId, cantPerformReason: reason },
       {
         onSuccess: () => {
           toast({ type: 'success', message: 'Step skipped with reason' });
           setActiveStepId(null);
         },
         onError: () => {
           toast({ type: 'error', message: 'Failed to skip step' });
         },
       },
     );
   }, [lead, telegramId, stepMutation, toast]);

   const handleUploadProof = useCallback(async (stepId: number, file: File) => {
     if (!lead || !telegramId) return;
     uploadMutation.mutate(
       { file, leadId: lead.id, stepId, telegramId },
       {
         onSuccess: () => {
           toast({ type: 'success', message: 'Proof uploaded!' });
         },
         onError: () => {
           toast({ type: 'error', message: 'Upload failed. Try again.' });
         },
       },
     );
   }, [lead, telegramId, uploadMutation, toast]);
   ```

6. **Replace the step list rendering** in the Active Plan CollapsibleSection:
   - For each step, check if `step.step_id === activeStepId`
   - If yes: render `<StepActionScreen>` with all props wired to the handlers above
   - If no: render the existing compact step row (keep the current JSX), but add an `onClick` handler on the step row that sets `setActiveStepId(step.step_id)` (make the row tappable to expand)
   - The compact row should be wrapped in a clickable container. Keep the existing status toggle button on the right -- but only for done/skipped steps. For pending steps, tapping the row opens the action screen instead.

   ```tsx
   {engagementPlan.map((step) => {
     const isHighlighted = step.step_id === visualHighlight;
     const isActive = step.step_id === activeStepId;

     if (isActive) {
       return (
         <div key={step.step_id} ref={(el) => { stepRefs.current[step.step_id] = el; }}>
           <StepActionScreen
             step={step}
             leadName={lead.prospect_first_name && lead.prospect_last_name
               ? `${lead.prospect_first_name} ${lead.prospect_last_name}`
               : lead.prospect_name ?? 'Unknown'}
             leadCompany={lead.prospect_company ?? undefined}
             onComplete={() => handleStepComplete(step.step_id)}
             onCantPerform={(reason) => handleCantPerform(step.step_id, reason)}
             onUploadProof={(file) => handleUploadProof(step.step_id, file)}
             onClose={() => setActiveStepId(null)}
             isUpdating={stepMutation.isPending}
             isUploading={uploadMutation.isPending}
           />
         </div>
       );
     }

     return (
       <div
         key={step.step_id}
         ref={(el) => { stepRefs.current[step.step_id] = el; }}
         role="button"
         tabIndex={0}
         onClick={() => step.status === 'pending' ? setActiveStepId(step.step_id) : handleStepToggle(step.step_id, step.status)}
         onKeyDown={(e) => { if (e.key === 'Enter') step.status === 'pending' ? setActiveStepId(step.step_id) : handleStepToggle(step.step_id, step.status); }}
         className={cn(
           'flex items-start gap-3 rounded-lg bg-surface-secondary/30 p-2 transition-all duration-300 cursor-pointer active:bg-surface-secondary/50',
           isHighlighted && 'ring-2 ring-accent animate-pulse',
           step.proof_url && 'border-l-2 border-success',
         )}
       >
         {/* Keep existing compact row content: step number, description, timing, status button */}
         <span className="flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-accent/15 text-xs font-bold text-accent">
           {step.step_id}
         </span>
         <div className="min-w-0 flex-1">
           <p className={cn("text-sm text-text", step.status === 'done' && "line-through text-text-hint")}>{step.description}</p>
           <div className="mt-1 flex flex-wrap gap-2">
             {step.timing && <span className="text-xs text-text-hint">{step.timing}</span>}
             {step.proof_url && <span className="text-xs text-success">Proof attached</span>}
             {step.cant_perform_reason && <span className="text-xs text-warning">Can't perform</span>}
           </div>
         </div>
         <button
           type="button"
           onClick={(e) => { e.stopPropagation(); handleStepToggle(step.step_id, step.status); }}
           disabled={stepMutation.isPending}
           className={`flex min-h-[32px] items-center gap-1 rounded-lg px-2 py-1 text-xs font-medium transition-colors active:scale-95 disabled:opacity-50 ${
             step.status === 'done'
               ? 'bg-success/15 text-success'
               : step.status === 'skipped'
                 ? 'bg-text-hint/15 text-text-hint'
                 : 'bg-surface-secondary text-text-secondary'
           }`}
         >
           {step.status === 'done' && <Check className="h-3 w-3" />}
           {step.status === 'skipped' && <SkipForward className="h-3 w-3" />}
           {step.status === 'pending' && <Circle className="h-3 w-3" />}
           {step.status === 'done' ? 'Done' : step.status === 'skipped' ? 'Skipped' : 'Pending'}
         </button>
       </div>
     );
   })}
   ```

7. **Remove the duplicate copyToClipboard function** from LeadDetail.tsx if it's now only used by DraftCopyCard. If it's still used by the draft display in the Intelligence section, keep it. Check before removing.

**LeadCard.tsx changes:**

8. **Add proof indicator to LeadCard** (`packages/webapp/src/features/leads/components/LeadCard.tsx`):
   - The `PlanProgress` type (from `../types`) is already passed as `progress` prop. However, it doesn't carry proof count data. Instead, access the raw engagement plan from `lead` to count proofs.
   - First, add `parseEngagementPlan` import from `'../types'` and `ImageIcon` (or `Camera`) from `lucide-react`.
   - Inside the component, compute proof count from the lead's raw engagement_plan JSONB:
     ```typescript
     const engagementPlan = parseEngagementPlan((lead as any).engagement_plan);
     const proofCount = engagementPlan?.filter(s => s.proof_url).length ?? 0;
     ```
     Note: Cast to `any` because `LeadListItem` may not include `engagement_plan` in its select. If `engagement_plan` is not on `LeadListItem`, instead compute proof count inside `computePlanProgress` and add `proofCount` to `PlanProgress` interface in `types.ts`. Choose whichever approach works with the existing data flow. The simpler path is to extend `PlanProgress` with `proofCount: number`, compute it in `computePlanProgress` by counting steps with `proof_url`, and use it in LeadCard.
   - Display the proof indicator in the engagement plan progress section, next to the steps count. Add it between the "{completed}/{total} steps" span and the overdue badge:
     ```tsx
     {proofCount > 0 && (
       <span className="flex items-center gap-1 text-xs text-success">
         <Camera className="h-3 w-3" />
         {proofCount} proof{proofCount > 1 ? 's' : ''}
       </span>
     )}
     ```
   - This gives users a quick visual cue in the lead list that proof screenshots have been attached to engagement steps, without needing to open the lead detail.
  </action>
  <verify>
Run `cd packages/webapp && npx tsc --noEmit` -- zero errors. Verify:
1. StepActionScreen is imported and rendered when activeStepId matches
2. Deep link ?step=X sets activeStepId (auto-expand)
3. Compact rows are tappable for pending steps
4. Upload proof, complete, and can't-perform all wire to correct mutations
5. LeadCard shows proof count indicator when proofCount > 0
6. Run `cd packages/webapp && npx vite build` -- build succeeds
  </verify>
  <done>
LeadDetail renders StepActionScreen when a step is active. Deep links auto-expand steps into action mode. Compact rows show proof indicators and are tappable. All mutation callbacks wired correctly. LeadCard displays proof count badge for leads with uploaded proof screenshots. Build succeeds.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify step action screen in TMA</name>
  <what-built>
Complete step action screen system:
- Tapping a pending step expands it into a full action screen with lead context, draft copy, proof upload, and done/can't-perform buttons
- Deep links from bot reminders (?step=X) auto-expand the step into action mode
- Draft text is copyable with one tap
- Proof screenshots can be uploaded via file picker
- Can't-perform flow collects a reason and skips the step
- Completed/skipped steps show inline indicators (proof attached, can't perform)
- LeadCard in the lead list shows proof count badge (e.g., "2 proofs") when steps have uploaded screenshots
  </what-built>
  <how-to-verify>
1. Open the TMA and navigate to a lead with an engagement plan
2. Tap a pending step -- it should expand into the action screen
3. Verify lead name and company appear in the context bar
4. If the step has suggested_text, verify the draft displays and the copy button works
5. Tap "Upload Proof Screenshot" -- the file picker should open (on mobile, should offer camera option)
6. Upload a screenshot -- it should show upload progress then a thumbnail
7. Tap "Mark Done" -- step should complete and collapse back
8. Try the "Can't do this?" link on another step -- input should appear, enter a reason, tap "Skip with reason"
9. Verify the step shows "Can't perform" indicator in collapsed view
10. Go back to the leads list -- verify the LeadCard for this lead shows a proof count badge (e.g., "1 proof")
11. Test deep link: send a bot reminder with "Open in App" button -- tapping should open the specific step in action mode
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- `cd packages/webapp && npx tsc --noEmit` passes with zero errors
- `cd packages/webapp && npx vite build` succeeds
- StepActionScreen renders in LeadDetail when step is tapped or deep-linked
- Draft copy works in Telegram WebView (clipboard fallback)
- Proof upload works via file input (not camera API)
- Can't-perform flow records reason and skips step
- Deep link ?step=X auto-expands into action mode
- Compact step rows show proof/can't-perform indicators
- LeadCard shows proof count badge when any steps have proof_url
</verification>

<success_criteria>
- Tapping a pending step opens action screen with lead context, draft, proof upload, and action buttons
- Deep link from bot reminder opens step in action mode (not just highlight)
- Draft copy works with one tap (clipboard API with fallback)
- Proof screenshot uploads to InsForge storage and shows thumbnail
- Can't-perform collects reason, marks step as skipped with reason stored
- Closing action screen returns to compact step list
- LeadCard in list view shows proof count indicator for leads with proof screenshots
- No regression on existing step toggle behavior for done/skipped steps
- TypeScript compiles and Vite builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/19-active-engagement-execution/19-03-SUMMARY.md`
</output>
