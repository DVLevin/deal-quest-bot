---
phase: 19-active-engagement-execution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/webapp/src/types/tables.ts
  - packages/webapp/src/features/leads/types.ts
  - packages/webapp/src/features/leads/hooks/useUpdatePlanStep.ts
  - packages/webapp/src/features/leads/hooks/useUploadProof.ts
autonomous: true

must_haves:
  truths:
    - "EngagementPlanStep type includes proof_url and cant_perform_reason optional fields"
    - "parseEngagementPlan defensively parses new fields from existing JSONB data without crashing"
    - "useUpdatePlanStep can save proof_url and cant_perform_reason alongside status changes"
    - "useUploadProof uploads a file to InsForge storage and updates engagement_plan JSONB with the URL"
  artifacts:
    - path: "packages/webapp/src/types/tables.ts"
      provides: "Extended EngagementPlanStep with proof_url, cant_perform_reason fields"
      contains: "proof_url"
    - path: "packages/webapp/src/features/leads/types.ts"
      provides: "Updated parseEngagementPlan with defensive parsing for new fields"
      contains: "proof_url"
    - path: "packages/webapp/src/features/leads/hooks/useUpdatePlanStep.ts"
      provides: "Extended mutation accepting proof_url and cant_perform_reason"
      contains: "proof_url"
    - path: "packages/webapp/src/features/leads/hooks/useUploadProof.ts"
      provides: "New hook for InsForge storage upload + JSONB update"
      contains: "storage"
  key_links:
    - from: "packages/webapp/src/features/leads/hooks/useUploadProof.ts"
      to: "InsForge storage API"
      via: "getInsforge().storage.from().upload()"
      pattern: "storage.*from.*upload"
    - from: "packages/webapp/src/features/leads/hooks/useUpdatePlanStep.ts"
      to: "lead_registry engagement_plan JSONB"
      via: "database update with proof_url and cant_perform_reason fields"
      pattern: "proof_url|cant_perform_reason"
---

<objective>
Extend the engagement plan type system and hooks to support proof-of-action screenshots and can't-perform flow data.

Purpose: Foundation for the action screen UI -- types and data hooks must exist before components can use them. This plan extends the existing EngagementPlanStep type with new optional fields (proof_url, cant_perform_reason), updates the defensive parser, extends useUpdatePlanStep to handle new fields, and creates a useUploadProof hook for InsForge storage uploads.

Output: Extended types, updated parser, enhanced step mutation hook, and new upload hook -- all ready for UI components to consume.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-active-engagement-execution/19-RESEARCH.md

@packages/webapp/src/types/tables.ts
@packages/webapp/src/features/leads/types.ts
@packages/webapp/src/features/leads/hooks/useUpdatePlanStep.ts
@packages/webapp/src/lib/insforge.ts
@packages/webapp/src/lib/queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend EngagementPlanStep type and parser</name>
  <files>
    packages/webapp/src/types/tables.ts
    packages/webapp/src/features/leads/types.ts
  </files>
  <action>
1. In `packages/webapp/src/types/tables.ts`, add three new optional fields to the `EngagementPlanStep` interface:
   - `proof_url?: string` -- URL of uploaded proof screenshot from InsForge storage
   - `cant_perform_reason?: string` -- Reason the user can't perform this step
   - `alternative_action?: string` -- Suggested alternative action text

   Keep PlanStepStatus as `'pending' | 'done' | 'skipped'` (do NOT add 'cant_perform' -- per research, treat can't-perform as 'skipped' with cant_perform_reason set, to avoid cross-stack type changes).

2. In `packages/webapp/src/features/leads/types.ts`, update the `parseEngagementPlan()` function to defensively parse the three new fields. Follow the exact same pattern as existing fields (typeof string guard with undefined fallback). Add after the `completed_at` field:
   ```
   proof_url: typeof item.proof_url === 'string' ? item.proof_url : undefined,
   cant_perform_reason: typeof item.cant_perform_reason === 'string' ? item.cant_perform_reason : undefined,
   alternative_action: typeof item.alternative_action === 'string' ? item.alternative_action : undefined,
   ```

   This ensures old leads without these fields parse cleanly as undefined (no runtime errors).
  </action>
  <verify>
Run `cd packages/webapp && npx tsc --noEmit` -- should compile with zero errors. Verify the new fields appear in the EngagementPlanStep interface and the parser handles them.
  </verify>
  <done>
EngagementPlanStep has proof_url, cant_perform_reason, alternative_action optional fields. parseEngagementPlan defensively parses all three. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend useUpdatePlanStep and create useUploadProof</name>
  <files>
    packages/webapp/src/features/leads/hooks/useUpdatePlanStep.ts
    packages/webapp/src/features/leads/hooks/useUploadProof.ts
  </files>
  <action>
1. **Extend useUpdatePlanStep** (`packages/webapp/src/features/leads/hooks/useUpdatePlanStep.ts`):
   - Add two optional fields to `UpdatePlanStepVars`: `proofUrl?: string` and `cantPerformReason?: string`
   - In the `mutationFn`, when updating the step in engagement_plan, spread the new fields:
     ```typescript
     const updatedPlan = currentPlan.map((step) => {
       if (step.step_id === stepId) {
         return {
           ...step,
           status: newStatus,
           completed_at: newStatus === 'done' || newStatus === 'skipped' ? new Date().toISOString() : null,
           ...(proofUrl !== undefined && { proof_url: proofUrl }),
           ...(cantPerformReason !== undefined && { cant_perform_reason: cantPerformReason }),
         };
       }
       return step;
     });
     ```
   - In the `onMutate` optimistic update, also apply proofUrl and cantPerformReason the same way.
   - Update the activity log content: if cantPerformReason is set, log `Step ${stepId} can't perform: ${cantPerformReason}` instead of `Step ${stepId} marked as Skipped`.

2. **Create useUploadProof** (`packages/webapp/src/features/leads/hooks/useUploadProof.ts`):
   - Create a new TanStack Query mutation hook that:
     a. Takes `{ file: File, leadId: number, stepId: number, telegramId: number }`
     b. Client-side compresses the image to max 1200px dimension using canvas (prevents large upload failures):
        - Create an Image element from the File via URL.createObjectURL
        - If width or height > 1200, scale down proportionally
        - Draw to canvas, export as JPEG quality 0.85
        - Convert canvas blob back to File
     c. Uploads the (possibly resized) file to InsForge storage using:
        ```typescript
        const key = `proof/${leadId}/${stepId}/${Date.now()}.jpg`;
        const { data, error } = await getInsforge().storage.from('prospect-photos').upload(key, file);
        ```
        Use the existing `prospect-photos` bucket with `proof/` key prefix (per research recommendation -- avoids needing to create a new bucket).
     d. After upload, fetches the public URL for the uploaded file:
        ```typescript
        const { data: urlData } = getInsforge().storage.from('prospect-photos').getPublicUrl(key);
        ```
     e. Returns the public URL string
   - On `onSettled`, invalidate `queryKeys.leads.detail(leadId)` and `queryKeys.leads.byUser(telegramId)`
   - Import getInsforge from `@/lib/insforge`, queryKeys from `@/lib/queries`
   - Export the hook and also export the `resizeImage` utility function so it can be tested independently if needed
  </action>
  <verify>
Run `cd packages/webapp && npx tsc --noEmit` -- should compile with zero errors. Verify both hooks exist and export correctly. Check that useUploadProof includes the canvas resize logic and InsForge storage upload.
  </verify>
  <done>
useUpdatePlanStep accepts optional proofUrl and cantPerformReason, applies them to JSONB updates and optimistic cache. useUploadProof resizes images client-side and uploads to InsForge storage prospect-photos bucket with proof/ prefix. Both hooks compile cleanly.
  </done>
</task>

</tasks>

<verification>
- `cd packages/webapp && npx tsc --noEmit` passes with zero errors
- EngagementPlanStep interface has proof_url, cant_perform_reason, alternative_action
- parseEngagementPlan handles old data without new fields (undefined, not crash)
- useUpdatePlanStep vars interface includes optional proofUrl and cantPerformReason
- useUploadProof hook exists with resize + upload + public URL logic
</verification>

<success_criteria>
- Extended EngagementPlanStep type is backward compatible (all new fields optional)
- Parser handles pre-Phase-19 data cleanly
- useUpdatePlanStep can persist proof and can't-perform data to JSONB
- useUploadProof compresses images and uploads to InsForge storage
- All TypeScript compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/19-active-engagement-execution/19-01-SUMMARY.md`
</output>
