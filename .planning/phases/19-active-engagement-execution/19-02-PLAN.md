---
phase: 19-active-engagement-execution
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/webapp/src/features/leads/components/StepActionScreen.tsx
  - packages/webapp/src/features/leads/components/ProofUpload.tsx
  - packages/webapp/src/features/leads/components/CantPerformFlow.tsx
  - packages/webapp/src/features/leads/components/DraftCopyCard.tsx
autonomous: true

must_haves:
  truths:
    - "StepActionScreen renders lead context summary, step instructions, timing, and action controls"
    - "DraftCopyCard displays draft text and copies to clipboard with one tap using existing fallback pattern"
    - "ProofUpload shows file input trigger, upload progress, and uploaded proof thumbnail"
    - "CantPerformFlow collects a reason via text input and calls onCantPerform callback"
  artifacts:
    - path: "packages/webapp/src/features/leads/components/StepActionScreen.tsx"
      provides: "Full action screen for a single engagement plan step"
      min_lines: 80
    - path: "packages/webapp/src/features/leads/components/DraftCopyCard.tsx"
      provides: "Draft text display with copy button"
      min_lines: 30
    - path: "packages/webapp/src/features/leads/components/ProofUpload.tsx"
      provides: "Screenshot upload with progress and preview"
      min_lines: 40
    - path: "packages/webapp/src/features/leads/components/CantPerformFlow.tsx"
      provides: "Reason input and skip-with-reason action"
      min_lines: 30
  key_links:
    - from: "packages/webapp/src/features/leads/components/StepActionScreen.tsx"
      to: "DraftCopyCard, ProofUpload, CantPerformFlow"
      via: "child component composition"
      pattern: "DraftCopyCard|ProofUpload|CantPerformFlow"
    - from: "packages/webapp/src/features/leads/components/DraftCopyCard.tsx"
      to: "clipboard API"
      via: "copyToClipboard function"
      pattern: "navigator\\.clipboard|execCommand"
---

<objective>
Create the four UI components for the step action screen: the main StepActionScreen wrapper, DraftCopyCard for draft text display, ProofUpload for screenshot capture, and CantPerformFlow for the can't-perform reason collection.

Purpose: These components are the visual core of Phase 19 -- they transform a compact step row into a guided action experience. They are pure presentational components that accept callbacks from the parent (LeadDetail) and don't directly call hooks.

Output: Four new React components ready to be composed into LeadDetail in Plan 03.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-active-engagement-execution/19-RESEARCH.md

@packages/webapp/src/features/leads/components/LeadDetail.tsx
@packages/webapp/src/types/tables.ts
@packages/webapp/src/shared/ui/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DraftCopyCard and ProofUpload components</name>
  <files>
    packages/webapp/src/features/leads/components/DraftCopyCard.tsx
    packages/webapp/src/features/leads/components/ProofUpload.tsx
  </files>
  <action>
1. **DraftCopyCard** (`packages/webapp/src/features/leads/components/DraftCopyCard.tsx`):
   - Props: `{ draftText: string }`
   - Internal state: `copied` boolean (resets after 2s)
   - Reuse the EXACT `copyToClipboard()` function pattern from LeadDetail.tsx (lines 64-85) -- copy it directly into this component as a module-level utility. It handles the Telegram WebView clipboard restriction with textarea+execCommand fallback.
   - Render:
     - A Card-like container with a label "Draft Message" and a small copy icon button in the header row
     - The draft text in a `<pre className="whitespace-pre-wrap font-sans text-sm leading-relaxed text-text">` (matching LeadDetail's existing draft display pattern)
     - A full-width "Copy Draft" button at the bottom. When tapped: calls copyToClipboard, sets copied=true, shows "Copied!" with Check icon for 2s, then reverts to "Copy Draft" with Copy icon.
   - Styling: Use existing Tailwind classes. Card-like appearance with `rounded-xl border border-surface-secondary bg-surface-secondary/30 p-3`. Copy button uses `bg-accent/15 text-accent` with active:scale-95.
   - Icons: Import Copy, Check from lucide-react

2. **ProofUpload** (`packages/webapp/src/features/leads/components/ProofUpload.tsx`):
   - Props: `{ onUpload: (file: File) => Promise<void>; existingProofUrl?: string; isUploading: boolean }`
   - Uses a hidden `<input type="file" accept="image/*">` with a useRef. Do NOT use `capture="camera"` (breaks on some Telegram Android WebView versions per research).
   - Three states:
     a. **No proof, not uploading**: Show a dashed-border upload area with Camera icon and "Upload Proof Screenshot" text. Tap triggers `fileInputRef.current?.click()`.
     b. **Uploading**: Show Loader2 with spin animation and "Uploading..." text. Button disabled.
     c. **Proof exists**: Show a green success bar with CheckCircle icon, "Proof uploaded" text, and a small thumbnail of the proof image (img tag with `h-10 w-10 rounded object-cover`). Include a small "Replace" button to allow re-upload.
   - On file select: call `onUpload(file)`. The parent handles the actual upload mutation.
   - Styling: Upload area uses `border-2 border-dashed border-accent/30 bg-accent/5 py-4 rounded-xl`. Success state uses `bg-success/10 border border-success/30`.
   - Icons: Import Camera, Loader2, CheckCircle from lucide-react
  </action>
  <verify>
Run `cd packages/webapp && npx tsc --noEmit` -- zero errors. Both components exist, export default-named exports, and accept the specified props.
  </verify>
  <done>
DraftCopyCard renders draft text with one-tap copy using clipboard fallback pattern. ProofUpload renders upload trigger, loading state, and proof preview with replace option. Both compile cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CantPerformFlow and StepActionScreen components</name>
  <files>
    packages/webapp/src/features/leads/components/CantPerformFlow.tsx
    packages/webapp/src/features/leads/components/StepActionScreen.tsx
  </files>
  <action>
1. **CantPerformFlow** (`packages/webapp/src/features/leads/components/CantPerformFlow.tsx`):
   - Props: `{ onCantPerform: (reason: string) => void; onCancel: () => void; isSubmitting: boolean }`
   - Internal state: `reason` string, `showInput` boolean (starts false)
   - Two phases:
     a. **Initial**: Show a subtle "Can't do this?" link/button at the bottom of the action screen. When tapped, sets showInput=true.
     b. **Input mode**: Show a textarea placeholder "Why can't you perform this step?" (max 200 chars), a "Skip with reason" primary button (disabled if reason empty or isSubmitting), and a "Cancel" text button.
   - On submit: calls `onCantPerform(reason)`. The parent handles the mutation (marks step as 'skipped' with cant_perform_reason).
   - Styling: Initial link uses `text-xs text-text-hint underline`. Input mode uses a Card-like container with textarea and buttons. "Skip with reason" button uses `bg-warning/15 text-warning`. Cancel uses plain text styling.
   - Icons: Import Ban from lucide-react for the initial trigger

2. **StepActionScreen** (`packages/webapp/src/features/leads/components/StepActionScreen.tsx`):
   - Props interface:
     ```typescript
     interface StepActionScreenProps {
       step: EngagementPlanStep;
       leadName: string;
       leadCompany?: string;
       onComplete: () => void;
       onCantPerform: (reason: string) => void;
       onUploadProof: (file: File) => Promise<void>;
       onClose: () => void;
       isUpdating: boolean;
       isUploading: boolean;
     }
     ```
   - Import EngagementPlanStep from `@/types/tables`
   - Layout (top to bottom, full-width card that replaces the compact step row):
     a. **Header bar**: Step number badge (accent circle), step description as title, X close button (top-right). Shows timing below description.
     b. **Lead context mini-card**: Small gray bar showing lead name and company (provides context without leaving the screen).
     c. **Draft section**: If `step.suggested_text` exists, render `<DraftCopyCard draftText={step.suggested_text} />`. If no draft, show a small "No draft available" hint.
     d. **Proof section**: Render `<ProofUpload onUpload={onUploadProof} existingProofUrl={step.proof_url} isUploading={isUploading} />`
     e. **Action buttons**: Two buttons side by side:
        - "Mark Done" -- green (`bg-success text-white`), calls onComplete, disabled if isUpdating. Shows Check icon.
        - "Skip" -- gray, calls onClose with skip intent. Shows SkipForward icon.
     f. **Can't perform**: Below action buttons, render `<CantPerformFlow onCantPerform={onCantPerform} onCancel={() => {}} isSubmitting={isUpdating} />`
   - If step.status is already 'done', show a success state: green banner "Step completed" with proof thumbnail if exists, and a "Reopen" option.
   - If step.status is 'skipped' with cant_perform_reason, show the reason in a warning-styled banner.
   - Styling: Outer container uses `rounded-2xl border border-surface-secondary bg-surface p-4 shadow-lg`. Use space-y-4 for vertical rhythm. Close button is absolute positioned top-right.
   - Icons: Import X, Check, SkipForward, Clock from lucide-react
  </action>
  <verify>
Run `cd packages/webapp && npx tsc --noEmit` -- zero errors. StepActionScreen composes DraftCopyCard, ProofUpload, and CantPerformFlow. All four components exist and export correctly.
  </verify>
  <done>
CantPerformFlow shows progressive disclosure (link -> input -> submit). StepActionScreen assembles all sub-components into a guided action experience with lead context, draft copy, proof upload, done/skip buttons, and can't-perform flow. All four components compile cleanly and are ready for LeadDetail integration.
  </done>
</task>

</tasks>

<verification>
- `cd packages/webapp && npx tsc --noEmit` passes with zero errors
- Four new component files exist in packages/webapp/src/features/leads/components/
- StepActionScreen imports and renders DraftCopyCard, ProofUpload, CantPerformFlow
- DraftCopyCard uses clipboard fallback pattern from LeadDetail
- ProofUpload uses `<input type="file" accept="image/*">` (not capture="camera")
- CantPerformFlow has progressive disclosure (collapsed -> expanded -> submit)
</verification>

<success_criteria>
- All four components render correctly (no runtime errors when parent passes valid props)
- DraftCopyCard copy button works with clipboard fallback pattern
- ProofUpload shows three distinct states (empty, uploading, uploaded)
- CantPerformFlow collects reason text and calls callback
- StepActionScreen shows completed/skipped state banners for non-pending steps
- Zero TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/19-active-engagement-execution/19-02-SUMMARY.md`
</output>
