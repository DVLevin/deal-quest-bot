---
phase: 18-agent-observatory
plan: 04
type: execute
wave: 2
depends_on: ["18-03"]
files_modified:
  - packages/webapp/src/features/admin/hooks/useModelConfig.ts
  - packages/webapp/src/features/admin/hooks/useOpenRouterModels.ts
  - packages/webapp/src/features/admin/components/ModelConfigPanel.tsx
  - packages/webapp/src/pages/Admin.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can see current per-agent model overrides on the admin page"
    - "Admin can set a model override for any agent by selecting from an OpenRouter model browser"
    - "Admin can remove (deactivate) a model override to revert an agent to the user's default"
    - "Model changes are persisted to the database immediately and the UI reflects the current state"
  artifacts:
    - path: "packages/webapp/src/features/admin/hooks/useModelConfig.ts"
      provides: "React Query hooks for agent_model_config CRUD"
      exports: ["useModelConfigs", "useUpsertModelConfig", "useDeactivateModelConfig"]
    - path: "packages/webapp/src/features/admin/hooks/useOpenRouterModels.ts"
      provides: "Fetches OpenRouter model catalog"
      exports: ["useOpenRouterModels"]
    - path: "packages/webapp/src/features/admin/components/ModelConfigPanel.tsx"
      provides: "Admin UI for per-agent model configuration"
      exports: ["ModelConfigPanel"]
    - path: "packages/webapp/src/pages/Admin.tsx"
      provides: "Admin page with ModelConfigPanel section"
      contains: "ModelConfigPanel"
  key_links:
    - from: "packages/webapp/src/features/admin/components/ModelConfigPanel.tsx"
      to: "packages/webapp/src/features/admin/hooks/useModelConfig.ts"
      via: "useModelConfigs() for data, useUpsertModelConfig() for saves"
      pattern: "useModelConfigs"
    - from: "packages/webapp/src/features/admin/hooks/useModelConfig.ts"
      to: "insforge agent_model_config table"
      via: "InsForge SDK query/insert/update"
      pattern: "agent_model_config"
    - from: "packages/webapp/src/features/admin/hooks/useOpenRouterModels.ts"
      to: "OpenRouter API"
      via: "fetch https://openrouter.ai/api/v1/models"
      pattern: "openrouter.ai/api/v1/models"
---

<objective>
Build the TMA admin UI for per-agent model configuration: a panel showing all agents with their current model override (or "Default"), a model browser fetching from OpenRouter API, and save/remove actions.

Purpose: Enables admin to configure which model each agent uses from the TMA admin page without code access. Combined with the 60s TTL cache in the bot, changes take effect quickly.
Output: ModelConfigPanel component on Admin page, OpenRouter model browser, CRUD hooks for agent_model_config table.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-agent-observatory/18-RESEARCH.md
@.planning/phases/18-agent-observatory/18-03-SUMMARY.md
@packages/webapp/src/pages/Admin.tsx
@packages/webapp/src/features/admin/components/TeamOverview.tsx
@packages/webapp/src/features/admin/hooks/useTeamStats.ts
@packages/webapp/src/lib/insforge.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create hooks for model config CRUD and OpenRouter model fetching</name>
  <files>packages/webapp/src/features/admin/hooks/useModelConfig.ts, packages/webapp/src/features/admin/hooks/useOpenRouterModels.ts</files>
  <action>
1. **Create packages/webapp/src/features/admin/hooks/useModelConfig.ts:**

Follow the existing hook patterns in the project (useTeamStats.ts etc.) using React Query + InsForge SDK.

```typescript
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { insforge } from '@/lib/insforge';

interface AgentModelConfig {
  id: number;
  agent_name: string;
  model_id: string;
  is_active: boolean;
  set_by: string | null;
  created_at: string;
  updated_at: string;
}

// Known agents in the system
export const KNOWN_AGENTS = [
  { name: 'strategist', label: 'Strategist', description: 'Deal analysis & strategy' },
  { name: 'extraction', label: 'Extraction', description: 'Screenshot OCR' },
  { name: 'trainer', label: 'Trainer', description: 'Response scoring' },
  { name: 'memory', label: 'Memory', description: 'User memory updates' },
  { name: 'reanalysis_strategist', label: 'Re-analysis', description: 'Strategy re-analysis' },
] as const;

export function useModelConfigs() {
  return useQuery({
    queryKey: ['admin', 'modelConfigs'],
    queryFn: async () => {
      const { data, error } = await insforge
        .from('agent_model_config')
        .select('*')
        .eq('is_active', true);
      if (error) throw error;
      return (data ?? []) as AgentModelConfig[];
    },
    staleTime: 30_000, // 30s stale (admin doesn't need real-time)
  });
}

export function useUpsertModelConfig() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async ({ agentName, modelId, setBy }: { agentName: string; modelId: string; setBy?: string }) => {
      // Check if exists
      const { data: existing } = await insforge
        .from('agent_model_config')
        .select('id')
        .eq('agent_name', agentName)
        .limit(1);

      if (existing && existing.length > 0) {
        const { data, error } = await insforge
          .from('agent_model_config')
          .update({
            model_id: modelId,
            is_active: true,
            set_by: setBy ?? null,
            updated_at: new Date().toISOString(),
          })
          .eq('agent_name', agentName)
          .select();
        if (error) throw error;
        return data;
      } else {
        const { data, error } = await insforge
          .from('agent_model_config')
          .insert({
            agent_name: agentName,
            model_id: modelId,
            is_active: true,
            set_by: setBy ?? null,
          })
          .select();
        if (error) throw error;
        return data;
      }
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['admin', 'modelConfigs'] });
    },
  });
}

export function useDeactivateModelConfig() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async (agentName: string) => {
      const { data, error } = await insforge
        .from('agent_model_config')
        .update({
          is_active: false,
          updated_at: new Date().toISOString(),
        })
        .eq('agent_name', agentName)
        .select();
      if (error) throw error;
      return data;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['admin', 'modelConfigs'] });
    },
  });
}
```

2. **Create packages/webapp/src/features/admin/hooks/useOpenRouterModels.ts:**

Fetch the public OpenRouter model catalog. This is a public API (no auth needed for reading models).

```typescript
import { useQuery } from '@tanstack/react-query';

export interface OpenRouterModel {
  id: string;
  name: string;
  context_length: number | null;
  pricing: {
    prompt: string;
    completion: string;
  };
  architecture: {
    modality: string;
    tokenizer: string;
    instruct_type: string | null;
  };
}

export function useOpenRouterModels() {
  return useQuery({
    queryKey: ['openrouter', 'models'],
    queryFn: async () => {
      const resp = await fetch('https://openrouter.ai/api/v1/models');
      if (!resp.ok) throw new Error('Failed to fetch models');
      const data = await resp.json();
      return (data.data as OpenRouterModel[])
        .filter(m => m.pricing && m.architecture?.modality === 'text->text')
        .sort((a, b) => a.name.localeCompare(b.name));
    },
    staleTime: 10 * 60 * 1000, // 10 minutes (model catalog rarely changes)
  });
}
```

NOTE: Filter to `text->text` modality to exclude image-only, audio, or multimodal-only models. This keeps the dropdown manageable. Users can still type custom model IDs for vision models.
  </action>
  <verify>
    - Files exist at the specified paths
    - `grep "useModelConfigs" packages/webapp/src/features/admin/hooks/useModelConfig.ts` shows the hook
    - `grep "useOpenRouterModels" packages/webapp/src/features/admin/hooks/useOpenRouterModels.ts` shows the hook
    - `grep "KNOWN_AGENTS" packages/webapp/src/features/admin/hooks/useModelConfig.ts` shows agent list
  </verify>
  <done>useModelConfigs (read), useUpsertModelConfig (create/update), useDeactivateModelConfig (soft delete), and useOpenRouterModels (fetch catalog) hooks created.</done>
</task>

<task type="auto">
  <name>Task 2: Create ModelConfigPanel component and integrate into Admin page</name>
  <files>packages/webapp/src/features/admin/components/ModelConfigPanel.tsx, packages/webapp/src/pages/Admin.tsx</files>
  <action>
1. **Create packages/webapp/src/features/admin/components/ModelConfigPanel.tsx:**

Build a panel that shows each known agent with its current model override status and allows setting/removing overrides.

Follow the visual style of existing admin components (TeamOverview.tsx, WeakAreas.tsx) using Tailwind CSS classes from the project.

Structure:
- Card container with heading "Agent Model Configuration"
- Subtitle: "Set per-agent model overrides. Agents without overrides use the user's default model. Changes take effect within 60 seconds."
- For each agent in KNOWN_AGENTS, show a row:
  - Agent name + description (left)
  - Current model or "Default" badge (center)
  - Edit/Remove buttons (right)
- When Edit is clicked, show a model selector:
  - A searchable input (combobox pattern) that filters the OpenRouter models list
  - Show model name, context length, and pricing per 1M tokens
  - Save button to confirm selection
  - Cancel button to close
- When Remove is clicked, call deactivate mutation

Implementation details:
```tsx
import { useState } from 'react';
import { useModelConfigs, useUpsertModelConfig, useDeactivateModelConfig, KNOWN_AGENTS } from '../hooks/useModelConfig';
import { useOpenRouterModels, OpenRouterModel } from '../hooks/useOpenRouterModels';

export function ModelConfigPanel() {
  const { data: configs, isLoading } = useModelConfigs();
  const upsertMutation = useUpsertModelConfig();
  const deactivateMutation = useDeactivateModelConfig();
  const { data: models } = useOpenRouterModels();
  const [editingAgent, setEditingAgent] = useState<string | null>(null);
  const [searchQuery, setSearchQuery] = useState('');

  // Build lookup map: agent_name -> config
  const configMap = new Map(configs?.map(c => [c.agent_name, c]) ?? []);

  // Filter models by search query
  const filteredModels = models?.filter(m =>
    m.id.toLowerCase().includes(searchQuery.toLowerCase()) ||
    m.name.toLowerCase().includes(searchQuery.toLowerCase())
  ).slice(0, 50) ?? []; // Limit to 50 for performance

  const handleSelectModel = (agentName: string, model: OpenRouterModel) => {
    upsertMutation.mutate({ agentName, modelId: model.id });
    setEditingAgent(null);
    setSearchQuery('');
  };

  const handleRemove = (agentName: string) => {
    deactivateMutation.mutate(agentName);
  };

  // Format pricing for display
  const formatPrice = (priceStr: string) => {
    const price = parseFloat(priceStr) * 1_000_000;
    if (price < 0.01) return '<$0.01';
    return `$${price.toFixed(2)}`;
  };

  return (
    <div className="rounded-xl bg-card p-4">
      <h2 className="text-lg font-semibold text-text">Agent Model Configuration</h2>
      <p className="mt-1 text-sm text-hint">
        Override which model each agent uses. Changes take effect within 60 seconds.
      </p>

      {isLoading ? (
        <div className="mt-4 text-center text-hint">Loading...</div>
      ) : (
        <div className="mt-4 space-y-3">
          {KNOWN_AGENTS.map(agent => {
            const config = configMap.get(agent.name);
            const isEditing = editingAgent === agent.name;

            return (
              <div key={agent.name} className="rounded-lg bg-bg p-3">
                <div className="flex items-center justify-between">
                  <div>
                    <span className="font-medium text-text">{agent.label}</span>
                    <span className="ml-2 text-xs text-hint">{agent.description}</span>
                  </div>
                  <div className="flex items-center gap-2">
                    {config ? (
                      <>
                        <span className="rounded-full bg-accent/20 px-2 py-0.5 text-xs text-accent">
                          {config.model_id}
                        </span>
                        <button
                          onClick={() => { setEditingAgent(isEditing ? null : agent.name); setSearchQuery(''); }}
                          className="text-xs text-accent hover:underline"
                        >
                          {isEditing ? 'Cancel' : 'Change'}
                        </button>
                        <button
                          onClick={() => handleRemove(agent.name)}
                          className="text-xs text-red-400 hover:underline"
                          disabled={deactivateMutation.isPending}
                        >
                          Remove
                        </button>
                      </>
                    ) : (
                      <>
                        <span className="rounded-full bg-hint/20 px-2 py-0.5 text-xs text-hint">
                          Default
                        </span>
                        <button
                          onClick={() => { setEditingAgent(isEditing ? null : agent.name); setSearchQuery(''); }}
                          className="text-xs text-accent hover:underline"
                        >
                          {isEditing ? 'Cancel' : 'Set Override'}
                        </button>
                      </>
                    )}
                  </div>
                </div>

                {/* Model selector (expanded when editing) */}
                {isEditing && (
                  <div className="mt-3 border-t border-hint/20 pt-3">
                    <input
                      type="text"
                      placeholder="Search models (e.g., claude, gpt-4o, deepseek)..."
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                      className="w-full rounded-lg bg-card px-3 py-2 text-sm text-text placeholder-hint outline-none ring-1 ring-hint/30 focus:ring-accent"
                      autoFocus
                    />
                    {searchQuery.length >= 2 && (
                      <div className="mt-2 max-h-48 overflow-y-auto rounded-lg bg-card">
                        {filteredModels.length === 0 ? (
                          <div className="p-3 text-center text-sm text-hint">No models found</div>
                        ) : (
                          filteredModels.map(model => (
                            <button
                              key={model.id}
                              onClick={() => handleSelectModel(agent.name, model)}
                              className="flex w-full items-center justify-between px-3 py-2 text-left hover:bg-bg"
                              disabled={upsertMutation.isPending}
                            >
                              <div>
                                <div className="text-sm text-text">{model.name}</div>
                                <div className="text-xs text-hint">{model.id}</div>
                              </div>
                              <div className="text-right text-xs text-hint">
                                {model.context_length ? `${Math.round(model.context_length / 1000)}K ctx` : ''}
                                {model.pricing && (
                                  <div>{formatPrice(model.pricing.prompt)}/M in</div>
                                )}
                              </div>
                            </button>
                          ))
                        )}
                      </div>
                    )}
                  </div>
                )}
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}
```

IMPORTANT: Use the existing Tailwind color tokens from the project (text, hint, bg, card, accent -- these are the Telegram theme-aware tokens). Look at TeamOverview.tsx for examples of the exact class patterns used.

2. **Update packages/webapp/src/pages/Admin.tsx:**
   - Add import: `import { ModelConfigPanel } from '@/features/admin/components/ModelConfigPanel';`
   - Add `<ModelConfigPanel />` AFTER the existing `<ActivityFeed />` component (bottom of the admin page, since it's a configuration section, not analytics)

The Admin page will now show:
1. Team Overview (existing)
2. Performance Chart (existing)
3. Member Leaderboard (existing)
4. Weak Areas (existing)
5. Activity Feed (existing)
6. Agent Model Configuration (NEW)
  </action>
  <verify>
    - `grep "ModelConfigPanel" packages/webapp/src/pages/Admin.tsx` shows the import and usage
    - `grep "KNOWN_AGENTS" packages/webapp/src/features/admin/components/ModelConfigPanel.tsx` shows the agent list
    - `grep "useOpenRouterModels" packages/webapp/src/features/admin/components/ModelConfigPanel.tsx` shows model browser integration
    - Run `cd packages/webapp && npx tsc --noEmit 2>&1 | head -20` to check for TypeScript errors (should compile cleanly)
    - Run `cd packages/webapp && pnpm build 2>&1 | tail -5` to verify the build succeeds
  </verify>
  <done>ModelConfigPanel on Admin page shows all 5 agents, their current override or "Default" status, searchable OpenRouter model browser, and Save/Remove actions. Build succeeds.</done>
</task>

</tasks>

<verification>
- Admin page renders ModelConfigPanel section with all 5 agents
- TypeScript compiles without errors: `cd packages/webapp && npx tsc --noEmit`
- Build succeeds: `cd packages/webapp && pnpm build`
- Hooks use InsForge SDK for agent_model_config CRUD
- OpenRouter model browser fetches and displays models with search
</verification>

<success_criteria>
- Admin page shows "Agent Model Configuration" section below existing analytics
- Each of the 5 agents (strategist, extraction, trainer, memory, reanalysis) shown with current model or "Default"
- Admin can search OpenRouter models by name/id and select one for any agent
- Admin can remove an override to revert to default
- Changes persist to agent_model_config table via InsForge SDK
- TMA builds and compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/18-agent-observatory/18-04-SUMMARY.md`
</output>
