---
phase: 06-gamification-and-admin
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/webapp/src/features/admin/lib/adminAccess.ts
  - packages/webapp/src/features/admin/hooks/useTeamStats.ts
  - packages/webapp/src/features/admin/hooks/useTeamLeaderboard.ts
  - packages/webapp/src/features/admin/hooks/useWeakAreas.ts
  - packages/webapp/src/features/admin/hooks/useRecentActivity.ts
  - packages/webapp/src/features/admin/components/AdminGuard.tsx
  - packages/webapp/src/features/admin/components/TeamOverview.tsx
  - packages/webapp/src/features/admin/components/PerformanceChart.tsx
  - packages/webapp/src/features/admin/components/MemberLeaderboard.tsx
  - packages/webapp/src/features/admin/components/WeakAreas.tsx
  - packages/webapp/src/features/admin/components/ActivityFeed.tsx
  - packages/webapp/src/pages/Admin.tsx
  - packages/webapp/src/app/Router.tsx
  - packages/webapp/src/lib/queries.ts
autonomous: true

must_haves:
  truths:
    - "Admin users see a team dashboard with total users, total XP, and active user count"
    - "Admin dashboard shows weekly performance chart with score trends"
    - "Admin dashboard shows member leaderboard ranked by XP with average scores"
    - "Admin dashboard shows weak areas where team scores lowest"
    - "Admin dashboard shows recent activity feed with timestamps"
    - "Non-admin users are redirected away from admin pages"
  artifacts:
    - path: "packages/webapp/src/features/admin/lib/adminAccess.ts"
      provides: "VITE_ADMIN_USERNAMES env var parsing and isAdminUsername() check"
      exports: ["isAdminUsername", "ADMIN_USERNAMES"]
      min_lines: 10
    - path: "packages/webapp/src/features/admin/components/AdminGuard.tsx"
      provides: "Route guard that redirects non-admin users to /"
      min_lines: 20
    - path: "packages/webapp/src/features/admin/hooks/useTeamStats.ts"
      provides: "Aggregate team stats: total users, total XP, active users, recent attempts"
      min_lines: 30
    - path: "packages/webapp/src/features/admin/components/TeamOverview.tsx"
      provides: "Stats cards showing total users, total XP, active users"
      min_lines: 30
    - path: "packages/webapp/src/features/admin/components/PerformanceChart.tsx"
      provides: "SVG bar chart showing weekly score trends"
      min_lines: 40
    - path: "packages/webapp/src/features/admin/components/MemberLeaderboard.tsx"
      provides: "Full team ranking by XP with average scores"
      min_lines: 40
    - path: "packages/webapp/src/features/admin/components/WeakAreas.tsx"
      provides: "Categories/scenarios where team scores lowest"
      min_lines: 30
    - path: "packages/webapp/src/features/admin/components/ActivityFeed.tsx"
      provides: "Recent team interactions with timestamps"
      min_lines: 30
    - path: "packages/webapp/src/pages/Admin.tsx"
      provides: "Admin page composing all dashboard sections"
      min_lines: 25
  key_links:
    - from: "packages/webapp/src/features/admin/components/AdminGuard.tsx"
      to: "packages/webapp/src/features/admin/lib/adminAccess.ts"
      via: "isAdminUsername() check against current user's username"
      pattern: "isAdminUsername"
    - from: "packages/webapp/src/app/Router.tsx"
      to: "packages/webapp/src/features/admin/components/AdminGuard.tsx"
      via: "AdminGuard wrapping Admin route element"
      pattern: "AdminGuard"
    - from: "packages/webapp/src/features/admin/hooks/useTeamStats.ts"
      to: "packages/webapp/src/lib/insforge.ts"
      via: "getInsforge().database queries for all users and attempts"
      pattern: "getInsforge.*database.*from"
---

<objective>
Build a complete admin dashboard with team analytics (overview stats, performance charts, member leaderboard, weak areas, activity feed) and access control that restricts the admin page to authorized usernames only.

Purpose: ADMIN-01 through ADMIN-06 -- gives team leads visibility into team performance and training engagement.

Output: Full admin feature module (lib, hooks, components), updated Admin page, AdminGuard route protection, and admin query keys.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Existing infrastructure:
@packages/webapp/src/pages/Admin.tsx — Current placeholder page (will be replaced)
@packages/webapp/src/app/Router.tsx — Current routing (Admin route at /admin/*)
@packages/webapp/src/lib/insforge.ts — getInsforge() client for PostgREST queries
@packages/webapp/src/lib/queries.ts — queryKeys factory (needs admin keys added)
@packages/webapp/src/features/auth/store.ts — useAuthStore with telegramId, photoUrl
@packages/webapp/src/features/dashboard/hooks/useUserProgress.ts — Pattern for user data fetching
@packages/webapp/src/features/dashboard/hooks/useLeaderboard.ts — Pattern for leaderboard queries
@packages/webapp/src/shared/ui/index.ts — Card, Skeleton, Badge, ProgressBar, Avatar, Button

Research decisions:
- VITE_ADMIN_USERNAMES env var for access control (matches bot pattern)
- SVG micro-charts for performance visualization (no charting library)
- 5-minute staleTime for admin data caching
- .limit() on all admin queries (50 users max, 500 attempts max, 20 activity items)
- Client-side access control only for v1 (documented security limitation)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin access control and data hooks</name>
  <files>
    packages/webapp/src/features/admin/lib/adminAccess.ts
    packages/webapp/src/features/admin/hooks/useTeamStats.ts
    packages/webapp/src/features/admin/hooks/useTeamLeaderboard.ts
    packages/webapp/src/features/admin/hooks/useWeakAreas.ts
    packages/webapp/src/features/admin/hooks/useRecentActivity.ts
    packages/webapp/src/features/admin/components/AdminGuard.tsx
    packages/webapp/src/lib/queries.ts
  </files>
  <action>
Create `src/features/admin/` directory structure with `lib/`, `hooks/`, `components/` subdirectories.

**Step 1: adminAccess.ts** — Admin username check:
```typescript
const ADMIN_USERNAMES: string[] = (import.meta.env.VITE_ADMIN_USERNAMES ?? '')
  .split(',')
  .map((u: string) => u.trim().toLowerCase().replace(/^@/, ''))
  .filter(Boolean);

export function isAdminUsername(username: string | null | undefined): boolean {
  if (!username) return false;
  return ADMIN_USERNAMES.includes(username.toLowerCase());
}
```

**Step 2: Add admin query keys to queries.ts** — Append to the existing queryKeys object:
```typescript
admin: {
  all: ['admin'] as const,
  teamStats: ['admin', 'teamStats'] as const,
  leaderboard: ['admin', 'leaderboard'] as const,
  weakAreas: ['admin', 'weakAreas'] as const,
  recentActivity: ['admin', 'recentActivity'] as const,
},
```

**Step 3: AdminGuard.tsx** — Route guard component:
- Import `useQuery` from @tanstack/react-query, `Navigate` from react-router, `useAuthStore`, `getInsforge`, `queryKeys`, `isAdminUsername`, Skeleton.
- Fetch the current user's data using `useQuery` with `queryKeys.users.detail(telegramId!)` (reuses existing user query -- TanStack Query deduplicates). Select `username` field.
- If loading: render `PageSkeleton` (import the Skeleton-based loading pattern from existing pages).
- If `!isAdminUsername(user?.username)`: render `<Navigate to="/" replace />`.
- If admin: render `{children}`.
- Props: `{ children: React.ReactNode }`.

**Step 4: useTeamStats.ts** — Aggregate team data hook:
- Query key: `queryKeys.admin.teamStats`.
- Fetch ALL users (`.from('users').select('id, telegram_id, username, first_name, total_xp, current_level, streak_days, last_active_at').limit(50)`) and recent attempts (`.from('attempts').select('id, telegram_id, score, mode, scenario_id, xp_earned, created_at').order('created_at', { ascending: false }).limit(500)`) in parallel via `Promise.all`.
- Compute: `totalUsers`, `totalXP` (sum of user.total_xp), `activeUsers` (users with `last_active_at` within last 7 days), `recentAttempts` (the raw attempts array for downstream use).
- Return the computed object.
- `staleTime: 5 * 60_000` (5 minutes).

**Step 5: useTeamLeaderboard.ts** — All team members ranked by XP:
- Query key: `queryKeys.admin.leaderboard`.
- Fetch users: `.from('users').select('id, telegram_id, username, first_name, total_xp, current_level').order('total_xp', { ascending: false }).limit(50)`.
- Also fetch attempts: `.from('attempts').select('telegram_id, score').limit(1000)`.
- For each user, compute average score from their attempts.
- Return array of `{ user, avgScore }` objects already sorted by XP.
- `staleTime: 5 * 60_000`.

**Step 6: useWeakAreas.ts** — Categories where team scores lowest:
- Query key: `queryKeys.admin.weakAreas`.
- Fetch recent attempts: `.from('attempts').select('scenario_id, score, mode').order('created_at', { ascending: false }).limit(200)`.
- Group by `scenario_id`, compute average score per scenario.
- Sort ascending by average score (worst first).
- Return top 5 weakest scenarios with `{ scenarioId, avgScore, attemptCount }`.
- `staleTime: 5 * 60_000`.

**Step 7: useRecentActivity.ts** — Recent team interactions:
- Query key: `queryKeys.admin.recentActivity`.
- Fetch last 20 attempts: `.from('attempts').select('id, telegram_id, scenario_id, score, mode, xp_earned, created_at').order('created_at', { ascending: false }).limit(20)`.
- Also fetch users in parallel to map telegram_id to username/first_name: `.from('users').select('telegram_id, username, first_name').limit(50)`.
- Join: for each attempt, attach the user's display name.
- Return array of activity items with `{ id, userName, scenarioId, score, mode, xpEarned, createdAt }`.
- `staleTime: 5 * 60_000`.
  </action>
  <verify>
    TypeScript compiles: `cd packages/webapp && npx tsc --noEmit`
    Admin query keys exist: grep for "admin:" in queries.ts
    AdminGuard uses isAdminUsername: grep for "isAdminUsername" in AdminGuard.tsx
    All hooks use staleTime: grep for "staleTime" in all admin hook files
    All hooks use .limit(): grep for "limit" in all admin hook files
  </verify>
  <done>Admin access control via VITE_ADMIN_USERNAMES env var. AdminGuard redirects non-admins. Four data hooks fetch team stats, leaderboard, weak areas, and recent activity with 5-min cache and query limits.</done>
</task>

<task type="auto">
  <name>Task 2: Admin dashboard components and page integration</name>
  <files>
    packages/webapp/src/features/admin/components/TeamOverview.tsx
    packages/webapp/src/features/admin/components/PerformanceChart.tsx
    packages/webapp/src/features/admin/components/MemberLeaderboard.tsx
    packages/webapp/src/features/admin/components/WeakAreas.tsx
    packages/webapp/src/features/admin/components/ActivityFeed.tsx
    packages/webapp/src/pages/Admin.tsx
    packages/webapp/src/app/Router.tsx
  </files>
  <action>
**Step 1: TeamOverview.tsx** — Stats cards (ADMIN-01):
- Import `useTeamStats` hook, `Card`, `Skeleton` from shared/ui.
- Import `Users`, `Zap`, `Activity` from lucide-react.
- Render 3 stat cards in a `grid grid-cols-3 gap-3` layout:
  - Total Users: Users icon + count
  - Total XP: Zap icon + formatted number (use toLocaleString())
  - Active (7d): Activity icon + count
- Loading: 3 skeleton cards. Error: "Unable to load team stats" text.

**Step 2: PerformanceChart.tsx** — SVG bar chart (ADMIN-02):
- Import `useTeamStats` hook (it already fetches recentAttempts).
- Group attempts by week (use the `created_at` field, bucket into last 4-6 weeks).
- For each week, compute average score.
- Render an SVG bar chart using hand-coded SVG (NO charting library):
  - `<svg viewBox="0 0 100 60" className="w-full h-32">`
  - Bars: `<rect>` elements with height proportional to avg score, `rx={2}` for rounded corners, `fill` using `var(--color-accent)`.
  - Week labels: `<text>` elements below bars showing short date labels (e.g., "Jan 27", "Feb 3").
  - If no data: show "No performance data yet" message.
- Wrap in Card with "Weekly Performance" heading.
- Loading: Skeleton rectangle matching chart height.

**Step 3: MemberLeaderboard.tsx** — Full team ranking (ADMIN-03):
- Import `useTeamLeaderboard` hook.
- Render a list inside a Card with "Team Leaderboard" heading.
- Each member row: rank number (#1, #2...), user display name (first_name or username), total XP (formatted), average score (formatted to 0 decimal).
- Top 3 get accent-colored rank numbers. Rest are text-hint.
- Loading: 5 skeleton rows. Empty: "No team members" text.

**Step 4: WeakAreas.tsx** — Lowest-scoring categories (ADMIN-04):
- Import `useWeakAreas` hook.
- Render a list inside a Card with "Areas to Improve" heading.
- Each weak area row: scenario ID (formatted -- replace underscores with spaces, capitalize first letter), average score (with color: red if < 40, warning if < 60, success if >= 60), attempt count.
- Loading: 3 skeleton rows. Empty: "No weak areas identified" text.

**Step 5: ActivityFeed.tsx** — Recent interactions (ADMIN-05):
- Import `useRecentActivity` hook.
- Render a list inside a Card with "Recent Activity" heading.
- Each activity item: user name, mode badge (learn/train/support), score, relative time (e.g., "2h ago", "1d ago" -- write a simple `timeAgo(dateString)` helper inline or in the component file).
- Use the design system Badge component for mode labels.
- Loading: 4 skeleton rows. Empty: "No recent activity" text.

**Step 6: Replace Admin.tsx** — Full admin page:
- Remove the existing placeholder content entirely.
- Import all 5 admin components: TeamOverview, PerformanceChart, MemberLeaderboard, WeakAreas, ActivityFeed.
- Compose in a `space-y-4 px-4 pt-4` container:
  1. "Team Dashboard" heading (`text-xl font-bold text-text`)
  2. TeamOverview
  3. PerformanceChart
  4. MemberLeaderboard
  5. WeakAreas
  6. ActivityFeed

**Step 7: Wrap Admin route with AdminGuard in Router.tsx:**
- Import `AdminGuard` from `@/features/admin/components/AdminGuard`.
- Change the Admin route from `<Route path="/admin/*" element={<Admin />} />` to:
  ```tsx
  <Route path="/admin/*" element={
    <AdminGuard>
      <Admin />
    </AdminGuard>
  } />
  ```
- The AdminGuard is rendered inside the Suspense boundary, so its loading state works correctly with the lazy-loaded Admin page.
  </action>
  <verify>
    TypeScript compiles: `cd packages/webapp && npx tsc --noEmit`
    Build succeeds: `cd packages/webapp && npx vite build`
    AdminGuard wraps Admin route: grep for "AdminGuard" in Router.tsx
    Admin.tsx imports all 5 components: grep for "TeamOverview\|PerformanceChart\|MemberLeaderboard\|WeakAreas\|ActivityFeed" in Admin.tsx
    SVG chart has no library dependency: grep for "viewBox" in PerformanceChart.tsx
    No charting library imported: ensure no import of recharts, chart.js, or d3 in any admin file
  </verify>
  <done>Admin dashboard displays 5 sections (overview, performance chart, leaderboard, weak areas, activity feed). AdminGuard wraps the route and redirects non-admins. SVG micro-chart uses no external charting library. All compile and build.</done>
</task>

</tasks>

<verification>
- `cd packages/webapp && npx tsc --noEmit` passes
- `cd packages/webapp && npx vite build` succeeds
- AdminGuard redirects non-admin users to /
- Admin page renders TeamOverview, PerformanceChart, MemberLeaderboard, WeakAreas, ActivityFeed
- All admin hooks use staleTime: 5 * 60_000 and .limit() on queries
- PerformanceChart uses hand-coded SVG (no charting library)
- queryKeys.admin namespace exists in queries.ts
- isAdminUsername parses VITE_ADMIN_USERNAMES env var correctly
</verification>

<success_criteria>
- ADMIN-01: Team overview shows total users, total XP, active user count
- ADMIN-02: Performance chart shows weekly score trends via SVG bar chart
- ADMIN-03: Member leaderboard shows all members ranked by XP with average scores
- ADMIN-04: Weak areas shows categories/scenarios with lowest team scores
- ADMIN-05: Recent activity feed shows last 20 team interactions with timestamps
- ADMIN-06: AdminGuard enforces access control -- non-admin users redirected to /
- No heavy charting library (D3, Chart.js, Recharts) imported
- All queries have .limit() and 5-min staleTime
</success_criteria>

<output>
After completion, create `.planning/phases/06-gamification-and-admin/06-03-SUMMARY.md`
</output>
