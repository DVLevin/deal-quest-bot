---
phase: 06-gamification-and-admin
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/webapp/package.json
  - packages/webapp/src/app/globals.css
  - packages/webapp/src/features/gamification/lib/confetti.ts
  - packages/webapp/src/features/gamification/hooks/useLevelUpDetection.ts
  - packages/webapp/src/features/gamification/components/LevelUpOverlay.tsx
  - packages/webapp/src/features/gamification/components/XPGainAnimation.tsx
  - packages/webapp/src/features/gamification/components/StreakIndicator.tsx
  - packages/webapp/src/features/scoring/components/ScoreDisplay.tsx
  - packages/webapp/src/features/dashboard/components/ProgressCard.tsx
  - packages/webapp/src/pages/Dashboard.tsx
autonomous: true

must_haves:
  truths:
    - "Leveling up triggers a confetti celebration animation with new rank title displayed"
    - "Completing a scenario shows an animated XP counter"
    - "Streak tracker displays flame icon with current streak days and bonus XP indicator"
    - "Confetti respects prefers-reduced-motion accessibility setting"
  artifacts:
    - path: "packages/webapp/src/features/gamification/lib/confetti.ts"
      provides: "canvas-confetti configuration presets for level-up celebration"
      min_lines: 15
    - path: "packages/webapp/src/features/gamification/hooks/useLevelUpDetection.ts"
      provides: "Hook that detects level changes by comparing cached vs fresh user data"
      min_lines: 25
    - path: "packages/webapp/src/features/gamification/components/LevelUpOverlay.tsx"
      provides: "Full-screen overlay showing confetti + new rank title on level-up"
      min_lines: 30
    - path: "packages/webapp/src/features/gamification/components/XPGainAnimation.tsx"
      provides: "Animated XP counter using CSS @property integer interpolation"
      min_lines: 10
    - path: "packages/webapp/src/features/gamification/components/StreakIndicator.tsx"
      provides: "Flame icon + streak days + bonus XP display"
      min_lines: 20
  key_links:
    - from: "packages/webapp/src/features/gamification/hooks/useLevelUpDetection.ts"
      to: "packages/webapp/src/lib/queries.ts"
      via: "queryKeys.users.detail for cache comparison"
      pattern: "queryKeys\\.users\\.detail"
    - from: "packages/webapp/src/features/gamification/components/LevelUpOverlay.tsx"
      to: "packages/webapp/src/features/gamification/lib/confetti.ts"
      via: "fireLevelUpConfetti() call on level-up"
      pattern: "fireLevelUpConfetti"
    - from: "packages/webapp/src/features/gamification/components/XPGainAnimation.tsx"
      to: "packages/webapp/src/app/globals.css"
      via: "CSS @property --xp-value and xpCountUp animation"
      pattern: "xp-counter"
---

<objective>
Add celebration animations and engagement visuals: canvas-confetti for level-up events, animated XP counter for scenario completion, and an enhanced streak indicator with flame icon and bonus XP display.

Purpose: GAME-03 (level-up celebration), GAME-04 (XP gain animation), GAME-05 (streak tracking visuals) -- these micro-celebrations reinforce the training habit loop.

Output: Confetti library, level-up detection hook, LevelUpOverlay, XPGainAnimation, and StreakIndicator components integrated into Dashboard and ScoreDisplay.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Existing infrastructure:
@packages/webapp/src/app/globals.css — CSS @property --score-value pattern, rarity colors
@packages/webapp/src/features/scoring/components/ScoreDisplay.tsx — Current score display with SVG arc + CSS counter animation
@packages/webapp/src/features/dashboard/components/ProgressCard.tsx — Dashboard progress card with streak display (basic "X day streak" text)
@packages/webapp/src/features/dashboard/hooks/useUserProgress.ts — Fetches user data (total_xp, current_level, streak_days)
@packages/webapp/src/types/constants.ts — RANK_TITLES, getRankTitle(), MAX_STREAK_BONUS_XP (50), XP_PER_LEVEL
@packages/webapp/src/lib/queries.ts — queryKeys factory
@packages/webapp/src/pages/Dashboard.tsx — Dashboard page composition
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install canvas-confetti and create animation primitives</name>
  <files>
    packages/webapp/package.json
    packages/webapp/src/app/globals.css
    packages/webapp/src/features/gamification/lib/confetti.ts
    packages/webapp/src/features/gamification/components/XPGainAnimation.tsx
    packages/webapp/src/features/gamification/components/StreakIndicator.tsx
  </files>
  <action>
**Step 1: Install canvas-confetti**
Run: `cd packages/webapp && pnpm add canvas-confetti && pnpm add -D @types/canvas-confetti`

**Step 2: Create confetti.ts** — Canvas-confetti configuration presets.
```typescript
import confetti from 'canvas-confetti';

export function fireLevelUpConfetti() {
  const defaults = {
    spread: 60,
    ticks: 100,
    gravity: 1.2,
    decay: 0.94,
    startVelocity: 30,
    particleCount: 40,
    scalar: 1.2,
    disableForReducedMotion: true,
  };
  // Left cannon
  confetti({ ...defaults, angle: 60, origin: { x: 0, y: 0.7 } });
  // Right cannon
  confetti({ ...defaults, angle: 120, origin: { x: 1, y: 0.7 } });
}
```

**Step 3: Add XP counter CSS to globals.css** — Append AFTER the existing score-counter block:
```css
/* XP gain counter animation (reuses @property integer interpolation pattern) */
@property --xp-value {
  syntax: '<integer>';
  initial-value: 0;
  inherits: false;
}

@keyframes xpCountUp {
  from {
    --xp-value: 0;
  }
}

.xp-counter {
  animation: xpCountUp 1s ease-out forwards;
  counter-set: xp var(--xp-value);
  font-variant-numeric: tabular-nums;
}

.xp-counter::after {
  content: "+" counter(xp) " XP";
}
```

**Step 4: Create XPGainAnimation.tsx** — Minimal component using the CSS counter:
```typescript
function XPGainAnimation({ xpEarned }: { xpEarned: number }) {
  return (
    <span
      className="xp-counter text-lg font-bold text-success"
      style={{ ['--xp-value' as string]: xpEarned }}
    />
  );
}
```
Export as named export.

**Step 5: Create StreakIndicator.tsx** — Enhanced streak display with flame icon and bonus XP:
- Import `Flame` and `Zap` from lucide-react.
- Import `MAX_STREAK_BONUS_XP` from `@/types/constants` (or from `@deal-quest/shared`; check which import path is used in existing code).
- Props: `{ streakDays: number }`.
- Calculate `bonusXP = Math.min(streakDays * 10, MAX_STREAK_BONUS_XP)`.
- Render: flame icon (orange when active, gray when 0), streak day count with "day/days" pluralization, and when `streakDays > 0 && bonusXP > 0`, show a `Zap` icon with "+{bonusXP} XP bonus" in success color.
- Use `cn()` for conditional styling based on `isActive = streakDays > 0`.
  </action>
  <verify>
    TypeScript compiles: `cd packages/webapp && npx tsc --noEmit`
    canvas-confetti installed: `ls packages/webapp/node_modules/canvas-confetti`
    CSS properties defined: grep for "@property --xp-value" in globals.css
  </verify>
  <done>canvas-confetti installed. XP counter CSS animation extends existing @property pattern. XPGainAnimation and StreakIndicator components compile. confetti.ts exports fireLevelUpConfetti().</done>
</task>

<task type="auto">
  <name>Task 2: Create level-up detection and overlay, integrate all into pages</name>
  <files>
    packages/webapp/src/features/gamification/hooks/useLevelUpDetection.ts
    packages/webapp/src/features/gamification/components/LevelUpOverlay.tsx
    packages/webapp/src/features/scoring/components/ScoreDisplay.tsx
    packages/webapp/src/features/dashboard/components/ProgressCard.tsx
    packages/webapp/src/pages/Dashboard.tsx
  </files>
  <action>
**Step 1: Create useLevelUpDetection.ts** — Hook that detects level-up events:
- Import `useRef`, `useState`, `useEffect` from React.
- Import `useUserProgress` from `@/features/dashboard/hooks/useUserProgress`.
- Use a `useRef<number>(0)` to track `previousLevel`.
- On user data change: if `previousLevel.current > 0` (we had real prior data) AND `user.current_level > previousLevel.current`, set state `levelUp = { oldLevel: previousLevel, newLevel: user.current_level }`. Also check sessionStorage key `dq_last_celebrated_level` -- only trigger if `user.current_level > parseInt(sessionStorage value)` (prevents re-triggers on page reload).
- Always update `previousLevel.current = user.current_level` after check.
- When celebrating, store `sessionStorage.setItem('dq_last_celebrated_level', String(user.current_level))`.
- Return `{ levelUp, dismiss: () => setLevelUp(null) }` where `levelUp` is `{ oldLevel: number; newLevel: number } | null`.
- Add `refetchOnWindowFocus: true` is already set on useUserProgress -- verify this. If not, the hook should be aware that data refreshes on focus return from bot.

**Step 2: Create LevelUpOverlay.tsx** — Celebration overlay component:
- Props: `{ oldLevel: number; newLevel: number; onDismiss: () => void }`.
- On mount, call `fireLevelUpConfetti()` from `../lib/confetti`.
- Render a centered overlay (`fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm`).
- Content card: "Level Up!" heading in large text, new rank title from `getRankTitle(newLevel)` in accent color, "Level {oldLevel} -> Level {newLevel}" subtitle.
- A "Continue" button that calls `onDismiss`.
- Auto-dismiss after 5 seconds via `setTimeout` in a useEffect (clear on unmount).

**Step 3: Enhance ScoreDisplay.tsx** — Add XP animation below the existing XP badge:
- Import `XPGainAnimation` from `@/features/gamification/components/XPGainAnimation`.
- Replace the static `+{xpEarned} XP` Badge with the XPGainAnimation component when `animate` is true. When `animate` is false, keep the static Badge.
- The XPGainAnimation renders the "+X XP" text with the count-up animation from CSS. Keep the existing Badge component but use it for the non-animated fallback.

**Step 4: Enhance ProgressCard.tsx** — Replace basic streak text with StreakIndicator:
- Import `StreakIndicator` from `@/features/gamification/components/StreakIndicator`.
- Replace the existing streak display block (the `<div className="mt-3 flex items-center gap-1.5">` with Flame icon and streak text) with `<StreakIndicator streakDays={user.streak_days} />` wrapped in the same `mt-3` container.

**Step 5: Add LevelUpOverlay to Dashboard.tsx:**
- Import `useLevelUpDetection` from `@/features/gamification/hooks/useLevelUpDetection`.
- Import `LevelUpOverlay` from `@/features/gamification/components/LevelUpOverlay`.
- In Dashboard component, call `const { levelUp, dismiss } = useLevelUpDetection()`.
- Render `{levelUp && <LevelUpOverlay oldLevel={levelUp.oldLevel} newLevel={levelUp.newLevel} onDismiss={dismiss} />}` at the top of the JSX (before the main div).
  </action>
  <verify>
    TypeScript compiles: `cd packages/webapp && npx tsc --noEmit`
    Build succeeds: `cd packages/webapp && npx vite build`
    Level-up detection has sessionStorage guard: grep for "dq_last_celebrated_level" in useLevelUpDetection.ts
    LevelUpOverlay calls confetti: grep for "fireLevelUpConfetti" in LevelUpOverlay.tsx
    ScoreDisplay uses XPGainAnimation: grep for "XPGainAnimation" in ScoreDisplay.tsx
    ProgressCard uses StreakIndicator: grep for "StreakIndicator" in ProgressCard.tsx
    Dashboard renders LevelUpOverlay: grep for "LevelUpOverlay" in Dashboard.tsx
  </verify>
  <done>Level-up detection fires confetti with rank title overlay on Dashboard. ScoreDisplay animates XP earned with CSS counter. ProgressCard shows enhanced streak with flame icon and bonus XP. All compile and build successfully.</done>
</task>

</tasks>

<verification>
- `cd packages/webapp && npx tsc --noEmit` passes
- `cd packages/webapp && npx vite build` succeeds
- canvas-confetti is in package.json dependencies
- globals.css has @property --xp-value and .xp-counter classes
- useLevelUpDetection uses sessionStorage to prevent re-triggers
- LevelUpOverlay calls fireLevelUpConfetti() and shows rank title
- ScoreDisplay shows animated XP counter (GAME-04)
- ProgressCard shows StreakIndicator with flame + bonus XP (GAME-05)
- Dashboard renders LevelUpOverlay on level-up events (GAME-03)
- confetti.ts uses disableForReducedMotion: true for accessibility
</verification>

<success_criteria>
- GAME-03: Level-up celebration fires confetti with new rank title overlay
- GAME-04: XP gain animation uses CSS @property counter (zero-JS integer interpolation)
- GAME-05: Streak indicator shows flame icon, streak days, and bonus XP
- canvas-confetti uses disableForReducedMotion for accessibility
- Level-up detection uses sessionStorage to prevent false triggers on page reload
- All existing functionality preserved (ScoreDisplay still works, ProgressCard still works)
</success_criteria>

<output>
After completion, create `.planning/phases/06-gamification-and-admin/06-02-SUMMARY.md`
</output>
