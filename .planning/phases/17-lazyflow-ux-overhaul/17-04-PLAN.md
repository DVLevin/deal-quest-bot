---
phase: 17-lazyflow-ux-overhaul
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - bot/handlers/support.py
autonomous: true

must_haves:
  truths:
    - "Forwarded messages in /support mode auto-extract sender name as prospect info"
    - "Forward metadata (sender name) is prepended to pipeline input for richer analysis"
    - "Regular (non-forwarded) text messages in /support still work identically"
    - "Photo lead creation response uses 'Looks Good' framing instead of 'Done'"
  artifacts:
    - path: "bot/handlers/support.py"
      provides: "Forward message handler and updated action keyboard"
      contains: "on_support_forward"
  key_links:
    - from: "bot/handlers/support.py on_support_forward"
      to: "_run_support_pipeline"
      via: "enriched user_input with forward metadata"
      pattern: "Forwarded from"
    - from: "bot/handlers/support.py _support_actions_keyboard"
      to: "support:done callback"
      via: "button text change"
      pattern: "Looks Good"
---

<objective>
Add forwarded message auto-detection in /support mode and reframe the photo lead creation response with "Looks Good" confirmation.

Purpose: Success Criteria 2 and 3 -- "pre-populates prospect info from forwarded messages" and "lead creation from screenshot requires exactly 1 user action". Forwarded messages carry sender metadata that should auto-populate prospect names. Photo leads should feel like a confirmation flow, not a manual process.

Output: New forward handler in support.py, updated action keyboard button labels.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@bot/handlers/support.py
@bot/handlers/context_input.py
@bot/states.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add forwarded message handler to /support flow</name>
  <files>
    bot/handlers/support.py
  </files>
  <action>
    Add a new handler for forwarded messages in support mode. This MUST be registered BEFORE the generic text handler (`on_support_input`) to prevent aiogram from matching forwarded messages as plain text.

    1. **Add forward handler** -- Insert this handler ABOVE `on_support_input` (the `@router.message(SupportState.waiting_input)` handler at the bottom of the file, around line 803). The order matters because aiogram checks handlers in registration order:

       ```python
       @router.message(SupportState.waiting_input, F.forward_date)
       async def on_support_forward(
           message: Message,
           state: FSMContext,
           user_repo: UserRepo,
           memory_repo: UserMemoryRepo,
           session_repo: SupportSessionRepo,
           lead_repo: LeadRegistryRepo,
           crypto: CryptoService,
           knowledge: KnowledgeService,
           casebook_service: CasebookService,
           agent_registry: AgentRegistry,
           engagement_service: EngagementService | None = None,
           shared_openrouter_key: str = "",
           reminder_repo: ScheduledReminderRepo | None = None,
       ) -> None:
           """Handle forwarded messages -- auto-extract sender as prospect info."""
           tg_id = message.from_user.id  # type: ignore[union-attr]
           forward_text = message.text or message.caption or ""

           # Extract forward sender metadata
           forward_from = None
           if message.forward_from:
               fn = message.forward_from.first_name or ""
               ln = message.forward_from.last_name or ""
               forward_from = f"{fn} {ln}".strip() or (
                   message.forward_from.username or None
               )
           elif message.forward_sender_name:
               forward_from = message.forward_sender_name

           # Enrich input with forward metadata for better prospect extraction
           if forward_from:
               user_input = (
                   f"Prospect name: {forward_from}\n\n"
                   f"Their message:\n{forward_text}"
               )
           else:
               user_input = forward_text

           if not user_input.strip():
               await message.answer(
                   "The forwarded message appears empty. "
                   "Please forward a text message or paste the content."
               )
               return

           status_msg = await message.answer(
               f"Analyzing forwarded message"
               f"{f' from {forward_from}' if forward_from else ''}..."
           )

           await _run_support_pipeline(
               user_input=user_input,
               tg_id=tg_id,
               user_repo=user_repo,
               memory_repo=memory_repo,
               session_repo=session_repo,
               lead_repo=lead_repo,
               crypto=crypto,
               knowledge=knowledge,
               casebook_service=casebook_service,
               agent_registry=agent_registry,
               status_msg=status_msg,
               state=state,
               engagement_service=engagement_service,
               shared_openrouter_key=shared_openrouter_key,
               reminder_repo=reminder_repo,
           )
       ```

    2. **CRITICAL: Handler registration order.**
       The handler order in the file determines aiogram's matching order for the SAME router. The forward handler (`SupportState.waiting_input, F.forward_date`) MUST appear BEFORE the generic text handler (`SupportState.waiting_input` with no filter). Currently the handlers are ordered:
       - `on_support_photo` (line ~656, F.photo filter)
       - `on_support_voice` (line ~738, F.voice filter)
       - `on_support_input` (line ~803, no extra filter -- catches all remaining)

       Insert `on_support_forward` between `on_support_voice` and `on_support_input`. This ensures aiogram matches `F.forward_date` before the generic text catch-all.

    3. **DI parameters:** Use the SAME DI parameter pattern as `on_support_input`. The forward handler needs the same services passed via `dp.workflow_data`. Do NOT import from `bot.config`. Follow the existing DI pattern exactly.

    4. **No new imports needed.** All required types (Message, FSMContext, F, Router, etc.) and services are already imported at the top of support.py.

    PITFALL: Do NOT add `~F.forward_date` filter to `on_support_input`. The handler ordering approach is simpler and already proven (aiogram picks the first matching handler). Adding negative filters would change the behavior of the existing handler.
  </action>
  <verify>
    Run `cd /Users/dmytrolevin/Downloads/GD_playground && python3 -c "from bot.handlers.support import router; print('OK')"` -- imports without error.
    Grep for `on_support_forward` in support.py confirms handler exists.
    Verify handler order: `grep -n "SupportState.waiting_input" bot/handlers/support.py` -- forward_date handler appears before generic handler.
  </verify>
  <done>
    Forwarded messages in /support mode extract sender name and prepend it to pipeline input. Non-forwarded messages handled identically to before. Handler registration order ensures no double-processing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update action keyboard with "Looks Good" framing</name>
  <files>
    bot/handlers/support.py
  </files>
  <action>
    Update the `_support_actions_keyboard` function to use "Looks Good" instead of "Done" for a LazyFlow confirmation feel:

    1. In `_support_actions_keyboard` (around line 78), change the "Done" button text:
       ```python
       InlineKeyboardButton(text="Looks Good", callback_data="support:done"),
       ```
       Keep the callback_data as "support:done" -- only the display text changes.

    2. Update the response text in `_run_support_pipeline` for new leads (around line 423-429). Change the message that appears after a new lead is created from photo analysis:
       - Current: `"Saved to your leads. Web research & engagement plan are generating in the background -- tap \"View Lead & Plan\" in ~30s to see them."`
       - Updated: `"Lead created! Web research & engagement plan generating in the background.\n\nTap \"View Lead & Plan\" in ~30s, or hit \"Looks Good\" to dismiss."`
       This reframes the flow: user sent a photo -> got analysis -> sees "Looks Good" as the natural completion action.

    3. The `on_support_action` handler for `action == "done"` (around line 887) already handles the callback correctly -- no changes needed there. The callback_data is still "support:done".

    IMPORTANT: This is a text-only change to button labels and response messages. No logic changes.
  </action>
  <verify>
    Run `cd /Users/dmytrolevin/Downloads/GD_playground && python3 -c "from bot.handlers.support import router; print('OK')"` -- imports without error.
    Grep for "Looks Good" in support.py confirms button text updated.
  </verify>
  <done>
    Action keyboard shows "Looks Good" instead of "Done". Photo lead creation response reframed as confirmation flow. Callback logic unchanged.
  </done>
</task>

</tasks>

<verification>
1. `python3 -c "from bot.handlers.support import router; print('OK')"` succeeds.
2. Grep confirms `on_support_forward` handler exists in support.py.
3. Grep confirms handler order: `F.forward_date` handler line number < generic `on_support_input` line number.
4. Grep confirms "Looks Good" appears in `_support_actions_keyboard`.
5. No other handlers in support.py were modified (photo, voice, callback handlers unchanged).
</verification>

<success_criteria>
- Forwarded messages in /support extract sender name into prospect info
- Forward handler registered before generic text handler (no double-processing)
- Non-forwarded text/photo/voice inputs work identically to before
- "Looks Good" button replaces "Done" on action keyboard
- Photo lead creation response reframed as confirmation
- Bot module imports without errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-lazyflow-ux-overhaul/17-04-SUMMARY.md`
</output>
