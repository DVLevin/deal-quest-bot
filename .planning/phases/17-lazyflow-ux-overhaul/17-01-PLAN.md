---
phase: 17-lazyflow-ux-overhaul
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/webapp/src/features/dashboard/hooks/useSmartLanding.ts
  - packages/webapp/src/pages/Dashboard.tsx
  - packages/webapp/src/features/dashboard/components/TodayActionsCard.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard shows contextual header reflecting urgency (overdue actions count or streak)"
    - "TodayActionsCard is promoted to first position when overdue actions exist"
    - "Dashboard shows skeleton state until smart landing data resolves (no layout shift)"
    - "Tapping a Today's Actions item loads lead detail instantly from prefetch cache"
  artifacts:
    - path: "packages/webapp/src/features/dashboard/hooks/useSmartLanding.ts"
      provides: "Smart landing hook that determines dashboard focus mode"
      exports: ["useSmartLanding", "LandingFocus"]
    - path: "packages/webapp/src/pages/Dashboard.tsx"
      provides: "Dashboard with conditional card ordering and contextual header"
      contains: "useSmartLanding"
    - path: "packages/webapp/src/features/dashboard/components/TodayActionsCard.tsx"
      provides: "Today's actions card with lead detail prefetching"
      contains: "prefetchQuery"
  key_links:
    - from: "packages/webapp/src/features/dashboard/hooks/useSmartLanding.ts"
      to: "useTodayActions"
      via: "hook composition"
      pattern: "useTodayActions"
    - from: "packages/webapp/src/pages/Dashboard.tsx"
      to: "useSmartLanding"
      via: "conditional rendering"
      pattern: "focus.*actions"
    - from: "packages/webapp/src/features/dashboard/components/TodayActionsCard.tsx"
      to: "queryClient.prefetchQuery"
      via: "useEffect prefetch"
      pattern: "prefetchQuery"
---

<objective>
Make the Dashboard context-aware: promote urgent content to the top, show contextual headers, and prefetch lead details for instant navigation from Today's Actions.

Purpose: Success Criterion 1 -- "Opening the TMA auto-detects context and surfaces the most relevant view" -- the Dashboard should feel like it reads the user's mind by showing what matters most first.

Output: useSmartLanding hook, updated Dashboard.tsx with conditional layout, TodayActionsCard with prefetching.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/webapp/src/pages/Dashboard.tsx
@packages/webapp/src/features/dashboard/components/TodayActionsCard.tsx
@packages/webapp/src/features/leads/hooks/useTodayActions.ts
@packages/webapp/src/features/dashboard/hooks/useUserProgress.ts
@packages/webapp/src/lib/queries.ts
@packages/webapp/src/features/leads/hooks/useLead.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useSmartLanding hook and update Dashboard layout</name>
  <files>
    packages/webapp/src/features/dashboard/hooks/useSmartLanding.ts
    packages/webapp/src/pages/Dashboard.tsx
  </files>
  <action>
    Create `useSmartLanding.ts` in `packages/webapp/src/features/dashboard/hooks/`:

    1. Import `useTodayActions` from `@/features/leads/hooks/useTodayActions` and `useUserProgress` from `./useUserProgress`.
    2. Export type `LandingFocus = 'actions-focus' | 'streak-focus' | 'default'`.
    3. Export function `useSmartLanding()` that returns `{ focus: LandingFocus; isReady: boolean; overdueCount: number; streakDays: number }`.
    4. Priority logic:
       - If either hook is loading, return `{ focus: 'default', isReady: false, overdueCount: 0, streakDays: 0 }`
       - Count overdue actions from `actions?.filter(a => a.isOverdue).length ?? 0`
       - Get streak from `user?.streak_days ?? 0`
       - If overdueCount > 0, focus = 'actions-focus'
       - Else if streakDays > 0, focus = 'streak-focus'
       - Else focus = 'default'

    Update `Dashboard.tsx`:

    1. Import `useSmartLanding` and `Skeleton` from `@/shared/ui`.
    2. Call `useSmartLanding()` at the top of the component.
    3. Add a contextual header `div` above the card list (inside the `space-y-4` container, before the first card):
       - If `!isReady`: render a Skeleton placeholder (height ~24px, width ~200px) as the header.
       - If `focus === 'actions-focus'`: render a text like `<p className="text-sm font-medium text-error">You have {overdueCount} overdue action{overdueCount !== 1 ? 's' : ''}</p>`
       - If `focus === 'streak-focus'`: render `<p className="text-sm font-medium text-accent">Day {streakDays} streak -- keep it going!</p>`
       - If `focus === 'default'`: render nothing (no header).
    4. Reorder children based on focus:
       - `actions-focus`: TodayActionsCard first, then ProgressCard, then QuickActions, WeakAreasCard, BadgePreview, LeaderboardWidget
       - `streak-focus` and `default`: keep current order (ProgressCard first, TodayActionsCard second)
       - Do NOT auto-navigate away from Dashboard. Do NOT use `navigate()`. Only reorder cards.
    5. Keep the existing `LevelUpOverlay` logic unchanged.

    IMPORTANT: Do NOT create a Zustand store. This is a simple hook composition.
    IMPORTANT: The hook must handle the case where `useTodayActions` returns empty array (no actions due = not 'actions-focus').
  </action>
  <verify>
    Run `cd /Users/dmytrolevin/Downloads/GD_playground/packages/webapp && npx tsc --noEmit` -- no type errors.
    Run `cd /Users/dmytrolevin/Downloads/GD_playground/packages/webapp && npx vite build` -- build succeeds.
  </verify>
  <done>
    useSmartLanding hook exists and returns correct focus mode. Dashboard conditionally reorders cards and shows contextual header. No layout shift (skeleton shown while loading).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add lead detail prefetching to TodayActionsCard</name>
  <files>
    packages/webapp/src/features/dashboard/components/TodayActionsCard.tsx
  </files>
  <action>
    Update `TodayActionsCard.tsx` to prefetch lead details for instant navigation:

    1. Import `useQueryClient` from `@tanstack/react-query`.
    2. Import `queryKeys` from `@/lib/queries` (already imported).
    3. Import `getInsforge` from `@/lib/insforge`.
    4. Import `useEffect` from `react`.
    5. Inside the component, after the `useTodayActions()` call:
       - Get `queryClient` via `useQueryClient()`.
       - Add a `useEffect` that watches `actions`:
         ```
         useEffect(() => {
           if (!actions || actions.length === 0) return;
           // Prefetch first 3 lead details for instant navigation
           const uniqueLeadIds = [...new Set(actions.slice(0, 5).map(a => a.lead_id))].slice(0, 3);
           uniqueLeadIds.forEach(leadId => {
             queryClient.prefetchQuery({
               queryKey: queryKeys.leads.detail(leadId),
               staleTime: 60_000,
             });
           });
         }, [actions, queryClient]);
         ```
       - NOTE: The prefetchQuery call only needs the queryKey and staleTime. TanStack Query will use the default queryFn if one is configured, otherwise the prefetch simply warms the cache key. Since `useLead` defines its own queryFn inline, the prefetch here primarily prevents a fresh fetch when the user navigates -- the detail page's `useLead` will find a warm cache entry. If no default queryFn exists, the prefetch is a no-op (silent fail), which is fine -- it's an optimization, not a requirement.
       - ACTUALLY, for the prefetch to work properly with inline queryFns, you need to provide the queryFn. Create a small helper:
         ```
         const prefetchLeadDetail = (leadId: number) => {
           const telegramId = useAuthStore.getState().telegramId;
           if (!telegramId) return;
           queryClient.prefetchQuery({
             queryKey: queryKeys.leads.detail(leadId),
             queryFn: async () => {
               const { data, error } = await getInsforge()
                 .database.from('lead_registry')
                 .select('id, user_id, telegram_id, prospect_name, prospect_first_name, prospect_last_name, prospect_title, prospect_company, prospect_geography, photo_url, photo_key, prospect_analysis, closing_strategy, engagement_tactics, draft_response, status, notes, input_type, web_research, engagement_plan, lead_source, created_at, updated_at')
                 .eq('id', leadId)
                 .eq('telegram_id', telegramId)
                 .limit(1);
               if (error) throw error;
               const rows = data ?? [];
               return rows.length > 0 ? rows[0] : null;
             },
             staleTime: 60_000,
           });
         };
         ```
       - Import `useAuthStore` from `@/features/auth/store`.
       - Call this in the useEffect for the first 3 unique lead IDs from actions.
    6. Do NOT change any existing rendering logic. This is purely additive prefetching.

    PITFALL: Limit prefetch to 3 leads max to avoid API call overload on Dashboard mount.
  </action>
  <verify>
    Run `cd /Users/dmytrolevin/Downloads/GD_playground/packages/webapp && npx tsc --noEmit` -- no type errors.
    Run `cd /Users/dmytrolevin/Downloads/GD_playground/packages/webapp && npx vite build` -- build succeeds.
  </verify>
  <done>
    TodayActionsCard prefetches first 3 lead details when actions data loads. Navigating to a lead detail from Today's Actions card shows data instantly from cache.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/dmytrolevin/Downloads/GD_playground/packages/webapp && npx tsc --noEmit` passes with no errors.
2. `cd /Users/dmytrolevin/Downloads/GD_playground/packages/webapp && npx vite build` succeeds.
3. Grep for `useSmartLanding` in Dashboard.tsx confirms hook is wired.
4. Grep for `prefetchQuery` in TodayActionsCard.tsx confirms prefetching is wired.
</verification>

<success_criteria>
- Dashboard shows contextual header when overdue actions or active streak detected
- TodayActionsCard promoted to first position during actions-focus mode
- Skeleton shown during smart landing data load (no CLS)
- Lead details prefetched for first 3 action items
- No regressions: default dashboard layout unchanged when no urgency detected
</success_criteria>

<output>
After completion, create `.planning/phases/17-lazyflow-ux-overhaul/17-01-SUMMARY.md`
</output>
