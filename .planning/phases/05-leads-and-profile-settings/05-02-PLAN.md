---
phase: 05-leads-and-profile-settings
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - packages/webapp/src/features/leads/hooks/useLeadActivities.ts
  - packages/webapp/src/features/leads/hooks/useAddLeadNote.ts
  - packages/webapp/src/features/leads/components/ActivityTimeline.tsx
  - packages/webapp/src/features/leads/components/LeadNotes.tsx
  - packages/webapp/src/features/leads/components/LeadDetail.tsx
  - packages/webapp/src/features/settings/hooks/useUserSettings.ts
  - packages/webapp/src/features/settings/hooks/useUpdateSettings.ts
  - packages/webapp/src/features/settings/components/SettingsPanel.tsx
  - packages/webapp/src/pages/Profile.tsx
autonomous: true

must_haves:
  truths:
    - "User can view a lead's activity log showing a timeline of status changes and actions"
    - "User can add notes to an existing lead"
    - "User can manage LLM provider and model selection from the Profile page"
    - "User sees API key status and can deep-link to bot for key management (TMA cannot access the Fernet ENCRYPTION_KEY required for encryption, so API key management is implemented as bot deep-link)"
  artifacts:
    - path: "packages/webapp/src/features/leads/components/ActivityTimeline.tsx"
      provides: "Chronological activity timeline for a lead"
      contains: "activity_type"
    - path: "packages/webapp/src/features/leads/hooks/useAddLeadNote.ts"
      provides: "Mutation hook for adding notes"
      contains: "useMutation"
    - path: "packages/webapp/src/features/settings/components/SettingsPanel.tsx"
      provides: "Provider/model selector and API key status"
      contains: "provider"
    - path: "packages/webapp/src/pages/Profile.tsx"
      provides: "Profile page with SettingsPanel added"
      contains: "SettingsPanel"
  key_links:
    - from: "packages/webapp/src/features/leads/hooks/useLeadActivities.ts"
      to: "lead_activity_log table"
      via: "getInsforge().database.from('lead_activity_log')"
      pattern: "from\\('lead_activity_log'\\)"
    - from: "packages/webapp/src/features/leads/hooks/useAddLeadNote.ts"
      to: "lead_registry and lead_activity_log tables"
      via: "update lead notes + insert activity entry"
      pattern: "\\.insert\\("
    - from: "packages/webapp/src/features/settings/hooks/useUpdateSettings.ts"
      to: "users table"
      via: "getInsforge().database.from('users').update()"
      pattern: "from\\('users'\\)\\.update"
---

<objective>
Add lead activity timeline, note management, and Profile settings panel -- completing all remaining Phase 5 requirements.

Purpose: LEAD-04 (notes), LEAD-05 (activity log), and PROF-05 (settings) complete the lead management experience and add the first user-facing settings controls. The activity timeline shows status changes created by Plan 01's mutation hook, and the settings panel allows provider/model configuration without switching to the bot.

Output: Activity timeline and notes components integrated into lead detail, settings feature with provider/model picker on Profile page.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-leads-and-profile-settings/05-RESEARCH.md
@.planning/phases/05-leads-and-profile-settings/05-01-SUMMARY.md
@packages/webapp/src/features/leads/types.ts
@packages/webapp/src/features/leads/hooks/useUpdateLeadStatus.ts
@packages/webapp/src/features/leads/components/LeadDetail.tsx
@packages/webapp/src/pages/Profile.tsx
@packages/webapp/src/types/enums.ts
@packages/webapp/src/types/tables.ts
@packages/webapp/src/lib/queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Activity timeline, notes hooks/components, and integrate into lead detail</name>
  <files>
    packages/webapp/src/features/leads/hooks/useLeadActivities.ts
    packages/webapp/src/features/leads/hooks/useAddLeadNote.ts
    packages/webapp/src/features/leads/components/ActivityTimeline.tsx
    packages/webapp/src/features/leads/components/LeadNotes.tsx
    packages/webapp/src/features/leads/components/LeadDetail.tsx
  </files>
  <action>
**1. Create `packages/webapp/src/features/leads/hooks/useLeadActivities.ts`:**

Fetch activity log entries for a lead. Accept `leadId: number` parameter. Query `lead_activity_log` table:
```typescript
.select('*')
.eq('lead_id', leadId)
.order('created_at', { ascending: false })
.limit(50)
```
Use `queryKeys.leads.activities(leadId)` as query key. Set `enabled: leadId > 0`.

**2. Create `packages/webapp/src/features/leads/hooks/useAddLeadNote.ts`:**

Mutation hook for adding notes to a lead. Uses `useMutation` from TanStack Query.

```typescript
interface AddNoteVars {
  leadId: number;
  telegramId: number;
  note: string;
}
```

`mutationFn` performs two operations:
1. Update `lead_registry.notes` to the new note text and set `updated_at`: `.from('lead_registry').update({ notes: note, updated_at: new Date().toISOString() }).eq('id', leadId)`
2. Insert activity log entry: `.from('lead_activity_log').insert([{ lead_id: leadId, telegram_id: telegramId, activity_type: 'context_update', content: note }])`

`onSettled`: Invalidate `queryKeys.leads.detail(leadId)`, `queryKeys.leads.activities(leadId)`, and `queryKeys.leads.byUser(telegramId)`.

No optimistic update needed for notes (unlike status, notes don't need instant UI feedback -- the form can show a loading state).

**3. Create `packages/webapp/src/features/leads/components/ActivityTimeline.tsx`:**

Props: `leadId: number`.

Uses `useLeadActivities(leadId)` hook. Renders a vertical timeline of activity entries.

Each entry shows:
- Activity type icon (left side, colored circle): status_change = `ArrowRightLeft` (blue), context_update = `StickyNote` (green), screenshot_comment = `Camera` (purple), ai_advice = `Sparkles` (amber), followup_sent = `Send` (brand). Default = `Clock` (gray).
- Content text (right side): `activity.content` (text-sm text-text)
- AI response if present: `activity.ai_response` in a subtle card below content (text-xs text-text-secondary bg-surface-secondary/30 rounded-lg p-2)
- Timestamp: formatted date below content (text-xs text-text-hint)
- Vertical line connecting entries (border-l-2 border-surface-secondary on the left)

Loading: 3 Skeleton rows. Empty: "No activity recorded yet." message. Import icons from lucide-react.

**4. Create `packages/webapp/src/features/leads/components/LeadNotes.tsx`:**

Props: `leadId: number`, `currentNote: string | null`.

Displays current note and provides an "Add/Update Note" form.

Structure:
- Display area: if `currentNote` exists, show it in a Card (text-sm whitespace-pre-wrap). If null, show "No notes yet."
- Input area: a `textarea` with placeholder "Add context, reminders, or follow-up notes..." and a submit button.
- Uses `useAddLeadNote()` mutation. Get `telegramId` from `useAuthStore`.
- Submit button shows "Saving..." with disabled state during `mutation.isPending`.
- After successful mutation, clear the textarea.
- Minimum textarea height: 3 rows. Button uses standard accent styling (bg-accent text-white rounded-button).

**5. Update `packages/webapp/src/features/leads/components/LeadDetail.tsx`:**

Add ActivityTimeline and LeadNotes components to the existing lead detail view.

After the existing sections (Analysis, Strategy, Tactics, Draft, Engagement Plan, Web Research, Notes), add:
- Replace the static Notes section with `<LeadNotes leadId={leadId} currentNote={lead.notes} />`
- Add `<ActivityTimeline leadId={leadId} />` as the last section, wrapped in a **Card** with a **Section header** following the same pattern used by Analysis, Strategy, and Tactics sections in LeadDetail (and the Section pattern from Support/Casebook): `History` icon from lucide-react + `'Activity'` title text. Specifically:
  ```tsx
  <Card className="...">
    <div className="flex items-center gap-2 mb-3">
      <History className="h-4 w-4 text-accent" />
      <h3 className="text-sm font-semibold text-text">Activity</h3>
    </div>
    <ActivityTimeline leadId={leadId} />
  </Card>
  ```
  This ensures visual consistency with all other detail sections (each section is a Card with an icon+title header).

The Notes section should appear where it currently is (after Web Research). ActivityTimeline goes at the very bottom.
  </action>
  <verify>
Run `cd /Users/dmytrolevin/Downloads/GD_playground/packages/webapp && npx tsc --noEmit` — no type errors. Verify features/leads/hooks/ now has 4 hooks (useLeads, useLead, useUpdateLeadStatus, useLeadActivities, useAddLeadNote). Verify ActivityTimeline.tsx and LeadNotes.tsx exist.
  </verify>
  <done>
Activity timeline renders chronological log entries with type-specific icons and timestamps. Notes component shows current note and allows adding/updating notes via mutation. LeadDetail integrates both components. Activity log shows status_change entries created by status updates from Plan 01.
  </done>
</task>

<task type="auto">
  <name>Task 2: Settings feature with provider/model picker and API key status on Profile page</name>
  <files>
    packages/webapp/src/features/settings/hooks/useUserSettings.ts
    packages/webapp/src/features/settings/hooks/useUpdateSettings.ts
    packages/webapp/src/features/settings/components/SettingsPanel.tsx
    packages/webapp/src/pages/Profile.tsx
  </files>
  <action>
**1. Create `packages/webapp/src/features/settings/hooks/useUserSettings.ts`:**

Fetch current user's settings (provider, openrouter_model, encrypted_api_key presence). Uses existing `users` table query:

```typescript
.from('users')
.select('provider, openrouter_model, encrypted_api_key')
.eq('telegram_id', telegramId)
.limit(1)
```

Return shaped data: `{ provider: string, openrouterModel: string, hasApiKey: boolean }`.
- `hasApiKey` is `!!data.encrypted_api_key` (just check presence, never expose the encrypted value).

Use `queryKeys.settings.user(telegramId)` as query key. Set `enabled: !!telegramId`. Get telegramId from `useAuthStore`.

**2. Create `packages/webapp/src/features/settings/hooks/useUpdateSettings.ts`:**

Mutation hook for updating provider and/or model. Uses `useMutation`.

```typescript
interface UpdateSettingsVars {
  telegramId: number;
  provider?: string;
  openrouterModel?: string;
}
```

`mutationFn`: Build update object from provided fields (only include non-undefined). Add `updated_at: new Date().toISOString()`. Call `.from('users').update(updateObj).eq('telegram_id', telegramId)`.

`onSettled`: Invalidate `queryKeys.settings.user(telegramId)` and `queryKeys.users.detail(telegramId)`.

**3. Create `packages/webapp/src/features/settings/components/SettingsPanel.tsx`:**

A self-contained settings panel component for the Profile page. Uses `useUserSettings()` and `useUpdateSettings()`.

Structure:
- **Section header**: `Settings` with `Settings` icon from lucide-react, styled like other profile sections
- **Provider selector**: Two option cards side by side.
  - "OpenRouter" with `Zap` icon and "(Free)" subtitle — highlighted if current provider is 'openrouter'
  - "Claude API" with `Sparkles` icon and "(Premium)" subtitle — highlighted if current provider is 'anthropic'
  - Tapping a provider card calls `updateSettings.mutate({ telegramId, provider: selectedProvider })`
  - Active card: `border-accent bg-accent/5`, inactive: `border-surface-secondary bg-surface`
  - Both cards in a 2-column grid with min height 44px
- **Model selector** (only visible when provider is 'openrouter'):
  - Label "OpenRouter Model"
  - Radio-style list of 4 models from bot settings (matching `bot/handlers/settings.py MODEL_KEYBOARD` exactly):
    - `openai/gpt-oss-120b` — "GPT-OSS 120B (Free)"
    - `moonshotai/kimi-k2.5` — "Kimi K2.5 (Free)"
    - `google/gemini-flash` — "Gemini Flash (Free)"
    - `deepseek/deepseek-r1` — "DeepSeek R1 (Free)"
  - Current model has filled radio indicator (accent circle). Others have empty circle.
  - Tapping a model calls `updateSettings.mutate({ telegramId, openrouterModel: modelId })`
  - Each option: min height 44px touch target
- **API Key management** (implemented as view-only status + bot deep-link):
  - NOTE: API key management is implemented as bot deep-link because the TMA cannot access the Fernet ENCRYPTION_KEY required for encryption/decryption. The bot holds the server-side ENCRYPTION_KEY and performs all key operations. The deep-link IS the management interface for PROF-05.
  - Show "API Key: Set" (green text) or "API Key: Not configured" (text-text-hint)
  - A "Manage API Key" button that deep-links to the bot: `openTelegramLink('https://t.me/{BOT_USERNAME}?start=settings')`. Use the same `openTelegramLink` pattern from Phase 3 (from `@telegram-apps/sdk-react`). For BOT_USERNAME, use `dealquest_bot` (the bot's username from the existing codebase — check config or use the known value).
  - Note explaining "API keys are encrypted and can only be managed through the bot for security."

Loading state: Skeleton placeholders for provider and model sections.

**4. Update `packages/webapp/src/pages/Profile.tsx`:**

Add SettingsPanel to the Profile page. Import and add `<SettingsPanel />` after the existing components (after AttemptHistory).

```typescript
import { SettingsPanel } from '@/features/settings/components/SettingsPanel';

export default function Profile() {
  return (
    <div className="space-y-4 px-4 pt-4 pb-4">
      <ProfileHeader />
      <StatsOverview />
      <BadgeCollection />
      <AttemptHistory />
      <SettingsPanel />
    </div>
  );
}
```
  </action>
  <verify>
Run `cd /Users/dmytrolevin/Downloads/GD_playground/packages/webapp && npx tsc --noEmit` — no type errors. Run `npx vite build` — builds without errors. Verify features/settings/ directory exists with hooks/ and components/. Verify Profile.tsx imports SettingsPanel.
  </verify>
  <done>
Settings panel shows current provider with visual toggle, model list for OpenRouter, and API key status with bot deep-link. Provider and model changes persist via useMutation to users table. Profile page renders SettingsPanel as the last section.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes — no type errors
2. `npx vite build` succeeds — no build errors
3. features/leads/hooks/ has 5 files: useLeads, useLead, useUpdateLeadStatus, useLeadActivities, useAddLeadNote
4. features/leads/components/ has ActivityTimeline.tsx and LeadNotes.tsx
5. LeadDetail.tsx integrates both LeadNotes and ActivityTimeline
6. features/settings/ directory exists with hooks/useUserSettings.ts, hooks/useUpdateSettings.ts, components/SettingsPanel.tsx
7. Profile.tsx imports and renders SettingsPanel
8. SettingsPanel shows provider toggle, model list (4 models matching bot), and API key status with deep-link
9. useAddLeadNote writes to both lead_registry.notes and lead_activity_log
10. Activity timeline shows typed icons for each activity_type including status_change
</verification>

<success_criteria>
- User can view a lead's activity log with a timeline of status changes, notes, and other actions
- User can add/update notes on a lead and the note appears in the activity timeline
- User can toggle between OpenRouter and Claude API providers from the Profile page
- User can select an OpenRouter model from the available free models
- User sees API key status and can tap to deep-link to bot for key management
- No type errors, builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/05-leads-and-profile-settings/05-02-SUMMARY.md`
</output>
