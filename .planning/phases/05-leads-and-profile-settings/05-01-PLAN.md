---
phase: 05-leads-and-profile-settings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/shared/src/enums.ts
  - packages/webapp/src/types/enums.ts
  - packages/webapp/src/types/tables.ts
  - packages/webapp/src/lib/queries.ts
  - packages/webapp/src/features/leads/types.ts
  - packages/webapp/src/features/leads/hooks/useLeads.ts
  - packages/webapp/src/features/leads/hooks/useLead.ts
  - packages/webapp/src/features/leads/hooks/useUpdateLeadStatus.ts
  - packages/webapp/src/features/leads/components/LeadCard.tsx
  - packages/webapp/src/features/leads/components/LeadList.tsx
  - packages/webapp/src/features/leads/components/LeadDetail.tsx
  - packages/webapp/src/features/leads/components/LeadStatusSelector.tsx
  - packages/webapp/src/pages/Leads.tsx
autonomous: true

must_haves:
  truths:
    - "User can browse a list of leads showing prospect name, company, title, and status badge"
    - "User can open a lead to see full analysis, strategy, engagement plan, draft, photos, and web research"
    - "User can update a lead's status through the pipeline stages and the change persists"
  artifacts:
    - path: "packages/webapp/src/types/enums.ts"
      provides: "Corrected LeadStatus with 6 values matching bot"
      contains: "meeting_booked"
    - path: "packages/webapp/src/features/leads/types.ts"
      provides: "Defensive parsers for lead TEXT JSON fields and status config"
      contains: "parseLeadAnalysis"
    - path: "packages/webapp/src/features/leads/hooks/useUpdateLeadStatus.ts"
      provides: "First TMA mutation with optimistic update"
      contains: "useMutation"
    - path: "packages/webapp/src/pages/Leads.tsx"
      provides: "Leads page with nested sub-routes (list + detail)"
      contains: "Routes"
  key_links:
    - from: "packages/webapp/src/features/leads/hooks/useLeads.ts"
      to: "lead_registry table"
      via: "getInsforge().database.from('lead_registry')"
      pattern: "from\\('lead_registry'\\)"
    - from: "packages/webapp/src/features/leads/hooks/useUpdateLeadStatus.ts"
      to: "lead_registry table"
      via: "getInsforge().database.from('lead_registry').update()"
      pattern: "\\.update\\("
    - from: "packages/webapp/src/pages/Leads.tsx"
      to: "LeadList and LeadDetail components"
      via: "nested Routes with index and :leadId"
      pattern: "path.*leadId"
---

<objective>
Build the lead pipeline list view, detail view, and status management -- the TMA's first page with write operations (mutations).

Purpose: LEAD-01 (list view), LEAD-02 (detail view), and LEAD-03 (status management) form the core lead pipeline experience. This plan also fixes the CRITICAL LeadStatus enum mismatch between TMA and bot, and establishes the useMutation pattern that Phase 5 Plan 2 and future phases will reuse.

Output: Leads feature directory with types, hooks (including first mutation hook), components, and a fully functional Leads page with nested sub-routes for browsing leads and viewing/updating lead details.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-leads-and-profile-settings/05-RESEARCH.md
@packages/webapp/src/types/enums.ts
@packages/webapp/src/types/tables.ts
@packages/webapp/src/lib/queries.ts
@packages/webapp/src/pages/Support.tsx
@packages/webapp/src/features/support/types.ts
@packages/webapp/src/features/support/components/AnalysisDisplay.tsx
@packages/webapp/src/features/support/components/StrategyDisplay.tsx
@packages/webapp/src/features/support/components/DraftDisplay.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix enums, create lead types with defensive parsers, hooks with first mutation, and query keys</name>
  <files>
    packages/shared/src/enums.ts
    packages/webapp/src/types/enums.ts
    packages/webapp/src/types/tables.ts
    packages/webapp/src/lib/queries.ts
    packages/webapp/src/features/leads/types.ts
    packages/webapp/src/features/leads/hooks/useLeads.ts
    packages/webapp/src/features/leads/hooks/useLead.ts
    packages/webapp/src/features/leads/hooks/useUpdateLeadStatus.ts
  </files>
  <action>
**1. Fix LeadStatus enum (CRITICAL) in BOTH files:**

In `packages/shared/src/enums.ts` AND `packages/webapp/src/types/enums.ts`, transform the current 5-value LeadStatus into the correct 6-value version matching bot/handlers/leads.py STATUS_LABELS.

**Before** (current TMA values): `'analyzed' | 'reached_out' | 'meeting' | 'in_progress' | 'closed'`
**After** (correct bot values): `'analyzed' | 'reached_out' | 'meeting_booked' | 'in_progress' | 'closed_won' | 'closed_lost'`

Specifically: REMOVE `'meeting'` and `'closed'`. ADD `'meeting_booked'`, `'closed_won'`, and `'closed_lost'`. The values `'analyzed'`, `'reached_out'`, and `'in_progress'` remain unchanged.

```typescript
export type LeadStatus =
  | 'analyzed'
  | 'reached_out'
  | 'meeting_booked'
  | 'in_progress'
  | 'closed_won'
  | 'closed_lost';
```

Also add `'status_change'` to LeadActivityType in both files:

```typescript
export type LeadActivityType =
  | 'context_update'
  | 'screenshot_comment'
  | 'ai_advice'
  | 'followup_sent'
  | 'status_change';
```

**2. Fix EngagementPlanStep in `packages/webapp/src/types/tables.ts`:**

The existing EngagementPlanStep type has `step` and `action` fields but the bot actually uses `step_id`, `description`, `timing`, `status`, `suggested_text`, `completed_at`. Replace:

```typescript
export interface EngagementPlanStep {
  step_id: number;
  description: string;
  timing: string;
  status: 'pending' | 'done';
  suggested_text?: string;
  completed_at?: string | null;
}
```

**3. Create `packages/webapp/src/features/leads/types.ts`:**

Build defensive parsers for lead TEXT JSON fields. These fields (prospect_analysis, closing_strategy, engagement_tactics, draft_response) are TEXT columns containing JSON strings, NOT JSONB. They arrive as raw strings from PostgREST and must be JSON.parsed manually with try/catch.

Include:
- `LEAD_STATUS_CONFIG` record mapping each LeadStatus to `{ label, variant, order }` (matching bot STATUS_LABELS exactly: analyzed=Analyzed/info/0, reached_out=Reached Out/brand/1, meeting_booked=Meeting Booked/warning/2, in_progress=In Progress/default/3, closed_won=Closed Won/success/4, closed_lost=Closed Lost/error/5). Variant values should match Badge component variant prop (see shared/ui).
- `parseLeadAnalysis(raw: string | null): SupportAnalysis` — parses prospect_analysis TEXT field. Reuse the same SupportAnalysis interface from `features/support/types.ts` or define compatible shape. Use `JSON.parse()` inside try/catch. Handle null, empty string, '{}', 'null', and malformed JSON. Use typeof guards on every property (same pattern as parseOutputJson from support/types.ts).
- `parseLeadStrategy(raw: string | null): string` — closing_strategy is stored as a plain text string, not structured JSON. Just return the string or empty fallback.
- `parseLeadTactics(raw: string | null): string` — same pattern as strategy, plain text.
- `parseLeadDraft(raw: string | null): string` — same pattern.
- `parseEngagementPlan(plan: unknown): EngagementPlanStep[]` — this field IS JSONB (comes pre-parsed from PostgREST). Validate it's an array, validate each item has step_id/description/timing/status fields with typeof guards.
- `formatLeadDate(isoString: string | null): string` — format ISO date to readable short date.

**4. Add query keys to `packages/webapp/src/lib/queries.ts`:**

Add to the queryKeys object:
```typescript
leads: {
  all: ['leads'] as const,
  byUser: (telegramId: number) => ['leads', telegramId] as const,
  detail: (leadId: number) => ['leads', 'detail', leadId] as const,
  activities: (leadId: number) => ['leads', 'activities', leadId] as const,
},
settings: {
  user: (telegramId: number) => ['settings', telegramId] as const,
},
```

**5. Create `packages/webapp/src/features/leads/hooks/useLeads.ts`:**

Fetch paginated lead list for current user. Use `useAuthStore` to get telegramId. Query `lead_registry` table selecting ONLY lightweight columns for list display: `id, prospect_name, prospect_company, prospect_title, status, photo_url, input_type, created_at, updated_at`. Order by `updated_at` descending. Limit to 30 rows. Use `queryKeys.leads.byUser(telegramId)` as query key. Set `enabled: !!telegramId`.

**6. Create `packages/webapp/src/features/leads/hooks/useLead.ts`:**

Fetch single lead with all fields. Accept `leadId: number` parameter. Query `lead_registry` with `.select('*').eq('id', leadId).limit(1)`. Return single item (data?.[0]). Use `queryKeys.leads.detail(leadId)` as query key. Set `enabled: leadId > 0`.

**7. Create `packages/webapp/src/features/leads/hooks/useUpdateLeadStatus.ts`:**

This is the TMA's FIRST mutation hook. Use `useMutation` from TanStack Query with full lifecycle:

```typescript
interface UpdateStatusVars {
  leadId: number;
  newStatus: LeadStatus;
  oldStatus: string;
  telegramId: number;
}
```

- `mutationFn`: Two operations in sequence:
  1. Update lead_registry: `.update({ status: newStatus, updated_at: new Date().toISOString() }).eq('id', leadId)`
  2. Insert activity log entry: `.insert([{ lead_id: leadId, telegram_id: telegramId, activity_type: 'status_change', content: \`Status changed from ${oldStatus} to ${newStatus}\` }])` into `lead_activity_log`
- `onMutate`: Cancel outgoing queries for both `leads.byUser(telegramId)` and `leads.detail(leadId)`. Snapshot previous data for rollback. Optimistically update the lead's status in the leads list cache.
- `onError`: Roll back to previous data.
- `onSettled`: Invalidate `leads.byUser(telegramId)`, `leads.detail(leadId)`, and `leads.activities(leadId)`.

Import `getInsforge` from `@/lib/insforge`, `queryKeys` from `@/lib/queries`.
  </action>
  <verify>
Run `cd /Users/dmytrolevin/Downloads/GD_playground/packages/webapp && npx tsc --noEmit` — no type errors. Verify files exist: types.ts, all 3 hooks, updated enums, updated queries.ts.
  </verify>
  <done>
LeadStatus has 6 values matching bot. LeadActivityType includes 'status_change'. EngagementPlanStep matches bot's actual structure. Defensive parsers handle TEXT JSON fields. Three hooks exist: useLeads (list), useLead (detail), useUpdateLeadStatus (first mutation). Query keys registered for leads and settings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Lead list, detail, status selector components, and Leads page with sub-routes</name>
  <files>
    packages/webapp/src/features/leads/components/LeadCard.tsx
    packages/webapp/src/features/leads/components/LeadList.tsx
    packages/webapp/src/features/leads/components/LeadDetail.tsx
    packages/webapp/src/features/leads/components/LeadStatusSelector.tsx
    packages/webapp/src/pages/Leads.tsx
  </files>
  <action>
**1. Create `LeadCard.tsx`:**

A compact card showing lead preview info for the list. Props: `lead` (subset of LeadRegistryRow with id, prospect_name, prospect_company, prospect_title, status, photo_url, input_type, created_at, updated_at), `onClick: () => void`.

Display:
- Left side: prospect photo thumbnail (40x40 rounded-full) if `photo_url` exists, otherwise a `User` icon from lucide-react in a colored circle
- Center: prospect_name (font-semibold text-text), prospect_company + prospect_title on second line (text-xs text-text-secondary), relative date on third line (text-xs text-text-hint)
- Right side: status badge using the `LEAD_STATUS_CONFIG[lead.status as LeadStatus]` — display the label text with appropriate styling. Use a small rounded pill with background color based on variant (info=accent/10, brand=brand/10, warning=yellow/10, success=green/10, error=red/10, default=surface-secondary).

Wrap in a Card component with `onClick`. Use `import { Card } from '@/shared/ui'`. Import `User` icon from lucide-react.

**2. Create `LeadList.tsx`:**

Renders the lead list. Uses `useLeads()` hook. Maps leads to `LeadCard` components. Receives `onSelectLead: (leadId: number) => void` prop.

States:
- Loading: show 4 Skeleton cards (height 80)
- Empty: centered empty state with Users icon saying "No leads yet — analyze prospects in the bot to build your pipeline."
- Data: map leads to LeadCard components, pass `onClick={() => onSelectLead(lead.id)}`

**3. Create `LeadStatusSelector.tsx`:**

A horizontal scrollable row of status pills showing all 6 pipeline stages. Props: `currentStatus: string`, `onStatusChange: (status: LeadStatus) => void`, `isUpdating: boolean`.

Render all 6 statuses from LEAD_STATUS_CONFIG in order. Each pill shows the label. The current status has a filled/active state (bg-accent text-white). Other statuses are tappable (bg-surface-secondary text-text-secondary). During `isUpdating`, disable all buttons and show reduced opacity. Minimum touch target 44px height.

Use `Object.entries(LEAD_STATUS_CONFIG).sort((a, b) => a[1].order - b[1].order)` for ordered rendering. Import types from `../types`.

**4. Create `LeadDetail.tsx`:**

Full lead detail view, similar to Support's SessionDetail but for lead_registry fields. Props: none (reads leadId from URL params via `useParams`).

Uses `useLead(leadId)` hook and `useUpdateLeadStatus()` mutation hook.

Structure:
- Header: prospect_name (large), prospect_title @ prospect_company, photo if available (larger, 80x80 rounded-xl), input type badge
- **LeadStatusSelector** — current status with ability to change. Pass `isUpdating: mutation.isPending`.
- When user taps a different status, call `mutation.mutate({ leadId, newStatus, oldStatus: lead.status, telegramId })`.
- Sections (each in a Card, similar to Support/Casebook Section pattern with icon + title + content):
  - **Prospect Analysis**: Parse `lead.prospect_analysis` with `parseLeadAnalysis()`. Display structured fields (prospect_type, seniority, stage, buying_signal, etc.) in a grid/list format. Use `Target` icon.
  - **Closing Strategy**: `parseLeadStrategy(lead.closing_strategy)`. Display as whitespace-pre-wrap text. Use `TrendingUp` icon.
  - **Engagement Tactics**: `parseLeadTactics(lead.engagement_tactics)`. Display as whitespace-pre-wrap text. Use `MessageSquare` icon.
  - **Draft Response**: `parseLeadDraft(lead.draft_response)`. Display as whitespace-pre-wrap text with copy button (reuse clipboard pattern from Phase 4: `navigator.clipboard.writeText` with textarea fallback). Use `FileText` icon.
  - **Engagement Plan**: `parseEngagementPlan(lead.engagement_plan)`. Display as a step list with step_id, description, timing, and status badge (pending/done). Read-only. Use `ListChecks` icon.
  - **Web Research**: Display `lead.web_research` as plain text in a scrollable section if present. Use `Globe` icon.
  - **Notes**: Display `lead.notes` if present. Use `StickyNote` icon.
- Only render sections that have content (skip null/empty sections).

Loading state: Skeleton placeholders. Not found: Navigate to /leads.

Import `useAuthStore` from `@/features/auth/store` for telegramId. Import Card and Skeleton from `@/shared/ui`.

**5. Replace `packages/webapp/src/pages/Leads.tsx`:**

Replace the placeholder stub with a full page using nested sub-routes (same pattern as Support.tsx and Casebook.tsx):

```typescript
import { Routes, Route, useNavigate, Navigate } from 'react-router';
import { Users } from 'lucide-react';

// Index route: lead list
function LeadListView() {
  const navigate = useNavigate();
  return <LeadList onSelectLead={(id) => navigate(`/leads/${id}`)} />;
}

// Detail route: :leadId
function LeadDetailView() {
  return <LeadDetail />;
}

export default function Leads() {
  return (
    <div className="space-y-4 px-4 pt-4 pb-6">
      <div className="flex items-center gap-2">
        <Users className="h-5 w-5 text-accent" />
        <h1 className="text-xl font-bold text-text">Leads</h1>
      </div>
      <Routes>
        <Route index element={<LeadListView />} />
        <Route path=":leadId" element={<LeadDetailView />} />
        <Route path="*" element={<Navigate to="/leads" replace />} />
      </Routes>
    </div>
  );
}
```
  </action>
  <verify>
Run `cd /Users/dmytrolevin/Downloads/GD_playground/packages/webapp && npx tsc --noEmit` — no type errors. Run `npx vite build` — builds without errors. Verify all component files exist in features/leads/components/.
  </verify>
  <done>
LeadCard renders name, company, status badge for list items. LeadList fetches and displays paginated leads with loading/empty states. LeadDetail shows full analysis with all sections parsed defensively. LeadStatusSelector shows 6 pipeline stages with active state highlighting. Leads page has nested sub-routes (list index + :leadId detail). Status changes trigger useMutation with optimistic update and activity log entry.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes in packages/webapp — no type errors
2. `npx vite build` succeeds — no build errors
3. LeadStatus in both enums.ts files has exactly 6 values: analyzed, reached_out, meeting_booked, in_progress, closed_won, closed_lost
4. LeadActivityType includes 'status_change' in both enums.ts files
5. EngagementPlanStep has step_id, description, timing, status (not step, action)
6. features/leads/types.ts exports parseLeadAnalysis, parseLeadStrategy, parseLeadTactics, parseLeadDraft, parseEngagementPlan, LEAD_STATUS_CONFIG
7. features/leads/hooks/ has useLeads.ts, useLead.ts, useUpdateLeadStatus.ts
8. useUpdateLeadStatus uses useMutation with onMutate/onError/onSettled and writes activity log entry
9. Leads page has nested Routes with index and :leadId paths
10. queryKeys.leads and queryKeys.settings exist in lib/queries.ts
</verification>

<success_criteria>
- User can browse a list of leads with name, company, title, and colored status badge
- User can tap a lead to see full detail with all analysis sections rendered from defensive parsers
- User can change lead status via the status selector and the change persists (optimistic update + server write + activity log entry)
- No type errors, builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/05-leads-and-profile-settings/05-01-SUMMARY.md`
</output>
