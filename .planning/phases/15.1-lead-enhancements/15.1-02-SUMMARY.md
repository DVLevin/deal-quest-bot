---
# Plan Execution Summary
phase: 15.1-lead-enhancements
plan: 02
completed: 2026-02-05

# What was built
subsystem: leads-tma
tags: [react-query, mutation, engagement-plan, tma]

# Dependency graph
requires: [14-02]
provides: [tma-plan-step-toggle]
affects: [15.1-03]

# Technical tracking
tech-stack:
  added: []
  patterns: [optimistic-update, dual-sync-jsonb-table]
key-files:
  created:
    - packages/webapp/src/features/leads/hooks/useUpdatePlanStep.ts
  modified:
    - packages/webapp/src/features/leads/components/LeadDetail.tsx
    - packages/webapp/src/features/leads/types.ts
    - packages/webapp/src/types/tables.ts

# Decisions made (reference format for STATE.md)
decisions:
  - id: 15.1-02-status-cycle
    choice: "Status cycles pending -> done -> skipped -> pending on tap"
    reason: "Three-state toggle with single gesture for mobile UX"
  - id: 15.1-02-dual-sync
    choice: "Update both engagement_plan JSONB and scheduled_reminders table"
    reason: "Keep data in sync per Phase 14-02 decision"

# Metrics
duration: 3m
---

# Phase 15.1 Plan 02: TMA Plan Step Toggle Summary

**One-liner:** Interactive engagement plan step toggles in TMA with optimistic updates and dual-sync to scheduled_reminders

## Tasks Completed

| Task | Name | Commit | Files |
|------|------|--------|-------|
| 1 | Create useUpdatePlanStep mutation hook | 11d3f53 | hooks/useUpdatePlanStep.ts, types.ts, tables.ts |
| 2 | Add interactive step toggles to LeadDetail | 6d5848f | LeadDetail.tsx |

## What Was Built

### Task 1: useUpdatePlanStep Hook

Created new mutation hook following the useUpdateLeadStatus pattern:

**Interface:**
```typescript
interface UpdatePlanStepVars {
  leadId: number;
  stepId: number;
  newStatus: PlanStepStatus; // 'pending' | 'done' | 'skipped'
  telegramId: number;
}
```

**Mutation flow:**
1. Fetch current lead's engagement_plan from lead_registry
2. Update the step with matching step_id (set status, completed_at timestamp)
3. Write updated engagement_plan back to lead_registry
4. Update scheduled_reminders row if it exists (maps done->completed, skipped->skipped)
5. Insert lead_activity_log entry (step_execution, step_skip, or step_reset)

**Optimistic updates:**
- onMutate: Cancel queries, snapshot previous lead, update cache immediately
- onError: Rollback to snapshot
- onSettled: Invalidate leads.detail, leads.byUser, and leads.activities queries

### Task 2: Interactive LeadDetail UI

Updated LeadDetail component:

**Imports added:**
- `useUpdatePlanStep` hook
- `Circle`, `SkipForward` icons from lucide-react
- `PlanStepStatus` type

**New handler:**
```typescript
const handleStepToggle = useCallback(
  (stepId: number, currentStatus: PlanStepStatus) => {
    // Cycle: pending -> done -> skipped -> pending
    let newStatus: PlanStepStatus;
    if (currentStatus === 'pending') newStatus = 'done';
    else if (currentStatus === 'done') newStatus = 'skipped';
    else newStatus = 'pending';

    stepMutation.mutate(...);
  },
  [lead, telegramId, stepMutation, toast],
);
```

**UI changes:**
- Replaced static Badge with clickable button
- Button shows appropriate icon: Check (done), SkipForward (skipped), Circle (pending)
- Color variants: success/15 (done), text-hint/15 (skipped), surface-secondary (pending)
- Disabled state during pending mutation
- Toast feedback on success/error with retry action

### Type Updates

**packages/webapp/src/types/tables.ts:**
- Added `PlanStepStatus` type: `'pending' | 'done' | 'skipped'`
- Updated `EngagementPlanStep.status` to use `PlanStepStatus`

**packages/webapp/src/features/leads/types.ts:**
- Updated `parseEngagementPlan` to handle 'skipped' status

## Deviations from Plan

None - plan executed exactly as written.

## Verification

- [x] File exists: useUpdatePlanStep.ts
- [x] Hook exported: `export function useUpdatePlanStep`
- [x] Uses React Query: `useMutation` imported and used
- [x] Hook imported in LeadDetail
- [x] handleStepToggle exists
- [x] Build passes: `npm run build` completed successfully

## Key Patterns Established

1. **Dual-sync pattern**: When updating JSONB field that has corresponding table rows, update both in single mutation
2. **Status mapping**: Plan step status -> scheduled_reminders status (done->completed, skipped->skipped, pending->pending)
3. **Activity logging**: Each step status change creates activity log entry for timeline

## Next Phase Readiness

Plan 15.1-03 (TMA Activity Timeline) can proceed - the activity log entries from step toggles will appear in the timeline.
