# Phase 15.1: Lead Enhancements & Comment Suggestions - Research

**Researched:** 2026-02-05
**Domain:** Lead management, web research versioning, engagement plan UX, screenshot-based comment generation
**Confidence:** HIGH

## Summary

This phase adds three features to the lead management system:

1. **Remake Web Research with Versions** - Allow users to re-run web research with optional URL input, keep history of research versions, and delete irrelevant ones
2. **Engagement Plan Status from TMA** - Enable step status changes (Done/Skip) directly from the TMA lead detail page
3. **Screenshot-based Comment Suggestions** - Branch in /support flow where users send LinkedIn POST screenshots and receive contextual comment suggestions

The current codebase has strong foundations: web research generation exists in `_background_enrich_lead()`, engagement plans are stored as JSONB with step-level status, and screenshot comment generation already exists in leads.py via `lead:screenshot:` callback. The main work involves:
- Adding version history to web_research (schema change + UI)
- Adding TMA mutation hook for engagement plan step updates
- Creating a new /support branch for POST screenshots (distinct from lead-attached screenshots)

**Primary recommendation:** Extend existing patterns rather than creating new abstractions. The codebase already has working implementations for all three features at different scopes.

## Standard Stack

The established libraries/tools for this domain:

### Core (Already in Use)
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| aiogram 3 | 3.x | Telegram bot framework | Already used, FSM states for flow branching |
| React Query | @tanstack/react-query | TMA data mutations | Already used for optimistic updates |
| InsForge SDK | @insforge/sdk | Database operations | PostgREST for JSONB updates |
| OpenRouter | API | LLM calls for research/comments | Already integrated via `web_research_call()` |

### Supporting (Already in Use)
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| Zustand | - | Auth store | telegram_id for all queries |
| Pydantic | - | Data models | Extend LeadRegistryModel for versions |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| JSONB for research versions | Separate table | JSONB simpler, no joins needed; separate table better for large history |
| Inline TMA mutations | Edge Function | Direct PostgREST is simpler, Edge Function needed only for complex logic |

## Architecture Patterns

### Current Web Research Flow
```
support.py:_background_enrich_lead()
    |
    v
web_research_call(openrouter_api_key, query)  # Uses Grok with web plugin
    |
    v
lead_repo.update_lead(lead_id, web_research=research[:5000])
```

**Key insight:** Research is stored as TEXT, not JSONB. Versioning requires schema change.

### Current Engagement Plan Step Toggle (Bot)
```
leads.py:on_lead_step_toggle()
    |
    v
Toggle step["status"] = "done" | "pending"
    |
    v
lead_repo.update_lead(lead_id, engagement_plan=updated_plan)
```

**Key insight:** Bot already has full implementation. TMA needs equivalent mutation hook.

### Current Screenshot Comment Flow (Leads Context)
```
leads.py:on_lead_screenshot_start()  # callback lead:screenshot:{lead_id}
    |
    v
LeadEngagementState.sending_screenshot  # FSM state
    |
    v
on_lead_screenshot_photo()
    |
    v
engagement_service.generate_comment(lead, photo_b64, research)
```

**Key insight:** This is tied to an existing lead. New feature needs standalone support flow.

### Recommended Project Structure for Changes
```
bot/
â”œâ”€â”€ handlers/
â”‚   â”œâ”€â”€ support.py          # Add CommentSupportState, screenshot branch
â”‚   â””â”€â”€ leads.py            # Add re-research callback handler
â”œâ”€â”€ states.py               # Add CommentSupportState
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ llm_router.py       # web_research_call already exists
â”‚   â””â”€â”€ engagement.py       # generate_comment already exists
â””â”€â”€ storage/
    â”œâ”€â”€ models.py           # Extend LeadRegistryModel for web_research_versions
    â””â”€â”€ repositories.py     # Add research version methods

packages/webapp/src/features/leads/
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useUpdatePlanStep.ts    # NEW: mutation for step status
â”‚   â””â”€â”€ useRerunResearch.ts     # NEW: mutation for re-research
â””â”€â”€ components/
    â””â”€â”€ LeadDetail.tsx          # Add step toggle + re-research buttons
```

### Pattern 1: Research Versioning Schema
**What:** Store web research as JSONB array of versioned entries
**When to use:** When users need to compare/delete research versions

```sql
-- Migration: Change web_research from TEXT to JSONB array
-- Example structure:
{
  "versions": [
    {
      "version_id": 1,
      "created_at": "2026-02-05T10:00:00Z",
      "query_used": "John Smith Acme Corp",
      "url_provided": null,
      "content": "Research content...",
      "active": true
    },
    {
      "version_id": 2,
      "created_at": "2026-02-05T11:00:00Z",
      "query_used": "John Smith",
      "url_provided": "https://linkedin.com/in/johnsmith",
      "content": "Updated research...",
      "active": true
    }
  ],
  "current_version_id": 2
}
```

### Pattern 2: TMA Engagement Plan Step Update
**What:** Optimistic mutation for toggling step status
**When to use:** When user taps step in TMA engagement plan view

```typescript
// useUpdatePlanStep.ts
interface UpdatePlanStepVars {
  leadId: number;
  stepId: number;
  newStatus: 'done' | 'pending' | 'skipped';
  telegramId: number;
}

// Mutation updates engagement_plan JSONB field
// Same pattern as useUpdateLeadStatus.ts
```

### Pattern 3: Support Flow Branching for Comment Screenshots
**What:** New FSM state for standalone comment suggestion (not tied to existing lead)
**When to use:** User wants comment suggestion for a POST, not a profile

```python
# states.py
class CommentSupportState(StatesGroup):
    waiting_screenshot = State()
    refining_comment = State()  # Optional: allow user to refine

# support.py - new handler
@router.message(Command("comment"))
async def cmd_comment(message: Message, state: FSMContext, ...):
    """Start comment suggestion flow."""
    await message.answer(
        "Send me a screenshot of the LinkedIn POST you want to comment on."
    )
    await state.set_state(CommentSupportState.waiting_screenshot)
```

### Anti-Patterns to Avoid
- **Storing versions in separate table:** Overkill for ~5-10 versions max per lead. JSONB is simpler.
- **Creating new agent for comment generation:** `engagement_service.generate_comment()` already works. Reuse it.
- **Building complex version diff UI:** Start with simple list view + delete button. Add diff later if needed.

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Web search with URL context | Custom scraper | `web_research_call()` with URL in query | Grok web plugin already handles URLs |
| Comment generation from image | Custom OCR + prompt | `engagement_service.generate_comment()` | Already handles vision model + prompting |
| JSONB array updates | Manual array manipulation | PostgreSQL JSONB operators | `jsonb_set`, array append are atomic |
| Optimistic TMA mutations | Manual cache updates | React Query's `useMutation` + `onMutate` | Already used in `useUpdateLeadStatus.ts` |

**Key insight:** All three features have partial implementations. The work is connecting existing pieces, not building from scratch.

## Common Pitfalls

### Pitfall 1: Research Version Migration
**What goes wrong:** Existing TEXT web_research data breaks when column becomes JSONB
**Why it happens:** Migration doesn't handle existing data
**How to avoid:** Two-step migration:
1. Add new column `web_research_versions JSONB`
2. Run data migration to copy existing `web_research` into versions array
3. Keep old column as fallback, deprecate after validation
**Warning signs:** Existing leads show no research after migration

### Pitfall 2: TMA Mutation Without Telegram ID
**What goes wrong:** Mutation succeeds but cache doesn't update
**Why it happens:** Query key uses telegramId which isn't in mutation vars
**How to avoid:** Always include telegramId in mutation vars (see `useUpdateLeadStatus.ts` pattern)
**Warning signs:** UI doesn't reflect changes until manual refresh

### Pitfall 3: Comment Flow Colliding with Support Flow
**What goes wrong:** User in /support mode sends screenshot, expects profile analysis but gets comment suggestions
**Why it happens:** Both flows use photo handlers
**How to avoid:** Use distinct FSM states (`SupportState.waiting_input` vs `CommentSupportState.waiting_screenshot`)
**Warning signs:** User confusion about what the bot will do with screenshot

### Pitfall 4: Re-Research Blocking UI
**What goes wrong:** User triggers re-research, UI hangs for 30+ seconds
**Why it happens:** Grok web search is slow (~15-30s)
**How to avoid:** Run as background task (like existing `_background_enrich_lead()`), show "generating..." status
**Warning signs:** UI becomes unresponsive during research

## Code Examples

Verified patterns from official sources:

### JSONB Array Append in PostgreSQL
```sql
-- Source: PostgreSQL docs for jsonb_set
UPDATE lead_registry
SET web_research_versions = jsonb_set(
  COALESCE(web_research_versions, '{"versions": [], "current_version_id": 0}'::jsonb),
  '{versions}',
  COALESCE(web_research_versions->'versions', '[]'::jsonb) ||
    jsonb_build_object(
      'version_id', COALESCE((web_research_versions->>'current_version_id')::int, 0) + 1,
      'created_at', now(),
      'content', 'New research content...'
    )::jsonb
)
WHERE id = $1;
```

### TMA Mutation with Optimistic Update
```typescript
// Source: useUpdateLeadStatus.ts (existing pattern)
export function useUpdatePlanStep() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async ({ leadId, stepId, newStatus }: UpdatePlanStepVars) => {
      // Fetch current plan, update step, write back
      const { data: lead } = await getInsforge()
        .database.from('lead_registry')
        .select('engagement_plan')
        .eq('id', leadId)
        .single();

      const plan = lead?.engagement_plan ?? [];
      const updatedPlan = plan.map((step: EngagementPlanStep) =>
        step.step_id === stepId ? { ...step, status: newStatus } : step
      );

      await getInsforge()
        .database.from('lead_registry')
        .update({ engagement_plan: updatedPlan, updated_at: new Date().toISOString() })
        .eq('id', leadId);
    },
    onMutate: async ({ leadId, stepId, newStatus, telegramId }) => {
      await queryClient.cancelQueries({ queryKey: queryKeys.leads.detail(leadId) });
      // Optimistic update logic...
    },
    // onError, onSettled same as useUpdateLeadStatus.ts
  });
}
```

### Bot Handler for Re-Research with URL
```python
# Source: Existing _background_enrich_lead() pattern
@router.callback_query(F.data.startswith("lead:reresearch:"))
async def on_lead_reresearch(
    callback: CallbackQuery,
    state: FSMContext,
) -> None:
    """Start re-research flow for a lead."""
    lead_id = int(callback.data.split(":")[2])
    await state.update_data(reresearch_lead_id=lead_id)
    await state.set_state(LeadEngagementState.reresearch_input)
    await callback.message.edit_text(
        "Re-running web research for this lead.\n\n"
        "Optionally, provide a URL (like their LinkedIn profile) for more accurate results.\n"
        "Or just send 'go' to re-run with existing info.\n\n"
        "_Send /cancel to go back._",
        parse_mode="Markdown",
    )
    await callback.answer()
```

### Comment Support Flow Entry Point
```python
# Source: Existing cmd_support() pattern
@router.message(Command("comment"))
async def cmd_comment(message: Message, state: FSMContext, user_repo: UserRepo) -> None:
    """Start comment suggestion mode."""
    tg_id = message.from_user.id
    user = await user_repo.get_by_telegram_id(tg_id)

    if not user or not user.encrypted_api_key:
        await message.answer("Please run /start first to set up your account.")
        return

    await message.answer(
        "ðŸ’¬ *Comment Suggestion Mode*\n\n"
        "Send me a screenshot of the LinkedIn POST you want to comment on.\n\n"
        "I'll extract the post content and generate engaging comment options "
        "that add value without being salesy.\n\n"
        "_This works best for posts about industry topics, not personal updates._",
        parse_mode="Markdown",
    )
    await state.set_state(CommentSupportState.waiting_screenshot)
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Single web_research TEXT | Versioned JSONB array | This phase | Users can compare/delete versions |
| Bot-only plan management | TMA + Bot dual control | This phase | Better UX for mobile users |
| Lead-attached comments | Standalone comment flow | This phase | Users can get comments for any post |

**Deprecated/outdated:**
- None identified. All existing patterns remain valid.

## Open Questions

Things that couldn't be fully resolved:

1. **Should re-research replace or append?**
   - What we know: Current implementation overwrites web_research
   - What's unclear: User expectation - replace latest or keep all?
   - Recommendation: Append by default, add "replace latest" option later

2. **Comment flow: New command or /support branch?**
   - What we know: Current /support expects profile/deal context
   - What's unclear: User mental model - is commenting part of "support"?
   - Recommendation: Start with `/comment` command for clarity, consider merging later

3. **Skip vs Done vs Pending for plan steps**
   - What we know: Current bot has `done` and `pending` only
   - What's unclear: Is "Skip" a needed status? What does it mean for reminders?
   - Recommendation: Add `skipped` status, treat as "don't remind but not completed"

4. **Research version limit**
   - What we know: No limit currently (JSONB can grow large)
   - What's unclear: How many versions is reasonable?
   - Recommendation: Start with soft limit of 10, oldest auto-archived

## Sources

### Primary (HIGH confidence)
- `/Users/dmytrolevin/Downloads/GD_playground/bot/handlers/support.py` - Current support flow implementation
- `/Users/dmytrolevin/Downloads/GD_playground/bot/handlers/leads.py` - Current leads management, step toggle, screenshot comment
- `/Users/dmytrolevin/Downloads/GD_playground/bot/services/engagement.py` - Comment generation service
- `/Users/dmytrolevin/Downloads/GD_playground/bot/services/llm_router.py` - web_research_call implementation
- `/Users/dmytrolevin/Downloads/GD_playground/packages/webapp/src/features/leads/components/LeadDetail.tsx` - TMA lead detail UI
- `/Users/dmytrolevin/Downloads/GD_playground/packages/webapp/src/features/leads/hooks/useUpdateLeadStatus.ts` - TMA mutation pattern

### Secondary (MEDIUM confidence)
- `/Users/dmytrolevin/Downloads/GD_playground/bot/storage/models.py` - Data models (LeadRegistryModel)
- `/Users/dmytrolevin/Downloads/GD_playground/packages/webapp/src/types/tables.ts` - TypeScript table types

### Tertiary (LOW confidence)
- PostgreSQL JSONB operator documentation (external)

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - All tools already in use in codebase
- Architecture: HIGH - Patterns derived from existing implementations
- Pitfalls: MEDIUM - Based on common issues, not observed failures

**Research date:** 2026-02-05
**Valid until:** 30 days (stable domain, no external API changes expected)
