---
phase: 15.1-lead-enhancements
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/webapp/src/features/leads/hooks/useUpdatePlanStep.ts
  - packages/webapp/src/features/leads/components/LeadDetail.tsx
  - packages/webapp/src/features/leads/types.ts
autonomous: true

must_haves:
  truths:
    - "User can tap engagement plan step in TMA to mark it Done"
    - "User can tap engagement plan step in TMA to mark it Skipped"
    - "UI shows immediate feedback (optimistic update)"
    - "Both scheduled_reminders and engagement_plan JSONB stay in sync"
  artifacts:
    - path: "packages/webapp/src/features/leads/hooks/useUpdatePlanStep.ts"
      provides: "Mutation hook for step status changes"
      exports: ["useUpdatePlanStep"]
    - path: "packages/webapp/src/features/leads/components/LeadDetail.tsx"
      provides: "Interactive engagement plan steps with toggle buttons"
      contains: "useUpdatePlanStep"
  key_links:
    - from: "packages/webapp/src/features/leads/components/LeadDetail.tsx"
      to: "packages/webapp/src/features/leads/hooks/useUpdatePlanStep.ts"
      via: "useUpdatePlanStep hook call"
      pattern: "useUpdatePlanStep"
    - from: "packages/webapp/src/features/leads/hooks/useUpdatePlanStep.ts"
      to: "InsForge database"
      via: "getInsforge().database.from('lead_registry').update"
      pattern: "engagement_plan"
---

<objective>
Enable engagement plan step status updates directly from the TMA lead detail page.

Purpose: Users can mark engagement plan steps as Done or Skip from the mobile app without switching to the bot. This provides immediate feedback and syncs both the engagement_plan JSONB in lead_registry and the corresponding scheduled_reminders row.

Output:
- New mutation hook: useUpdatePlanStep
- Updated LeadDetail component with interactive step toggles
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15.1-lead-enhancements/15.1-RESEARCH.md

# Existing patterns to follow
@packages/webapp/src/features/leads/hooks/useUpdateLeadStatus.ts
@packages/webapp/src/features/leads/components/LeadDetail.tsx
@packages/webapp/src/features/leads/types.ts
@packages/webapp/src/lib/queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useUpdatePlanStep mutation hook</name>
  <files>
    packages/webapp/src/features/leads/hooks/useUpdatePlanStep.ts
    packages/webapp/src/features/leads/types.ts
  </files>
  <action>
1. Update `packages/webapp/src/features/leads/types.ts`:
   - Add type for step status: `type PlanStepStatus = 'pending' | 'done' | 'skipped';`
   - Ensure EngagementPlanStep type includes status field (should already exist)

2. Create `packages/webapp/src/features/leads/hooks/useUpdatePlanStep.ts`:
   - Follow pattern from useUpdateLeadStatus.ts exactly
   - Interface:
     ```typescript
     interface UpdatePlanStepVars {
       leadId: number;
       stepId: number;
       newStatus: 'done' | 'skipped' | 'pending';
       telegramId: number;
     }
     ```

   - mutationFn:
     1. Fetch current lead's engagement_plan from lead_registry
     2. Update the step with matching step_id:
        - Set status to newStatus
        - If done/skipped, set completed_at to current ISO timestamp
        - If pending, set completed_at to null
     3. Write updated engagement_plan back to lead_registry
     4. Also update scheduled_reminders row:
        - Query for row with lead_id and step_id
        - If found, update status to:
          - 'completed' if newStatus is 'done'
          - 'skipped' if newStatus is 'skipped'
          - 'pending' if newStatus is 'pending'

   - onMutate (optimistic update):
     1. Cancel queries for leads.detail(leadId)
     2. Snapshot previous lead data
     3. Optimistically update the step status in cache

   - onError: Rollback to snapshot

   - onSettled: Invalidate leads.detail(leadId) and leads.byUser(telegramId)

Note: scheduled_reminders table has columns: lead_id, step_id, status. The status field
maps to: pending, sent, completed, skipped, cancelled.
  </action>
  <verify>
    - File exists: `ls packages/webapp/src/features/leads/hooks/useUpdatePlanStep.ts`
    - Hook exported: `grep "export function useUpdatePlanStep" packages/webapp/src/features/leads/hooks/useUpdatePlanStep.ts`
    - Uses React Query: `grep "useMutation" packages/webapp/src/features/leads/hooks/useUpdatePlanStep.ts`
  </verify>
  <done>
    - useUpdatePlanStep hook created
    - Mutation updates both engagement_plan JSONB and scheduled_reminders
    - Optimistic update implemented
    - Error rollback implemented
  </done>
</task>

<task type="auto">
  <name>Task 2: Add interactive step toggles to LeadDetail</name>
  <files>
    packages/webapp/src/features/leads/components/LeadDetail.tsx
  </files>
  <action>
1. Import useUpdatePlanStep hook at top of file

2. In LeadDetail component, add mutation instance:
   ```typescript
   const stepMutation = useUpdatePlanStep();
   ```

3. Add handler function:
   ```typescript
   const handleStepToggle = useCallback(
     (stepId: number, currentStatus: string) => {
       if (!lead || !telegramId) return;
       // Cycle: pending -> done -> skipped -> pending
       let newStatus: 'done' | 'skipped' | 'pending';
       if (currentStatus === 'pending') {
         newStatus = 'done';
       } else if (currentStatus === 'done') {
         newStatus = 'skipped';
       } else {
         newStatus = 'pending';
       }
       stepMutation.mutate(
         { leadId: lead.id, stepId, newStatus, telegramId },
         {
           onSuccess: () => {
             toast({ type: 'success', message: `Step ${stepId} marked ${newStatus}` });
           },
           onError: () => {
             toast({
               type: 'error',
               message: 'Failed to update step',
               action: { label: 'Retry', onClick: () => handleStepToggle(stepId, currentStatus) },
             });
           },
         }
       );
     },
     [lead, telegramId, stepMutation, toast],
   );
   ```

4. Update Engagement Plan section rendering:
   - Replace static Badge with clickable button
   - Add visual feedback for pending mutation (spinner or opacity)
   - Show status with appropriate styling:
     - done: green check, success variant
     - skipped: gray skip icon, default variant
     - pending: empty checkbox, default variant

   Replace this section:
   ```tsx
   <Badge
     variant={step.status === 'done' ? 'success' : 'default'}
     size="sm"
   >
     {step.status === 'done' ? 'Done' : 'Pending'}
   </Badge>
   ```

   With interactive button:
   ```tsx
   <button
     type="button"
     onClick={() => handleStepToggle(step.step_id, step.status)}
     disabled={stepMutation.isPending}
     className="flex min-h-[32px] items-center gap-1 rounded-lg px-2 py-1 text-xs font-medium transition-colors active:scale-95"
     style={{
       backgroundColor: step.status === 'done' ? 'var(--success-bg)' :
                        step.status === 'skipped' ? 'var(--hint-bg)' : 'var(--surface-secondary)',
       color: step.status === 'done' ? 'var(--success)' :
              step.status === 'skipped' ? 'var(--hint)' : 'var(--text-secondary)',
     }}
   >
     {step.status === 'done' && <Check className="h-3 w-3" />}
     {step.status === 'skipped' && <SkipForward className="h-3 w-3" />}
     {step.status === 'pending' && <Circle className="h-3 w-3" />}
     {step.status === 'done' ? 'Done' : step.status === 'skipped' ? 'Skipped' : 'Pending'}
   </button>
   ```

5. Import necessary icons from lucide-react: `Check`, `SkipForward`, `Circle`

Note: Use Tailwind's color variables from the design system (--success, --hint, etc.)
or explicit Tailwind classes like bg-success/15 text-success.
  </action>
  <verify>
    - Hook imported: `grep "useUpdatePlanStep" packages/webapp/src/features/leads/components/LeadDetail.tsx`
    - Handler exists: `grep "handleStepToggle" packages/webapp/src/features/leads/components/LeadDetail.tsx`
    - Build passes: `cd packages/webapp && npm run build`
  </verify>
  <done>
    - LeadDetail imports and uses useUpdatePlanStep hook
    - Engagement plan steps are clickable buttons
    - Clicking cycles through pending -> done -> skipped -> pending
    - Toast feedback on success/error
    - UI shows optimistic update immediately
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes (no type errors)
2. TMA build completes successfully
3. Manual test in TMA:
   - Open a lead with engagement plan
   - Tap a step badge to toggle status
   - Verify status changes immediately (optimistic)
   - Refresh page to confirm server state matches
4. Verify scheduled_reminders table also gets updated (check via SQL query or bot reminder behavior)
</verification>

<success_criteria>
- useUpdatePlanStep hook exists and follows useUpdateLeadStatus pattern
- LeadDetail engagement plan section has clickable step toggles
- Status cycles: pending -> done -> skipped -> pending
- Both engagement_plan JSONB and scheduled_reminders stay in sync
- Optimistic updates provide instant feedback
- Error handling with toast notifications
</success_criteria>

<output>
After completion, create `.planning/phases/15.1-lead-enhancements/15.1-02-SUMMARY.md`
</output>
