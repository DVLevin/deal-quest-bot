---
phase: 15.1-lead-enhancements
plan: 01
subsystem: leads
tags: [web-research, versioning, jsonb, bot-handlers]

dependency-graph:
  requires:
    - Phase 13 (Smart Lead Creation) - lead_registry table
    - web_research_call in llm_router.py
  provides:
    - Web research versioning with re-run capability
    - Version history preservation
    - User-triggered re-research with optional URL
  affects:
    - Future phases using lead web research data

tech-stack:
  added: []
  patterns:
    - JSONB versioned history with current_version_id pointer
    - Backward-compatible dual-write (versions + legacy field)

file-tracking:
  created:
    - insforge/migrations/003_web_research_versions.sql
  modified:
    - bot/storage/models.py (LeadRegistryModel.web_research_versions)
    - bot/storage/repositories.py (add_research_version, delete_research_version)
    - bot/states.py (LeadEngagementState.reresearch_input)
    - bot/handlers/leads.py (re-research flow, versions view, delete version)

decisions: []

metrics:
  duration: 3m
  completed: 2026-02-05
---

# Phase 15.1 Plan 01: Web Research Versioning Summary

Web research versioning with re-run capability via JSONB history, URL-enhanced queries, and bot UI for version management.

## What Was Built

### 1. Schema Migration (003_web_research_versions.sql)
- Added `web_research_versions JSONB DEFAULT NULL` column to lead_registry
- Structure: `{"versions": [...], "current_version_id": N}`
- Each version stores: version_id, created_at, query_used, url_provided, content
- Preserves existing `web_research TEXT` column for backward compatibility

### 2. Model & Repository Updates
- Added `web_research_versions: dict[str, Any] | None` field to LeadRegistryModel
- `add_research_version()`: Appends new version with auto-incremented ID, updates both JSONB and legacy field
- `delete_research_version()`: Removes version, updates current pointer if needed

### 3. Bot Handlers
- **Re-research button** in lead detail keyboard
- **Versions button** shows when multiple versions exist
- **Re-research flow**: User can send URL or "go" to trigger re-research
- **Versions view**: Lists all versions with created date and URL indicator
- **Delete version**: Removes specific version (minimum 1 required)

## Key Patterns

1. **Dual-write backward compatibility**: New code writes to both `web_research_versions` (full history) and `web_research` (current content)
2. **Auto-increment version IDs**: Each new version gets max(existing) + 1
3. **URL extraction**: Supports http/https URLs, linkedin.com shorthand, or plain text hints
4. **Current version pointer**: Tracks which version is "active" for legacy field sync

## Files Changed

| File | Change |
|------|--------|
| insforge/migrations/003_web_research_versions.sql | New JSONB column migration |
| bot/storage/models.py | web_research_versions field |
| bot/storage/repositories.py | add_research_version, delete_research_version methods |
| bot/states.py | reresearch_input state |
| bot/handlers/leads.py | Re-research flow + versions UI handlers |

## Deviations from Plan

None - plan executed exactly as written.

## Verification

- [x] Migration SQL file exists and is syntactically valid
- [x] Model has web_research_versions field
- [x] Repository has version management methods
- [x] All Python files compile successfully
- [x] Re-research button added to lead detail keyboard
- [x] Versions button shows when multiple versions exist
- [x] Delete version handler prevents deleting last version

## Pending User Action

Run migration on InsForge database:
```sql
-- In InsForge SQL editor
\i insforge/migrations/003_web_research_versions.sql
```

## Next Phase Readiness

Ready for Phase 15.1-02 (Re-analysis on New Context) - this plan provides the versioned research foundation.
