---
phase: 14-engagement-plan-execution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bot/storage/repositories.py
  - bot/services/plan_scheduler.py
autonomous: true

must_haves:
  truths:
    - "Due reminders are sent with lead name, step description, and draft preview"
    - "Reminder messages include Done/Snooze/Skip/ViewDraft inline buttons"
    - "Overdue reminders escalate through 3 levels before auto-snoozing"
  artifacts:
    - path: "bot/storage/repositories.py"
      provides: "snooze() method on ScheduledReminderRepo"
      contains: "async def snooze"
    - path: "bot/services/plan_scheduler.py"
      provides: "Rich reminder messages with escalation logic"
      contains: "_reminder_action_keyboard"
  key_links:
    - from: "bot/services/plan_scheduler.py"
      to: "bot/storage/repositories.py"
      via: "reminder_repo.snooze() call for auto-snooze"
      pattern: "reminder_repo\\.snooze"
---

<objective>
Upgrade the plan scheduler to send rich reminder messages with inline action buttons and implement escalation logic that progressively nudges users without spamming.

Purpose: Phase 12 established the scheduling infrastructure with basic text notifications. This plan upgrades the notification format to be actionable (inline buttons) and intelligent (escalation logic), enabling users to respond directly from the reminder message.

Output: Enhanced `plan_scheduler.py` with rich Markdown formatting, inline keyboard generation, 3-level escalation logic with auto-snooze, and the supporting `snooze()` method in `ScheduledReminderRepo`.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-engagement-plan-execution/14-RESEARCH.md

@bot/services/plan_scheduler.py
@bot/storage/repositories.py
@bot/storage/models.py
@bot/handlers/leads.py (inline keyboard patterns, lines 370-580)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add snooze() method to ScheduledReminderRepo</name>
  <files>bot/storage/repositories.py</files>
  <action>
Add a `snooze()` method to `ScheduledReminderRepo` class. The method should:

1. Accept `reminder_id: int` and `new_due_iso: str` parameters
2. Query the reminder to get current `snooze_count`
3. Update the reminder with:
   - `due_at` = new_due_iso
   - `status` = "pending" (reset to pending for next dispatch)
   - `snooze_count` = current + 1
   - `updated_at` = now

Place this method after `update_status()` and before `delete_for_lead()`.

Pattern reference (from repositories.py):
```python
async def snooze(self, reminder_id: int, new_due_iso: str) -> None:
    """Snooze a reminder by updating due_at and incrementing snooze_count."""
    rows = await self.client.query(
        self.table,
        filters={"id": reminder_id},
        limit=1,
    )
    if not rows or not isinstance(rows, list) or len(rows) == 0:
        return

    current_snooze = rows[0].get("snooze_count", 0)
    now = datetime.now(timezone.utc).isoformat()

    await self.client.update(
        self.table,
        {"id": reminder_id},
        {
            "due_at": new_due_iso,
            "status": "pending",
            "snooze_count": current_snooze + 1,
            "updated_at": now,
        },
    )
```
  </action>
  <verify>
Grep for `async def snooze` in repositories.py confirms method exists.
Method signature matches: `async def snooze(self, reminder_id: int, new_due_iso: str) -> None`
  </verify>
  <done>
ScheduledReminderRepo has snooze() method that updates due_at, resets status to pending, and increments snooze_count.
  </done>
</task>

<task type="auto">
  <name>Task 2: Upgrade plan_scheduler.py with rich messages and escalation</name>
  <files>bot/services/plan_scheduler.py</files>
  <action>
Upgrade `_process_due_plan_reminders()` in `plan_scheduler.py` to:

1. **Add imports** at the top:
   ```python
   from aiogram.types import InlineKeyboardButton, InlineKeyboardMarkup
   ```

2. **Add escalation constants** after PLAN_CHECK_INTERVAL:
   ```python
   MAX_ESCALATION = 3  # After 3 reminder sends, auto-snooze for 7 days
   ```

3. **Add helper function `_format_reminder_message()`** that formats rich Markdown:
   - Include lead name and company
   - Escalation tone (initial, nudge, final) based on reminder_count
   - Step description from engagement_plan
   - Draft preview truncated to 150 chars
   - Bell emoji for levels 0-1, exclamation for level 2

4. **Add helper function `_reminder_action_keyboard()`** that creates inline keyboard:
   - Row 1: Done, Snooze 24h, Skip buttons
   - Row 2: View Full Draft button
   - Row 3: View Lead button
   - Use callback_data format: `reminder:{action}:{lead_id}:{step_id}`

5. **Upgrade `_process_due_plan_reminders()`** to:
   - Check `reminder_count >= MAX_ESCALATION` and auto-snooze for 7 days using `reminder_repo.snooze()`
   - Send auto-snooze notification message (no keyboard)
   - For normal reminders: get step details from lead.engagement_plan
   - Format message with `_format_reminder_message()`
   - Attach keyboard with `_reminder_action_keyboard()`
   - Send with `reply_markup=keyboard`

Implementation details:

```python
def _format_reminder_message(
    lead: LeadRegistryModel,
    reminder: ScheduledReminderModel,
    step: dict | None,
    escalation_level: int,
) -> str:
    """Format a rich reminder message with escalation tone."""
    name = lead.prospect_name or f"Lead #{lead.id}"
    company = f" @ {lead.prospect_company}" if lead.prospect_company else ""

    # Get step details
    step_desc = ""
    if step:
        step_desc = step.get("description", "")

    # Escalation tone
    if escalation_level == 0:
        icon = "\U0001F514"  # bell
        intro = "Time for your next engagement step!"
    elif escalation_level == 1:
        icon = "\U0001F514"  # bell
        intro = "Gentle reminder: this step is still pending."
    else:
        icon = "\u2757"  # exclamation
        intro = "Final reminder before auto-snooze."

    # Draft preview (truncated)
    draft_preview = ""
    draft_text = reminder.draft_text or (step.get("suggested_text") if step else None)
    if draft_text:
        preview = draft_text[:150].replace("\n", " ")
        draft_preview = f'\n\n\U0001F4DD *Draft:* "{preview}..."'

    return (
        f"{icon} *Engagement Step Due: {name}{company}*\n\n"
        f"{intro}\n\n"
        f"\U0001F4CB *Step {reminder.step_id}:* {step_desc}\n"
        f"{draft_preview}"
    )


def _reminder_action_keyboard(lead_id: int, step_id: int) -> InlineKeyboardMarkup:
    """Build inline keyboard for reminder actions."""
    return InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(
                text="\u2705 Done",
                callback_data=f"reminder:done:{lead_id}:{step_id}"
            ),
            InlineKeyboardButton(
                text="\u23F0 Snooze 24h",
                callback_data=f"reminder:snooze:{lead_id}:{step_id}"
            ),
            InlineKeyboardButton(
                text="\u23ED Skip",
                callback_data=f"reminder:skip:{lead_id}:{step_id}"
            ),
        ],
        [
            InlineKeyboardButton(
                text="\U0001F4DD View Full Draft",
                callback_data=f"reminder:draft:{lead_id}:{step_id}"
            ),
        ],
        [
            InlineKeyboardButton(
                text="\U0001F4CB View Lead",
                callback_data=f"lead:view:{lead_id}"
            ),
        ],
    ])
```

Update `_process_due_plan_reminders()` loop to:

```python
# Check escalation level
reminder_count = reminder.reminder_count or 0

if reminder_count >= MAX_ESCALATION:
    # Auto-snooze for 7 days
    new_due = now + timedelta(days=7)
    await reminder_repo.snooze(reminder.id, new_due.isoformat())  # type: ignore[arg-type]

    # Notify user of auto-snooze
    lead = await lead_repo.get_by_id(reminder.lead_id)
    if lead:
        name = lead.prospect_name or f"Lead #{lead.id}"
        await bot.send_message(
            chat_id=reminder.telegram_id,
            text=(
                f"\u23F8 *Auto-snoozed: {name} - Step {reminder.step_id}*\n\n"
                f"This step has been automatically snoozed for 7 days "
                f"after {MAX_ESCALATION} reminders.\n\n"
                f"Use /leads to manage your engagement plans."
            ),
            parse_mode="Markdown",
        )
    continue

# ... rest of the existing code for normal reminders, but replace the
# simple text message with:

# Get step details from engagement_plan
step = None
if lead.engagement_plan:
    for s in lead.engagement_plan:
        if s.get("step_id") == reminder.step_id:
            step = s
            break

# Build rich message
text = _format_reminder_message(lead, reminder, step, reminder_count)
keyboard = _reminder_action_keyboard(lead.id, reminder.step_id)  # type: ignore[arg-type]

# Send notification with inline keyboard
await bot.send_message(
    chat_id=reminder.telegram_id,
    text=text,
    parse_mode="Markdown",
    reply_markup=keyboard,
)
```
  </action>
  <verify>
1. Grep for `MAX_ESCALATION` in plan_scheduler.py confirms constant exists
2. Grep for `_reminder_action_keyboard` confirms helper exists
3. Grep for `reply_markup=keyboard` in send_message confirms inline keyboard attached
4. Grep for `reminder_repo.snooze` confirms auto-snooze logic wired
  </verify>
  <done>
plan_scheduler.py sends rich formatted reminder messages with lead/step context, inline action buttons (Done/Snooze/Skip/ViewDraft/ViewLead), and escalation logic that auto-snoozes after 3 reminders.
  </done>
</task>

</tasks>

<verification>
1. ScheduledReminderRepo.snooze() method exists and updates due_at, status, snooze_count
2. plan_scheduler.py imports InlineKeyboardButton, InlineKeyboardMarkup
3. _format_reminder_message() helper produces Markdown with escalation tones
4. _reminder_action_keyboard() helper builds 3-row inline keyboard
5. _process_due_plan_reminders() sends rich messages with keyboard for normal reminders
6. Auto-snooze logic triggers after MAX_ESCALATION (3) reminders
7. No syntax errors (python -m py_compile bot/services/plan_scheduler.py passes)
</verification>

<success_criteria>
- Due reminders are sent with lead name, company, step description, and draft preview
- Reminder messages include Done/Snooze/Skip buttons in first row, View Full Draft in second, View Lead in third
- Escalation tone changes from initial -> nudge -> final based on reminder_count
- After 3 reminders, step is auto-snoozed for 7 days with notification to user
- Callback_data format is `reminder:{action}:{lead_id}:{step_id}` for handler parsing
</success_criteria>

<output>
After completion, create `.planning/phases/14-engagement-plan-execution/14-01-SUMMARY.md`
</output>
