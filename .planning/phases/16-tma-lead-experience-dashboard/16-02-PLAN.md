---
phase: 16-tma-lead-experience-dashboard
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/webapp/src/shared/ui/CollapsibleSection.tsx
  - packages/webapp/src/features/leads/components/LeadDetail.tsx
autonomous: true

must_haves:
  truths:
    - "Opening a lead shows Active Plan section first (expanded by default)"
    - "Intelligence section contains analysis, strategy, tactics, draft"
    - "Activity section contains notes and timeline"
    - "Deep link with ?step=X query param scrolls to and highlights that step"
  artifacts:
    - path: "packages/webapp/src/shared/ui/CollapsibleSection.tsx"
      provides: "Reusable collapsible accordion section"
      exports: ["CollapsibleSection"]
    - path: "packages/webapp/src/features/leads/components/LeadDetail.tsx"
      provides: "Plan-first layout with three collapsible sections"
      contains: "CollapsibleSection"
  key_links:
    - from: "LeadDetail.tsx"
      to: "react-router useSearchParams"
      via: "query param parsing for step highlight"
      pattern: "useSearchParams|searchParams"
    - from: "LeadDetail.tsx"
      to: "CollapsibleSection"
      via: "section rendering"
      pattern: "CollapsibleSection"
---

<objective>
Restructure LeadDetail with plan-first layout: Active Plan section opens first, Intelligence (analysis/strategy/tactics/draft) and Activity (notes/timeline) are collapsible secondary sections.

Purpose: Users see actionable engagement steps immediately when opening a lead, with intelligence and history available on demand (TMAUX-V20-01).
Output: CollapsibleSection UI component, restructured LeadDetail with three-section accordion layout and deep link step highlighting.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-tma-lead-experience-dashboard/16-RESEARCH.md

@packages/webapp/src/features/leads/components/LeadDetail.tsx
@packages/webapp/src/features/leads/components/ActivityTimeline.tsx
@packages/webapp/src/features/leads/components/LeadNotes.tsx
@packages/webapp/src/shared/ui/Card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CollapsibleSection UI component</name>
  <files>
    packages/webapp/src/shared/ui/CollapsibleSection.tsx
    packages/webapp/src/shared/ui/index.ts
  </files>
  <action>
Create a reusable collapsible section component for accordion-style layouts.

```typescript
// CollapsibleSection.tsx
import { type ComponentType, type ReactNode } from 'react';
import { ChevronDown } from 'lucide-react';
import { Card, Badge } from '@/shared/ui';
import { cn } from '@/lib/utils';

interface CollapsibleSectionProps {
  title: string;
  icon: ComponentType<{ className?: string }>;
  isOpen: boolean;
  onToggle: () => void;
  badge?: string;
  badgeVariant?: 'default' | 'info' | 'warning' | 'success' | 'error' | 'brand';
  children: ReactNode;
}

export function CollapsibleSection({
  title,
  icon: Icon,
  isOpen,
  onToggle,
  badge,
  badgeVariant = 'error',
  children,
}: CollapsibleSectionProps) {
  return (
    <Card padding="sm">
      <button
        type="button"
        onClick={onToggle}
        className="flex w-full items-center gap-2 text-left"
      >
        <Icon className="h-4 w-4 text-accent" />
        <span className="flex-1 text-sm font-semibold text-text">{title}</span>
        {badge && (
          <Badge variant={badgeVariant} size="sm">
            {badge}
          </Badge>
        )}
        <ChevronDown
          className={cn(
            'h-4 w-4 text-text-hint transition-transform duration-200',
            isOpen && 'rotate-180'
          )}
        />
      </button>
      <div
        className={cn(
          'overflow-hidden transition-all duration-200',
          isOpen ? 'mt-3 max-h-[2000px] opacity-100' : 'max-h-0 opacity-0'
        )}
      >
        {children}
      </div>
    </Card>
  );
}
```

Export from shared/ui/index.ts if there is one, or note that imports should use direct path.
  </action>
  <verify>
    TypeScript compilation passes: `cd packages/webapp && npx tsc --noEmit`
  </verify>
  <done>
    - CollapsibleSection component exported
    - Accepts icon, title, isOpen, onToggle, optional badge props
    - Smooth expand/collapse animation with CSS transitions
  </done>
</task>

<task type="auto">
  <name>Task 2: Restructure LeadDetail with plan-first collapsible sections</name>
  <files>
    packages/webapp/src/features/leads/components/LeadDetail.tsx
  </files>
  <action>
Refactor LeadDetail to use three collapsible sections: Active Plan (default open), Intelligence, Activity.

1. Add imports:
   - `import { useSearchParams } from 'react-router';`
   - `import { CollapsibleSection } from '@/shared/ui/CollapsibleSection';`
   - `import { Brain, History as HistoryIcon } from 'lucide-react';` (for Intelligence and Activity icons)

2. Add state for active section:
   ```typescript
   type SectionId = 'plan' | 'intel' | 'activity';
   const [activeSection, setActiveSection] = useState<SectionId>('plan');
   const toggleSection = (id: SectionId) => {
     setActiveSection((prev) => (prev === id ? id : id));
     // Note: always open clicked section (accordion behavior)
   };
   ```

3. Add deep link handling for step highlighting:
   ```typescript
   const [searchParams] = useSearchParams();
   const highlightStepId = searchParams.get('step') ? Number(searchParams.get('step')) : null;
   const stepRefs = useRef<Record<number, HTMLDivElement | null>>({});

   // Scroll to highlighted step after data loads
   useEffect(() => {
     if (highlightStepId && !isLoading && lead && stepRefs.current[highlightStepId]) {
       // Ensure plan section is open
       setActiveSection('plan');
       setTimeout(() => {
         stepRefs.current[highlightStepId]?.scrollIntoView({
           behavior: 'smooth',
           block: 'center',
         });
       }, 100);
     }
   }, [highlightStepId, isLoading, lead]);
   ```

4. Reorganize the return JSX:
   - Keep: Header (photo, name, title, company, status badges)
   - Keep: LeadStatusSelector
   - SECTION 1 - Active Plan (CollapsibleSection):
     - title="Active Plan", icon=ListChecks
     - isOpen={activeSection === 'plan'}
     - Badge showing overdue count if any (compute from engagementPlan + reminders)
     - Content: Current engagement plan step rendering (move from existing code)
     - Add ref to each step div: `ref={(el) => { stepRefs.current[step.step_id] = el; }}`
     - Add highlight styling when step.step_id === highlightStepId: extra ring-2 ring-accent animation
   - SECTION 2 - Intelligence (CollapsibleSection):
     - title="Intelligence", icon=Brain
     - isOpen={activeSection === 'intel'}
     - Content: AnalysisSection, StrategyDisplay, TacticsDisplay, Draft section (move from existing)
   - SECTION 3 - Activity (CollapsibleSection):
     - title="Activity", icon=HistoryIcon
     - isOpen={activeSection === 'activity'}
     - Content: LeadNotes, ActivityTimeline (move from existing)

5. Highlight animation for deep-linked step:
   ```typescript
   const isHighlighted = step.step_id === highlightStepId;
   // In step div className:
   className={cn(
     'flex items-start gap-3 rounded-lg bg-surface-secondary/30 p-2',
     isHighlighted && 'ring-2 ring-accent animate-pulse'
   )}
   ```
   - Use animate-pulse for 2 seconds then remove (useEffect with setTimeout to clear highlightStepId from visual state)

6. Remove the old flat section rendering; all content now inside CollapsibleSections.
  </action>
  <verify>
    - Run `cd packages/webapp && npm run build` to verify production build succeeds
    - Check that LeadDetail renders with collapsible sections in dev mode
  </verify>
  <done>
    - LeadDetail opens with Active Plan section expanded
    - Intelligence section contains analysis, strategy, tactics, draft
    - Activity section contains notes and timeline
    - Deep link ?step=X scrolls to and highlights that step with animation
    - Clicking section headers toggles open/closed state
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Production build succeeds
3. LeadDetail renders three collapsible sections
4. Active Plan section is open by default
5. Clicking a section header toggles it open
6. Deep link /leads/123?step=2 scrolls to step 2 and highlights it
7. Highlight animation visible for a few seconds then fades
</verification>

<success_criteria>
- Opening a lead shows Active Plan section first (expanded by default)
- Intelligence section (collapsed) contains all analysis content
- Activity section (collapsed) contains notes and timeline
- Navigating via /leads/:id?step=X scrolls to and highlights the specified step
- Accordion behavior: clicking section opens it, previous section collapses
</success_criteria>

<output>
After completion, create `.planning/phases/16-tma-lead-experience-dashboard/16-02-SUMMARY.md`
</output>
