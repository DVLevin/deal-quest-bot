---
phase: 16-tma-lead-experience-dashboard
plan: 04
type: execute
wave: 2
depends_on: []
files_modified:
  - bot/utils_tma.py
  - bot/services/plan_scheduler.py
autonomous: true

must_haves:
  truths:
    - "Bot reminder messages include an Open in App button"
    - "Open in App button deep-links to the lead detail with step highlighted via query param"
  artifacts:
    - path: "bot/utils_tma.py"
      provides: "Extended add_open_in_app_row with query_params support"
      contains: "query_params"
    - path: "bot/services/plan_scheduler.py"
      provides: "Reminder messages with Open in App button"
      contains: "add_open_in_app_row"
  key_links:
    - from: "plan_scheduler.py"
      to: "utils_tma.py"
      via: "import and call add_open_in_app_row"
      pattern: "add_open_in_app_row"
---

<objective>
Add "Open in App" deep link button to bot reminder messages that navigates to the specific lead with the step highlighted.

Purpose: Users can tap from a reminder directly into the TMA at the exact step that needs attention (TMAUX-V20-05).
Output: Extended utils_tma.py with query_params support, plan_scheduler.py using it for reminder messages.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-tma-lead-experience-dashboard/16-RESEARCH.md

@bot/utils_tma.py
@bot/services/plan_scheduler.py
@bot/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend add_open_in_app_row with query_params support</name>
  <files>
    bot/utils_tma.py
  </files>
  <action>
Extend the add_open_in_app_row function to accept optional query_params dict.

Update the function signature and implementation:

```python
def add_open_in_app_row(
    keyboard: InlineKeyboardMarkup | None,
    tma_url: str,
    path: str = "",
    query_params: dict[str, str] | None = None,
) -> InlineKeyboardMarkup | None:
    """Append an 'Open in App' WebApp button as the last row of a keyboard.

    If tma_url is empty/falsy, returns the keyboard unchanged (graceful skip).
    If keyboard is None and tma_url is set, returns a new keyboard with just the button.

    Args:
        keyboard: Existing keyboard to append to (or None)
        tma_url: Base TMA URL from config
        path: Optional path segment (e.g., "leads/123")
        query_params: Optional dict of query params (e.g., {"step": "2"})
    """
    if not tma_url:
        return keyboard

    url = f"{tma_url}/{path}" if path else tma_url

    # Append query string if params provided
    if query_params:
        qs = "&".join(f"{k}={v}" for k, v in query_params.items())
        url = f"{url}?{qs}"

    new_row = [InlineKeyboardButton(text="Open in App", web_app=WebAppInfo(url=url))]

    if keyboard is None:
        return InlineKeyboardMarkup(inline_keyboard=[new_row])

    return InlineKeyboardMarkup(inline_keyboard=[*keyboard.inline_keyboard, new_row])
```

This is backward-compatible - existing callers without query_params continue to work.
  </action>
  <verify>
    Python syntax check: `python3 -m py_compile bot/utils_tma.py`
  </verify>
  <done>
    - add_open_in_app_row accepts optional query_params parameter
    - Query string is correctly appended to URL when params provided
    - Backward compatible with existing callers
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Open in App button to reminder messages in plan_scheduler.py</name>
  <files>
    bot/services/plan_scheduler.py
  </files>
  <action>
Update plan_scheduler.py to add "Open in App" button to reminder messages.

1. Add imports at top:
   ```python
   from bot.config import settings
   from bot.utils_tma import add_open_in_app_row
   ```

2. Update _reminder_action_keyboard function to add Open in App row:
   ```python
   def _reminder_action_keyboard(lead_id: int, step_id: int) -> InlineKeyboardMarkup:
       """Build inline keyboard for reminder actions."""
       keyboard = InlineKeyboardMarkup(inline_keyboard=[
           [
               InlineKeyboardButton(
                   text="\u2705 Done",
                   callback_data=f"reminder:done:{lead_id}:{step_id}"
               ),
               InlineKeyboardButton(
                   text="\u23F0 Snooze 24h",
                   callback_data=f"reminder:snooze:{lead_id}:{step_id}"
               ),
               InlineKeyboardButton(
                   text="\u23ED Skip",
                   callback_data=f"reminder:skip:{lead_id}:{step_id}"
               ),
           ],
           [
               InlineKeyboardButton(
                   text="\U0001F4DD View Full Draft",
                   callback_data=f"reminder:draft:{lead_id}:{step_id}"
               ),
           ],
           [
               InlineKeyboardButton(
                   text="\U0001F4CB View Lead",
                   callback_data=f"lead:view:{lead_id}"
               ),
           ],
       ])

       # Add "Open in App" button with deep link to specific step
       keyboard = add_open_in_app_row(
           keyboard,
           settings.tma_url,
           path=f"leads/{lead_id}",
           query_params={"step": str(step_id)},
       )

       return keyboard  # type: ignore[return-value]
   ```

   Note: add_open_in_app_row returns InlineKeyboardMarkup | None, but we know it returns the keyboard since we pass a valid keyboard. The type: ignore is safe here.
  </action>
  <verify>
    Python syntax check: `python3 -m py_compile bot/services/plan_scheduler.py`
  </verify>
  <done>
    - plan_scheduler.py imports add_open_in_app_row and settings
    - _reminder_action_keyboard adds "Open in App" button as last row
    - Deep link includes leads/{lead_id}?step={step_id} path
  </done>
</task>

</tasks>

<verification>
1. Python files compile without syntax errors
2. add_open_in_app_row correctly builds URLs with query params
3. Reminder keyboard includes "Open in App" button with deep link
4. If TMA_URL is not set, button is gracefully skipped (no crash)
</verification>

<success_criteria>
- Bot reminder messages include "Open in App" inline button
- Tapping "Open in App" opens TMA at /leads/{lead_id}?step={step_id}
- TMA scrolls to and highlights the specified step (handled by 16-02)
- Works correctly when TMA_URL is set; gracefully degrades when not set
</success_criteria>

<output>
After completion, create `.planning/phases/16-tma-lead-experience-dashboard/16-04-SUMMARY.md`
</output>
