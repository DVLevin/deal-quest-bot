---
phase: 16-tma-lead-experience-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/webapp/src/features/leads/types.ts
  - packages/webapp/src/features/leads/hooks/useLeads.ts
  - packages/webapp/src/features/leads/hooks/useLeadReminders.ts
  - packages/webapp/src/features/leads/components/LeadCard.tsx
autonomous: true

must_haves:
  truths:
    - "Lead list cards show overdue step count badge when steps are past due"
    - "Lead list cards show engagement plan progress bar"
    - "Lead list cards show next pending action preview text"
  artifacts:
    - path: "packages/webapp/src/features/leads/types.ts"
      provides: "computePlanProgress utility function"
      contains: "computePlanProgress"
    - path: "packages/webapp/src/features/leads/hooks/useLeadReminders.ts"
      provides: "Batched reminder query for all user leads"
      exports: ["useLeadReminders"]
    - path: "packages/webapp/src/features/leads/components/LeadCard.tsx"
      provides: "Enhanced lead card with progress bar, overdue badge, next action"
      contains: "ProgressBar"
  key_links:
    - from: "LeadCard.tsx"
      to: "types.ts"
      via: "computePlanProgress import"
      pattern: "computePlanProgress"
    - from: "LeadList.tsx (or Leads.tsx)"
      to: "useLeadReminders"
      via: "hook call for reminder data"
      pattern: "useLeadReminders"
---

<objective>
Enhance LeadCard with engagement plan visibility: overdue step count badge, progress bar, and next action preview.

Purpose: Users can scan their lead pipeline and immediately see which leads need attention (TMAUX-V20-03).
Output: Updated LeadCard component, useLeadReminders hook for batched reminder data, computePlanProgress utility.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-tma-lead-experience-dashboard/16-RESEARCH.md

@packages/webapp/src/features/leads/types.ts
@packages/webapp/src/features/leads/hooks/useLeads.ts
@packages/webapp/src/features/leads/components/LeadCard.tsx
@packages/webapp/src/features/leads/components/LeadList.tsx
@packages/webapp/src/pages/Leads.tsx
@packages/webapp/src/lib/queries.ts
@packages/webapp/src/shared/ui/ProgressBar.tsx
@packages/webapp/src/shared/ui/Badge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add computePlanProgress utility and extend useLeads</name>
  <files>
    packages/webapp/src/features/leads/types.ts
    packages/webapp/src/features/leads/hooks/useLeads.ts
    packages/webapp/src/lib/queries.ts
  </files>
  <action>
1. Add to types.ts:
   - Interface `PlanProgress { total: number; completed: number; overdue: number; nextAction: string | null; }`
   - Function `computePlanProgress(plan: EngagementPlanStep[] | null, remindersDueAt: Map<number, string> | null): PlanProgress`
   - Logic: iterate plan steps, count done/skipped as completed, count pending steps with past due_at as overdue, capture first pending step description as nextAction
   - If remindersDueAt is null, cannot compute overdue (set to 0)

2. Update useLeads.ts:
   - Add `engagement_plan` to the select query (it's JSONB, comes pre-parsed)
   - Update LeadListItem type to include `engagement_plan: EngagementPlanStep[] | null`

3. Add to queries.ts:
   - Add `reminders: (telegramId: number) => ['leads', 'reminders', telegramId] as const` inside leads key
  </action>
  <verify>
    TypeScript compilation passes: `cd packages/webapp && npx tsc --noEmit`
  </verify>
  <done>
    - computePlanProgress function exported from types.ts
    - useLeads returns engagement_plan field
    - queryKeys.leads.reminders key exists
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useLeadReminders hook for batched reminder data</name>
  <files>
    packages/webapp/src/features/leads/hooks/useLeadReminders.ts
  </files>
  <action>
Create a new hook that fetches all pending/sent scheduled_reminders for the current user in one query.

```typescript
// useLeadReminders.ts
import { useQuery } from '@tanstack/react-query';
import { getInsforge } from '@/lib/insforge';
import { useAuthStore } from '@/features/auth/store';
import { queryKeys } from '@/lib/queries';

interface ReminderDueInfo {
  lead_id: number;
  step_id: number;
  due_at: string;
  status: string;
}

/**
 * Returns a Map of lead_id -> Map of step_id -> due_at ISO string.
 * Only includes pending/sent reminders (not completed/skipped/cancelled).
 */
export function useLeadReminders() {
  const telegramId = useAuthStore((s) => s.telegramId);

  return useQuery({
    queryKey: queryKeys.leads.reminders(telegramId!),
    queryFn: async () => {
      const { data, error } = await getInsforge()
        .database.from('scheduled_reminders')
        .select('lead_id, step_id, due_at, status')
        .eq('telegram_id', telegramId!)
        .in('status', ['pending', 'sent'])
        .order('due_at', { ascending: true });

      if (error) throw error;

      // Group by lead_id: Map<lead_id, Map<step_id, due_at>>
      const byLead = new Map<number, Map<number, string>>();
      for (const r of (data ?? []) as ReminderDueInfo[]) {
        if (!byLead.has(r.lead_id)) {
          byLead.set(r.lead_id, new Map());
        }
        byLead.get(r.lead_id)!.set(r.step_id, r.due_at);
      }
      return byLead;
    },
    enabled: !!telegramId,
    staleTime: 60000, // 1 minute - reminders don't change frequently
  });
}
```

This avoids N+1 queries by fetching all reminders once, then looking up per-lead in O(1).
  </action>
  <verify>
    TypeScript compilation passes: `cd packages/webapp && npx tsc --noEmit`
  </verify>
  <done>
    - useLeadReminders hook exists and returns Map<number, Map<number, string>>
    - Hook uses queryKeys.leads.reminders key
  </done>
</task>

<task type="auto">
  <name>Task 3: Enhance LeadCard with progress bar, overdue badge, next action</name>
  <files>
    packages/webapp/src/features/leads/components/LeadCard.tsx
    packages/webapp/src/features/leads/components/LeadList.tsx
    packages/webapp/src/pages/Leads.tsx
  </files>
  <action>
1. Update LeadCard.tsx:
   - Import ProgressBar from '@/shared/ui', AlertCircle from 'lucide-react'
   - Import computePlanProgress, PlanProgress from '../types'
   - Add prop: `progress?: PlanProgress`
   - Add UI below the lead info:
     - If progress.total > 0: show ProgressBar (current=completed, max=total, size="sm", showLabel={false})
     - Below progress bar: flex row with "{completed}/{total} steps" on left, overdue badge on right if overdue > 0
     - Overdue badge: `<Badge variant="error" size="sm"><AlertCircle className="mr-1 h-3 w-3" />{progress.overdue} overdue</Badge>`
   - If progress.nextAction: show truncated preview text "Next: {nextAction}" in text-xs text-text-secondary

2. Update LeadList.tsx (or wherever LeadCard is rendered):
   - Import useLeadReminders hook
   - Import computePlanProgress from '../types'
   - Call useLeadReminders() to get reminders Map
   - For each lead, compute progress: `computePlanProgress(lead.engagement_plan, reminders?.get(lead.id) ?? null)`
   - Pass progress prop to LeadCard

3. If Leads.tsx renders LeadCard directly (check structure), apply same pattern there.
  </action>
  <verify>
    - Run `cd packages/webapp && npm run build` to verify production build succeeds
    - Check LeadCard renders progress bar and overdue badge in dev mode
  </verify>
  <done>
    - LeadCard shows progress bar when engagement_plan has steps
    - LeadCard shows overdue badge when steps are past due
    - LeadCard shows next action preview text
    - No N+1 queries (single useLeadReminders call for all leads)
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Production build succeeds
3. LeadCard component accepts progress prop and renders:
   - Progress bar showing completed/total steps
   - Overdue badge with count when applicable
   - Next action text preview
4. useLeadReminders fetches all user reminders in single query
5. computePlanProgress correctly calculates overdue based on due_at timestamps
</verification>

<success_criteria>
- Lead list cards show engagement plan progress bar with completed/total count
- Lead list cards show red "X overdue" badge when steps are past due
- Lead list cards show "Next: [action]" preview for first pending step
- All data fetched efficiently (no N+1 queries)
</success_criteria>

<output>
After completion, create `.planning/phases/16-tma-lead-experience-dashboard/16-01-SUMMARY.md`
</output>
