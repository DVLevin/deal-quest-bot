---
phase: 02-dashboard-and-profile
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/webapp/src/lib/queries.ts
  - packages/webapp/src/shared/data/badges.ts
  - packages/webapp/src/shared/ui/ProgressBar.tsx
  - packages/webapp/src/shared/ui/Avatar.tsx
  - packages/webapp/src/shared/ui/index.ts
  - packages/webapp/src/features/dashboard/hooks/useUserProgress.ts
  - packages/webapp/src/features/dashboard/hooks/useRecentBadges.ts
  - packages/webapp/src/features/dashboard/hooks/useLeaderboard.ts
  - packages/webapp/src/features/dashboard/components/ProgressCard.tsx
  - packages/webapp/src/features/dashboard/components/BadgePreview.tsx
  - packages/webapp/src/features/dashboard/components/LeaderboardWidget.tsx
  - packages/webapp/src/features/dashboard/components/QuickActions.tsx
  - packages/webapp/src/pages/Dashboard.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard displays the user's current XP, level, rank title, and streak count with a visual progress bar"
    - "Dashboard shows the last 4 earned badges with icons and names"
    - "Dashboard shows a top-5 leaderboard with the user's position highlighted"
    - "Dashboard has quick-action buttons that navigate to Learn, Train, Support, Casebook, and Leads"
    - "Tapping the user's avatar or name in the progress card navigates to /profile"
  artifacts:
    - path: "packages/webapp/src/lib/queries.ts"
      provides: "Query key factory for TanStack Query"
      contains: "queryKeys"
    - path: "packages/webapp/src/shared/data/badges.ts"
      provides: "Static badge definitions and evaluation logic"
      contains: "BADGE_DEFINITIONS"
    - path: "packages/webapp/src/shared/ui/ProgressBar.tsx"
      provides: "Reusable XP progress bar component"
      contains: "ProgressBar"
    - path: "packages/webapp/src/shared/ui/Avatar.tsx"
      provides: "Avatar component with initials fallback"
      contains: "Avatar"
    - path: "packages/webapp/src/features/dashboard/hooks/useUserProgress.ts"
      provides: "User XP, level, rank, streak data hook"
      contains: "useUserProgress"
    - path: "packages/webapp/src/features/dashboard/hooks/useLeaderboard.ts"
      provides: "Top-5 leaderboard data hook"
      contains: "useLeaderboard"
    - path: "packages/webapp/src/pages/Dashboard.tsx"
      provides: "Full dashboard page replacing stub"
      min_lines: 40
  key_links:
    - from: "packages/webapp/src/features/dashboard/hooks/useUserProgress.ts"
      to: "getInsforge().database.from('users')"
      via: "TanStack Query useQuery wrapping InsForge PostgREST"
      pattern: "useQuery.*queryKeys\\.users"
    - from: "packages/webapp/src/features/dashboard/hooks/useLeaderboard.ts"
      to: "getInsforge().database.from('users')"
      via: "TanStack Query useQuery with order by total_xp"
      pattern: "order.*total_xp"
    - from: "packages/webapp/src/pages/Dashboard.tsx"
      to: "features/dashboard/hooks"
      via: "imports useUserProgress, useRecentBadges, useLeaderboard"
      pattern: "use(UserProgress|RecentBadges|Leaderboard)"
    - from: "packages/webapp/src/features/dashboard/components/QuickActions.tsx"
      to: "react-router navigate"
      via: "useNavigate or Link to /learn, /train, /support, /casebook, /leads"
      pattern: "(useNavigate|Link).*/(learn|train|support|casebook|leads)"
---

<objective>
Build the shared data infrastructure (query keys, badge definitions, reusable UI components) and the full Dashboard page with progress tracking, badge preview, leaderboard, and quick-action navigation.

Purpose: This plan establishes the data-fetching patterns used by all Phase 2+ features and delivers the first real data-driven page -- the Dashboard -- proving the complete InsForge-to-UI pipeline.
Output: Query key factory, static badge system, ProgressBar and Avatar components, 3 Dashboard data hooks, 4 Dashboard feature components, and a fully wired Dashboard page replacing the stub.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-dashboard-and-profile/02-RESEARCH.md

# Phase 1 outputs needed for this plan
@deal-quest-bot/packages/webapp/src/lib/insforge.ts
@deal-quest-bot/packages/webapp/src/features/auth/store.ts
@deal-quest-bot/packages/webapp/src/shared/ui/index.ts
@deal-quest-bot/packages/webapp/src/shared/ui/Card.tsx
@deal-quest-bot/packages/webapp/src/shared/ui/Badge.tsx
@deal-quest-bot/packages/webapp/src/shared/ui/Skeleton.tsx
@deal-quest-bot/packages/webapp/src/shared/lib/cn.ts
@deal-quest-bot/packages/webapp/src/app/globals.css
@deal-quest-bot/packages/shared/src/tables.ts
@deal-quest-bot/packages/shared/src/constants.ts
@deal-quest-bot/packages/shared/src/index.ts
@deal-quest-bot/packages/webapp/src/pages/Dashboard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared data infrastructure -- query keys, badge definitions, ProgressBar, Avatar</name>
  <files>
    packages/webapp/src/lib/queries.ts
    packages/webapp/src/shared/data/badges.ts
    packages/webapp/src/shared/ui/ProgressBar.tsx
    packages/webapp/src/shared/ui/Avatar.tsx
    packages/webapp/src/shared/ui/index.ts
  </files>
  <action>
    Create 4 new files and update 1 barrel export:

    1. **packages/webapp/src/lib/queries.ts** -- Query key factory for TanStack Query.
       Define `queryKeys` object with namespaced keys for `users` (all, detail by telegramId, leaderboard), `attempts` (all, byUser, history with page, stats), and `badges` (all, byUser). Use `as const` for type safety. Follow the pattern from 02-RESEARCH.md Pattern 1.

    2. **packages/webapp/src/shared/data/badges.ts** -- Static badge definitions and client-side evaluation.
       - Export `BadgeDefinition` interface with id, name, description, icon (lucide icon name), rarity ('common' | 'rare' | 'epic' | 'legendary'), and `criteria` discriminated union.
       - Export `BadgeCriteria` type with variants: xp_threshold, streak_days, attempt_count, perfect_score, first_attempt.
       - Export `BADGE_DEFINITIONS` array with 8 badges (from research: first-win, on-fire, perfect-score, dedicated, xp-hunter, veteran, streak-master, legend).
       - Export `EarnedBadge` interface extending BadgeDefinition with `earnedAt: string | null`.
       - Export `evaluateBadges(user: UserRow, attempts: AttemptRow[]): EarnedBadge[]` function that checks each badge criteria against user data and returns earned badges.
       Import UserRow and AttemptRow from `@deal-quest/shared`.
       NO database queries in this file -- pure evaluation logic.

    3. **packages/webapp/src/shared/ui/ProgressBar.tsx** -- Reusable XP progress bar.
       Props: `current: number`, `max: number`, `className?: string`, `showLabel?: boolean` (default true), `size?: 'sm' | 'md' | 'lg'` (default 'md').
       Heights: sm=h-1.5, md=h-2.5, lg=h-4.
       Track: rounded-full bg-surface-secondary overflow-hidden.
       Fill: rounded-full bg-accent with transition-[width] duration-500 ease-out.
       Label: text-xs text-text-hint showing "current / max XP".
       Include role="progressbar" with aria-valuenow, aria-valuemin=0, aria-valuemax for accessibility.
       Use cn() for class merging. Clamp percentage to 0-100%.

    4. **packages/webapp/src/shared/ui/Avatar.tsx** -- User avatar with initials fallback.
       Props: `username?: string | null`, `firstName?: string | null`, `size?: 'sm' | 'md' | 'lg'` (default 'md'), `className?: string`.
       Sizes: sm=h-8 w-8 text-xs, md=h-12 w-12 text-sm, lg=h-16 w-16 text-lg.
       Display: rounded-full bg-brand-100 text-brand-700 font-semibold, centered initials.
       Initials logic: first char of firstName, falling back to first char of username, falling back to '?'. Uppercased.
       No image support needed (Telegram avatars unavailable in TMA context).

    5. **packages/webapp/src/shared/ui/index.ts** -- Add ProgressBar and Avatar to barrel exports.
       Add: `export { ProgressBar, type ProgressBarProps } from './ProgressBar';`
       Add: `export { Avatar, type AvatarProps } from './Avatar';`
       Keep all existing exports.

    IMPORTANT: Use oklch color tokens from globals.css (bg-surface-secondary, bg-accent, text-text-hint, bg-brand-100, text-brand-700). Do NOT use hardcoded hex or rgb values.
  </action>
  <verify>
    Run `cd deal-quest-bot && pnpm typecheck` -- must pass with zero errors.
    Verify query keys file exports queryKeys with users, attempts, badges namespaces.
    Verify badges file exports BADGE_DEFINITIONS with 8 entries and evaluateBadges function.
    Verify ProgressBar and Avatar are exported from shared/ui/index.ts.
  </verify>
  <done>
    Query key factory, 8 static badge definitions with evaluation function, ProgressBar with 3 sizes and accessibility, Avatar with initials fallback -- all type-checked and exported.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build Dashboard hooks, feature components, and replace page stub</name>
  <files>
    packages/webapp/src/features/dashboard/hooks/useUserProgress.ts
    packages/webapp/src/features/dashboard/hooks/useRecentBadges.ts
    packages/webapp/src/features/dashboard/hooks/useLeaderboard.ts
    packages/webapp/src/features/dashboard/components/ProgressCard.tsx
    packages/webapp/src/features/dashboard/components/BadgePreview.tsx
    packages/webapp/src/features/dashboard/components/LeaderboardWidget.tsx
    packages/webapp/src/features/dashboard/components/QuickActions.tsx
    packages/webapp/src/pages/Dashboard.tsx
  </files>
  <action>
    Create 7 new files in the dashboard feature folder and replace the Dashboard page stub:

    **HOOKS (3 files):**

    1. **features/dashboard/hooks/useUserProgress.ts** -- Fetches current user's progress data.
       - Use `useQuery` from @tanstack/react-query with `queryKeys.users.detail(telegramId!)`.
       - Get telegramId from `useAuthStore((s) => s.telegramId)`.
       - Query: `getInsforge().database.from('users').select('id, telegram_id, username, first_name, total_xp, current_level, streak_days, last_active_at, created_at').eq('telegram_id', telegramId!).single()`.
       - Cast result as `UserRow`.
       - Gate with `enabled: !!telegramId`.
       - Return the full useQuery result (data, isLoading, isError, error).

    2. **features/dashboard/hooks/useRecentBadges.ts** -- Evaluates earned badges client-side.
       - Use `useQuery` with `queryKeys.badges.byUser(telegramId!)`.
       - Fetch user row (same query as useUserProgress -- TanStack Query deduplicates).
       - Fetch last 100 attempts: `getInsforge().database.from('attempts').select('id, score, xp_earned, created_at').eq('telegram_id', telegramId!).order('created_at', { ascending: false }).limit(100)`.
       - Call `evaluateBadges(userData, attemptsData)` to get earned badges.
       - Return `{ earned: EarnedBadge[], total: BADGE_DEFINITIONS.length }` plus useQuery loading/error states.
       - Gate with `enabled: !!telegramId`.

    3. **features/dashboard/hooks/useLeaderboard.ts** -- Fetches top-5 leaderboard.
       - Use `useQuery` with `queryKeys.users.leaderboard`.
       - Query: `getInsforge().database.from('users').select('id, telegram_id, username, first_name, total_xp, current_level').order('total_xp', { ascending: false }).limit(10)`.
       - Fetch 10 rows but display top 5. Find current user's position in the full list.
       - Return: `{ top5: UserRow[], myPosition: number | null, myEntry: UserRow | null }`.
       - Gate with `enabled: !!telegramId`.
       - Set `staleTime: 2 * 60_000` (2 minutes -- leaderboard changes frequently).

       NOTE on RLS: The leaderboard query may return only the current user's row if RLS restricts cross-user reads. Handle this gracefully -- if only 1 row returned and it matches current user, show "Leaderboard unavailable" empty state. The RLS policy adjustment is a pending Phase 1 todo (01-02 open question). The hook should work correctly once the policy is added.

    **COMPONENTS (4 files):**

    4. **features/dashboard/components/ProgressCard.tsx** -- XP progress, level, rank, streak.
       - Props: none (uses useUserProgress hook directly).
       - Layout: Card with flex row. Left side: Avatar (tapping navigates to /profile via Link from react-router). Right side: username/firstName, rank title from `getRankTitle(user.current_level)`, level number.
       - Below: ProgressBar showing XP progress to next level. Use `getXPForNextLevel(user.current_level)` for max value. Current value = `user.total_xp - XP_PER_LEVEL[user.current_level - 1]` (XP within current level).
       - If at max level, show "MAX LEVEL" instead of progress bar.
       - Streak: flame icon from lucide-react + `user.streak_days` day count. Show "No streak" if 0.
       - Loading state: use Skeleton components matching layout shape.
       - Empty/error state: show "Unable to load progress" in Card.
       - Import getRankTitle, getXPForNextLevel, XP_PER_LEVEL from `@deal-quest/shared`.

    5. **features/dashboard/components/BadgePreview.tsx** -- Last 4 earned badges.
       - Props: none (uses useRecentBadges hook directly).
       - Layout: Card with "Badges" header and "See all" link to /profile (using Link from react-router).
       - Grid of last 4 earned badges (slice from earned array, most recent first -- but since we don't have earnedAt dates, just show first 4).
       - Each badge: lucide icon rendered dynamically (import icons by name mapping), badge name below, rarity-colored border using design token rarity colors from globals.css if available, otherwise use Badge component with appropriate variant.
       - Empty state: "No badges earned yet -- start training!" with text-text-hint.
       - Loading state: 4 Skeleton circles in a row.

    6. **features/dashboard/components/LeaderboardWidget.tsx** -- Top 5 users.
       - Props: none (uses useLeaderboard hook directly).
       - Layout: Card with "Leaderboard" header.
       - List of top 5 users. Each row: position number (1-5), Avatar (sm), username or firstName, XP with text-text-hint, level badge.
       - Highlight current user's row with bg-brand-50 or a subtle accent background.
       - If current user not in top 5, show a separator "..." row then current user's position below the list.
       - Empty state: "Complete your first scenario to join the leaderboard!" with text-text-hint.
       - Loading state: 5 Skeleton rows.

    7. **features/dashboard/components/QuickActions.tsx** -- Navigation buttons.
       - Props: none.
       - Layout: grid of 5 action buttons in a 3+2 or 2+3 grid (3 columns on wider screens, wrapping).
       - Buttons: Learn (BookOpen icon), Train (Swords icon), Support (LifeBuoy icon), Casebook (BookMarked icon), Leads (Users icon).
       - Each button: Card with vertical layout (icon + label), tappable (use Link from react-router), min 44px touch target.
       - Navigate to respective routes: /learn, /train, /support, /casebook, /leads.
       - Use lucide-react for all icons.

    **PAGE (1 file):**

    8. **pages/Dashboard.tsx** -- Replace the existing stub with the full dashboard.
       - REPLACE the entire file content (not modify).
       - Import and render: ProgressCard, BadgePreview, LeaderboardWidget, QuickActions.
       - Layout: vertical stack with gap-4, px-4 pt-4 padding (matches current stub pattern).
       - No additional hooks in the page -- all data fetching is in the feature components.
       - Keep the default export.

    IMPORTANT:
    - All hooks must import from `@/lib/queries` for query keys, `@/lib/insforge` for getInsforge(), `@/features/auth/store` for useAuthStore.
    - All components must use design system tokens (bg-surface, text-text, text-text-hint, bg-accent, etc.) -- NO hardcoded colors.
    - All interactive elements must have min 44px touch targets.
    - Use Skeleton/SkeletonText for loading states, not custom spinners.
    - Handle empty data states with helpful messages (not blank space or "undefined").
  </action>
  <verify>
    Run `cd deal-quest-bot && pnpm typecheck` -- must pass with zero errors.
    Run `cd deal-quest-bot && pnpm build` -- must produce clean build with no warnings.
    Verify Dashboard.tsx imports all 4 feature components.
    Verify each hook uses queryKeys from lib/queries.ts.
    Verify each component has loading and empty states.
  </verify>
  <done>
    Dashboard page displays user progress (XP bar, level, rank, streak), last 4 earned badges, top-5 leaderboard with user position highlighted, and 5 quick-action navigation buttons. All components handle loading and empty states. Avatar links to /profile. "See all" badges link goes to /profile. Build passes clean.
  </done>
</task>

</tasks>

<verification>
1. `cd deal-quest-bot && pnpm typecheck` passes with zero errors
2. `cd deal-quest-bot && pnpm build` produces clean output with code-split chunks
3. Dashboard.tsx is no longer a stub -- it renders 4 feature components
4. All 3 hooks use queryKeys from lib/queries.ts and gate on `enabled: !!telegramId`
5. ProgressBar has role="progressbar" with aria attributes
6. Avatar renders initials fallback when no image available
7. Badge definitions include all 8 badges with evaluation function
8. QuickActions has 5 navigation buttons linking to /learn, /train, /support, /casebook, /leads
</verification>

<success_criteria>
- Dashboard page renders ProgressCard, BadgePreview, LeaderboardWidget, and QuickActions
- useUserProgress fetches user data from InsForge via PostgREST query
- useLeaderboard fetches top users ordered by total_xp
- useRecentBadges evaluates badges client-side from user + attempt data
- All components show Skeleton loading states and empty-data messages
- ProgressBar shows XP within current level toward next level threshold
- Avatar navigates to /profile on tap
- QuickActions navigate to 5 target routes
- TypeScript compilation and Vite build pass clean
</success_criteria>

<output>
After completion, create `.planning/phases/02-dashboard-and-profile/02-01-SUMMARY.md`
</output>
