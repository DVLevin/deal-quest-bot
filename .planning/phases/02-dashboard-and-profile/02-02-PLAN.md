---
phase: 02-dashboard-and-profile
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - packages/webapp/src/features/profile/hooks/useUserProfile.ts
  - packages/webapp/src/features/profile/hooks/useUserStats.ts
  - packages/webapp/src/features/profile/hooks/useAttemptHistory.ts
  - packages/webapp/src/features/profile/hooks/useUserBadges.ts
  - packages/webapp/src/features/profile/components/ProfileHeader.tsx
  - packages/webapp/src/features/profile/components/StatsOverview.tsx
  - packages/webapp/src/features/profile/components/AttemptHistory.tsx
  - packages/webapp/src/features/profile/components/BadgeCollection.tsx
  - packages/webapp/src/pages/Profile.tsx
autonomous: false

must_haves:
  truths:
    - "Profile page shows avatar, username, rank title, level, total XP, and member-since date"
    - "Profile page shows full stats: total attempts, average score, best score"
    - "Profile page shows paginated attempt history with scenario name, score, and date"
    - "Profile page displays badge collection with earned count vs total count"
    - "User can navigate between attempt history pages"
  artifacts:
    - path: "packages/webapp/src/features/profile/hooks/useUserProfile.ts"
      provides: "Full user profile data hook"
      contains: "useUserProfile"
    - path: "packages/webapp/src/features/profile/hooks/useUserStats.ts"
      provides: "Aggregate stats from attempts"
      contains: "useUserStats"
    - path: "packages/webapp/src/features/profile/hooks/useAttemptHistory.ts"
      provides: "Paginated attempt list hook"
      contains: "useAttemptHistory"
    - path: "packages/webapp/src/features/profile/hooks/useUserBadges.ts"
      provides: "Full badge collection hook"
      contains: "useUserBadges"
    - path: "packages/webapp/src/pages/Profile.tsx"
      provides: "Full profile page replacing stub"
      min_lines: 40
  key_links:
    - from: "packages/webapp/src/features/profile/hooks/useUserStats.ts"
      to: "getInsforge().database.from('attempts')"
      via: "TanStack Query fetching last 100 attempts for client-side aggregation"
      pattern: "from.*attempts.*limit.*100"
    - from: "packages/webapp/src/features/profile/hooks/useAttemptHistory.ts"
      to: "getInsforge().database.from('attempts')"
      via: "Paginated query with range()"
      pattern: "range.*from.*to"
    - from: "packages/webapp/src/pages/Profile.tsx"
      to: "features/profile/hooks"
      via: "imports useUserProfile, useUserStats, useAttemptHistory, useUserBadges"
      pattern: "use(UserProfile|UserStats|AttemptHistory|UserBadges)"
---

<objective>
Build the full Profile page with user info header, aggregate stats, paginated attempt history, and badge collection display.

Purpose: The Profile page completes Phase 2 by showing the user's complete training history and badge progress, proving the full data pipeline for paginated queries and client-side data aggregation.
Output: 4 Profile data hooks, 4 Profile feature components, and a fully wired Profile page replacing the stub.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-dashboard-and-profile/02-RESEARCH.md
@.planning/phases/02-dashboard-and-profile/02-01-SUMMARY.md

# Shared infrastructure created in Plan 01
@deal-quest-bot/packages/webapp/src/lib/queries.ts
@deal-quest-bot/packages/webapp/src/shared/data/badges.ts
@deal-quest-bot/packages/webapp/src/shared/ui/ProgressBar.tsx
@deal-quest-bot/packages/webapp/src/shared/ui/Avatar.tsx
@deal-quest-bot/packages/webapp/src/shared/ui/index.ts

# Phase 1 outputs
@deal-quest-bot/packages/webapp/src/lib/insforge.ts
@deal-quest-bot/packages/webapp/src/features/auth/store.ts
@deal-quest-bot/packages/webapp/src/shared/ui/Card.tsx
@deal-quest-bot/packages/webapp/src/shared/ui/Badge.tsx
@deal-quest-bot/packages/webapp/src/shared/ui/Skeleton.tsx
@deal-quest-bot/packages/webapp/src/shared/lib/cn.ts
@deal-quest-bot/packages/shared/src/tables.ts
@deal-quest-bot/packages/shared/src/constants.ts
@deal-quest-bot/packages/webapp/src/pages/Profile.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build Profile hooks, feature components, and replace page stub</name>
  <files>
    packages/webapp/src/features/profile/hooks/useUserProfile.ts
    packages/webapp/src/features/profile/hooks/useUserStats.ts
    packages/webapp/src/features/profile/hooks/useAttemptHistory.ts
    packages/webapp/src/features/profile/hooks/useUserBadges.ts
    packages/webapp/src/features/profile/components/ProfileHeader.tsx
    packages/webapp/src/features/profile/components/StatsOverview.tsx
    packages/webapp/src/features/profile/components/AttemptHistory.tsx
    packages/webapp/src/features/profile/components/BadgeCollection.tsx
    packages/webapp/src/pages/Profile.tsx
  </files>
  <action>
    Create 8 new files in the profile feature folder and replace the Profile page stub:

    **HOOKS (4 files):**

    1. **features/profile/hooks/useUserProfile.ts** -- Fetches full user profile data.
       - Use `useQuery` with `queryKeys.users.detail(telegramId!)`.
       - Query: `getInsforge().database.from('users').select('*').eq('telegram_id', telegramId!).single()`.
       - Cast result as `UserRow`.
       - Gate with `enabled: !!telegramId`.
       - This will be deduplicated with Dashboard's useUserProgress by TanStack Query (same query key).

    2. **features/profile/hooks/useUserStats.ts** -- Computes aggregate stats from attempts.
       - Use `useQuery` with `queryKeys.attempts.stats(telegramId!)`.
       - Fetch last 100 attempts: `getInsforge().database.from('attempts').select('id, score, xp_earned, mode, created_at').eq('telegram_id', telegramId!).order('created_at', { ascending: false }).limit(100)`.
       - Compute client-side: `totalAttempts` (array length), `averageScore` (mean of score field, rounded to 1 decimal), `bestScore` (max of score field), `scenariosCompleted` (count of unique scenario_ids -- need to include scenario_id in select).
       - UPDATE the select to include scenario_id: `.select('id, scenario_id, score, xp_earned, mode, created_at')`.
       - Return: `{ totalAttempts, averageScore, bestScore, scenariosCompleted, isLoading, isError }`.
       - Handle zero attempts: return 0 for all values (not NaN or undefined).
       - Gate with `enabled: !!telegramId`.

    3. **features/profile/hooks/useAttemptHistory.ts** -- Paginated attempt list.
       - Accept `page: number` parameter (0-indexed).
       - Use `useQuery` with `queryKeys.attempts.history(telegramId!, page)`.
       - PAGE_SIZE = 10.
       - Query: `getInsforge().database.from('attempts').select('id, scenario_id, mode, score, xp_earned, created_at', { count: 'exact' }).eq('telegram_id', telegramId!).order('created_at', { ascending: false }).range(from, to)` where from = page * PAGE_SIZE, to = from + PAGE_SIZE - 1.
       - Return: `{ attempts: AttemptRow[], total: number, hasMore: boolean, isLoading, isError }`.
       - Use `placeholderData: keepPreviousData` from @tanstack/react-query for smooth page transitions.
       - Gate with `enabled: !!telegramId`.
       - Import `keepPreviousData` from `@tanstack/react-query`.

    4. **features/profile/hooks/useUserBadges.ts** -- Full badge collection.
       - Use `useQuery` with `queryKeys.badges.byUser(telegramId!)`.
       - Same data fetching as Dashboard's useRecentBadges (TanStack Query will deduplicate).
       - Fetch user + last 100 attempts, call `evaluateBadges()`.
       - Return: `{ allBadges: BadgeDefinition[], earned: EarnedBadge[], earnedCount: number, totalCount: number, isLoading, isError }`.
       - allBadges = BADGE_DEFINITIONS (all 8), earned = evaluateBadges result.
       - Gate with `enabled: !!telegramId`.

    **COMPONENTS (4 files):**

    5. **features/profile/components/ProfileHeader.tsx** -- User info header.
       - Props: none (uses useUserProfile hook directly).
       - Layout: Avatar (lg size) centered at top. Below: username or firstName (text-lg font-bold), rank title from getRankTitle(), "Level {n}" badge, total XP formatted with toLocaleString().
       - Member since: "Member since {formatted date}" using created_at. Format as "MMM YYYY" (e.g., "Jan 2026"). Use `new Date(user.created_at).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })`.
       - Streak display: flame icon + streak days count, or "No active streak" if 0.
       - Loading state: centered Skeleton circle + Skeleton text lines.
       - Empty/error state: "Unable to load profile" message.

    6. **features/profile/components/StatsOverview.tsx** -- Aggregate stats grid.
       - Props: none (uses useUserStats hook directly).
       - Layout: Card with "Stats" header. Grid of stat items (2 columns on mobile, 3 columns on wider screens).
       - Stats to display: Total Attempts (target icon), Average Score (bar-chart icon), Best Score (trophy icon), Scenarios Completed (check-circle icon).
       - Each stat: icon + value (text-xl font-bold) + label (text-xs text-text-hint).
       - Loading state: 4 Skeleton boxes in grid.
       - Zero state: show "0" or "0.0" for values, not "--" or blank.

    7. **features/profile/components/AttemptHistory.tsx** -- Paginated attempt list.
       - Uses local `useState(0)` for page number.
       - Uses useAttemptHistory(page) hook.
       - Layout: Card with "Recent Attempts" header and total count badge.
       - Each attempt row: scenario_id (truncated if long), mode badge (using Badge component -- "learn" or "train"), score with color coding (green >=80, yellow >=60, red <60), date formatted as "MMM DD" (e.g., "Jan 15").
       - Pagination controls at bottom: "Previous" and "Next" buttons (using Button component, disabled at boundaries).
       - Show "Page {n+1} of {totalPages}" between buttons.
       - Empty state: "No attempts yet -- start training to see your history!" in text-text-hint.
       - Loading state: 5 Skeleton rows.
       - IMPORTANT: Handle AttemptRow type -- the select only includes certain fields. Cast appropriately.

    8. **features/profile/components/BadgeCollection.tsx** -- Full badge grid.
       - Props: none (uses useUserBadges hook directly).
       - Layout: Card with "Badges" header and "{earned}/{total}" count in header.
       - Grid layout: 4 columns on mobile, wrap naturally.
       - Earned badges: lucide icon rendered via icon name mapping (same approach as Dashboard BadgePreview), badge name, rarity-colored accent. Full opacity.
       - Unearned badges: show silhouette/locked state -- same icon but with opacity-30, grayscale filter, and "Locked" or the badge name with text-text-hint styling. Show the criteria description as tooltip-like text below.
       - Use rarity colors: common=default, rare=blue, epic=purple, legendary=gold/amber (use design token variants if available, otherwise Tailwind built-in amber/purple/blue).
       - Loading state: 8 Skeleton circles in grid.
       - Empty state (zero earned): "Start your training journey to earn badges!" with motivational text.

    **PAGE (1 file):**

    9. **pages/Profile.tsx** -- Replace the existing stub with the full profile page.
       - REPLACE the entire file content (not modify).
       - Import and render: ProfileHeader, StatsOverview, AttemptHistory, BadgeCollection.
       - Layout: vertical stack with gap-4, px-4 pt-4 pb-4 padding.
       - Order: ProfileHeader at top, then StatsOverview, then BadgeCollection, then AttemptHistory at bottom.
       - Keep the default export.

    IMPORTANT:
    - All hooks must import from `@/lib/queries` for query keys, `@/lib/insforge` for getInsforge(), `@/features/auth/store` for useAuthStore.
    - Import badge definitions and evaluateBadges from `@/shared/data/badges`.
    - All components must use design system tokens -- NO hardcoded colors.
    - Use Skeleton/SkeletonText for loading states.
    - Handle empty data states with helpful messages (not blank or "undefined" or NaN).
    - All interactive elements must have min 44px touch targets (pagination buttons).
  </action>
  <verify>
    Run `cd deal-quest-bot && pnpm typecheck` -- must pass with zero errors.
    Run `cd deal-quest-bot && pnpm build` -- must produce clean build with no warnings.
    Verify Profile.tsx imports all 4 feature components (ProfileHeader, StatsOverview, AttemptHistory, BadgeCollection).
    Verify useAttemptHistory uses keepPreviousData and range() pagination.
    Verify useUserStats handles zero attempts without NaN.
    Verify BadgeCollection shows both earned and locked states.
  </verify>
  <done>
    Profile page displays user avatar, name, rank, level, XP, member-since date, aggregate stats (total attempts, avg score, best score, scenarios completed), paginated attempt history with page navigation, and full badge collection showing earned vs locked badges. All components handle loading and empty states. Build passes clean.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Dashboard and Profile pages for the Deal Quest TMA, proving the full data pipeline from InsForge through TanStack Query hooks to rendered React components.

    **Dashboard (Plan 02-01):**
    - ProgressCard: XP bar, level, rank title, streak count, avatar linking to /profile
    - BadgePreview: Last 4 earned badges (evaluated client-side)
    - LeaderboardWidget: Top-5 users with current user highlighted
    - QuickActions: 5 navigation buttons (Learn, Train, Support, Casebook, Leads)

    **Profile (Plan 02-02):**
    - ProfileHeader: Avatar, username, rank, level, XP, member-since date, streak
    - StatsOverview: Total attempts, avg score, best score, scenarios completed
    - AttemptHistory: Paginated list with scenario, mode, score, date
    - BadgeCollection: Full badge grid with earned (full color) and locked (silhouette) states
  </what-built>
  <how-to-verify>
    1. Run `cd deal-quest-bot && pnpm dev` to start the development server
    2. Open the TMA URL in a browser (HTTPS required for Telegram SDK mock)
    3. Verify **Dashboard** page loads:
       - Progress card shows XP bar (may show 0 XP for new users -- that's correct)
       - Level and rank title display (Level 1 / Rookie for new users)
       - Streak counter shows (0 days for new users)
       - Avatar with initials is visible and tappable
       - Badge section shows "No badges earned yet" for new users (or 4 badges if user has activity)
       - Leaderboard shows users or empty state message
       - 5 quick action buttons are visible and tappable
    4. Tap the avatar or "See all" badges link -- should navigate to /profile
    5. Verify **Profile** page loads:
       - Avatar, username, rank, level, XP, and member-since date visible
       - Stats grid shows 4 stat values (0 for new users)
       - Badge collection shows all 8 badges (earned in color, locked in grayscale)
       - Attempt history shows "No attempts yet" or paginated list
    6. If attempts exist, verify pagination: Previous/Next buttons work, page counter updates
    7. Navigate back to Dashboard using Telegram BackButton or NavBar
    8. Verify no console errors related to undefined/NaN values

    **NOTE:** Data display depends on the InsForge Edge Function being deployed and RLS migration being applied (Phase 1 pending todos). If auth is not yet configured, the hooks will show loading/error states -- this is expected. The visual layout and empty states should still be verifiable.
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 2, or describe visual/functional issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `cd deal-quest-bot && pnpm typecheck` passes with zero errors
2. `cd deal-quest-bot && pnpm build` produces clean output with code-split chunks
3. Profile.tsx is no longer a stub -- it renders 4 feature components
4. All 4 profile hooks use queryKeys from lib/queries.ts and gate on `enabled: !!telegramId`
5. useAttemptHistory uses range() and keepPreviousData for pagination
6. useUserStats computes average without producing NaN on zero attempts
7. BadgeCollection shows 8 badges with earned/locked visual distinction
8. AttemptHistory has Previous/Next pagination buttons with disabled states at boundaries
</verification>

<success_criteria>
- Profile page renders ProfileHeader, StatsOverview, BadgeCollection, and AttemptHistory
- useUserProfile fetches complete user data from InsForge
- useUserStats computes aggregate stats from last 100 attempts (handles zero gracefully)
- useAttemptHistory supports page navigation with keepPreviousData smooth transitions
- useUserBadges evaluates all 8 badge definitions against user data
- BadgeCollection shows earned badges in full color and locked badges as silhouettes
- AttemptHistory shows paginated rows with mode badges and score color coding
- Both Dashboard and Profile pass human visual verification
- TypeScript compilation and Vite build pass clean
</success_criteria>

<output>
After completion, create `.planning/phases/02-dashboard-and-profile/02-02-SUMMARY.md`
</output>
