---
phase: 07-bot-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/webapp/src/shared/hooks/useDeepLink.ts
  - packages/webapp/src/app/Router.tsx
autonomous: true

must_haves:
  truths:
    - "TMA navigates to the correct page when opened with a startParam (fallback for direct links)"
    - "TMA works normally when opened without startParam (no redirect, stays on root)"
    - "Deep link navigation only fires once on initial mount, not on subsequent renders"
  artifacts:
    - path: "packages/webapp/src/shared/hooks/useDeepLink.ts"
      provides: "startParam -> route navigation hook"
      exports: ["useDeepLink"]
      min_lines: 20
    - path: "packages/webapp/src/app/Router.tsx"
      provides: "useDeepLink integration in AppRoutes"
      contains: "useDeepLink"
  key_links:
    - from: "packages/webapp/src/app/Router.tsx"
      to: "packages/webapp/src/shared/hooks/useDeepLink.ts"
      via: "useDeepLink() call inside AppRoutes"
      pattern: "useDeepLink"
    - from: "packages/webapp/src/shared/hooks/useDeepLink.ts"
      to: "@telegram-apps/sdk-react"
      via: "retrieveLaunchParams for startParam"
      pattern: "retrieveLaunchParams"
---

<objective>
Add deep link routing to the TMA so it correctly navigates when opened via startParam (fallback for direct links like t.me/bot/app?startapp=learn).

Purpose: While WebAppInfo URL path routing works natively with BrowserRouter for inline buttons (Plan 01), the startParam mechanism is needed as a fallback for direct link launches and future t.me/bot/app?startapp=X links (BOT-02 completeness).
Output: New useDeepLink hook and updated Router.tsx.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-bot-integration/07-RESEARCH.md
@packages/webapp/src/app/Router.tsx
@packages/webapp/src/shared/hooks/useBackButton.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useDeepLink hook and integrate into Router</name>
  <files>packages/webapp/src/shared/hooks/useDeepLink.ts, packages/webapp/src/app/Router.tsx</files>
  <action>
1. **packages/webapp/src/shared/hooks/useDeepLink.ts**: Create a NEW file:

```typescript
/**
 * Deep link routing hook for TMA startParam.
 *
 * When the TMA is opened via a direct link (t.me/bot/app?startapp=learn),
 * Telegram passes the startapp value as startParam in launch params.
 * This hook reads it and navigates to the corresponding route.
 *
 * For inline web_app buttons (Plan 01), routing happens natively via
 * BrowserRouter because WebAppInfo.url contains the full path. This
 * hook is a fallback for direct link launches only.
 */
import { useEffect, useRef } from 'react';
import { useNavigate, useLocation } from 'react-router';
import { retrieveLaunchParams } from '@telegram-apps/sdk-react';

const START_PARAM_MAP: Record<string, string> = {
  stats: '/',
  dashboard: '/',
  learn: '/learn',
  train: '/train',
  support: '/support',
  leads: '/leads',
  profile: '/profile',
};

export function useDeepLink() {
  const navigate = useNavigate();
  const location = useLocation();
  const handled = useRef(false);

  useEffect(() => {
    // Only process once per app lifecycle
    if (handled.current) return;
    handled.current = true;

    // If already navigated to a non-root path (via WebAppInfo URL), skip
    if (location.pathname !== '/') return;

    try {
      const { startParam } = retrieveLaunchParams();
      if (startParam) {
        const route = START_PARAM_MAP[startParam];
        if (route && route !== '/') {
          navigate(route, { replace: true });
        }
      }
    } catch {
      // Not in Telegram context or SDK unavailable -- silently ignore
    }
  }, []);
}
```

Key design decisions:
- `useRef(handled)` ensures the hook only runs once per app lifecycle, preventing re-triggers on re-renders
- `location.pathname !== '/'` check skips startParam parsing when WebAppInfo URL already routed to the correct page (inline button flow)
- `route !== '/'` prevents unnecessary navigation to root when already on root
- Empty catch block: In dev mode outside Telegram, retrieveLaunchParams may throw. This is expected and should not log errors.
- `{ replace: true }` prevents the root path from appearing in browser history

2. **packages/webapp/src/app/Router.tsx**: Add the useDeepLink hook to AppRoutes:
   - Add import: `import { useDeepLink } from '@/shared/hooks/useDeepLink';`
   - Inside the `AppRoutes` function, add `useDeepLink();` right after the existing `useBackButton();` call
   - No other changes to Router.tsx
  </action>
  <verify>
    - `cd packages/webapp && npx tsc --noEmit` passes (TypeScript compiles without errors)
    - File exists: `packages/webapp/src/shared/hooks/useDeepLink.ts`
    - Router.tsx contains both `useBackButton()` and `useDeepLink()` calls
    - Grep for `START_PARAM_MAP` in useDeepLink.ts confirms all 5 routes are mapped
  </verify>
  <done>
    - useDeepLink hook created with startParam -> route mapping for all 5 commands plus dashboard and profile
    - Router.tsx calls useDeepLink() inside AppRoutes alongside useBackButton()
    - Hook fires only once on initial mount (useRef guard)
    - Hook skips when already on a non-root path (WebAppInfo URL routing takes priority)
    - TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `cd packages/webapp && npx tsc --noEmit`
2. useDeepLink.ts exists and exports useDeepLink
3. Router.tsx imports and calls useDeepLink
4. START_PARAM_MAP covers stats, dashboard, learn, train, support, leads, profile
</verification>

<success_criteria>
- useDeepLink hook parses startParam from Telegram launch params and navigates to the correct route
- Hook is integrated into AppRoutes in Router.tsx
- Hook only fires once (useRef guard prevents re-triggers)
- WebAppInfo URL path routing (from inline buttons) takes priority over startParam (location.pathname check)
- No regressions in existing routing behavior
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/07-bot-integration/07-02-SUMMARY.md`
</output>
