---
phase: 07-bot-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bot/config.py
  - bot/utils_tma.py
  - bot/main.py
  - bot/handlers/stats.py
  - bot/handlers/learn.py
  - bot/handlers/train.py
  - bot/handlers/support.py
  - bot/handlers/leads.py
autonomous: true

must_haves:
  truths:
    - "Bot commands (/stats, /learn, /train, /support, /leads) include an 'Open in App' inline button as the last row of the keyboard"
    - "Tapping 'Open in App' opens the TMA at the correct page path via WebAppInfo URL"
    - "The TMA menu button is set programmatically at bot startup to open the TMA root"
    - "If TMA_URL is not configured, bot continues to work normally without web_app buttons"
  artifacts:
    - path: "bot/config.py"
      provides: "tma_url config field"
      contains: "tma_url"
    - path: "bot/utils_tma.py"
      provides: "add_open_in_app_row helper + setup_menu_button"
      exports: ["add_open_in_app_row", "setup_menu_button"]
    - path: "bot/main.py"
      provides: "tma_url DI injection and menu button setup at startup"
      contains: "tma_url"
    - path: "bot/handlers/stats.py"
      provides: "Open in App button on /stats response"
      contains: "web_app"
    - path: "bot/handlers/learn.py"
      provides: "Open in App button on /learn response"
      contains: "web_app"
    - path: "bot/handlers/train.py"
      provides: "Open in App button on /train response"
      contains: "web_app"
    - path: "bot/handlers/support.py"
      provides: "Open in App button on /support response"
      contains: "web_app"
    - path: "bot/handlers/leads.py"
      provides: "Open in App button on /leads response"
      contains: "web_app"
  key_links:
    - from: "bot/main.py"
      to: "bot/config.py"
      via: "cfg.tma_url in workflow_data"
      pattern: "tma_url.*workflow_data|workflow_data.*tma_url"
    - from: "bot/handlers/stats.py"
      to: "bot/utils_tma.py"
      via: "add_open_in_app_row import"
      pattern: "from bot.utils_tma import"
    - from: "bot/main.py"
      to: "bot/utils_tma.py"
      via: "setup_menu_button call at startup"
      pattern: "setup_menu_button"
---

<objective>
Add "Open in App" inline buttons to all 5 bot command handlers and configure the TMA menu button at startup.

Purpose: This is the primary bot-side integration that lets users seamlessly jump from bot text responses into the rich TMA experience (BOT-01, BOT-02, BOT-03).
Output: Modified bot handlers with WebAppInfo buttons, new helper module, updated config and main.py.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-bot-integration/07-RESEARCH.md
@bot/config.py
@bot/main.py
@bot/handlers/stats.py
@bot/handlers/learn.py
@bot/handlers/train.py
@bot/handlers/support.py
@bot/handlers/leads.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Bot infrastructure -- config, helper module, and main.py</name>
  <files>bot/config.py, bot/utils_tma.py, bot/main.py</files>
  <action>
1. **bot/config.py**: Add `tma_url: str = ""` field to the Settings class, right after the existing `assemblyai_api_key` field (in the "Configuration" section). This is the TMA deployment URL (e.g., "https://dealquest.up.railway.app"). No validation needed -- empty string means "skip TMA features."

2. **bot/utils_tma.py**: Create a NEW file with two functions:

   a. `add_open_in_app_row(keyboard: InlineKeyboardMarkup | None, tma_url: str, path: str = "") -> InlineKeyboardMarkup | None`:
      - If `tma_url` is empty/falsy, return `keyboard` unchanged (graceful skip)
      - Build URL: `f"{tma_url}/{path}"` if path else `tma_url`
      - Create new row: `[InlineKeyboardButton(text="Open in App", web_app=WebAppInfo(url=url))]`
      - If `keyboard` is None, return `InlineKeyboardMarkup(inline_keyboard=[new_row])`
      - If `keyboard` exists, return `InlineKeyboardMarkup(inline_keyboard=[*keyboard.inline_keyboard, new_row])`
      - Import `InlineKeyboardButton, InlineKeyboardMarkup` from `aiogram.types` and `WebAppInfo` from `aiogram.types`

   b. `async def setup_menu_button(bot: Bot, tma_url: str) -> None`:
      - If `tma_url` is empty, log warning "TMA_URL not configured, skipping menu button setup" and return
      - Call `await bot.set_chat_menu_button(menu_button=MenuButtonWebApp(text="Open App", web_app=WebAppInfo(url=tma_url)))`
      - Wrap in try/except, log success at info level, log failure at warning level
      - Import `Bot` from `aiogram`, `MenuButtonWebApp` from `aiogram.types`

3. **bot/main.py**: Two changes:

   a. Add `"tma_url": cfg.tma_url,` to the `dp.workflow_data.update(...)` dict (after the existing `admin_usernames` entry)

   b. After bot initialization (after `dp = Dispatcher(...)` block), before `dp.include_router(...)`, add:
      ```python
      # Set up TMA menu button
      from bot.utils_tma import setup_menu_button
      await setup_menu_button(bot, cfg.tma_url)
      ```
      Note: This must be awaited BEFORE polling starts. Place it after the authorization middleware block and before the router registration block.
  </action>
  <verify>
    - `python -c "from bot.config import load_settings; s = load_settings(); print(f'tma_url={s.tma_url!r}')"` prints `tma_url=''`
    - `python -c "from bot.utils_tma import add_open_in_app_row, setup_menu_button; print('imports OK')"` succeeds
    - `python -c "from bot.main import main; print('main module loads')"` succeeds (no import errors)
  </verify>
  <done>
    - Settings class has tma_url field with empty string default
    - utils_tma.py exports add_open_in_app_row and setup_menu_button
    - main.py injects tma_url into workflow_data and calls setup_menu_button at startup
    - All three files have no import errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add "Open in App" button to all 5 command handlers</name>
  <files>bot/handlers/stats.py, bot/handlers/learn.py, bot/handlers/train.py, bot/handlers/support.py, bot/handlers/leads.py</files>
  <action>
Each handler needs: (1) import `add_open_in_app_row` from `bot.utils_tma`, (2) accept `tma_url: str = ""` as a handler parameter (injected via workflow_data), (3) use `add_open_in_app_row` to append the button row.

**Bot command -> TMA page mapping:**
- /stats -> root (path="")
- /learn -> learn (path="learn")
- /train -> train (path="train")
- /support -> support (path="support")
- /leads -> leads (path="leads")

Specific changes per handler:

**stats.py** -- `cmd_stats` function:
- Add `tma_url: str = ""` parameter to `cmd_stats`
- Add `from bot.utils_tma import add_open_in_app_row` at top
- After the existing keyboard is built (line ~129), wrap it: `keyboard = add_open_in_app_row(keyboard, tma_url)`
- The "Open in App" button will appear as the 3rd row, after the two existing action button rows

**learn.py** -- `cmd_learn` function:
- Add `tma_url: str = ""` parameter to `cmd_learn`
- Add `from bot.utils_tma import add_open_in_app_row` at top
- After `keyboard = InlineKeyboardMarkup(inline_keyboard=buttons)` (line ~136), add: `keyboard = add_open_in_app_row(keyboard, tma_url, "learn")`
- Also handle the `else: keyboard = None` case -- if no levels are unlocked yet, still show Open in App: change the else block to `keyboard = add_open_in_app_row(None, tma_url, "learn")`

**train.py** -- `cmd_train` function:
- Add `tma_url: str = ""` parameter to `cmd_train`
- Add `from bot.utils_tma import add_open_in_app_row` at top
- After `reply_markup=DIFFICULTY_KEYBOARD` in the `message.answer()` call, change to use a modified keyboard: Before the `await message.answer(...)` call, add `kb = add_open_in_app_row(DIFFICULTY_KEYBOARD, tma_url, "train")` and use `reply_markup=kb` instead of `reply_markup=DIFFICULTY_KEYBOARD`
- IMPORTANT: Do NOT mutate the module-level `DIFFICULTY_KEYBOARD` constant. The helper creates a new InlineKeyboardMarkup, so this is safe.

**support.py** -- `cmd_support` function:
- Add `tma_url: str = ""` parameter to `cmd_support`
- Add `from bot.utils_tma import add_open_in_app_row` at top
- Currently `cmd_support` sends a text-only response with NO inline keyboard. Add an inline keyboard with just the "Open in App" button: `keyboard = add_open_in_app_row(None, tma_url, "support")`, then add `reply_markup=keyboard` to the `message.answer()` call. If tma_url is empty, `keyboard` will be None, and `reply_markup=None` means no keyboard (current behavior preserved).

**leads.py** -- `cmd_leads` function:
- Add `tma_url: str = ""` parameter to `cmd_leads`
- Add `from bot.utils_tma import add_open_in_app_row` at top
- For the "no leads" case: add `keyboard = add_open_in_app_row(None, tma_url, "leads")` and add `reply_markup=keyboard` to the message.answer call
- For the "has leads" case: after `reply_markup=_leads_list_keyboard(leads)`, change to first build the keyboard then wrap it: `kb = _leads_list_keyboard(leads)` then `kb = add_open_in_app_row(kb, tma_url, "leads")` and use `reply_markup=kb`

**CRITICAL:** Only modify the initial `/command` handler functions (cmd_stats, cmd_learn, cmd_train, cmd_support, cmd_leads). Do NOT modify callback query handlers (on_stats_learn, on_difficulty_chosen, etc.) -- those are mid-flow interactions, not entry points.
  </action>
  <verify>
    - `python -c "from bot.handlers.stats import router; print('stats OK')"` succeeds
    - `python -c "from bot.handlers.learn import router; print('learn OK')"` succeeds
    - `python -c "from bot.handlers.train import router; print('train OK')"` succeeds
    - `python -c "from bot.handlers.support import router; print('support OK')"` succeeds
    - `python -c "from bot.handlers.leads import router; print('leads OK')"` succeeds
    - Grep for "add_open_in_app_row" across all 5 handler files confirms each handler uses it
    - Grep for "web_app" in utils_tma.py confirms WebAppInfo usage
  </verify>
  <done>
    - All 5 command handlers (/stats, /learn, /train, /support, /leads) include an "Open in App" inline button as the LAST row
    - Each handler gracefully skips the button when tma_url is empty
    - Each button opens the correct TMA page path (root, learn, train, support, leads)
    - No existing keyboard rows are replaced or removed -- "Open in App" is always appended
    - No callback query handlers are modified
  </done>
</task>

</tasks>

<verification>
1. All Python files import without errors: `python -c "from bot.main import main; print('OK')"`
2. Grep confirms all 5 handlers import add_open_in_app_row
3. Grep confirms WebAppInfo is used in utils_tma.py
4. bot/config.py has tma_url field
5. bot/main.py has tma_url in workflow_data and calls setup_menu_button
</verification>

<success_criteria>
- Settings class includes tma_url with empty default
- Helper module (utils_tma.py) provides reusable add_open_in_app_row and setup_menu_button
- All 5 bot command handlers append "Open in App" as the last keyboard row
- Menu button is set programmatically at bot startup
- Everything gracefully degrades when TMA_URL is not set (empty string = no changes to behavior)
- No existing bot functionality is broken
</success_criteria>

<output>
After completion, create `.planning/phases/07-bot-integration/07-01-SUMMARY.md`
</output>
