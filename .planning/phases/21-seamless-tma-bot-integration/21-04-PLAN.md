---
phase: 21-seamless-tma-bot-integration
plan: 04
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - bot/services/plan_scheduler.py
  - bot/utils_tma.py
  - packages/webapp/src/shared/hooks/useDeepLink.ts
  - packages/webapp/src/app/Router.tsx
  - packages/webapp/src/features/dashboard/hooks/useSmartLanding.ts
  - packages/webapp/src/pages/Dashboard.tsx
autonomous: true

must_haves:
  truths:
    - "Opening TMA via bot deep link to a lead lands on the exact step action screen (not just the lead page)"
    - "Opening TMA via deep link with section=plan auto-expands the plan section"
    - "Opening TMA via menu button resumes the last-viewed page (stored in localStorage)"
    - "When no last-viewed context exists and overdue actions exist, Dashboard shows overdue hero section"
    - "Last-viewed context is cleared after 24 hours to prevent stale navigation"
  artifacts:
    - path: "packages/webapp/src/shared/hooks/useDeepLink.ts"
      provides: "Enhanced deep link parsing for section and action params"
      contains: "section"
    - path: "packages/webapp/src/features/dashboard/hooks/useSmartLanding.ts"
      provides: "Session resume from localStorage with 24h expiry"
      contains: "localStorage"
    - path: "bot/utils_tma.py"
      provides: "Deep link URL with section and action query params"
      contains: "query_params"
  key_links:
    - from: "bot/services/plan_scheduler.py"
      to: "bot/utils_tma.py"
      via: "add_open_in_app_row with section=action query param"
      pattern: "section.*action"
    - from: "packages/webapp/src/shared/hooks/useDeepLink.ts"
      to: "packages/webapp/src/app/Router.tsx"
      via: "useLocation reading query params on mount"
      pattern: "searchParams"
    - from: "packages/webapp/src/features/dashboard/hooks/useSmartLanding.ts"
      to: "localStorage"
      via: "useSessionResume reading/writing last viewed path"
      pattern: "localStorage"
---

<objective>
Enhance deep links to target exact screens and sections (step action screen, plan section), and add session resume so opening TMA via menu button returns to the last-viewed context.

Purpose: SC4 requires deep links to land on exact screens (not just lead pages). SC5 requires the menu button to resume last-viewed context with an overdue-actions fallback. This plan delivers both.

Output: Precise deep links from bot, enhanced TMA route handling for query params, and localStorage-based session resume.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bot/services/plan_scheduler.py
@bot/utils_tma.py
@packages/webapp/src/shared/hooks/useDeepLink.ts
@packages/webapp/src/app/Router.tsx
@packages/webapp/src/features/dashboard/hooks/useSmartLanding.ts
@packages/webapp/src/pages/Dashboard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance bot deep links with section and action parameters</name>
  <files>
    bot/services/plan_scheduler.py
    bot/utils_tma.py
  </files>
  <action>
The existing deep link from reminder messages uses: `leads/{lead_id}?step={step_id}`

This already navigates to the lead page and highlights the step. However, it doesn't:
1. Auto-open the step action screen (the user has to tap the step)
2. Expand the plan section if collapsed

Update `_reminder_action_keyboard` in `plan_scheduler.py` to include an `action=execute` query param:
```python
query_params={"step": str(step_id), "action": "execute"}
```

This tells the TMA to auto-open the StepActionScreen for that step when the lead detail loads.

Also update the plan_poller's `_notify_plan_ready` function to include `section=plan` so the plan section auto-expands:
- Read `bot/services/plan_poller.py` and find the `add_open_in_app_row` call in `_notify_plan_ready`
- Add query_params: `query_params={"section": "plan"}`

No changes needed to `bot/utils_tma.py` itself -- the existing `add_open_in_app_row` already supports arbitrary query_params via `urlencode`. Just need to pass the right params from callers.
  </action>
  <verify>Read plan_scheduler.py _reminder_action_keyboard for `action=execute` param. Read plan_poller.py _notify_plan_ready for `section=plan` param.</verify>
  <done>Bot deep links include action=execute for step reminders and section=plan for plan-ready notifications, enabling precise TMA navigation.</done>
</task>

<task type="auto">
  <name>Task 2: Enhance TMA deep link handling and add session resume</name>
  <files>
    packages/webapp/src/shared/hooks/useDeepLink.ts
    packages/webapp/src/app/Router.tsx
    packages/webapp/src/features/dashboard/hooks/useSmartLanding.ts
    packages/webapp/src/pages/Dashboard.tsx
  </files>
  <action>
**Part A: Session tracking (write side)**

Add a `useSessionTracker` hook or integrate into existing Router:
- In `AppRoutes` (inside Router.tsx), add a `useEffect` that runs on every `location.pathname` change
- Writes to `localStorage.setItem('dq_last_path', JSON.stringify({ path: location.pathname + location.search, ts: Date.now() }))`
- Debounce: only write if path actually changed (compare to previous via useRef)
- Exclude non-resumable paths: don't save '/' (dashboard), '/admin/*' paths
- This is lightweight -- just a localStorage write on navigation

**Part B: Session resume (read side)**

Enhance `useSmartLanding` in `packages/webapp/src/features/dashboard/hooks/useSmartLanding.ts`:
- Add a new field to `SmartLandingResult`: `resumePath: string | null`
- On mount, check `localStorage.getItem('dq_last_path')`
- Parse the JSON, check if `ts` is within 24 hours (86400000ms)
- If valid and path is not '/', set `resumePath` to the stored path
- Clear the stored path after reading (one-shot resume)

In `Dashboard.tsx`:
- Get `resumePath` from `useSmartLanding()`
- If `resumePath` is set AND the user arrived at '/' via the menu button (not via deep link -- check that there's no `startParam` and no direct URL path), navigate to `resumePath` using `navigate(resumePath, { replace: true })`
- Use a `useEffect` with a ref guard (only fire once) to avoid navigation loops
- The effect should run after `isReady` is true so it doesn't flash
- If resumePath is null, fall back to existing smart landing behavior (overdue hero, streak, etc.)

**Part C: Deep link query param handling for action=execute and section=plan**

The existing LeadDetail component already reads `?step=stepId` from URL search params (from Phase 16). Extend this:

In LeadDetail.tsx (read the current file first to understand the step highlighting logic):
- Read `action` param from URL search: `const action = searchParams.get('action')`
- If `action === 'execute'` AND `step` param exists:
  - After the lead loads, auto-set the `activeStepId` state (or equivalent) to open the StepActionScreen for that step
  - This should behave as if the user tapped the step row
  - Clear the query params after processing (use `navigate(location.pathname, { replace: true })` to avoid re-triggering on back navigation)

For `section=plan` param:
- Read `section` param from URL search
- If `section === 'plan'`, ensure the Plan CollapsibleSection is expanded (it should already be default-expanded as it's the "plan-first layout" from Phase 16, but confirm)
- If for some reason it's collapsed, auto-expand it

Note: The deep link hook (`useDeepLink.ts`) handles `startParam` from direct Telegram links (t.me/bot/app?startapp=leads). It does NOT need changes for query params because WebApp inline buttons (which is what reminder "Open in App" uses) already load the full URL with path and query params directly into the BrowserRouter. The `useDeepLink` hook is only a fallback for `startapp=` parameter.
  </action>
  <verify>Read Router.tsx for localStorage session tracking on navigation. Read useSmartLanding.ts for resumePath field with 24h expiry. Read Dashboard.tsx for session resume navigation. Read LeadDetail.tsx for action=execute auto-opening StepActionScreen.</verify>
  <done>Deep links land on exact screens (step action screen, plan section). Menu button reopens last-viewed page (within 24h). Session tracking writes on navigation, resumes on Dashboard mount.</done>
</task>

</tasks>

<verification>
1. Read plan_scheduler.py -- reminder Open in App includes action=execute param
2. Read plan_poller.py -- plan-ready Open in App includes section=plan param
3. Read Router.tsx -- session tracking writes to localStorage on pathname change
4. Read useSmartLanding.ts -- resumePath reads from localStorage with 24h expiry
5. Read Dashboard.tsx -- navigates to resumePath if available
6. Read LeadDetail.tsx -- action=execute auto-opens StepActionScreen
7. Confirm session tracking excludes '/' and '/admin/*' paths
8. Confirm resumePath is cleared after use (one-shot)
</verification>

<success_criteria>
- Tapping "Open in App" on a reminder opens the step action screen directly
- Tapping "Open in App" on a plan-ready notification opens lead with plan section visible
- Opening TMA via menu button resumes last-viewed lead or page (within 24h)
- After 24h, session context expires and Dashboard shows normal smart landing
- No navigation loops or flash of wrong content
</success_criteria>

<output>
After completion, create `.planning/phases/21-seamless-tma-bot-integration/21-04-SUMMARY.md`
</output>
