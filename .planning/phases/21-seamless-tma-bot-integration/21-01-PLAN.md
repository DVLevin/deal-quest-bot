---
phase: 21-seamless-tma-bot-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bot/services/plan_scheduler.py
  - bot/handlers/reminders.py
autonomous: true

must_haves:
  truths:
    - "Bot reminder messages show the full draft text inline (not just a preview) when available"
    - "Reminder messages include a [Copy Draft] button that displays the full draft as a separate message the user can copy"
    - "Reminder messages include a [Mark Done] button that completes the step and shows next step info"
    - "After marking done via inline button, the confirmation message tells user when the next step is due"
  artifacts:
    - path: "bot/services/plan_scheduler.py"
      provides: "Enhanced reminder message with full draft inline and updated keyboard"
      contains: "_format_reminder_message"
    - path: "bot/handlers/reminders.py"
      provides: "Enhanced done handler with next step info, copy_draft handler"
      contains: "reminder:copy_draft"
  key_links:
    - from: "bot/services/plan_scheduler.py"
      to: "bot/handlers/reminders.py"
      via: "callback_data format: reminder:copy_draft:{lead_id}:{step_id}"
      pattern: "reminder:copy_draft"
---

<objective>
Upgrade bot reminder messages to be self-contained action points -- users can read the full draft, copy it, and mark the step done without ever opening the TMA. After marking done, the bot tells them when their next step is due.

Purpose: SC1 requires 80% of step completions to happen without opening TMA. Currently reminders show a truncated 150-char preview and "View Full Draft" replaces the message. This plan makes the reminder itself the primary action interface.

Output: Enhanced plan_scheduler.py reminder messages with full draft inline, updated keyboard with Copy Draft and Mark Done buttons, and enhanced reminders.py handlers.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bot/services/plan_scheduler.py
@bot/handlers/reminders.py
@bot/storage/repositories.py
@bot/storage/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance reminder message format and keyboard for self-contained actions</name>
  <files>bot/services/plan_scheduler.py</files>
  <action>
Modify `_format_reminder_message` to include the full draft text inline (not truncated to 150 chars). The message should show:
- Lead name and company (existing)
- Step number and description (existing)
- Full draft text in a clearly formatted block (new -- show full `draft_text` or `suggested_text` from the step, not truncated). If draft text exceeds Telegram's 4096 char limit, truncate at 3500 chars with "..." suffix and keep the "View Full Draft" button for overflow.
- Format the draft section as: `\n\nüìù *Suggested draft:*\n\n{draft_text}` (not in quotes, not italicized -- clean readable text the user can long-press to copy natively).

Modify `_reminder_action_keyboard` to reorganize buttons:
- Row 1: [Mark Done] [Snooze 24h] (primary actions -- remove Skip from first row to reduce cognitive load)
- Row 2: [Copy Draft] [Skip] (Copy Draft is new -- callback_data: `reminder:copy_draft:{lead_id}:{step_id}`)
- Row 3: [Open in App] (existing deep link -- keep as-is)

Remove the existing "View Full Draft" button since the draft is now shown inline. Only keep it as a fallback if the draft was truncated (over 3500 chars).

Key constraints:
- Telegram message limit is 4096 chars. The message header (lead name, step, intro) uses ~200-300 chars. Leave room.
- `draft_text` field on ScheduledReminderModel is capped at 500 chars. But the step's `suggested_text` may be longer. Try `suggested_text` from the engagement_plan step first, fall back to `reminder.draft_text`.
- Keep parse_mode="Markdown" (existing).
  </action>
  <verify>Read bot/services/plan_scheduler.py and confirm: (1) _format_reminder_message includes full draft text section, (2) keyboard has Copy Draft button with correct callback_data format, (3) truncation at 3500 chars with fallback View Full Draft button, (4) Skip moved to row 2.</verify>
  <done>Reminder messages display the full draft inline with a reorganized keyboard: [Mark Done][Snooze] on row 1, [Copy Draft][Skip] on row 2, [Open in App] on row 3.</done>
</task>

<task type="auto">
  <name>Task 2: Add Copy Draft handler and enhance Done handler with next step info</name>
  <files>bot/handlers/reminders.py</files>
  <action>
Add a new callback handler `on_reminder_copy_draft` for `reminder:copy_draft:{lead_id}:{step_id}`:
- Parse lead_id and step_id from callback_data
- Fetch lead from lead_repo, find the step in engagement_plan
- Get the full draft text: try step's `suggested_text`, fall back to reminder's `draft_text`
- Send the draft as a NEW message (not edit -- use `callback.message.answer()`) with ONLY the draft text and no formatting/headers. This lets the user long-press to copy the entire message content. Add a small footer: `\n\n_Tap and hold to copy_`
- Answer the callback with "Draft sent below"

Enhance `on_reminder_done` to include next step information:
- After marking the step done, find the next pending step in the engagement_plan (step with status != 'done' and status != 'skipped', sorted by step_id ascending)
- If a next step exists, find its corresponding reminder from reminder_repo to get the due_at date
- Update the confirmation message to include: "Next step: Step {N} ‚Äî {description}\nDue: {due_date_formatted}" (format due_date as "in X days" or "tomorrow" or "today" relative text)
- If no next step exists, show: "All steps complete! Great job finishing the engagement plan."
- Keep existing activity logging and dual-table update logic unchanged.

Helper function `_format_relative_date(due_at_iso: str) -> str`:
- Parse ISO date string, compare to now (UTC)
- Return: "today" if same day, "tomorrow" if next day, "in {N} days" otherwise, "overdue by {N} days" if past
  </action>
  <verify>Read bot/handlers/reminders.py and confirm: (1) on_reminder_copy_draft handler exists with correct filter, (2) sends draft as new message via answer(), (3) on_reminder_done shows next step info, (4) _format_relative_date helper exists.</verify>
  <done>Copy Draft callback sends the full draft as a copyable message. Done callback shows next step name and due date (or completion message if all steps are done).</done>
</task>

</tasks>

<verification>
1. Read plan_scheduler.py -- reminder message includes full draft text inline
2. Read plan_scheduler.py -- keyboard has [Mark Done][Snooze], [Copy Draft][Skip], [Open in App] rows
3. Read reminders.py -- `reminder:copy_draft:` handler exists and sends draft as new message
4. Read reminders.py -- done handler finds next pending step and formats relative due date
5. Confirm callback_data format consistency: `reminder:copy_draft:{lead_id}:{step_id}`
</verification>

<success_criteria>
- Reminder messages are self-contained: user sees full draft, can copy it, and mark done without leaving Telegram
- After marking done, user knows exactly when their next step is due
- No regressions to existing Snooze, Skip, or View Lead functionality
</success_criteria>

<output>
After completion, create `.planning/phases/21-seamless-tma-bot-integration/21-01-SUMMARY.md`
</output>
