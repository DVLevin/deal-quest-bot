---
phase: 13-smart-lead-creation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bot/services/llm_router.py
  - bot/services/image_utils.py
  - requirements.txt
autonomous: true

must_haves:
  truths:
    - "ClaudeProvider.complete() sends images to Claude API using multipart content array format"
    - "Images larger than 1568px are resized before being sent to vision models"
    - "Pillow dependency is added to requirements.txt"
  artifacts:
    - path: "bot/services/llm_router.py"
      provides: "Fixed ClaudeProvider with image support"
      contains: "type.*image"
    - path: "bot/services/image_utils.py"
      provides: "Image pre-resize utility"
      exports: ["pre_resize_image"]
    - path: "requirements.txt"
      provides: "Pillow dependency"
      contains: "Pillow"
  key_links:
    - from: "bot/services/llm_router.py"
      to: "Claude Messages API"
      via: "multipart content array with image block"
      pattern: 'type.*image.*source.*base64'
---

<objective>
Fix ClaudeProvider to correctly process images and add image pre-resize utility.

Purpose: Claude vision models currently don't receive images because ClaudeProvider ignores the image_b64 parameter. This blocks screenshot-based lead creation for users with Claude API keys. Additionally, large images should be pre-resized to 1568px to reduce token cost and latency.

Output: Working ClaudeProvider image support and a reusable image resize utility.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-smart-lead-creation/13-RESEARCH.md

# Source files
@bot/services/llm_router.py
@requirements.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix ClaudeProvider image support</name>
  <files>bot/services/llm_router.py</files>
  <action>
Fix the `ClaudeProvider.complete()` method to correctly handle the `image_b64` parameter.

Current broken implementation (line 94-101) ignores image_b64 entirely:
```python
resp = await self._client.post(
    "/v1/messages",
    json={
        "model": self.model,
        "max_tokens": 4096,
        "system": system_prompt,
        "messages": [{"role": "user", "content": user_message}],  # Ignores image!
    },
)
```

Replace with multipart content array when image is provided:
```python
# Build user content - multipart if image provided
if image_b64:
    user_content: list[dict[str, Any]] | str = [
        {
            "type": "image",
            "source": {
                "type": "base64",
                "media_type": "image/jpeg",
                "data": image_b64,
            },
        },
        {"type": "text", "text": user_message},
    ]
else:
    user_content = user_message

resp = await self._client.post(
    "/v1/messages",
    json={
        "model": self.model,
        "max_tokens": 4096,
        "system": system_prompt,
        "messages": [{"role": "user", "content": user_content}],
    },
)
```

This matches the pattern already used in `OpenRouterProvider.complete()` (lines 165-174) but uses Claude's native image format instead of OpenAI's image_url format.
  </action>
  <verify>
Grep for the pattern to confirm multipart content is implemented:
```bash
grep -A5 "type.*image" bot/services/llm_router.py
```
Should show the image block with source.type: base64.
  </verify>
  <done>ClaudeProvider.complete() builds multipart content array when image_b64 is provided, matching Claude Messages API format.</done>
</task>

<task type="auto">
  <name>Task 2: Add image pre-resize utility</name>
  <files>bot/services/image_utils.py, requirements.txt</files>
  <action>
1. Add Pillow to requirements.txt:
```
Pillow>=10.0.0
```

2. Create new file `bot/services/image_utils.py` with the pre-resize function:

```python
"""Image utilities for vision model preprocessing."""

from __future__ import annotations

import logging
from io import BytesIO

from PIL import Image

logger = logging.getLogger(__name__)

MAX_DIMENSION = 1568  # Claude recommended max for vision


def pre_resize_image(image_bytes: bytes, max_dim: int = MAX_DIMENSION) -> bytes:
    """Resize image to fit within max_dim on longest edge, preserving aspect ratio.

    Args:
        image_bytes: Raw image bytes (JPEG, PNG, etc.)
        max_dim: Maximum dimension for longest edge (default 1568px per Claude docs)

    Returns:
        JPEG bytes, resized if original exceeded max_dim
    """
    img = Image.open(BytesIO(image_bytes))

    # Convert to RGB if needed (handles RGBA, P, L modes)
    if img.mode not in ("RGB",):
        img = img.convert("RGB")

    original_size = max(img.width, img.height)

    # Only resize if exceeds limit
    if original_size > max_dim:
        # thumbnail modifies in place, preserves aspect ratio, uses best resampling
        img.thumbnail((max_dim, max_dim), Image.Resampling.LANCZOS)
        logger.info(
            "Pre-resized image from %dx%d to %dx%d",
            img.width if original_size == img.width else img.height,
            img.height if original_size == img.height else img.width,
            img.width,
            img.height,
        )

    # Save as JPEG (smaller than PNG for photos, widely supported)
    output = BytesIO()
    img.save(output, format="JPEG", quality=85)
    return output.getvalue()
```

Key implementation notes:
- Uses Pillow's `thumbnail()` which modifies in place and preserves aspect ratio
- LANCZOS resampling for best quality downscaling
- Converts to RGB to handle various input formats (PNG with alpha, palette images)
- Returns JPEG at quality=85 (good balance of size and clarity)
- Logs when resize occurs for debugging
  </action>
  <verify>
```bash
# Check Pillow in requirements
grep -i pillow requirements.txt

# Check function exists and has correct signature
grep -A3 "def pre_resize_image" bot/services/image_utils.py

# Verify imports work (quick syntax check)
python3 -c "from bot.services.image_utils import pre_resize_image; print('OK')"
```
  </verify>
  <done>Image pre-resize utility exists with pre_resize_image() function that resizes to 1568px max dimension using Pillow.</done>
</task>

</tasks>

<verification>
1. ClaudeProvider has multipart content array implementation:
   ```bash
   grep -c "type.*image" bot/services/llm_router.py  # Should be >= 1
   ```

2. Image utils module importable:
   ```bash
   python3 -c "from bot.services.image_utils import pre_resize_image, MAX_DIMENSION; print(f'MAX_DIMENSION={MAX_DIMENSION}')"
   ```

3. Pillow in requirements:
   ```bash
   grep -i pillow requirements.txt
   ```
</verification>

<success_criteria>
- ClaudeProvider.complete() correctly sends images using multipart content array format (matching Claude Messages API spec)
- pre_resize_image() function exists and resizes images to 1568px max dimension
- Pillow>=10.0.0 added to requirements.txt
- No breaking changes to existing text-only calls (user_content falls back to plain string when no image)
</success_criteria>

<output>
After completion, create `.planning/phases/13-smart-lead-creation/13-01-SUMMARY.md`
</output>
