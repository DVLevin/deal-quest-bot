---
phase: 09-training-experience
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/webapp/src/lib/queries.ts
  - packages/webapp/src/features/train/hooks/useTrainingStats.ts
  - packages/webapp/src/features/train/components/DifficultyRecommendation.tsx
  - packages/webapp/src/features/train/components/ScenarioVariety.tsx
  - packages/webapp/src/pages/Train.tsx
autonomous: true

must_haves:
  truths:
    - "Train page shows a recommended difficulty based on user's average scores per difficulty"
    - "Recommendation shows 'Try Hard' / 'Try Medium' / 'Stay at Easy' etc. with average score context"
    - "Train page shows remaining unseen scenarios count before starting training"
    - "When unseen scenarios count is 3 or fewer, a nudge message encourages variety"
    - "New users with insufficient data see 'Not enough data' instead of a recommendation"
  artifacts:
    - path: "packages/webapp/src/features/train/hooks/useTrainingStats.ts"
      provides: "Shared hook: cross-references attempts with scenario pool to compute avg score per difficulty, recommended difficulty, unseen scenario count"
      exports: ["useTrainingStats"]
    - path: "packages/webapp/src/features/train/components/DifficultyRecommendation.tsx"
      provides: "Card showing recommended difficulty with avg score context"
      exports: ["DifficultyRecommendation"]
    - path: "packages/webapp/src/features/train/components/ScenarioVariety.tsx"
      provides: "Indicator showing X unseen scenarios remaining with low-pool nudge"
      exports: ["ScenarioVariety"]
  key_links:
    - from: "packages/webapp/src/features/train/hooks/useTrainingStats.ts"
      to: "InsForge attempts + scenarios_seen tables"
      via: "TanStack Query with refetchOnWindowFocus"
      pattern: "getInsforge.*from.*attempts"
    - from: "packages/webapp/src/features/train/hooks/useTrainingStats.ts"
      to: "packages/webapp/src/features/train/data/scenarios.ts"
      via: "TRAIN_POOL import for difficulty map"
      pattern: "import.*TRAIN_POOL"
    - from: "packages/webapp/src/pages/Train.tsx"
      to: "DifficultyRecommendation + ScenarioVariety"
      via: "Component composition in filter step"
      pattern: "<DifficultyRecommendation|<ScenarioVariety"
---

<objective>
Create the useTrainingStats shared hook and add difficulty recommendation + scenario variety indicators to the Train page.

Purpose: Users get actionable training guidance -- the app suggests appropriate difficulty based on performance and shows how many unseen scenarios remain, encouraging variety (TRAIN-V11-01 + TRAIN-V11-04).

Output: useTrainingStats hook, DifficultyRecommendation component, ScenarioVariety component, updated Train page.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-training-experience/09-RESEARCH.md
@packages/webapp/src/pages/Train.tsx
@packages/webapp/src/features/train/hooks/useScenarioPool.ts
@packages/webapp/src/features/train/data/scenarios.ts
@packages/webapp/src/features/profile/hooks/useUserStats.ts
@packages/webapp/src/features/admin/hooks/useWeakAreas.ts
@packages/webapp/src/lib/queries.ts
@packages/webapp/src/types/tables.ts
@packages/webapp/src/types/constants.ts
@packages/webapp/src/shared/ui/Card.tsx
@packages/webapp/src/shared/ui/Badge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useTrainingStats hook and add query keys</name>
  <files>
    packages/webapp/src/features/train/hooks/useTrainingStats.ts
    packages/webapp/src/lib/queries.ts
  </files>
  <action>
    1. Add new query keys to `queryKeys` in queries.ts:
       - `training.stats: (telegramId: number) => ['training', telegramId, 'stats'] as const`
       (Add a new `training` section to queryKeys object.)

    2. Create `useTrainingStats.ts` hook that:
       a. Fetches user's last 100 train-mode attempts from InsForge (`attempts` table, filtered by `telegram_id` and `mode = 'train'`, select `scenario_id, score, created_at`).
       b. Fetches `scenarios_seen` for the user (`scenario_id` column, filtered by `telegram_id`).
       c. Imports `TRAIN_POOL` from `../data/scenarios` and `useScenarioPool` (difficulty=undefined for full pool) to build a scenario_id -> difficulty `Map<string, number>`.
       d. Also tries to load generated_scenarios from the scenario pool hook to include DB scenarios in the difficulty map.
       e. Cross-references attempts with the difficulty map to compute `avgScoreByDifficulty: Record<number, { avg: number; count: number }>` (groups 1, 2, 3).
       f. Computes `recommendedDifficulty: number | null` using threshold logic:
          - MIN_ATTEMPTS = 3 (need at least 3 attempts at a difficulty to consider it)
          - Check user's current highest difficulty with enough data
          - If avg >= 70 at that difficulty AND diff < 3: recommend diff + 1 (promote)
          - If avg < 40 at that difficulty AND diff > 1: recommend diff - 1 (demote)
          - Otherwise: recommend current difficulty (stay)
          - If no difficulty has MIN_ATTEMPTS: return null
       g. Computes `unseenCount` = total pool size minus seen scenarios count.
       h. Computes `isRunningLow` = unseenCount <= 3 AND total pool > 0.
       i. Uses `refetchOnWindowFocus: true` on the attempts query for freshness.
       j. Returns interface `TrainingStats`:
          ```
          {
            avgScoreByDifficulty: Record<number, { avg: number; count: number }>;
            recommendedDifficulty: number | null;
            unseenCount: number;
            totalPoolSize: number;
            isRunningLow: boolean;
            isLoading: boolean;
          }
          ```

    Key patterns to follow:
    - Use `useAuthStore((s) => s.telegramId)` for user identity (same as useUserStats).
    - Use `getInsforge().database.from(...)` for queries (same as useUserStats).
    - Guard all averages with `count > 0` checks to prevent NaN/Infinity.
    - Use `useMemo` for derived computations over fetched data, not React state.
    - Filter attempts by `mode = 'train'` to exclude learn attempts (Pitfall 2 from research).
  </action>
  <verify>
    TypeScript compiles without errors: `cd packages/webapp && npx tsc --noEmit 2>&1 | head -20`
  </verify>
  <done>
    useTrainingStats hook exists, exports TrainingStats interface, compiles cleanly, query keys added.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DifficultyRecommendation and ScenarioVariety components, wire into Train page</name>
  <files>
    packages/webapp/src/features/train/components/DifficultyRecommendation.tsx
    packages/webapp/src/features/train/components/ScenarioVariety.tsx
    packages/webapp/src/pages/Train.tsx
  </files>
  <action>
    1. Create `DifficultyRecommendation.tsx`:
       - Receives props: `recommendedDifficulty: number | null`, `avgScoreByDifficulty: Record<number, { avg: number; count: number }>`, `onSelectDifficulty: (diff: number) => void`
       - When `recommendedDifficulty` is null: render nothing (return null) -- not enough data yet.
       - When recommendation exists: render a Card with:
         - Icon: TrendingUp from lucide-react (or Target)
         - Title: "Recommended: {DIFFICULTY_LABELS[recommendedDifficulty]}" (use DIFFICULTY_LABELS from constants)
         - Subtitle context: e.g., "You're averaging {avg} on {currentDiffLabel}" (show the score at the difficulty level that triggered the recommendation)
         - A small "Try it" button/link that calls `onSelectDifficulty(recommendedDifficulty)`
       - Use Card from shared/ui, text-sm, text-text-secondary for subtitle.
       - 44px min touch target on the Try it button.

    2. Create `ScenarioVariety.tsx`:
       - Receives props: `unseenCount: number`, `totalPoolSize: number`, `isRunningLow: boolean`
       - Renders a text line showing: "{unseenCount} of {totalPoolSize} scenarios unseen"
       - When `isRunningLow` is true: show an additional nudge line in text-warning or text-accent:
         "Only {unseenCount} left! Great coverage -- consider revisiting past scenarios."
       - Use text-xs text-text-hint for the count, text-xs text-warning for the nudge.
       - If totalPoolSize is 0, render nothing (return null).

    3. Update `Train.tsx` filter step:
       - Import `useTrainingStats` and both new components.
       - Call `useTrainingStats()` at component top level (unconditionally).
       - In the filter step render (the default return), add BEFORE the DifficultyFilter:
         ```
         <DifficultyRecommendation
           recommendedDifficulty={stats.recommendedDifficulty}
           avgScoreByDifficulty={stats.avgScoreByDifficulty}
           onSelectDifficulty={(d) => setSelectedDifficulty(d)}
         />
         ```
       - AFTER the pool size text and BEFORE the Start Training button, add:
         ```
         <ScenarioVariety
           unseenCount={stats.unseenCount}
           totalPoolSize={stats.totalPoolSize}
           isRunningLow={stats.isRunningLow}
         />
         ```
       - Replace the existing `{poolSize} scenario(s) available` text line with the ScenarioVariety component (it already shows the count in a more informative way). Keep the `poolSize` for the Start Training button disabled check.

    Layout order in filter step:
    ```
    <h1>Train</h1>
    <p>Select a difficulty...</p>
    <DifficultyRecommendation ... />   <-- NEW
    <DifficultyFilter ... />           <-- EXISTING
    {loading skeleton OR:}
      <ScenarioVariety ... />          <-- NEW (replaces plain count)
      <Button>Start Training</Button>  <-- EXISTING
    ```
  </action>
  <verify>
    TypeScript compiles: `cd packages/webapp && npx tsc --noEmit 2>&1 | head -20`
    Build succeeds: `cd packages/webapp && npx vite build 2>&1 | tail -5`
  </verify>
  <done>
    Train page shows difficulty recommendation card (when data available) above the filter buttons, and scenario variety indicator with unseen count + low-pool nudge below the filter.
  </done>
</task>

</tasks>

<verification>
1. `cd packages/webapp && npx tsc --noEmit` -- zero type errors
2. `cd packages/webapp && npx vite build` -- production build succeeds
3. Grep for key exports: `grep -r "useTrainingStats\|DifficultyRecommendation\|ScenarioVariety" packages/webapp/src/ --include="*.ts" --include="*.tsx"` confirms all components are imported and used
4. Verify no NaN/Infinity risk: `grep -n "/ " packages/webapp/src/features/train/hooks/useTrainingStats.ts` -- all divisions guarded by count > 0
</verification>

<success_criteria>
- useTrainingStats hook computes avg score per difficulty, recommended difficulty, unseen count from real InsForge data
- DifficultyRecommendation shows contextual recommendation with "Try it" CTA (or nothing when insufficient data)
- ScenarioVariety shows "X of Y scenarios unseen" with nudge when running low (<=3)
- Train page composes both components into the filter step without breaking existing flow
- All TypeScript compiles, Vite builds succeed
</success_criteria>

<output>
After completion, create `.planning/phases/09-training-experience/09-01-SUMMARY.md`
</output>
