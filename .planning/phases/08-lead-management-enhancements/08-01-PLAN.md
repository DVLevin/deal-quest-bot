---
phase: 08-lead-management-enhancements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - migrations/003_lead_source_field.sql
  - bot/storage/models.py
  - bot/handlers/support.py
  - packages/shared/src/enums.ts
  - packages/webapp/src/types/enums.ts
  - packages/shared/src/tables.ts
  - packages/webapp/src/types/tables.ts
  - packages/webapp/src/features/leads/hooks/useLeads.ts
  - packages/webapp/src/features/leads/types.ts
  - packages/webapp/src/features/leads/components/LeadCard.tsx
  - packages/webapp/src/features/leads/components/LeadDetail.tsx
autonomous: true

must_haves:
  truths:
    - "Leads not updated in 7+ days show a warning badge with 'Xd ago' text in the list view"
    - "Stale indicator also appears in the detail view header alongside status badge"
    - "Each lead displays its source as a badge (AI Analysis, Manual, or Import)"
    - "LeadRegistryRow TypeScript type includes lead_source field in both shared and webapp copies"
    - "Bot sets lead_source='support_analysis' when creating new leads"
  artifacts:
    - path: "migrations/003_lead_source_field.sql"
      provides: "Database migration adding lead_source column"
      contains: "lead_source"
    - path: "packages/webapp/src/features/leads/types.ts"
      provides: "Stale helpers and source config"
      contains: "getLeadStaleDays"
    - path: "packages/webapp/src/features/leads/components/LeadCard.tsx"
      provides: "Stale badge and source badge in list cards"
      contains: "staleDays"
    - path: "packages/webapp/src/features/leads/components/LeadDetail.tsx"
      provides: "Stale indicator and source badge in detail header"
      contains: "staleDays"
  key_links:
    - from: "packages/webapp/src/features/leads/hooks/useLeads.ts"
      to: "lead_source column in DB"
      via: "PostgREST .select() includes lead_source"
      pattern: "lead_source"
    - from: "packages/webapp/src/features/leads/components/LeadCard.tsx"
      to: "packages/webapp/src/features/leads/types.ts"
      via: "getLeadStaleDays and LEAD_SOURCE_CONFIG imports"
      pattern: "getLeadStaleDays|LEAD_SOURCE_CONFIG"
---

<objective>
Add lead_source field to the full stack (DB migration, Python model, TypeScript types, enums), then add stale lead indicators and lead source badges to LeadCard and LeadDetail components.

Purpose: Gives users visual feedback on which leads need attention (stale) and where each lead came from (source tracking). Lays the type foundation for Plan 02's list features.
Output: Migration file, updated models/types, enhanced LeadCard and LeadDetail with stale + source badges.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-lead-management-enhancements/08-RESEARCH.md

Key source files:
@packages/webapp/src/features/leads/types.ts
@packages/webapp/src/features/leads/hooks/useLeads.ts
@packages/webapp/src/features/leads/components/LeadCard.tsx
@packages/webapp/src/features/leads/components/LeadDetail.tsx
@packages/webapp/src/types/tables.ts
@packages/webapp/src/types/enums.ts
@packages/shared/src/tables.ts
@packages/shared/src/enums.ts
@bot/storage/models.py
@bot/handlers/support.py
@packages/webapp/src/shared/ui/Badge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add lead_source field across full stack (migration + models + types)</name>
  <files>
    migrations/003_lead_source_field.sql
    bot/storage/models.py
    bot/handlers/support.py
    packages/shared/src/enums.ts
    packages/webapp/src/types/enums.ts
    packages/shared/src/tables.ts
    packages/webapp/src/types/tables.ts
    packages/webapp/src/features/leads/hooks/useLeads.ts
  </files>
  <action>
    1. CREATE `migrations/003_lead_source_field.sql`:
       ```sql
       -- Add lead_source column to track how each lead was created
       ALTER TABLE lead_registry ADD COLUMN IF NOT EXISTS lead_source TEXT DEFAULT 'support_analysis';
       -- DEFAULT backfills all existing rows automatically (all created via bot /support)
       ```

    2. MODIFY `bot/storage/models.py` — add `lead_source: str = "support_analysis"` field to
       LeadRegistryModel class, place it after `followup_count` (line 106), before `created_at`.

    3. MODIFY `bot/handlers/support.py` — in the LeadRegistryModel constructor call (around line 293),
       add `lead_source="support_analysis"` as an explicit parameter. This future-proofs the code
       even though the DB default handles it.

    4. MODIFY both enum files — add LeadSource type to BOTH:
       - `packages/shared/src/enums.ts`
       - `packages/webapp/src/types/enums.ts`
       Add AFTER the existing `InputType` type:
       ```typescript
       /** lead_registry.lead_source */
       export type LeadSource = 'support_analysis' | 'manual' | 'import';
       ```

    5. MODIFY both table type files — add `lead_source: string | null;` to LeadRegistryRow interface in BOTH:
       - `packages/shared/src/tables.ts` — add after `followup_count: number;` (line 131)
       - `packages/webapp/src/types/tables.ts` — add after `followup_count: number;` (line 131)
       Use `string | null` (not the LeadSource union) to match DB column type convention used by all other fields.

    6. MODIFY `packages/webapp/src/features/leads/hooks/useLeads.ts`:
       - Add `'lead_source'` to the LeadListItem Pick union (after `'updated_at'`)
       - Add `lead_source` to the `.select()` string (append `, lead_source` at the end)
       - Increase `.limit(30)` to `.limit(100)` (needed for client-side search in Plan 02, and ensures all user leads are fetched)
  </action>
  <verify>
    Run `cd /Users/dmytrolevin/Downloads/GD_playground/packages/webapp && npx tsc --noEmit` to verify no TypeScript errors.
    Check both enums files have LeadSource type, both tables files have lead_source field, and useLeads includes it in Pick + select.
  </verify>
  <done>
    - Migration file exists at migrations/003_lead_source_field.sql
    - Python LeadRegistryModel has lead_source field
    - Bot support handler sets lead_source="support_analysis" explicitly
    - LeadSource type exists in both enums files
    - lead_source field exists in LeadRegistryRow in both tables files
    - useLeads hook includes lead_source in Pick type, select string, and fetches up to 100 leads
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add stale indicator and source badge to LeadCard and LeadDetail</name>
  <files>
    packages/webapp/src/features/leads/types.ts
    packages/webapp/src/features/leads/components/LeadCard.tsx
    packages/webapp/src/features/leads/components/LeadDetail.tsx
  </files>
  <action>
    1. MODIFY `packages/webapp/src/features/leads/types.ts` — add two things:

       a. Stale calculation helper (add after the formatLeadDate function, at end of file):
       ```typescript
       // ---------------------------------------------------------------------------
       // Stale lead helpers (LEAD-V11-01)
       // ---------------------------------------------------------------------------

       /**
        * Calculate days since last lead activity.
        * Uses updated_at as primary (set on every status change, note, update).
        * Falls back to created_at only if updated_at is null.
        */
       export function getLeadStaleDays(updatedAt: string | null, createdAt: string | null): number {
         const dateStr = updatedAt ?? createdAt;
         if (!dateStr) return 0;
         try {
           const date = new Date(dateStr);
           if (isNaN(date.getTime())) return 0;
           return Math.floor((Date.now() - date.getTime()) / 86400000);
         } catch {
           return 0;
         }
       }

       export const STALE_THRESHOLD_DAYS = 7;
       ```

       b. Lead source config (add after stale helpers):
       ```typescript
       // ---------------------------------------------------------------------------
       // Lead source configuration (LEAD-V11-02)
       // ---------------------------------------------------------------------------

       import type { LeadSource } from '@/types/enums';
       import type { BadgeProps } from '@/shared/ui/Badge';

       export const LEAD_SOURCE_CONFIG: Record<LeadSource, { label: string; variant: NonNullable<BadgeProps['variant']> }> = {
         support_analysis: { label: 'AI Analysis', variant: 'info' },
         manual: { label: 'Manual', variant: 'default' },
         import: { label: 'Import', variant: 'brand' },
       };
       ```
       NOTE: The `import type { LeadSource }` and `import type { BadgeProps }` should be added to the
       existing import block at the top of the file. LeadSource from '@/types/enums' (add to the existing
       LeadStatus import line). BadgeProps from '@/shared/ui/Badge' as a new import.

    2. MODIFY `packages/webapp/src/features/leads/components/LeadCard.tsx`:
       - Add imports: `getLeadStaleDays, STALE_THRESHOLD_DAYS, LEAD_SOURCE_CONFIG` from `../types`
       - Add import: `type { LeadSource }` from `@/types/enums`
       - Inside the LeadCard component, before the return, compute:
         ```typescript
         const staleDays = getLeadStaleDays(lead.updated_at ?? null, lead.created_at ?? null);
         const isStale = staleDays >= STALE_THRESHOLD_DAYS;
         const sourceConfig = lead.lead_source
           ? LEAD_SOURCE_CONFIG[lead.lead_source as LeadSource]
           : null;
         ```
       - In the JSX, add stale badge BEFORE the status badge (inside the card, after the lead info div,
         before the existing status Badge):
         ```tsx
         {/* Stale + Source + Status badges */}
         <div className="flex shrink-0 flex-col items-end gap-1">
           {isStale && (
             <Badge variant="warning" size="sm">
               {staleDays}d ago
             </Badge>
           )}
           {sourceConfig && (
             <Badge variant={sourceConfig.variant} size="sm">
               {sourceConfig.label}
             </Badge>
           )}
           {statusConfig && (
             <Badge variant={statusConfig.variant} size="sm">
               {statusConfig.label}
             </Badge>
           )}
         </div>
         ```
       - IMPORTANT: Replace the existing single status Badge at the end of the card with this stacked
         badge column. The current layout has the status badge inline at the end. Wrap all badges in a
         flex-col div for vertical stacking on the right side.

    3. MODIFY `packages/webapp/src/features/leads/components/LeadDetail.tsx`:
       - Add imports: `getLeadStaleDays, STALE_THRESHOLD_DAYS, LEAD_SOURCE_CONFIG` from `../types`
       - Add import: `type { LeadSource }` from `@/types/enums`
       - Add import: `{ AlertTriangle }` from `lucide-react` (for stale icon in detail view)
       - Inside the LeadDetail component, after parsing engagement plan (around line 245), compute:
         ```typescript
         const staleDays = getLeadStaleDays(lead.updated_at ?? null, lead.created_at ?? null);
         const isStale = staleDays >= STALE_THRESHOLD_DAYS;
         const sourceConfig = lead.lead_source
           ? LEAD_SOURCE_CONFIG[lead.lead_source as LeadSource]
           : null;
         ```
       - In the header badge row (the `<div className="mt-1 flex flex-wrap gap-2">` around line 280),
         add stale badge and source badge alongside the existing status and input_type badges:
         ```tsx
         <div className="mt-1 flex flex-wrap gap-2">
           {statusConfig && (
             <Badge variant={statusConfig.variant} size="sm">
               {statusConfig.label}
             </Badge>
           )}
           {sourceConfig && (
             <Badge variant={sourceConfig.variant} size="sm">
               {sourceConfig.label}
             </Badge>
           )}
           <Badge variant="default" size="sm">
             {lead.input_type}
           </Badge>
           {isStale && (
             <Badge variant="warning" size="sm">
               <AlertTriangle className="mr-1 inline h-3 w-3" />
               Stale {staleDays}d
             </Badge>
           )}
         </div>
         ```
  </action>
  <verify>
    Run `cd /Users/dmytrolevin/Downloads/GD_playground/packages/webapp && npx tsc --noEmit` to verify no TypeScript errors.
    Verify that getLeadStaleDays, STALE_THRESHOLD_DAYS, and LEAD_SOURCE_CONFIG are exported from types.ts.
    Verify LeadCard.tsx and LeadDetail.tsx both import and use these new helpers.
  </verify>
  <done>
    - types.ts exports getLeadStaleDays, STALE_THRESHOLD_DAYS, LEAD_SOURCE_CONFIG
    - LeadCard shows stale warning badge ("Xd ago") for leads with updated_at 7+ days ago
    - LeadCard shows source badge (AI Analysis / Manual / Import) based on lead_source field
    - LeadDetail header shows stale badge with AlertTriangle icon for stale leads
    - LeadDetail header shows source badge alongside status and input_type badges
    - TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/dmytrolevin/Downloads/GD_playground/packages/webapp && npx tsc --noEmit` passes
2. Migration file exists at migrations/003_lead_source_field.sql with ALTER TABLE statement
3. Python model has lead_source field, bot handler sets it explicitly
4. Both shared and webapp enums have LeadSource type
5. Both shared and webapp tables have lead_source in LeadRegistryRow
6. useLeads hook fetches lead_source and limits to 100
7. LeadCard displays stale badge (warning variant, "Xd ago") for 7+ day old leads
8. LeadCard displays source badge based on lead_source field
9. LeadDetail displays stale badge and source badge in header
</verification>

<success_criteria>
- LEAD-V11-01: Stale leads (7+ days since updated_at) show warning badge in both list and detail views
- LEAD-V11-02: Lead source is displayed as a badge in LeadCard and LeadDetail, auto-set on creation in bot
- LEAD-V11-04: lead_source field exists across DB migration, Python model, both TypeScript type files, and both enum files
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/08-lead-management-enhancements/08-01-SUMMARY.md`
</output>
