---
phase: 08-lead-management-enhancements
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - packages/webapp/src/features/leads/components/LeadList.tsx
  - packages/webapp/src/pages/Leads.tsx
autonomous: true

must_haves:
  truths:
    - "Users can type in a search bar to filter leads by name or company (instant client-side filtering)"
    - "Users can tap status filter chips to show only leads in a specific pipeline stage"
    - "Users can toggle a 'Group by Company' view that shows collapsible company headers with contact counts"
    - "Null or empty company leads are grouped under 'No Company'"
    - "Search and status filter work in both flat and grouped view modes"
  artifacts:
    - path: "packages/webapp/src/features/leads/components/LeadList.tsx"
      provides: "Search bar, status filter chips, company grouping toggle, and filtered/grouped lead rendering"
      contains: "useDebouncedValue"
    - path: "packages/webapp/src/pages/Leads.tsx"
      provides: "Updated Leads page integrating enhanced LeadList"
  key_links:
    - from: "packages/webapp/src/features/leads/components/LeadList.tsx"
      to: "packages/webapp/src/shared/hooks/useDebouncedValue.ts"
      via: "import useDebouncedValue for search debouncing"
      pattern: "useDebouncedValue"
    - from: "packages/webapp/src/features/leads/components/LeadList.tsx"
      to: "packages/webapp/src/features/leads/hooks/useLeads.ts"
      via: "useLeads provides LeadListItem[] with lead_source for filtering"
      pattern: "useLeads"
    - from: "packages/webapp/src/features/leads/components/LeadList.tsx"
      to: "packages/webapp/src/features/casebook/components/SearchBar.tsx"
      via: "import SearchBar for lead search input"
      pattern: "SearchBar"
---

<objective>
Add search/filter capabilities and company grouping to the lead list view. Users can search by name/company, filter by status, and toggle a grouped-by-company view with collapsible headers.

Purpose: Makes the lead pipeline navigable for users with many leads. Finding specific leads, focusing on a pipeline stage, and seeing all contacts at one company become one-tap actions.
Output: Enhanced LeadList with search bar, status filter chips, view mode toggle, and company grouping with collapsible headers.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-lead-management-enhancements/08-RESEARCH.md
@.planning/phases/08-lead-management-enhancements/08-01-SUMMARY.md

Key source files:
@packages/webapp/src/features/leads/components/LeadList.tsx
@packages/webapp/src/features/leads/components/LeadCard.tsx
@packages/webapp/src/features/leads/hooks/useLeads.ts
@packages/webapp/src/features/leads/types.ts
@packages/webapp/src/pages/Leads.tsx
@packages/webapp/src/types/enums.ts
@packages/webapp/src/shared/hooks/useDebouncedValue.ts
@packages/webapp/src/features/casebook/components/SearchBar.tsx
@packages/webapp/src/features/casebook/components/CasebookFilters.tsx
@packages/webapp/src/shared/ui/Badge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add search, status filter, and company grouping to LeadList</name>
  <files>
    packages/webapp/src/features/leads/components/LeadList.tsx
  </files>
  <action>
    Rewrite LeadList.tsx to add three capabilities: search, status filter, and company grouping toggle.
    All filtering is client-side using useMemo on the leads array from useLeads() (which now returns up to 100 leads from Plan 01).

    **Imports to add:**
    - `{ useState, useMemo }` from 'react'
    - `{ Search, X, Building2, ChevronRight, Filter }` from 'lucide-react'
    - `{ Badge }` from '@/shared/ui'
    - `{ useDebouncedValue }` from '@/shared/hooks/useDebouncedValue'
    - `{ LEAD_STATUS_CONFIG }` from '../types'
    - `type { LeadStatus }` from '@/types/enums'
    - `{ cn }` from '@/shared/lib/cn'

    **State variables** (inside LeadList component):
    ```typescript
    const [searchTerm, setSearchTerm] = useState('');
    const debouncedSearch = useDebouncedValue(searchTerm, 300);
    const [statusFilter, setStatusFilter] = useState<LeadStatus | ''>('');
    const [groupByCompany, setGroupByCompany] = useState(false);
    const [collapsedCompanies, setCollapsedCompanies] = useState<Set<string>>(new Set());
    ```

    **Filtered leads** (useMemo):
    ```typescript
    const filteredLeads = useMemo(() => {
      if (!leads) return [];
      let result = leads;
      if (debouncedSearch.trim()) {
        const q = debouncedSearch.toLowerCase();
        result = result.filter(lead =>
          (lead.prospect_name?.toLowerCase().includes(q)) ||
          (lead.prospect_first_name?.toLowerCase().includes(q)) ||
          (lead.prospect_last_name?.toLowerCase().includes(q)) ||
          (lead.prospect_company?.toLowerCase().includes(q))
        );
      }
      if (statusFilter) {
        result = result.filter(lead => lead.status === statusFilter);
      }
      return result;
    }, [leads, debouncedSearch, statusFilter]);
    ```

    **Company grouping** (useMemo):
    ```typescript
    const companyGroups = useMemo(() => {
      if (!groupByCompany) return null;
      const map = new Map<string, typeof filteredLeads>();
      for (const lead of filteredLeads) {
        const company = lead.prospect_company?.trim() || 'No Company';
        const group = map.get(company) ?? [];
        group.push(lead);
        map.set(company, group);
      }
      return Array.from(map.entries())
        .map(([company, leads]) => ({ company, leads }))
        .sort((a, b) => b.leads.length - a.leads.length);
    }, [filteredLeads, groupByCompany]);
    ```

    **Toggle company collapse:**
    ```typescript
    function toggleCompany(company: string) {
      setCollapsedCompanies(prev => {
        const next = new Set(prev);
        if (next.has(company)) next.delete(company);
        else next.add(company);
        return next;
      });
    }
    ```

    **JSX structure** — Replace existing return with:

    1. **Search bar** at top — Reuse the SearchBar component from casebook. Import `{ SearchBar }` from
       `@/features/casebook/components/SearchBar`. Pass `placeholder="Search leads..."` to override the default.
       ```tsx
       <SearchBar
         value={searchTerm}
         onChange={setSearchTerm}
         placeholder="Search leads..."
       />
       ```

    2. **Status filter chips** — Horizontal-scrollable row of status filter pills. Include an "All" chip
       plus one chip per status from LEAD_STATUS_CONFIG. Follow the FilterChip pattern from CasebookFilters
       but implement inline (don't import CasebookFilters — it's too casebook-specific).
       ```tsx
       <div className="flex gap-2 overflow-x-auto pb-1 scrollbar-none">
         <button
           type="button"
           onClick={() => setStatusFilter('')}
           className={cn(
             'inline-flex h-8 shrink-0 items-center rounded-button px-3 text-xs font-medium transition-colors',
             statusFilter === ''
               ? 'bg-accent text-accent-text'
               : 'bg-surface-secondary text-text-hint',
           )}
         >
           All
         </button>
         {(Object.entries(LEAD_STATUS_CONFIG) as [LeadStatus, typeof LEAD_STATUS_CONFIG[LeadStatus]][]).map(
           ([status, config]) => (
             <button
               key={status}
               type="button"
               onClick={() => setStatusFilter(statusFilter === status ? '' : status)}
               className={cn(
                 'inline-flex h-8 shrink-0 items-center rounded-button px-3 text-xs font-medium transition-colors',
                 statusFilter === status
                   ? 'bg-accent text-accent-text'
                   : 'bg-surface-secondary text-text-hint',
               )}
             >
               {config.label}
             </button>
           ),
         )}
       </div>
       ```

    3. **View mode toggle** — A small button to toggle between flat list and grouped-by-company view.
       Place it between filters and the list, right-aligned:
       ```tsx
       <div className="flex items-center justify-between">
         <p className="text-xs text-text-hint">
           {filteredLeads.length} lead{filteredLeads.length !== 1 ? 's' : ''}
         </p>
         <button
           type="button"
           onClick={() => setGroupByCompany(!groupByCompany)}
           className={cn(
             'inline-flex h-8 items-center gap-1.5 rounded-button px-3 text-xs font-medium transition-colors',
             groupByCompany
               ? 'bg-accent text-accent-text'
               : 'bg-surface-secondary text-text-hint',
           )}
         >
           <Building2 className="h-3.5 w-3.5" />
           Group by Company
         </button>
       </div>
       ```

    4. **Lead cards** — render flat or grouped:

       **Flat mode** (default, when `!groupByCompany`):
       ```tsx
       <div className="space-y-2">
         {filteredLeads.map((lead) => (
           <LeadCard key={lead.id} lead={lead} onClick={() => onSelectLead(lead.id)} />
         ))}
       </div>
       ```

       **Grouped mode** (when `groupByCompany && companyGroups`):
       ```tsx
       <div className="space-y-3">
         {companyGroups.map(({ company, leads: groupLeads }) => (
           <div key={company}>
             <button
               type="button"
               onClick={() => toggleCompany(company)}
               className="flex w-full items-center gap-2 py-2 text-left"
             >
               <ChevronRight
                 className={cn(
                   'h-4 w-4 text-text-hint transition-transform',
                   !collapsedCompanies.has(company) && 'rotate-90',
                 )}
               />
               <span className="text-sm font-semibold text-text">{company}</span>
               <Badge variant="default" size="sm">{groupLeads.length}</Badge>
             </button>
             {!collapsedCompanies.has(company) && (
               <div className="space-y-2 pl-6">
                 {groupLeads.map((lead) => (
                   <LeadCard key={lead.id} lead={lead} onClick={() => onSelectLead(lead.id)} />
                 ))}
               </div>
             )}
           </div>
         ))}
       </div>
       ```

    5. **Empty states** — Show different messages based on context:
       - If leads array is empty (no leads at all): keep existing empty state
       - If filteredLeads is empty but leads exist: show "No matching leads" with a "Clear filters" button
       ```tsx
       {filteredLeads.length === 0 && leads && leads.length > 0 && (
         <div className="flex flex-col items-center gap-2 rounded-card bg-surface-secondary/30 p-6 text-center">
           <Filter className="h-6 w-6 text-text-hint" />
           <p className="text-sm font-medium text-text-secondary">No matching leads</p>
           <button
             type="button"
             onClick={() => { setSearchTerm(''); setStatusFilter(''); }}
             className="text-xs font-medium text-accent"
           >
             Clear filters
           </button>
         </div>
       )}
       ```

    **Key points:**
    - Do NOT build a custom SearchBar -- reuse the one from `@/features/casebook/components/SearchBar`
    - Filter chips are built inline (not imported from CasebookFilters) because the casebook version has 3 filter dimensions + "My Entries" which is not needed here
    - All filtering is client-side with useMemo -- no PostgREST query changes needed
    - The search + filter controls should be wrapped in a container div with `space-y-3` for consistent spacing
    - Loading skeleton state remains unchanged
    - Empty state (no leads at all) remains unchanged
  </action>
  <verify>
    Run `cd /Users/dmytrolevin/Downloads/GD_playground/packages/webapp && npx tsc --noEmit` to verify no TypeScript errors.
    Verify LeadList.tsx imports SearchBar from casebook, useDebouncedValue from shared hooks.
    Verify companyGroups logic handles null prospect_company correctly.
  </verify>
  <done>
    - Search bar appears above lead list, filters by prospect name (first, last, full) and company
    - Status filter chips show All + each status, toggling filters the list instantly
    - "Group by Company" toggle button switches between flat and grouped views
    - Grouped view shows company headers with contact count badges and chevron collapse arrows
    - Collapsing a company header hides its leads
    - "No matching leads" with "Clear filters" button shown when search/filter produces empty results
    - Search works in both flat and grouped modes
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify Leads page integration and run full build</name>
  <files>
    packages/webapp/src/pages/Leads.tsx
  </files>
  <action>
    Verify that the Leads page integrates correctly with the enhanced LeadList.

    1. READ `packages/webapp/src/pages/Leads.tsx` — check the page wrapper spacing.
       The page wraps content in `<div className="space-y-4 px-4 pt-4 pb-6">`.
       Since LeadList now contains search/filter controls at the top, the spacing between
       the "Leads" heading and the search bar should be 16px (space-y-4). If it looks too
       wide for a search bar, reduce to `space-y-3` (12px). Otherwise leave as-is.

    2. Run TypeScript type check: `cd packages/webapp && npx tsc --noEmit`

    3. Run full Vite production build: `cd packages/webapp && npx vite build`
       This verifies all imports resolve, tree-shaking works, and the bundle builds successfully.

    If Leads.tsx needs no changes, commit only the build verification.
    If spacing is adjusted, commit the change.
  </action>
  <verify>
    Run `cd /Users/dmytrolevin/Downloads/GD_playground/packages/webapp && npx tsc --noEmit` — zero errors.
    Run `cd /Users/dmytrolevin/Downloads/GD_playground/packages/webapp && npx vite build` — build succeeds with dist/ output.
  </verify>
  <done>
    - TypeScript compiles without errors across the entire webapp
    - Full Vite production build succeeds
    - Leads page spacing is verified/adjusted for enhanced LeadList
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/dmytrolevin/Downloads/GD_playground/packages/webapp && npx tsc --noEmit` passes
2. `cd /Users/dmytrolevin/Downloads/GD_playground/packages/webapp && npx vite build` succeeds
3. LeadList renders SearchBar with "Search leads..." placeholder
4. Status filter chips (All, Analyzed, Reached Out, Meeting Booked, In Progress, Closed Won, Closed Lost) render and toggle
5. "Group by Company" toggle switches between flat and grouped views
6. Company group headers show company name, contact count badge, and collapsible chevron
7. Null/empty company leads grouped under "No Company"
8. Search filters by prospect_name, prospect_first_name, prospect_last_name, and prospect_company
9. "No matching leads" empty state appears when filters produce zero results
</verification>

<success_criteria>
- LEAD-V11-03: Lead list can be grouped by company with collapsible headers showing contact count
- LEAD-V11-05: Users can search leads by name/company and filter by status from the lead list page
- Search and filter work in both flat and grouped view modes
- Full TypeScript build passes
</success_criteria>

<output>
After completion, create `.planning/phases/08-lead-management-enhancements/08-02-SUMMARY.md`
</output>
