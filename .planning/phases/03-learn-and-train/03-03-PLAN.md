---
phase: 03-learn-and-train
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - packages/webapp/src/features/scoring/types.ts
  - packages/webapp/src/features/scoring/components/ScoreDisplay.tsx
  - packages/webapp/src/features/scoring/components/FeedbackBreakdown.tsx
  - packages/webapp/src/features/scoring/components/StrengthsList.tsx
  - packages/webapp/src/features/learn/components/LevelResults.tsx
  - packages/webapp/src/features/train/components/ScoreResults.tsx
  - packages/webapp/src/app/globals.css
  - packages/webapp/src/pages/Learn.tsx
  - packages/webapp/src/pages/Train.tsx
autonomous: true

must_haves:
  truths:
    - "User sees a score out of 100 with animated counter after completing a learn scenario"
    - "User sees strengths, areas for improvement, and ideal response comparison"
    - "User sees animated scoring results with XP earned after a training scenario"
    - "User has quick actions after train scoring: Next Scenario, Retry, View Stats"
    - "Score circle animates from 0 to actual value with CSS @property"
  artifacts:
    - path: "packages/webapp/src/features/scoring/types.ts"
      provides: "FeedbackData interface and parseFeedback() safe parser for feedback_json"
      exports: ["FeedbackData", "parseFeedback", "ScoreBreakdownItem"]
    - path: "packages/webapp/src/features/scoring/components/ScoreDisplay.tsx"
      provides: "Animated circular score indicator with CSS @property counter"
    - path: "packages/webapp/src/features/scoring/components/FeedbackBreakdown.tsx"
      provides: "Criteria-by-criteria score breakdown list"
    - path: "packages/webapp/src/features/scoring/components/StrengthsList.tsx"
      provides: "Strengths + improvements lists with ideal response comparison"
    - path: "packages/webapp/src/features/learn/components/LevelResults.tsx"
      provides: "Learn level results view showing score, feedback, and next level unlock status"
    - path: "packages/webapp/src/features/train/components/ScoreResults.tsx"
      provides: "Train score results with XP animation and quick action buttons"
    - path: "packages/webapp/src/app/globals.css"
      provides: "CSS @property definition for --score-value integer animation"
      contains: "@property --score-value"
  key_links:
    - from: "packages/webapp/src/features/scoring/types.ts"
      to: "packages/webapp/src/types/tables.ts"
      via: "parses AttemptRow.feedback_json safely"
      pattern: "Record<string, unknown>"
    - from: "packages/webapp/src/features/scoring/components/ScoreDisplay.tsx"
      to: "packages/webapp/src/app/globals.css"
      via: "CSS @property --score-value animation"
      pattern: "score-counter"
    - from: "packages/webapp/src/features/learn/components/LevelResults.tsx"
      to: "InsForge attempts table"
      via: "fetches latest attempt for learn scenario"
      pattern: "from\\('attempts'\\)"
    - from: "packages/webapp/src/features/train/components/ScoreResults.tsx"
      to: "packages/webapp/src/features/scoring/components/"
      via: "imports shared scoring components"
      pattern: "import.*ScoreDisplay"
---

<objective>
Build shared scoring/feedback display components and wire them into Learn and Train results views.

Purpose: LEARN-04, TRAIN-04, TRAIN-05 -- after completing a scenario (via bot), users return to the TMA and see their score with animated display, detailed feedback breakdown, strengths/improvements, ideal response comparison, XP earned, and quick action buttons.

Output: Scoring types with safe parser, 3 shared scoring components, LevelResults view for Learn, ScoreResults view for Train, CSS @property animation, and updated pages with results routes.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-learn-and-train/03-RESEARCH.md
@.planning/phases/03-learn-and-train/03-01-SUMMARY.md
@.planning/phases/03-learn-and-train/03-02-SUMMARY.md
@packages/webapp/src/types/tables.ts
@packages/webapp/src/types/constants.ts
@packages/webapp/src/lib/queries.ts
@packages/webapp/src/app/globals.css
@packages/webapp/src/pages/Learn.tsx
@packages/webapp/src/pages/Train.tsx
@packages/webapp/src/shared/ui/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scoring types + CSS animation + shared scoring components</name>
  <files>
    packages/webapp/src/features/scoring/types.ts
    packages/webapp/src/app/globals.css
    packages/webapp/src/features/scoring/components/ScoreDisplay.tsx
    packages/webapp/src/features/scoring/components/FeedbackBreakdown.tsx
    packages/webapp/src/features/scoring/components/StrengthsList.tsx
  </files>
  <action>
    1. Create `features/scoring/types.ts`:
       - Define `ScoreBreakdownItem`: `criterion: string`, `score: number`, `max: number`, `feedback: string`, `user_quote?: string | null`, `suggestion?: string | null`
       - Define `PatternObservation`: `recurring_issue?: string`, `improving_area?: string`, `suggestion?: string`
       - Define `IdealComparison`: `what_ideal_did_differently?: string[]`
       - Define `FeedbackData`: `total_score: number`, `xp_earned: number`, `breakdown?: ScoreBreakdownItem[]`, `strengths?: string[]`, `improvements?: string[]`, `pattern_observation?: PatternObservation`, `ideal_response_comparison?: IdealComparison`
       - Export `parseFeedback(json: Record<string, unknown>): FeedbackData` -- safe parser using typeof checks and Array.isArray (NEVER trust raw feedback_json -- per Pitfall 3 in research). Every field uses fallback: `typeof json.total_score === 'number' ? json.total_score : 0`, etc.

    2. Update `app/globals.css` (APPEND to existing, do not modify existing styles):
       - Add CSS `@property --score-value` with syntax '<integer>', initial-value 0, inherits false
       - Add `@keyframes countUp { from { --score-value: 0; } }`
       - Add `@keyframes scoreArc { from { stroke-dasharray: 0 264; } }`
       - Add `.score-counter` class: `animation: countUp 1.5s ease-out forwards`, `counter-set: score var(--score-value)`, `font-variant-numeric: tabular-nums`
       - Add `.score-counter::after { content: counter(score); }`

    3. Create `features/scoring/components/ScoreDisplay.tsx`:
       - Props: `score: number`, `xpEarned: number`, `animate?: boolean` (default true)
       - Circular SVG score indicator (radius 42, viewBox 100x100):
         - Background circle: stroke-surface-secondary
         - Progress arc: strokeDasharray computed from score, color depends on pass/fail (success for >= PASSING_SCORE, warning for < PASSING_SCORE)
         - If animate: use scoreArc animation on the progress circle
       - Center: animated score number using .score-counter CSS class with --score-value custom property. If !animate, render score directly as text.
       - Below circle: "/100" label
       - XP earned badge: "+{xpEarned} XP" using Badge component with success/warning variant
       - Import PASSING_SCORE from @deal-quest/shared (or @/types/constants)

    4. Create `features/scoring/components/FeedbackBreakdown.tsx`:
       - Props: `breakdown?: ScoreBreakdownItem[]`
       - If no breakdown (undefined or empty array): render nothing (return null)
       - For each criterion: render a row with criterion name, score/max fraction, progress bar (ProgressBar component), and feedback text
       - If user_quote present: show it in a small blockquote
       - If suggestion present: show it with a lightbulb icon
       - Use Card component for the container with "Scoring Breakdown" heading

    5. Create `features/scoring/components/StrengthsList.tsx`:
       - Props: `strengths?: string[]`, `improvements?: string[]`, `idealComparison?: IdealComparison`
       - Strengths section: green checkmark icon + each strength as a list item (only render if strengths has items)
       - Improvements section: orange arrow-up icon + each improvement item (only render if improvements has items)
       - Ideal response comparison section: if `idealComparison?.what_ideal_did_differently` has items, show "What the ideal response did differently" heading with bullet list
       - All sections use optional chaining -- never crash on undefined data
       - Use Card component for container
  </action>
  <verify>
    Run `cd /Users/dmytrolevin/Downloads/GD_playground && pnpm --filter @deal-quest/webapp exec tsc --noEmit` -- no type errors.
    Verify parseFeedback returns safe defaults for empty/malformed input: `parseFeedback({})` should return `{ total_score: 0, xp_earned: 0 }`.
    Verify globals.css contains @property --score-value definition.
    Verify ScoreDisplay renders SVG circle with correct strokeDasharray calculation.
    Verify StrengthsList.tsx renders three sections: strengths (checkmark), improvements (arrow-up), and ideal response comparison (bullet list). Grep for "what_ideal_did_differently" in StrengthsList.tsx to confirm ideal response comparison is rendered.
  </verify>
  <done>
    Scoring types with safe parser handle non-deterministic LLM output. CSS @property enables zero-JS score counter animation. Three shared scoring components render score circle, criteria breakdown, and strengths/improvements with ideal response comparison -- all with full null safety.
  </done>
</task>

<task type="auto">
  <name>Task 2: LevelResults + ScoreResults views + page route wiring</name>
  <files>
    packages/webapp/src/features/learn/components/LevelResults.tsx
    packages/webapp/src/features/train/components/ScoreResults.tsx
    packages/webapp/src/pages/Learn.tsx
    packages/webapp/src/pages/Train.tsx
  </files>
  <action>
    1. Create `features/learn/components/LevelResults.tsx`:
       - Props: none (reads levelId from useParams)
       - Uses `useParams()` to get levelId, looks up level from TRACKS.foundations
       - Fetches the latest attempt for this scenario from InsForge: `attempts` table filtered by `telegram_id`, `scenario_id` (e.g., `learn_1_1`), `mode: 'learn'`, ordered by `created_at desc`, limit 1
       - If no attempt found: show "No results yet" with a "Practice in Bot" button (same deep link pattern from ScenarioPractice)
       - If attempt found: parse feedback_json with `parseFeedback()`, then render ALL of the following (LEARN-04 complete coverage):
         - ScoreDisplay with total_score (displayed as score/100) and xp_earned
         - Pass/fail status: "Level Complete!" (score >= PASSING_SCORE) or "Keep Practicing" with appropriate coloring
         - Next level unlock indication: if score >= PASSING_SCORE, show "Next level unlocked!" message with the next level's name
         - StrengthsList with strengths array, improvements array, AND idealComparison (ideal_response_comparison from feedback) -- this is the LEARN-04 "ideal response" requirement
         - FeedbackBreakdown with breakdown data
       - LEARN-04 verification: LevelResults MUST display all four elements: (1) score out of 100, (2) strengths list, (3) areas for improvement list, (4) ideal response comparison via StrengthsList's idealComparison prop
       - Loading state: Skeleton placeholders for score circle and feedback sections
       - Navigation: "Back to Track" button linking to /learn, "Try Again" button with bot deep link

    2. Create `features/train/components/ScoreResults.tsx`:
       - Props: `scenarioId: string`, `onNextScenario: () => void`, `onRetry: () => void`
       - Fetches the latest attempt for this scenario from InsForge: `attempts` table filtered by `telegram_id`, `scenario_id`, `mode: 'train'`, ordered by `created_at desc`, limit 1
       - If no attempt found: show "Complete this scenario in the bot first" with deep link
       - If attempt found: parse feedback_json with `parseFeedback()`, then render:
         - ScoreDisplay with score and xp_earned (animated)
         - FeedbackBreakdown
         - StrengthsList
       - Quick actions section (TRAIN-05) with 3 buttons:
         - "Next Scenario" (accent variant) -> calls onNextScenario
         - "Retry" (default variant) -> calls onRetry (deep links to bot with same scenario)
         - "View Stats" (default variant) -> navigates to /profile
       - Quick actions rendered as a row of Button components at bottom

    3. Update `Learn.tsx` (modify the file created in Plan 01):
       - Add a new Route: `level/:levelId/results` -> `<LevelResults />`
       - Import LevelResults from features/learn/components/LevelResults
       - The existing LevelDetail inline component should include a "View Results" link/button that navigates to `results` sub-route (when user has previous attempts)

    4. Update `Train.tsx` (modify the file created in Plan 02):
       - Add ScoreResults into the flow: after the scenario step, add a 'results' step that shows ScoreResults
       - The "Next Scenario" handler should: pick a new random scenario, reset to the scenario step
       - The "Retry" handler should: deep link to bot with the same scenario ID
       - Add navigation to results: either via a "View Results" button on the scenario screen, or automatically when the query detects a new attempt (using refetchOnWindowFocus which fires when user returns from bot)
       - Wire ScoreResults with the current scenario's ID
  </action>
  <verify>
    Run `cd /Users/dmytrolevin/Downloads/GD_playground && pnpm --filter @deal-quest/webapp exec tsc --noEmit` -- no type errors.
    Run `cd /Users/dmytrolevin/Downloads/GD_playground && pnpm --filter @deal-quest/webapp build` -- production build succeeds.
    Verify Learn.tsx has route for level/:levelId/results.
    Verify ScoreResults has 3 quick action buttons (Next Scenario, Retry, View Stats).
    Verify both results views use parseFeedback() for safe feedback_json handling.
    LEARN-04 explicit check: Verify LevelResults.tsx renders ALL four required elements:
      1. Grep LevelResults.tsx for "ScoreDisplay" (score out of 100)
      2. Grep LevelResults.tsx for "StrengthsList" (must pass strengths, improvements, AND idealComparison props)
      3. Grep LevelResults.tsx for "idealComparison" or "ideal_response_comparison" (ideal response display)
      4. Grep LevelResults.tsx for "FeedbackBreakdown" (detailed scoring breakdown)
    If any of these four greps fail, the task is NOT complete.
  </verify>
  <done>
    LevelResults displays all LEARN-04 elements: score out of 100, strengths list, areas for improvement list, and ideal response comparison. Shows pass/fail status and next-level-unlock indication. ScoreResults shows train scores with animated display and 3 quick action buttons (Next Scenario, Retry, View Stats). Both views safely parse feedback_json and handle missing attempts gracefully. Routes wired in both Learn.tsx and Train.tsx.
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter @deal-quest/webapp build` succeeds with no errors
- CSS @property --score-value is defined in globals.css
- parseFeedback handles malformed input without crashing
- ScoreDisplay renders animated SVG circle with correct pass/fail coloring
- LevelResults renders ScoreDisplay (score/100), StrengthsList with strengths + improvements + idealComparison, and FeedbackBreakdown -- all four LEARN-04 elements present
- LevelResults shows next-level-unlock message when score >= 60
- ScoreResults has Next Scenario, Retry, and View Stats quick actions
- All feedback_json access uses optional chaining throughout
</verification>

<success_criteria>
- LEARN-04: Score and feedback display shows score/100, strengths, improvements, ideal response comparison -- all four elements explicitly rendered in LevelResults.tsx via ScoreDisplay, StrengthsList (with idealComparison prop), and FeedbackBreakdown
- TRAIN-04: Score results display shows animated score, XP earned, feedback breakdown
- TRAIN-05: Quick actions after scoring: Next Scenario, Retry, View Stats all functional
- CSS @property score counter animation works (countUp from 0 to actual score)
- parseFeedback safely handles all edge cases in feedback_json
- Production build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-learn-and-train/03-03-SUMMARY.md`
</output>
