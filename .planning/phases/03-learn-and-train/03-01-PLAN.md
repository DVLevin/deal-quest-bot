---
phase: 03-learn-and-train
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/webapp/src/features/learn/data/tracks.ts
  - packages/webapp/src/lib/queries.ts
  - packages/webapp/src/features/learn/hooks/useTrackProgress.ts
  - packages/webapp/src/features/learn/components/TrackList.tsx
  - packages/webapp/src/features/learn/components/LevelCard.tsx
  - packages/webapp/src/features/learn/components/LessonView.tsx
  - packages/webapp/src/features/learn/components/ScenarioPractice.tsx
  - packages/webapp/src/pages/Learn.tsx
autonomous: true

must_haves:
  truths:
    - "User sees a list of learning levels with locked/unlocked/completed status and best scores"
    - "User can open a level to read lesson content (title, text, key points)"
    - "User can view a scenario's persona card and situation text"
    - "User sees 'Practice in Bot' MainButton to deep-link to bot for response submission"
    - "First level shows as unlocked and rest as locked when no track_progress rows exist"
  artifacts:
    - path: "packages/webapp/src/features/learn/data/tracks.ts"
      provides: "Static track/level/lesson/scenario data extracted from scenarios.json"
      contains: "TRACKS"
    - path: "packages/webapp/src/lib/queries.ts"
      provides: "Extended query key factory with trackProgress and scenarios namespaces"
      contains: "trackProgress"
    - path: "packages/webapp/src/features/learn/hooks/useTrackProgress.ts"
      provides: "Hook merging static track data with dynamic track_progress from InsForge"
      exports: ["useTrackProgress"]
    - path: "packages/webapp/src/features/learn/components/TrackList.tsx"
      provides: "Track overview showing all levels with status indicators"
    - path: "packages/webapp/src/features/learn/components/LevelCard.tsx"
      provides: "Individual level card with icon, name, status badge, best score"
    - path: "packages/webapp/src/features/learn/components/LessonView.tsx"
      provides: "Lesson content display with title, text, key points list"
    - path: "packages/webapp/src/features/learn/components/ScenarioPractice.tsx"
      provides: "Scenario persona card, situation text, and Practice in Bot CTA"
    - path: "packages/webapp/src/pages/Learn.tsx"
      provides: "Learn page with nested sub-routes (index, level/:levelId)"
  key_links:
    - from: "packages/webapp/src/features/learn/hooks/useTrackProgress.ts"
      to: "packages/webapp/src/features/learn/data/tracks.ts"
      via: "imports TRACKS constant and merges with DB data"
      pattern: "TRACKS\\["
    - from: "packages/webapp/src/features/learn/hooks/useTrackProgress.ts"
      to: "InsForge track_progress table"
      via: "PostgREST query"
      pattern: "from\\('track_progress'\\)"
    - from: "packages/webapp/src/features/learn/components/ScenarioPractice.tsx"
      to: "Telegram bot"
      via: "deep link URL"
      pattern: "t\\.me.*start=learn"
    - from: "packages/webapp/src/pages/Learn.tsx"
      to: "packages/webapp/src/features/learn/components/TrackList.tsx"
      via: "React Router nested Routes"
      pattern: "Route.*index.*TrackList"
---

<objective>
Build the Learn mode page with track visualization, lesson content, and scenario practice UI.

Purpose: LEARN-01 through LEARN-03 and LEARN-05 -- users can browse the structured learning track, see which levels are locked/unlocked/completed with best scores, read lesson content for each level, and view the practice scenario with a deep-link to the bot for actual submission.

Output: Static track data file, query key extensions, track progress hook, 4 Learn feature components, and Learn.tsx with nested sub-routes.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-learn-and-train/03-RESEARCH.md
@packages/webapp/src/lib/queries.ts
@packages/webapp/src/types/tables.ts
@packages/webapp/src/types/enums.ts
@packages/webapp/src/types/constants.ts
@packages/webapp/src/app/Router.tsx
@packages/webapp/src/pages/Learn.tsx
@packages/webapp/src/features/dashboard/hooks/useUserProgress.ts
@packages/webapp/src/shared/hooks/useMainButton.ts
@packages/webapp/src/shared/ui/index.ts
@data/scenarios.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Static track data + query key extensions + track progress hook</name>
  <files>
    packages/webapp/src/features/learn/data/tracks.ts
    packages/webapp/src/lib/queries.ts
    packages/webapp/src/features/learn/hooks/useTrackProgress.ts
  </files>
  <action>
    1. Create `features/learn/data/tracks.ts`:
       - Define TypeScript interfaces: `TrackLevel` (id, name, lesson: {title, content, keyPoints}, scenario: {id, persona: {name, role, company, background, context?}, situation, difficulty, timeLimitSeconds?, idealResponse, commonMistakes?})
       - Define `Track` interface (id, name, description, levels: TrackLevel[])
       - Export `TRACKS: Record<string, Track>` constant containing ALL data from `data/scenarios.json` `learn_tracks.track_1` -- extract all 4 levels with full lesson and scenario data
       - This is a static data file compiled into the bundle (browser cannot access scenarios.json)

    2. Extend `lib/queries.ts`:
       - Add `trackProgress` namespace: `all`, `byTrack(telegramId, trackId)`, `level(telegramId, trackId, levelId)`
       - Add `scenarios` namespace: `all`, `pool(difficulty?)`, `seen(telegramId)`
       - Keep ALL existing keys (users, attempts, badges) unchanged

    3. Create `features/learn/hooks/useTrackProgress.ts`:
       - Import `useQuery` from @tanstack/react-query, `getInsforge` from @/lib/insforge, `useAuthStore`, `queryKeys`, `TRACKS`
       - Export `LevelWithProgress` interface: extends track level data with `status: TrackStatus`, `bestScore: number`, `attemptsCount: number`
       - Query `track_progress` table filtered by `telegram_id` and `track_id`
       - Merge: map over `TRACKS[trackId].levels`, look up each level in the DB progress map
       - Handle empty track_progress gracefully: first level defaults to 'unlocked', rest default to 'locked' (per Pitfall 5 in research)
       - Query gated on `!!telegramId`
       - Default trackId parameter to 'foundations'
  </action>
  <verify>
    Run `cd /Users/dmytrolevin/Downloads/GD_playground && pnpm --filter @deal-quest/webapp exec tsc --noEmit` -- no type errors.
    Verify tracks.ts exports TRACKS with 4 levels matching scenarios.json structure.
    Verify queries.ts has trackProgress and scenarios namespaces.
  </verify>
  <done>
    Static track data contains all 4 levels from scenarios.json. Query keys extended with trackProgress and scenarios. useTrackProgress hook merges static data with DB progress and handles the empty-rows case.
  </done>
</task>

<task type="auto">
  <name>Task 2: Learn components + sub-routed page</name>
  <files>
    packages/webapp/src/features/learn/components/TrackList.tsx
    packages/webapp/src/features/learn/components/LevelCard.tsx
    packages/webapp/src/features/learn/components/LessonView.tsx
    packages/webapp/src/features/learn/components/ScenarioPractice.tsx
    packages/webapp/src/pages/Learn.tsx
  </files>
  <action>
    1. Create `LevelCard.tsx`:
       - Props: `level: LevelWithProgress`, `trackId: string`, `onClick: () => void`
       - Display: level name, difficulty badge (use DIFFICULTY_LABELS + Badge component), status indicator (lock icon for locked, checkmark for completed, play icon for unlocked), best score (if > 0)
       - Locked levels: reduced opacity, no onClick
       - Completed levels: success-colored checkmark, show "Best: {score}/100"
       - Unlocked levels: accent-colored, full opacity, tappable
       - Use Card component, 44px min touch target, lucide-react icons (Lock, CheckCircle, Play)

    2. Create `TrackList.tsx`:
       - Uses `useTrackProgress('foundations')` hook
       - Renders track name and description at top
       - Maps over levels, rendering a LevelCard for each
       - Loading state: 4 Skeleton cards
       - Error state: error message with retry
       - Navigation: clicking an unlocked/completed LevelCard navigates to `/learn/level/${levelId}` using `useNavigate` with relative path

    3. Create `LessonView.tsx`:
       - Props: `lesson: { title: string; content: string; keyPoints: string[] }`, `onContinue: () => void`
       - Displays lesson title as heading, content as paragraph text, key points as a bulleted list with checkmark icons
       - "Continue to Practice" button at bottom (uses Button component)
       - Scrollable content area

    4. Create `ScenarioPractice.tsx`:
       - Props: `scenario` (persona, situation, difficulty, timeLimitSeconds), `levelId: string`
       - Displays persona card (name, role, company, background, context) in a Card
       - Shows difficulty badge and time limit (if present) as "{seconds}s" badge
       - Displays situation text in a styled quote block
       - Uses `useMainButton({ text: 'Practice in Bot', onClick: handlePractice })` where handlePractice creates deep link: `https://t.me/${import.meta.env.VITE_BOT_USERNAME}?start=learn_${levelId}` and opens via `openLink` from @telegram-apps/sdk-react (with `tryInstantView: false`)
       - Fallback: if openLink not available, use `window.open(url, '_blank')`
       - Does NOT include text input for response (TMA is display layer -- response submission happens in bot)

    5. Update `Learn.tsx`:
       - Replace stub content with nested Routes (React Router v7):
         - `index` -> `<TrackList />`
         - `level/:levelId` -> `<LevelDetail />` (inline component that reads levelId from useParams, looks up level from TRACKS, shows LessonView + ScenarioPractice in a tab or sequential scroll layout)
       - Import TrackList and create inline LevelDetail component
       - LevelDetail: use `useParams()` to get levelId, look up the level from TRACKS.foundations, show LessonView at top followed by ScenarioPractice below. If level not found, navigate back to /learn.
       - Use `useBackButton` is already handled globally, but ensure navigation back from level detail goes to /learn

    Design notes:
    - Follow the existing feature-based folder structure (features/learn/components/)
    - Use existing UI components: Card, Badge, Button, Skeleton from @/shared/ui
    - Use Tailwind classes consistent with Dashboard page patterns (space-y-4, px-4, pt-4)
    - 44px minimum touch targets on all interactive elements
    - Import types from @deal-quest/shared where applicable
  </action>
  <verify>
    Run `cd /Users/dmytrolevin/Downloads/GD_playground && pnpm --filter @deal-quest/webapp exec tsc --noEmit` -- no type errors.
    Run `cd /Users/dmytrolevin/Downloads/GD_playground && pnpm --filter @deal-quest/webapp build` -- production build succeeds.
    Verify Learn.tsx has Routes with index and level/:levelId paths.
  </verify>
  <done>
    Learn page shows track overview with 4 level cards showing status (locked/unlocked/completed) and best scores. Tapping an unlocked level navigates to level detail showing lesson content and scenario practice. MainButton opens bot deep link for practice. Build passes cleanly.
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter @deal-quest/webapp build` succeeds with no errors
- Learn.tsx has nested Routes with index and level/:levelId
- TRACKS constant has 4 levels matching data/scenarios.json
- useTrackProgress handles empty track_progress gracefully (first level unlocked, rest locked)
- LevelCard renders different states for locked/unlocked/completed
- ScenarioPractice uses MainButton with deep link to bot
</verification>

<success_criteria>
- LEARN-01: Track visualization shows all 4 levels with locked/unlocked/completed status and best scores
- LEARN-02: Lesson content displays title, content text, and key points for each level
- LEARN-03: Scenario practice UI shows persona card, situation text, with Practice in Bot CTA
- LEARN-05: Visual indication of level status (first unlocked by default, auto-unlock via track_progress data from bot)
- Production build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-learn-and-train/03-01-SUMMARY.md`
</output>
