---
phase: 10-error-handling-and-ux
plan: 03
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - packages/webapp/src/features/leads/components/LeadDetail.tsx
  - packages/webapp/src/features/leads/components/LeadNotes.tsx
  - packages/webapp/src/features/settings/components/SettingsPanel.tsx
  - packages/webapp/src/features/leads/components/LeadList.tsx
  - packages/webapp/src/features/profile/components/AttemptHistory.tsx
  - packages/webapp/src/pages/SupportPage.tsx
autonomous: true

must_haves:
  truths:
    - "Failed status update on a lead shows an error toast with retry action"
    - "Failed note save shows an error toast with retry action"
    - "Failed settings update shows an error toast"
    - "Lead list with no leads shows a designed EmptyState with icon, guidance text, and CTA"
    - "Attempt history with no attempts shows a designed EmptyState with icon and CTA"
    - "Support page with no sessions shows a designed EmptyState with icon and guidance"
  artifacts:
    - path: "packages/webapp/src/features/leads/components/LeadDetail.tsx"
      provides: "Toast feedback on status mutation error"
      contains: "useToast"
    - path: "packages/webapp/src/features/leads/components/LeadNotes.tsx"
      provides: "Toast feedback on note save error and success"
      contains: "useToast"
    - path: "packages/webapp/src/features/settings/components/SettingsPanel.tsx"
      provides: "Toast feedback on settings update error"
      contains: "useToast"
    - path: "packages/webapp/src/features/leads/components/LeadList.tsx"
      provides: "Designed empty state using EmptyState component"
      contains: "EmptyState"
    - path: "packages/webapp/src/features/profile/components/AttemptHistory.tsx"
      provides: "Designed empty state using EmptyState component"
      contains: "EmptyState"
  key_links:
    - from: "LeadDetail.tsx"
      to: "packages/webapp/src/shared/stores/toastStore.ts"
      via: "useToast() hook for mutation feedback"
      pattern: "toast\\("
    - from: "LeadNotes.tsx"
      to: "packages/webapp/src/shared/stores/toastStore.ts"
      via: "useToast() hook for mutation feedback"
      pattern: "toast\\("
---

<objective>
Wire toast notifications into all 3 mutation hooks for error/success feedback, and upgrade empty states in key pages to use the EmptyState component.

Purpose: UX-V11-03 requires mutation error feedback (users currently get no indication when saves fail). UX-V11-05 requires designed empty states to guide users when pages have no data.
Output: 3 components with toast-integrated mutations, 3 components with upgraded empty states.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-error-handling-and-ux/10-RESEARCH.md

Plan 01 SUMMARY (for Toast and EmptyState API):
@.planning/phases/10-error-handling-and-ux/10-01-SUMMARY.md

Key files to modify:
@packages/webapp/src/features/leads/components/LeadDetail.tsx
@packages/webapp/src/features/leads/components/LeadNotes.tsx
@packages/webapp/src/features/settings/components/SettingsPanel.tsx
@packages/webapp/src/features/leads/hooks/useUpdateLeadStatus.ts
@packages/webapp/src/features/leads/hooks/useAddLeadNote.ts
@packages/webapp/src/features/settings/hooks/useUpdateSettings.ts
@packages/webapp/src/features/leads/components/LeadList.tsx
@packages/webapp/src/features/profile/components/AttemptHistory.tsx
@packages/webapp/src/shared/stores/toastStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire toast notifications into 3 mutation call sites</name>
  <files>
    packages/webapp/src/features/leads/components/LeadDetail.tsx
    packages/webapp/src/features/leads/components/LeadNotes.tsx
    packages/webapp/src/features/settings/components/SettingsPanel.tsx
  </files>
  <action>
    Add toast feedback to mutation calls in the **component files** (not the hook files). The mutation hooks define the mutationFn and cache management. The component call sites (`.mutate()`) are where we add `onSuccess` and `onError` callbacks with toast.

    **Important:** Pass `onSuccess` and `onError` as the second argument to `mutation.mutate(vars, { onSuccess, onError })`. This is the component-level callback pattern TanStack Query v5 supports -- it does NOT replace the hook-level callbacks, it runs IN ADDITION to them.

    **LeadDetail.tsx** -- `handleStatusChange` calls `mutation.mutate()`:
    1. Import `useToast` from `@/shared/stores/toastStore`
    2. Add `const { toast } = useToast();` at the top of the component
    3. In `handleStatusChange`, change the `mutation.mutate()` call to include callbacks:
       ```typescript
       const vars = { leadId: lead.id, newStatus, oldStatus: lead.status, telegramId };
       mutation.mutate(vars, {
         onSuccess: () => {
           toast({ type: 'success', message: 'Status updated' });
         },
         onError: () => {
           toast({
             type: 'error',
             message: 'Failed to update status',
             action: { label: 'Retry', onClick: () => mutation.mutate(vars) },
           });
         },
       });
       ```
    4. Note: the hook's existing `onMutate`/`onError`/`onSettled` for optimistic update + rollback continue to work. These component-level callbacks ADD toast feedback.

    **LeadNotes.tsx** -- `handleSubmit` calls `mutation.mutate()`:
    1. Import `useToast` from `@/shared/stores/toastStore`
    2. Add `const { toast } = useToast();`
    3. In `handleSubmit`, wrap the `mutation.mutate()` with callbacks:
       ```typescript
       const vars = { leadId, telegramId, note: noteText.trim() };
       mutation.mutate(vars, {
         onSuccess: () => {
           setNoteText('');  // Clear textarea on success (move this here if not already)
           toast({ type: 'success', message: 'Note saved' });
         },
         onError: () => {
           toast({
             type: 'error',
             message: 'Failed to save note',
             action: { label: 'Retry', onClick: () => mutation.mutate(vars) },
           });
         },
       });
       ```

    **SettingsPanel.tsx** -- wherever provider/model mutations are called:
    1. Import `useToast` from `@/shared/stores/toastStore`
    2. Add `const { toast } = useToast();`
    3. Find the mutation.mutate() calls for provider and model changes. Add callbacks:
       ```typescript
       mutation.mutate(vars, {
         onSuccess: () => {
           toast({ type: 'success', message: 'Settings saved' });
         },
         onError: () => {
           toast({ type: 'error', message: 'Failed to save settings' });
         },
       });
       ```
    4. No retry action needed for settings -- the user can just re-select the option.

    **Pitfall to avoid:** The research warns about stale closures in retry callbacks. The pattern above captures `vars` BEFORE the mutate call, so the retry closure has the correct variables. Do NOT reference component state in the retry callback -- use the captured `vars` object.
  </action>
  <verify>Run `cd /Users/dmytrolevin/Downloads/GD_playground/packages/webapp && npx tsc --noEmit` -- must pass with zero errors.</verify>
  <done>All 3 mutation call sites show toast on error (with retry for status + notes) and toast on success. The useToast hook is imported from the Zustand store.</done>
</task>

<task type="auto">
  <name>Task 2: Upgrade empty states in LeadList, AttemptHistory, and Support page</name>
  <files>
    packages/webapp/src/features/leads/components/LeadList.tsx
    packages/webapp/src/features/profile/components/AttemptHistory.tsx
    packages/webapp/src/pages/SupportPage.tsx
  </files>
  <action>
    Replace basic empty state JSX with the EmptyState component from Plan 01.

    **LeadList.tsx** -- currently has a decent empty state (Users icon + "No leads yet" text) but built inline:
    1. Import `EmptyState` from `@/shared/ui`
    2. Replace the entire empty state div (the `!leads || leads.length === 0` branch) with:
       ```typescript
       <EmptyState
         icon={Users}
         title="No leads yet"
         description="Analyze prospects in the bot to build your sales pipeline."
         action={{
           label: "Open Bot",
           onClick: () => {
             // Deep link to bot support command
             window.open('https://t.me/DealQuestBot?start=support', '_blank');
           },
         }}
       />
       ```
    3. The Users icon import from lucide-react is already there -- reuse it.
    4. Remove the old inline empty state JSX.

    **AttemptHistory.tsx** -- currently plain text "No attempts yet -- start training to see your history!":
    1. Import `EmptyState` from `@/shared/ui`
    2. Import `Target` from `lucide-react` (for training-themed icon)
    3. Import `useNavigate` from `react-router`
    4. Replace the `attempts.length === 0 && page === 0` branch with:
       ```typescript
       <EmptyState
         icon={Target}
         title="No attempts yet"
         description="Complete training scenarios to track your progress here."
         action={{
           label: "Start Training",
           onClick: () => navigate('/train'),
         }}
       />
       ```
    5. Add `const navigate = useNavigate();` at the top of the component.
    6. Keep the EmptyState INSIDE the Card wrapper (it's already wrapped in a Card). Since EmptyState has its own styling, you may need to check if the Card padding creates visual doubling. If so, render EmptyState without the Card for the empty case, or use Card padding="none" for the empty branch.

    **SupportPage.tsx** (or the component rendering support session history):
    1. Find the support page/component that shows session history (likely `SupportHome` or the page wrapper). Check the actual file path -- it may be at `pages/SupportPage.tsx` or `features/support/components/SupportHome.tsx` or similar.
    2. Import `EmptyState` from `@/shared/ui`
    3. Import `MessageSquare` from `lucide-react`
    4. Replace the basic empty state with:
       ```typescript
       <EmptyState
         icon={MessageSquare}
         title="No support sessions yet"
         description="Analyze a prospect in the bot to get AI-powered deal strategy and insights."
         action={{
           label: "Open Bot",
           onClick: () => {
             window.open('https://t.me/DealQuestBot?start=support', '_blank');
           },
         }}
       />
       ```
    5. If the support page already has a good empty state (research says SupportHome is "GOOD"), only upgrade if it's inline JSX. If it's already well-designed, leave it and focus on SessionHistory instead.

    **Note:** CasebookList already has an EXCELLENT empty state (CasebookEmptyState) per the research. Do NOT change it. BadgeWall shows locked badges for empty state which is appropriate. LeaderboardWidget's empty message is contextual. These are fine as-is.
  </action>
  <verify>Run `cd /Users/dmytrolevin/Downloads/GD_playground/packages/webapp && npx tsc --noEmit` -- must pass. Run `npx vite build` -- must succeed.</verify>
  <done>LeadList, AttemptHistory, and Support page use EmptyState component with icon, descriptive text, and CTA buttons. TypeScript compiles and app builds.</done>
</task>

</tasks>

<verification>
1. `cd packages/webapp && npx tsc --noEmit` -- zero TypeScript errors
2. `cd packages/webapp && npx vite build` -- successful build
3. Grep for `useToast` in LeadDetail.tsx, LeadNotes.tsx, SettingsPanel.tsx -- all must import and use it
4. Grep for `EmptyState` in LeadList.tsx, AttemptHistory.tsx -- must use the component
5. Grep for remaining basic empty state patterns ("No leads yet" as plain text, "No attempts yet" as plain text) -- should not exist in target files
</verification>

<success_criteria>
- Status update failure shows an error toast with "Failed to update status" and Retry action
- Note save failure shows an error toast with "Failed to save note" and Retry action
- Settings update failure shows an error toast
- All 3 mutations also show success toasts
- LeadList empty state has icon, title, description, and "Open Bot" CTA
- AttemptHistory empty state has icon, title, description, and "Start Training" CTA
- Support session empty state upgraded with EmptyState component
</success_criteria>

<output>
After completion, create `.planning/phases/10-error-handling-and-ux/10-03-SUMMARY.md`
</output>
