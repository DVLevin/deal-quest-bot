---
phase: 10-error-handling-and-ux
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - packages/webapp/src/features/dashboard/components/ProgressCard.tsx
  - packages/webapp/src/features/dashboard/components/LeaderboardWidget.tsx
  - packages/webapp/src/features/dashboard/components/BadgePreview.tsx
  - packages/webapp/src/features/gamification/components/BadgeWall.tsx
  - packages/webapp/src/features/profile/components/ProfileHeader.tsx
  - packages/webapp/src/features/profile/components/AttemptHistory.tsx
  - packages/webapp/src/features/profile/components/BadgeCollection.tsx
  - packages/webapp/src/features/profile/components/StatsOverview.tsx
  - packages/webapp/src/features/admin/components/TeamOverview.tsx
  - packages/webapp/src/features/admin/components/MemberLeaderboard.tsx
  - packages/webapp/src/features/admin/components/WeakAreas.tsx
  - packages/webapp/src/features/admin/components/ActivityFeed.tsx
  - packages/webapp/src/features/learn/components/TrackList.tsx
  - packages/webapp/src/features/leads/components/LeadList.tsx
  - packages/webapp/src/features/leads/components/LeadDetail.tsx
  - packages/webapp/src/features/leads/components/ActivityTimeline.tsx
  - packages/webapp/src/features/settings/components/SettingsPanel.tsx
  - packages/webapp/src/features/casebook/components/CasebookList.tsx
autonomous: true

must_haves:
  truths:
    - "All 18 data-fetching components use ErrorCard for error states instead of inline text"
    - "Every ErrorCard has an onRetry prop wired to the query's refetch function"
    - "Components that previously ignored isError now destructure and handle it"
    - "ErrorCard uses compact mode when rendered inside an existing Card wrapper"
  artifacts:
    - path: "packages/webapp/src/features/dashboard/components/ProgressCard.tsx"
      provides: "ErrorCard replacing inline error text"
      contains: "ErrorCard"
    - path: "packages/webapp/src/features/admin/components/TeamOverview.tsx"
      provides: "ErrorCard replacing inline error text"
      contains: "ErrorCard"
    - path: "packages/webapp/src/features/leads/components/LeadList.tsx"
      provides: "ErrorCard added where isError was not checked"
      contains: "ErrorCard"
    - path: "packages/webapp/src/features/leads/components/LeadDetail.tsx"
      provides: "ErrorCard added where isError was not checked"
      contains: "ErrorCard"
  key_links:
    - from: "all 18 components"
      to: "packages/webapp/src/shared/ui/ErrorCard.tsx"
      via: "import { ErrorCard } from '@/shared/ui'"
      pattern: "ErrorCard"
---

<objective>
Replace all 18 inconsistent inline error states across the TMA with the standardized ErrorCard component, and add isError handling to components that currently ignore errors.

Purpose: UX-V11-02 requires consistent error state rendering across all TMA components. Currently 13 components have different styling and only 1 has retry. After this plan, all 18 components use ErrorCard with retry.
Output: 18 updated component files all using ErrorCard with onRetry.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-error-handling-and-ux/10-RESEARCH.md

Plan 01 SUMMARY (for ErrorCard API):
@.planning/phases/10-error-handling-and-ux/10-01-SUMMARY.md

Key reference for the replacement pattern:
@packages/webapp/src/shared/ui/ErrorCard.tsx
@packages/webapp/src/features/dashboard/components/ProgressCard.tsx
@packages/webapp/src/features/admin/components/TeamOverview.tsx
@packages/webapp/src/features/leads/components/LeadList.tsx
@packages/webapp/src/features/leads/components/LeadDetail.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace inline error states with ErrorCard in 11 components that already check isError</name>
  <files>
    packages/webapp/src/features/dashboard/components/ProgressCard.tsx
    packages/webapp/src/features/dashboard/components/LeaderboardWidget.tsx
    packages/webapp/src/features/dashboard/components/BadgePreview.tsx
    packages/webapp/src/features/gamification/components/BadgeWall.tsx
    packages/webapp/src/features/profile/components/ProfileHeader.tsx
    packages/webapp/src/features/profile/components/AttemptHistory.tsx
    packages/webapp/src/features/profile/components/BadgeCollection.tsx
    packages/webapp/src/features/admin/components/TeamOverview.tsx
    packages/webapp/src/features/admin/components/MemberLeaderboard.tsx
    packages/webapp/src/features/admin/components/WeakAreas.tsx
    packages/webapp/src/features/admin/components/ActivityFeed.tsx
  </files>
  <action>
    For each of the 11 components listed below, apply this pattern:

    1. Add import: `import { ErrorCard } from '@/shared/ui';` (or add ErrorCard to existing `@/shared/ui` import)
    2. Add `refetch` to the query hook destructuring (e.g., `const { data, isLoading, isError, refetch } = useXxx()`)
    3. Replace the inline error JSX with ErrorCard

    **Replacement rules for compact vs full mode:**
    - If the component's error state is INSIDE a Card wrapper, use `<ErrorCard message="..." onRetry={refetch} compact />`
    - If the component's error state IS a standalone Card or renders without a Card parent, use `<ErrorCard message="..." onRetry={refetch} />`

    **Specific replacements:**

    1. **ProgressCard.tsx** (line ~42-48): Currently `<Card><p>Unable to load progress</p></Card>`.
       Replace with: `<ErrorCard message="Unable to load progress" onRetry={refetch} />`
       Destructure `refetch` from `useUserProgress()`.

    2. **LeaderboardWidget.tsx** (line ~83-84): Currently plain text "Unable to load leaderboard".
       Replace with: `<ErrorCard message="Unable to load leaderboard" onRetry={refetch} compact />`
       (It renders inside a Card already -- check and use compact if so, otherwise full.)

    3. **BadgePreview.tsx** (line ~91-92): Currently plain text "Unable to load badges".
       Replace with: `<ErrorCard message="Unable to load badges" onRetry={refetch} compact />`

    4. **BadgeWall.tsx** (line ~38-41): Currently centered text.
       Replace with: `<ErrorCard message="Unable to load badges" onRetry={refetch} />`

    5. **ProfileHeader.tsx** (line ~30-36): Currently centered text.
       Replace with: `<ErrorCard message="Unable to load profile" onRetry={refetch} />`

    6. **AttemptHistory.tsx** (line ~88-91): Currently inside a Card, plain text.
       Replace the `isError` branch with: `<ErrorCard message="Unable to load attempt history" onRetry={refetch} compact />`
       (The component renders everything inside a Card already.)

    7. **BadgeCollection.tsx** (line ~110): Currently centered text.
       Replace with: `<ErrorCard message="Unable to load badges" onRetry={refetch} compact />`

    8. **TeamOverview.tsx** (line ~29-35): Currently `<Card><p>Unable to load team stats</p></Card>`.
       Replace with: `<ErrorCard message="Unable to load team stats" onRetry={refetch} />`
       Destructure `refetch` from `useTeamStats()`.

    9. **MemberLeaderboard.tsx** (line ~28-35): Currently inside Card.
       Replace with: `<ErrorCard message="Unable to load leaderboard" onRetry={refetch} compact />`

    10. **WeakAreas.tsx** (line ~42-49): Currently inside Card.
        Replace with: `<ErrorCard message="Unable to load weak areas" onRetry={refetch} compact />`

    11. **ActivityFeed.tsx** (line ~62-69): Currently inside Card.
        Replace with: `<ErrorCard message="Unable to load recent activity" onRetry={refetch} compact />`

    **Also update TrackList.tsx**: It already has a retry button. Replace its custom error UI with ErrorCard to standardize styling:
    - Replace the custom error div + Retry button with: `<ErrorCard message="Failed to load progress" onRetry={refetch} />`
    - Remove the existing custom retry button and error-bg styling
  </action>
  <verify>Run `cd /Users/dmytrolevin/Downloads/GD_playground/packages/webapp && npx tsc --noEmit` -- must pass with zero errors.</verify>
  <done>All 11 components (plus TrackList) use ErrorCard with onRetry={refetch} instead of inline error text. Each has refetch destructured from its query hook.</done>
</task>

<task type="auto">
  <name>Task 2: Add isError handling to 6 components that currently ignore errors</name>
  <files>
    packages/webapp/src/features/leads/components/LeadList.tsx
    packages/webapp/src/features/leads/components/LeadDetail.tsx
    packages/webapp/src/features/leads/components/ActivityTimeline.tsx
    packages/webapp/src/features/settings/components/SettingsPanel.tsx
    packages/webapp/src/features/profile/components/StatsOverview.tsx
    packages/webapp/src/features/casebook/components/CasebookList.tsx
  </files>
  <action>
    For each component, add `isError` and `refetch` to the query hook destructuring, then add an error check AFTER the loading check and BEFORE the data rendering.

    **Pattern:**
    ```typescript
    const { data, isLoading, isError, refetch } = useXxx();

    if (isLoading) { ... } // existing loading state
    if (isError) {
      return <ErrorCard message="Unable to load [thing]" onRetry={refetch} />;
    }
    // ... rest of component
    ```

    **Specific changes:**

    1. **LeadList.tsx**: Destructure `isError, refetch` from `useLeads()`. After `isLoading` check, add:
       `if (isError) return <ErrorCard message="Unable to load leads" onRetry={refetch} />;`
       Import ErrorCard from `@/shared/ui`.
       Keep the existing empty state (no leads) -- that will be upgraded in Plan 03.

    2. **LeadDetail.tsx**: Destructure `isError, refetch` from `useLead()`. After `isLoading` check and BEFORE the `!lead` redirect, add:
       `if (isError) return <ErrorCard message="Unable to load lead details" onRetry={refetch} />;`
       The `!lead` check already redirects to /leads, which is fine for a 404 case. The isError check catches network/server errors specifically.

    3. **ActivityTimeline.tsx**: Destructure `isError, refetch` from `useLeadActivities()`. Add error check. Use `compact` mode since ActivityTimeline renders inside a Card in LeadDetail.
       `if (isError) return <ErrorCard message="Unable to load activity" onRetry={refetch} compact />;`

    4. **SettingsPanel.tsx**: Destructure `isError, refetch` from `useUserSettings()`. Add error check after loading.
       `if (isError) return <ErrorCard message="Unable to load settings" onRetry={refetch} />;`

    5. **StatsOverview.tsx**: Destructure `isError, refetch` from `useUserStats()`. Add error check after loading.
       `if (isError) return <ErrorCard message="Unable to load stats" onRetry={refetch} />;`

    6. **CasebookList.tsx**: The component uses `useCasebook()`. Destructure `isError, refetch` alongside existing fields. Add error check after loading. Use full mode since it's a standalone list.
       `if (isError) return <ErrorCard message="Unable to load casebook" onRetry={refetch} />;`

    **Important: Do NOT check `isFetching` here.** The research identified a pitfall about ErrorCard flickering during refetch, but TanStack Query v5 with `keepPreviousData` / `placeholderData` handles this correctly -- `isError` only becomes true when there's no cached data and the query fails. If the query has stale cached data, `isError` stays false even on refetch failure. This is the correct behavior.
  </action>
  <verify>Run `cd /Users/dmytrolevin/Downloads/GD_playground/packages/webapp && npx tsc --noEmit` -- must pass with zero errors. Run `npx vite build` -- must succeed.</verify>
  <done>All 6 previously-ignoring components now destructure isError and refetch, show ErrorCard on error. TypeScript compiles and Vite builds.</done>
</task>

</tasks>

<verification>
1. `cd packages/webapp && npx tsc --noEmit` -- zero TypeScript errors
2. `cd packages/webapp && npx vite build` -- successful build
3. Grep for `ErrorCard` across all 18 component files -- each must have at least one usage
4. Grep for remaining inline error patterns (`text-text-hint.*Unable to load`, `text-error.*Failed`) -- none should remain in the 18 target files
</verification>

<success_criteria>
- All 18 components listed in the research Integration Map use ErrorCard
- Every ErrorCard has onRetry wired to the query's refetch
- Components that previously ignored isError now handle it
- No inline error text patterns remain in the 18 target files
- TypeScript compiles and app builds cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/10-error-handling-and-ux/10-02-SUMMARY.md`
</output>
