---
phase: 04-support-and-casebook
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/webapp/src/features/support/types.ts
  - packages/webapp/src/features/support/hooks/useSupportSessions.ts
  - packages/webapp/src/features/support/hooks/useSupportSession.ts
  - packages/webapp/src/features/support/components/SupportInput.tsx
  - packages/webapp/src/features/support/components/AnalysisDisplay.tsx
  - packages/webapp/src/features/support/components/StrategyDisplay.tsx
  - packages/webapp/src/features/support/components/TacticsDisplay.tsx
  - packages/webapp/src/features/support/components/DraftDisplay.tsx
  - packages/webapp/src/features/support/components/SessionCard.tsx
  - packages/webapp/src/pages/Support.tsx
  - packages/webapp/src/lib/queries.ts
autonomous: true

must_haves:
  truths:
    - "User sees a CTA to open bot for new deal analysis with description of what support does"
    - "User can browse past support sessions listed by date and prospect info extracted from output_json"
    - "User can tap a session to see structured analysis: prospect type, stage, signal strength, closing strategy"
    - "User can view engagement tactics (LinkedIn actions, comment suggestions, timing) and draft response"
    - "User can copy draft response text to clipboard"
    - "User sees regenerate and save-to-casebook actions that deep-link to bot"
  artifacts:
    - path: "packages/webapp/src/features/support/types.ts"
      provides: "SupportOutput interface and parseOutputJson() defensive parser"
      contains: "parseOutputJson"
    - path: "packages/webapp/src/features/support/hooks/useSupportSessions.ts"
      provides: "Paginated list of support sessions for current user"
      contains: "useSupportSessions"
    - path: "packages/webapp/src/features/support/hooks/useSupportSession.ts"
      provides: "Single support session detail by ID"
      contains: "useSupportSession"
    - path: "packages/webapp/src/pages/Support.tsx"
      provides: "Support page with nested sub-routes (index, session/:sessionId, history)"
      contains: "Routes"
    - path: "packages/webapp/src/lib/queries.ts"
      provides: "Support query key factory entries"
      contains: "support"
  key_links:
    - from: "packages/webapp/src/features/support/hooks/useSupportSessions.ts"
      to: "InsForge support_sessions table"
      via: "getInsforge().database.from('support_sessions')"
      pattern: "from\\('support_sessions'\\)"
    - from: "packages/webapp/src/features/support/components/AnalysisDisplay.tsx"
      to: "packages/webapp/src/features/support/types.ts"
      via: "parseOutputJson for defensive JSON access"
      pattern: "parseOutputJson"
    - from: "packages/webapp/src/features/support/components/SupportInput.tsx"
      to: "Bot deep link"
      via: "openTelegramLink"
      pattern: "openTelegramLink"
    - from: "packages/webapp/src/features/support/components/DraftDisplay.tsx"
      to: "Clipboard API"
      via: "navigator.clipboard.writeText"
      pattern: "clipboard\\.writeText"
---

<objective>
Build the Support mode feature: strategy builder input CTA (deep link to bot), structured analysis display for past sessions, engagement tactics, draft response with copy/regenerate/save actions, and session history browsing.

Purpose: Users can get AI-powered deal support by starting sessions in the bot, then view rich structured analysis results in the TMA with prospect type, signal strength, closing strategy, engagement tactics, and copyable draft responses.

Output: Complete support feature directory with types, hooks, display components, and Support page with nested sub-routes.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-support-and-casebook/04-RESEARCH.md

@packages/webapp/src/types/tables.ts
@packages/webapp/src/lib/queries.ts
@packages/webapp/src/lib/insforge.ts
@packages/webapp/src/app/Router.tsx
@packages/webapp/src/features/scoring/types.ts
@packages/webapp/src/features/learn/hooks/useTrackProgress.ts
@packages/webapp/src/features/auth/store.ts
@packages/webapp/src/shared/ui/index.ts
@packages/webapp/src/pages/Support.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Support types, hooks, and query keys</name>
  <files>
    packages/webapp/src/features/support/types.ts
    packages/webapp/src/features/support/hooks/useSupportSessions.ts
    packages/webapp/src/features/support/hooks/useSupportSession.ts
    packages/webapp/src/lib/queries.ts
  </files>
  <action>
1. Create `features/support/types.ts` with:
   - SupportAnalysis interface: prospect_type, seniority, background_leverage, company_context, stage, key_concern, buying_signal, buying_signal_reason (all strings)
   - StrategyStep interface: principle, detail (strings)
   - SupportStrategy interface: steps (StrategyStep[]), anticipated_objection, objection_response (strings)
   - EngagementTactics interface: linkedin_actions (string[]), comment_suggestion, timing (strings)
   - SupportDraft interface: platform, message (strings), word_count (number), playbook_reference (string)
   - SupportOutput interface: analysis (SupportAnalysis), strategy (SupportStrategy), engagement_tactics (EngagementTactics), draft (SupportDraft)
   - `parseOutputJson(json: Record<string, unknown>): SupportOutput` function with typeof guards on EVERY field, following the exact pattern from `features/scoring/types.ts` parseFeedback(). Parse nested objects defensively: check typeof === 'object' && !== null before accessing sub-fields. Use fallback defaults ('Unknown', '', 0, []) for all missing/wrong-typed fields. Parse strategy.steps as Array.isArray check with .map and typeof guards on each step.

2. Create `features/support/hooks/useSupportSessions.ts`:
   - Import useQuery, getInsforge, useAuthStore, queryKeys
   - Export `useSupportSessions()` hook
   - Fetches from 'support_sessions' table: select('id, telegram_id, input_text, output_json, provider_used, created_at')
   - Filter by .eq('telegram_id', telegramId!)
   - Order by created_at descending, limit 20
   - enabled: !!telegramId
   - Return type: SupportSessionRow[] (from types/tables.ts)
   - Add refetchOnWindowFocus: true (so results refresh when returning from bot, matching Phase 3 pattern)

3. Create `features/support/hooks/useSupportSession.ts`:
   - Export `useSupportSession(sessionId: number)` hook
   - Fetches single session by .eq('id', sessionId).eq('telegram_id', telegramId!).limit(1)
   - Select all columns ('*')
   - enabled: !!telegramId && !!sessionId
   - Return type: SupportSessionRow | null (extract first element from data array)

4. Update `lib/queries.ts`: Add support entries to the queryKeys object:
   ```
   support: {
     all: ['support'] as const,
     sessions: (telegramId: number) => ['support', telegramId, 'sessions'] as const,
     session: (sessionId: number) => ['support', 'session', sessionId] as const,
   },
   ```
  </action>
  <verify>
Run `cd /Users/dmytrolevin/Downloads/GD_playground && pnpm --filter webapp exec tsc --noEmit` to confirm TypeScript compilation passes with no errors.
  </verify>
  <done>
Support types with defensive parseOutputJson parser exist. Two hooks (useSupportSessions, useSupportSession) query InsForge with proper query keys. queries.ts has support key factory entries. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Support page with display components and sub-routes</name>
  <files>
    packages/webapp/src/features/support/components/SupportInput.tsx
    packages/webapp/src/features/support/components/AnalysisDisplay.tsx
    packages/webapp/src/features/support/components/StrategyDisplay.tsx
    packages/webapp/src/features/support/components/TacticsDisplay.tsx
    packages/webapp/src/features/support/components/DraftDisplay.tsx
    packages/webapp/src/features/support/components/SessionCard.tsx
    packages/webapp/src/pages/Support.tsx
  </files>
  <action>
1. Create `features/support/components/SupportInput.tsx`:
   - Title section explaining what Support does: "Get AI-powered strategy analysis for your prospects"
   - Description of what the analysis includes (prospect analysis, closing strategy, engagement tactics, draft response)
   - Primary CTA button "Start Analysis in Bot" that deep-links to bot using openTelegramLink:
     ```
     const botUsername = import.meta.env.VITE_BOT_USERNAME;
     const url = `https://t.me/${botUsername}?start=support`;
     if (openTelegramLink.isAvailable()) { openTelegramLink(url); }
     ```
   - Use openTelegramLink from '@telegram-apps/sdk-react' (not openLink, per Phase 3 decision)
   - Mention that screenshots can be sent via the bot for visual analysis
   - Style: Use Card component, Button with variant="primary", lucide-react icons (MessageSquare, ArrowRight)

2. Create `features/support/components/AnalysisDisplay.tsx`:
   - Props: { analysis: SupportAnalysis }
   - Display prospect_type and seniority as header badges
   - Show stage and buying_signal with signal strength badge:
     - Map buying_signal to variant: 'high' -> success (green), 'medium' -> warning (yellow), else -> error (red)
     - Use Badge component with appropriate variant
   - Show key_concern in a highlighted card section
   - Show background_leverage and company_context as text sections
   - buying_signal_reason as supporting detail text
   - Style: Cards with section headers, badges for categorical values

3. Create `features/support/components/StrategyDisplay.tsx`:
   - Props: { strategy: SupportStrategy }
   - Render strategy.steps as numbered list: each step shows principle (bold) and detail (body text)
   - Show anticipated_objection in a callout/warning card
   - Show objection_response beneath it as the recommended counter
   - Style: Numbered steps with dividers, callout card for objection
   - Use lucide-react Shield or Target icon for the section header

4. Create `features/support/components/TacticsDisplay.tsx`:
   - Props: { tactics: EngagementTactics }
   - LinkedIn actions as a bulleted list with Linkedin icon
   - Comment suggestion as a highlighted text block
   - Timing recommendation as a small info section
   - Style: Card sections with icons (Linkedin, MessageCircle, Clock from lucide-react)

5. Create `features/support/components/DraftDisplay.tsx`:
   - Props: { draft: SupportDraft }
   - Show platform badge and word count
   - Display the message text in a styled pre/code-like block (preserve formatting)
   - Show playbook_reference as a footnote
   - Three action buttons at the bottom:
     a. "Copy" button: uses navigator.clipboard.writeText(draft.message) with fallback (textarea trick for older WebViews). Show "Copied!" state for 2 seconds using useState + setTimeout. Use Copy and Check icons from lucide-react.
     b. "Regenerate" button: deep-links to bot via openTelegramLink (same pattern as SupportInput). Use RefreshCw icon.
     c. "Save to Casebook" button: deep-links to bot via openTelegramLink. Use BookmarkPlus icon.
   - Style: Message in a rounded container with subtle background, action buttons in a flex row at bottom

6. Create `features/support/components/SessionCard.tsx`:
   - Props: { session: SupportSessionRow, onClick: () => void }
   - Extract prospect info from session.output_json using parseOutputJson():
     - Show analysis.prospect_type and analysis.seniority as badge/tag
     - Show truncated analysis.company_context (max 60 chars) as subtitle
   - Show created_at formatted as locale date string
   - Show truncated input_text (max 80 chars) as preview
   - Clickable card (onClick navigates to session detail)
   - Style: Card component with flex layout, date on right, prospect info on left

7. Replace `pages/Support.tsx` with nested sub-routes:
   - Import Routes, Route, useNavigate from 'react-router'
   - Three views:
     a. Index route (SupportHome): Show SupportInput CTA at top, then "Recent Sessions" section with useSupportSessions() rendering SessionCard components. Each card onClick navigates to `/support/session/${session.id}`. Handle empty state: "No support sessions yet. Start your first analysis!" Handle loading state with Skeleton.
     b. `session/:sessionId` route (SessionDetail): Parse sessionId from useParams(). Use useSupportSession(Number(sessionId)). Call parseOutputJson(session.output_json). Render AnalysisDisplay, StrategyDisplay, TacticsDisplay, DraftDisplay stacked vertically with section spacing. Handle loading with Skeleton. Handle not-found with redirect.
     c. `history` route (SessionHistory): Full paginated list of sessions (reuse useSupportSessions hook). Show all sessions as SessionCard list.
   - Use the existing Support.tsx wildcard route (/support/* already in Router.tsx)
   - Page title "Deal Support" with Zap icon
  </action>
  <verify>
Run `cd /Users/dmytrolevin/Downloads/GD_playground && pnpm --filter webapp exec tsc --noEmit` to confirm TypeScript compilation passes. Then run `cd /Users/dmytrolevin/Downloads/GD_playground && pnpm --filter webapp build` to confirm production build succeeds.
  </verify>
  <done>
Support page renders with three sub-routes. Index shows input CTA + recent sessions. Session detail shows full analysis with all four sections (analysis, strategy, tactics, draft). Copy button uses clipboard API with fallback. Regenerate and save-to-casebook buttons deep-link to bot. Session cards show prospect info extracted from output_json. Build passes cleanly.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `pnpm --filter webapp exec tsc --noEmit` passes with 0 errors
2. Production build: `pnpm --filter webapp build` succeeds
3. Support page has 3 sub-routes: index (home), session/:sessionId (detail), history
4. parseOutputJson uses typeof guards on every field (never raw property access on output_json)
5. openTelegramLink used (not openLink) for all bot deep links
6. Clipboard copy has fallback for older WebViews
7. Session cards extract prospect info from output_json.analysis (not from non-existent columns)
8. refetchOnWindowFocus: true on session queries for auto-refresh when returning from bot
</verification>

<success_criteria>
- All 5 SUPP requirements addressed: SUPP-01 (input CTA), SUPP-02 (analysis display), SUPP-03 (engagement tactics), SUPP-04 (draft with copy/regenerate/save), SUPP-05 (session history)
- Defensive parsing throughout (no raw output_json access)
- Bot deep link pattern consistent with Phase 3 (openTelegramLink)
- Feature directory follows established pattern (features/support/hooks/, components/)
- Build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-support-and-casebook/04-01-SUMMARY.md`
</output>
