---
phase: 04-support-and-casebook
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - packages/webapp/src/features/casebook/hooks/useCasebook.ts
  - packages/webapp/src/features/casebook/hooks/useCasebookEntry.ts
  - packages/webapp/src/features/casebook/components/CasebookList.tsx
  - packages/webapp/src/features/casebook/components/CasebookCard.tsx
  - packages/webapp/src/features/casebook/components/CasebookDetail.tsx
  - packages/webapp/src/features/casebook/components/CasebookFilters.tsx
  - packages/webapp/src/features/casebook/components/SearchBar.tsx
  - packages/webapp/src/shared/hooks/useDebouncedValue.ts
  - packages/webapp/src/pages/Casebook.tsx
  - packages/webapp/src/app/Router.tsx
  - packages/webapp/src/lib/queries.ts
autonomous: true

must_haves:
  truths:
    - "User can browse casebook entries showing persona type, scenario type, and quality score"
    - "User can search casebook by keyword across all text fields with debounced input"
    - "User can filter casebook by persona type, scenario type, and industry using selectable chips"
    - "User can open a casebook entry to see full analysis, strategy, tactics, and draft response"
    - "User can tap 'Use as Template' to deep-link to bot's support command"
  artifacts:
    - path: "packages/webapp/src/features/casebook/hooks/useCasebook.ts"
      provides: "Filtered and searched casebook entries from InsForge"
      contains: "useCasebook"
    - path: "packages/webapp/src/features/casebook/hooks/useCasebookEntry.ts"
      provides: "Single casebook entry by ID"
      contains: "useCasebookEntry"
    - path: "packages/webapp/src/features/casebook/components/CasebookList.tsx"
      provides: "Browsable list with search and filter integration"
      contains: "CasebookList"
    - path: "packages/webapp/src/features/casebook/components/CasebookDetail.tsx"
      provides: "Full detail view for a casebook entry"
      contains: "CasebookDetail"
    - path: "packages/webapp/src/shared/hooks/useDebouncedValue.ts"
      provides: "Reusable debounce hook for search input"
      contains: "useDebouncedValue"
    - path: "packages/webapp/src/app/Router.tsx"
      provides: "Casebook route with /* wildcard for sub-routes"
      contains: 'path="/casebook/*"'
    - path: "packages/webapp/src/lib/queries.ts"
      provides: "Casebook query key factory entries"
      contains: "casebook"
  key_links:
    - from: "packages/webapp/src/features/casebook/hooks/useCasebook.ts"
      to: "InsForge casebook table"
      via: "getInsforge().database.from('casebook') with .or() and .ilike()"
      pattern: "from\\('casebook'\\)"
    - from: "packages/webapp/src/features/casebook/hooks/useCasebook.ts"
      to: "Search input"
      via: "PostgREST .or() with ilike pattern, escaped % and _"
      pattern: "\\.or\\("
    - from: "packages/webapp/src/features/casebook/components/CasebookDetail.tsx"
      to: "Bot deep link"
      via: "openTelegramLink for Use as Template action"
      pattern: "openTelegramLink"
    - from: "packages/webapp/src/features/casebook/components/SearchBar.tsx"
      to: "packages/webapp/src/shared/hooks/useDebouncedValue.ts"
      via: "300ms debounce on search term"
      pattern: "useDebouncedValue"
---

<objective>
Build the Casebook browser feature: searchable and filterable list of saved responses, detail view with full analysis, and "Use as Template" flow that deep-links to bot.

Purpose: Users can browse their team's library of high-quality saved responses, search by keyword, filter by persona/scenario/industry, view full details, and use entries as templates for new support sessions.

Output: Complete casebook feature directory with hooks, components, debounce utility, and Casebook page with nested sub-routes.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-support-and-casebook/04-RESEARCH.md
@.planning/phases/04-support-and-casebook/04-01-SUMMARY.md

@packages/webapp/src/types/tables.ts
@packages/webapp/src/lib/queries.ts
@packages/webapp/src/lib/insforge.ts
@packages/webapp/src/app/Router.tsx
@packages/webapp/src/features/auth/store.ts
@packages/webapp/src/shared/ui/index.ts
@packages/webapp/src/pages/Casebook.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Casebook hooks, debounce utility, query keys, and Router fix</name>
  <files>
    packages/webapp/src/features/casebook/hooks/useCasebook.ts
    packages/webapp/src/features/casebook/hooks/useCasebookEntry.ts
    packages/webapp/src/shared/hooks/useDebouncedValue.ts
    packages/webapp/src/lib/queries.ts
    packages/webapp/src/app/Router.tsx
  </files>
  <action>
1. Fix Router.tsx: Change the casebook route from `path="/casebook"` to `path="/casebook/*"` to enable nested sub-routes. This is CRITICAL -- without the wildcard, /casebook/:id routes will 404 (Pitfall 5 from research).

2. Create `shared/hooks/useDebouncedValue.ts`:
   - Export `useDebouncedValue<T>(value: T, delayMs = 300): T`
   - Uses useState + useEffect with setTimeout/clearTimeout pattern
   - Generic type parameter for reusability
   - This is a shared utility (not casebook-specific) placed in shared/hooks/

3. Add casebook entries to `lib/queries.ts` (append to existing queryKeys object):
   ```
   casebook: {
     all: ['casebook'] as const,
     list: (filters: Record<string, unknown>) => ['casebook', 'list', filters] as const,
     entry: (entryId: number) => ['casebook', 'entry', entryId] as const,
     filterOptions: ['casebook', 'filterOptions'] as const,
   },
   ```

4. Create `features/casebook/hooks/useCasebook.ts`:
   - Export `useCasebook(options: { keyword?: string; personaType?: string; scenarioType?: string; industry?: string })` hook
   - Import useQuery, getInsforge, useAuthStore, queryKeys
   - Build query: `getInsforge().database.from('casebook').select('*')`
   - NOTE: Do NOT filter by telegram_id or created_from_user -- casebook is a team-wide resource (Pitfall 2 from research). Show all entries the user can access.
   - If keyword is non-empty, escape special chars (% and _) in the search term: `term.replace(/%/g, '\\%').replace(/_/g, '\\_')`, then apply `.or()` with ilike across persona_type, scenario_type, industry, prospect_analysis, draft_response columns:
     ```
     query = query.or(
       `persona_type.ilike.%${escaped}%,scenario_type.ilike.%${escaped}%,industry.ilike.%${escaped}%,prospect_analysis.ilike.%${escaped}%,draft_response.ilike.%${escaped}%`
     );
     ```
   - Apply .eq() filters for personaType, scenarioType, industry when non-empty
   - Order by quality_score descending, limit 50
   - Query key: queryKeys.casebook.list({ keyword, personaType, scenarioType, industry })
   - enabled: true (no telegramId gate needed since casebook is team-wide)
   - Return type: CasebookRow[] (from types/tables.ts)

5. Create `features/casebook/hooks/useCasebookEntry.ts`:
   - Export `useCasebookEntry(entryId: number)` hook
   - Fetches single casebook entry by .eq('id', entryId).limit(1)
   - Select all columns ('*')
   - enabled: !!entryId
   - Return type: CasebookRow | null (extract first element)
   - Query key: queryKeys.casebook.entry(entryId)

6. Also export a `useCasebookFilterOptions()` hook from useCasebook.ts (or a separate file):
   - Fetches all casebook entries with select('persona_type, scenario_type, industry')
   - Deduplicates client-side with Set: extract unique persona_type, scenario_type, industry values
   - Filter out null/empty values
   - Query key: queryKeys.casebook.filterOptions
   - staleTime: 5 * 60 * 1000 (5 minutes -- filter options don't change often)
   - Return: { personaTypes: string[], scenarioTypes: string[], industries: string[] }
  </action>
  <verify>
Run `cd /Users/dmytrolevin/Downloads/GD_playground && pnpm --filter webapp exec tsc --noEmit` to confirm TypeScript compilation passes with no errors.
  </verify>
  <done>
Router has casebook/* wildcard. Debounce utility is in shared/hooks. Query keys include casebook entries. useCasebook hook builds PostgREST queries with ilike search and eq filters. useCasebookEntry fetches single entries. useCasebookFilterOptions provides unique filter values. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Casebook page with list, search, filters, detail view, and template action</name>
  <files>
    packages/webapp/src/features/casebook/components/SearchBar.tsx
    packages/webapp/src/features/casebook/components/CasebookFilters.tsx
    packages/webapp/src/features/casebook/components/CasebookCard.tsx
    packages/webapp/src/features/casebook/components/CasebookList.tsx
    packages/webapp/src/features/casebook/components/CasebookDetail.tsx
    packages/webapp/src/pages/Casebook.tsx
  </files>
  <action>
1. Create `features/casebook/components/SearchBar.tsx`:
   - Props: { value: string; onChange: (value: string) => void; placeholder?: string }
   - Text input with Search icon (lucide-react) on the left
   - Clear button (X icon) when value is non-empty
   - Style: Rounded input with icon padding, bg-bg-secondary, text-text, placeholder text-text-hint
   - 44px minimum height for touch target
   - Note: Debouncing is NOT in this component -- the parent component uses useDebouncedValue on the state it passes here

2. Create `features/casebook/components/CasebookFilters.tsx`:
   - Props: { personaTypes: string[]; scenarioTypes: string[]; industries: string[]; selectedPersonaType: string; selectedScenarioType: string; selectedIndustry: string; onPersonaTypeChange: (v: string) => void; onScenarioTypeChange: (v: string) => void; onIndustryChange: (v: string) => void }
   - Three rows of filter chips (horizontal scrollable with overflow-x-auto):
     a. Persona Type: "All" chip + one chip per unique persona type
     b. Scenario Type: "All" chip + one chip per unique scenario type
     c. Industry: "All" chip + one chip per unique industry
   - Active chip: bg-brand text-white. Inactive: bg-bg-secondary text-text-hint
   - Each chip is a Button component with variant toggling based on selected state
   - "All" chip maps to empty string (no filter)
   - Style: Horizontal scroll rows with gap-2, no wrap, 36px chip height for touch

3. Create `features/casebook/components/CasebookCard.tsx`:
   - Props: { entry: CasebookRow; onClick: () => void }
   - Show persona_type as a colored badge (top-left)
   - Show scenario_type as a secondary badge (next to persona_type)
   - Show quality_score as a score indicator: format as percentage (quality_score * 100), color-coded (>= 0.8 green, >= 0.6 yellow, else red)
   - Show industry if present (small tag)
   - Show truncated draft_response preview (max 100 chars with ellipsis)
   - Clickable card (onClick navigates to detail)
   - Style: Card component, compact layout, badges in top row, preview text below

4. Create `features/casebook/components/CasebookList.tsx`:
   - Props: { entries: CasebookRow[]; isLoading: boolean; onEntryClick: (id: number) => void }
   - If loading: show 3 Skeleton cards
   - If empty: show empty state card: "No casebook entries found." with contextual message:
     - If search/filters active: "Try adjusting your search or filters"
     - If no filters: "Use /support in the bot to build your casebook. High-quality responses are saved automatically."
   - Map entries to CasebookCard components
   - Style: Vertical stack with gap-3

5. Create `features/casebook/components/CasebookDetail.tsx`:
   - Props: { entry: CasebookRow }
   - Header: persona_type badge, scenario_type badge, quality_score percentage, industry tag
   - Four content sections (each in a Card with section title):
     a. "Prospect Analysis": entry.prospect_analysis (render as text, handle null with "No analysis available")
     b. "Closing Strategy": entry.closing_strategy (render as text, handle null)
     c. "Engagement Tactics": entry.engagement_tactics (render as text, handle null)
     d. "Draft Response": entry.draft_response in a styled code-like block, with Copy button (same clipboard pattern as DraftDisplay from Plan 01 -- navigator.clipboard.writeText with fallback, "Copied!" state for 2 seconds)
   - Playbook references section if entry.playbook_references is non-null
   - "Use as Template" action button at the bottom:
     - Deep-links to bot /support: `https://t.me/${botUsername}?start=support`
     - Uses openTelegramLink from '@telegram-apps/sdk-react'
     - Label: "Use as Template" with FileText or Copy icon
     - Style: Full-width Button with variant="primary"
   - Created date footer: entry.created_at formatted as locale date
   - Style: Stacked Card sections with padding, section headers in text-text-hint

6. Replace `pages/Casebook.tsx` with nested sub-routes:
   - Import Routes, Route, useNavigate, useParams from 'react-router'
   - State management in CasebookHome:
     - searchTerm (string state), pass to SearchBar
     - debouncedSearch = useDebouncedValue(searchTerm, 300)
     - selectedPersonaType, selectedScenarioType, selectedIndustry (string states, default '')
     - useCasebookFilterOptions() for chip values
     - useCasebook({ keyword: debouncedSearch, personaType: selectedPersonaType, ... })
   - Two views:
     a. Index route (CasebookHome): SearchBar at top, CasebookFilters below, CasebookList with results. Each card onClick navigates to `/casebook/${entry.id}`
     b. `:entryId` route (CasebookEntryView): Parse entryId from useParams(). Use useCasebookEntry(Number(entryId)). Render CasebookDetail. Handle loading with Skeleton. Handle not-found with "Entry not found" message.
   - Page title "Casebook" with BookOpen icon
  </action>
  <verify>
Run `cd /Users/dmytrolevin/Downloads/GD_playground && pnpm --filter webapp exec tsc --noEmit` to confirm TypeScript compilation passes. Then run `cd /Users/dmytrolevin/Downloads/GD_playground && pnpm --filter webapp build` to confirm production build succeeds.
  </verify>
  <done>
Casebook page renders with two sub-routes. Index shows search bar, filter chips, and filtered casebook list. Detail view shows full entry with all sections and "Use as Template" button. Search is debounced at 300ms with special character escaping. Filter chips show actual values from the database. Empty states handle both no-results and no-entries scenarios. Copy button works with clipboard API fallback. Build passes cleanly.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `pnpm --filter webapp exec tsc --noEmit` passes with 0 errors
2. Production build: `pnpm --filter webapp build` succeeds
3. Router.tsx has `/casebook/*` wildcard (not just `/casebook`)
4. Casebook queries do NOT filter by telegram_id (team-wide resource)
5. Search escapes % and _ characters before sending to PostgREST ilike
6. Search input is debounced at 300ms (not firing on every keystroke)
7. Filter chips populated from actual database values via useCasebookFilterOptions
8. Detail view has Copy button with clipboard fallback and "Use as Template" deep link to bot
9. Empty states are contextual (different messages for no results vs no entries)
</verification>

<success_criteria>
- All 5 CASE requirements addressed: CASE-01 (browsable list), CASE-02 (keyword search), CASE-03 (filter by persona/scenario/industry), CASE-04 (detail view), CASE-05 (use as template)
- Router wildcard fixed before sub-routes built
- Team-wide casebook (no user filtering)
- Search debounced and special chars escaped
- Feature directory follows established pattern (features/casebook/hooks/, components/)
- Build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-support-and-casebook/04-02-SUMMARY.md`
</output>
