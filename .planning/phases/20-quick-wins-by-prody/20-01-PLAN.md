---
phase: 20-quick-wins-by-prody
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/webapp/src/features/leads/hooks/useUpdateLeadStatus.ts
  - packages/webapp/src/features/leads/components/LeadDetail.tsx
  - bot/handlers/leads.py
  - bot/handlers/start.py
autonomous: true

must_haves:
  truths:
    - "Changing a lead to closed_won awards 500 XP and triggers confetti celebration in the TMA"
    - "Bot-side status change to closed_won also awards 500 XP via UserRepo.update_xp"
    - "Onboarding 'Quick Setup' button reads 'Start Free' with no technical jargon visible"
    - "XP award does not double-fire when status is changed from both TMA and bot"
  artifacts:
    - path: "packages/webapp/src/features/leads/hooks/useUpdateLeadStatus.ts"
      provides: "XP award + level recalculation on closed_won status change"
      contains: "closed_won"
    - path: "packages/webapp/src/features/leads/components/LeadDetail.tsx"
      provides: "Confetti trigger + celebration toast on closed_won"
      contains: "fireLevelUpConfetti"
    - path: "bot/handlers/leads.py"
      provides: "Bot-side XP award on closed_won status change"
      contains: "update_xp"
    - path: "bot/handlers/start.py"
      provides: "Renamed onboarding button text"
      contains: "Start Free"
  key_links:
    - from: "packages/webapp/src/features/leads/hooks/useUpdateLeadStatus.ts"
      to: "users table"
      via: "InsForge update after closed_won status write"
      pattern: "closed_won.*total_xp"
    - from: "packages/webapp/src/features/leads/components/LeadDetail.tsx"
      to: "gamification/lib/confetti.ts"
      via: "fireLevelUpConfetti import and call"
      pattern: "fireLevelUpConfetti"
---

<objective>
Implement deal closure celebration with XP award (QW #1) and "Start Free" onboarding label (QW #2).

Purpose: Reward the most important user action (closing a deal) with 500 XP, confetti, and a celebration toast -- making pipeline progression feel impactful. Clean up onboarding language to reduce confusion for non-technical users.

Output: Modified status mutation hook with XP logic, confetti-enhanced LeadDetail, bot-side XP on closed_won, renamed onboarding button.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/webapp/src/features/leads/hooks/useUpdateLeadStatus.ts
@packages/webapp/src/features/leads/components/LeadDetail.tsx
@packages/webapp/src/features/gamification/lib/confetti.ts
@packages/webapp/src/features/gamification/hooks/useLevelUpDetection.ts
@bot/handlers/leads.py
@bot/handlers/start.py
@bot/storage/repositories.py (UserRepo.update_xp method)
@bot/services/scoring.py (get_level_from_xp function)
</context>

<tasks>

<task type="auto">
  <name>Task 1: TMA deal closure celebration + XP award</name>
  <files>
    packages/webapp/src/features/leads/hooks/useUpdateLeadStatus.ts
    packages/webapp/src/features/leads/components/LeadDetail.tsx
  </files>
  <action>
In `useUpdateLeadStatus.ts`:
1. After the successful activity log insert in `mutationFn`, add a `closed_won` check:
   ```
   if (newStatus === 'closed_won') {
     // Fetch current user XP
     const { data: userData } = await getInsforge()
       .database.from('users')
       .select('total_xp, current_level')
       .eq('telegram_id', telegramId)
       .single();
     if (userData) {
       const newXp = userData.total_xp + 500;
       // Recalculate level (same formula as bot/services/scoring.py)
       let level = 1;
       let remaining = newXp;
       while (true) {
         const needed = level * 200;
         if (remaining < needed) break;
         remaining -= needed;
         level++;
       }
       await getInsforge()
         .database.from('users')
         .update({ total_xp: newXp, current_level: level })
         .eq('telegram_id', telegramId);
     }
   }
   ```
2. In `onSettled`, add invalidation of `queryKeys.users.detail(telegramId)` so the ProgressCard and LevelUpDetection hook pick up the new level/XP immediately.

In `LeadDetail.tsx`:
1. Import `fireLevelUpConfetti` from `@/features/gamification/lib/confetti`.
2. In `handleStatusChange`, inside the `onSuccess` callback, add:
   ```
   if (newStatus === 'closed_won') {
     fireLevelUpConfetti();
     toast({ type: 'success', message: 'Deal Won! +500 XP' });
   } else {
     toast({ type: 'success', message: 'Status updated' });
   }
   ```
   Replace the existing generic toast with this conditional.
  </action>
  <verify>
TypeScript compiles without errors: `cd packages/webapp && npx tsc --noEmit`.
Grep confirms `closed_won` check in useUpdateLeadStatus.ts.
Grep confirms `fireLevelUpConfetti` import in LeadDetail.tsx.
  </verify>
  <done>
Changing a lead to closed_won in the TMA awards 500 XP, recalculates level, triggers confetti, and shows a "Deal Won! +500 XP" toast. User progress cache is invalidated so ProgressCard updates immediately.
  </done>
</task>

<task type="auto">
  <name>Task 2: Bot-side XP award + "Start Free" onboarding label</name>
  <files>
    bot/handlers/leads.py
    bot/handlers/start.py
  </files>
  <action>
In `bot/handlers/leads.py`:
1. Add `UserRepo` to the `on_lead_status_update` function signature (DI injection): `async def on_lead_status_update(callback: CallbackQuery, lead_repo: LeadRegistryRepo, user_repo: UserRepo) -> None:`
2. After `await lead_repo.update_status(lead_id, new_status)` (line ~449), add:
   ```python
   # Award XP on deal closure
   if new_status == "closed_won" and callback.from_user:
       await user_repo.update_xp(callback.from_user.id, 500)
       await callback.answer("Deal Won! +500 XP")
   else:
       status_label = STATUS_LABELS.get(new_status, new_status)
       await callback.answer(f"Updated to {status_label}")
   ```
   Move the existing `callback.answer` into the `else` branch so closed_won gets its own celebratory answer.
3. Add `UserRepo` import if not already imported at the top of the file.

In `bot/handlers/start.py`:
1. Change `SETUP_METHOD_KEYBOARD` first button text from `"Quick Setup (Recommended)"` to `"Start Free (Recommended)"`.
2. Change the `callback_data` remains `"setup:auto"` (unchanged).
3. Change `"Use My Own API Key"` to `"Use My Own Key"` (remove "API" -- technical jargon).

Note: The bot uses aiogram DI -- adding `user_repo: UserRepo` to the handler signature is sufficient for injection since it's already in `workflow_data` (wired in main.py).
  </action>
  <verify>
Python syntax check: `python3 -c "import ast; ast.parse(open('bot/handlers/leads.py').read()); ast.parse(open('bot/handlers/start.py').read()); print('OK')"`.
Grep confirms "Start Free" in start.py.
Grep confirms "update_xp" call in leads.py on_lead_status_update.
  </verify>
  <done>
Bot awards 500 XP when a lead's status is changed to closed_won via the bot. Onboarding button reads "Start Free (Recommended)" instead of "Quick Setup (Recommended)".
  </done>
</task>

</tasks>

<verification>
1. `useUpdateLeadStatus.ts` contains a `closed_won` branch that awards 500 XP and recalculates level
2. `LeadDetail.tsx` imports `fireLevelUpConfetti` and fires it on closed_won status change
3. `leads.py` `on_lead_status_update` calls `user_repo.update_xp(tg_id, 500)` when new_status is closed_won
4. `start.py` `SETUP_METHOD_KEYBOARD` contains "Start Free" text
5. User progress query is invalidated after XP award (both TMA and bot paths)
</verification>

<success_criteria>
- Deal closure (closed_won) awards 500 XP from both TMA and bot surfaces
- TMA shows confetti animation and "Deal Won! +500 XP" toast
- Bot shows "Deal Won! +500 XP" callback answer
- Level recalculation happens atomically with XP update
- Onboarding button says "Start Free" with no API key jargon
</success_criteria>

<output>
After completion, create `.planning/phases/20-quick-wins-by-prody/20-01-SUMMARY.md`
</output>
