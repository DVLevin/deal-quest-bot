---
phase: 20-quick-wins-by-prody
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/webapp/src/features/dashboard/components/WeakAreasCard.tsx
  - packages/webapp/src/pages/Train.tsx
  - packages/webapp/src/features/leads/components/LeadDetail.tsx
  - packages/webapp/src/features/leads/hooks/useUpdatePlanStep.ts
autonomous: true

must_haves:
  truths:
    - "Tapping 'Practice' on a difficulty-based weak area navigates to /train with difficulty pre-selected"
    - "Train page reads difficulty URL param and pre-selects it, overriding the auto-recommended default"
    - "After completing engagement steps, a toast suggests moving to the next pipeline status when appropriate"
  artifacts:
    - path: "packages/webapp/src/features/dashboard/components/WeakAreasCard.tsx"
      provides: "Difficulty-filtered navigation via URL params"
      contains: "difficulty="
    - path: "packages/webapp/src/pages/Train.tsx"
      provides: "URL param reading for pre-selected difficulty"
      contains: "useSearchParams"
    - path: "packages/webapp/src/features/leads/components/LeadDetail.tsx"
      provides: "Smart status suggestion toast after step completion"
      contains: "suggest.*status"
  key_links:
    - from: "packages/webapp/src/features/dashboard/components/WeakAreasCard.tsx"
      to: "packages/webapp/src/pages/Train.tsx"
      via: "URL params ?difficulty=N"
      pattern: "navigate.*train.*difficulty"
    - from: "packages/webapp/src/features/leads/hooks/useUpdatePlanStep.ts"
      to: "packages/webapp/src/features/leads/components/LeadDetail.tsx"
      via: "onSuccess callback triggers status suggestion check"
      pattern: "suggestNextStatus"
---

<objective>
Implement weak area -> filtered training link (QW #4) and smart status suggestion on step completion (QW #5).

Purpose: Make training recommendations actionable by pre-filtering the difficulty, and automate pipeline progression prompts when engagement steps are completed.

Output: WeakAreasCard navigates with difficulty param, Train page reads it, LeadDetail shows status suggestion toast after step completions.
</objective>

<execution_context>
@/Users/dmytrolevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dmytrolevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/webapp/src/features/dashboard/components/WeakAreasCard.tsx
@packages/webapp/src/pages/Train.tsx
@packages/webapp/src/features/leads/components/LeadDetail.tsx
@packages/webapp/src/features/leads/hooks/useUpdatePlanStep.ts
@packages/webapp/src/features/leads/types.ts (suggestNextStatus, LEAD_STATUS_CONFIG)
@packages/webapp/src/features/leads/components/LeadStatusSelector.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Weak area -> filtered training navigation + Train URL param reading</name>
  <files>
    packages/webapp/src/features/dashboard/components/WeakAreasCard.tsx
    packages/webapp/src/pages/Train.tsx
  </files>
  <action>
In `WeakAreasCard.tsx`:
1. The existing `navigate()` call in the Practice button's `onClick` currently routes difficulty-type weak areas to `/train` with no params. Change it to pass the difficulty level as a URL param.
2. Each weak area where `area.type === 'difficulty'` was built from `Object.entries(stats.avgScoreByDifficulty)` using `diff` as the key. The difficulty number needs to be extracted. Since `area.label` is `"Easy scenarios"` etc., we need the original difficulty number. Add a `difficulty` field to the `WeakArea` interface: `difficulty?: number;`. Populate it in the loop:
   ```typescript
   areas.push({
     label: `${DIFFICULTY_LABELS[diffNum] ?? `Level ${diffNum}`} scenarios`,
     avgScore: data.avg,
     type: 'difficulty',
     difficulty: diffNum,
   });
   ```
3. Update the navigate call:
   ```typescript
   onClick={() =>
     navigate(
       area.type === 'track-level'
         ? '/learn'
         : `/train${area.difficulty != null ? `?difficulty=${area.difficulty}` : ''}`,
     )
   }
   ```

In `Train.tsx`:
1. Import `useSearchParams` from `react-router`.
2. Add `const [searchParams] = useSearchParams();` near the top of the component.
3. Read the URL difficulty param: `const urlDifficulty = searchParams.get('difficulty');`
4. Change the `useState` initializer for `selectedDifficulty` from `null` to read the URL param:
   ```typescript
   const [selectedDifficulty, setSelectedDifficulty] = useState<number | null>(
     urlDifficulty ? parseInt(urlDifficulty, 10) : null,
   );
   ```
5. Update the `useEffect` that auto-selects recommended difficulty to NOT override a URL-provided difficulty. The current condition `selectedDifficulty === null` already handles this correctly since the URL param would set it to non-null. No change needed to the useEffect.
  </action>
  <verify>
TypeScript compiles: `cd packages/webapp && npx tsc --noEmit`.
Grep confirms `useSearchParams` in Train.tsx.
Grep confirms `difficulty=` in WeakAreasCard.tsx navigate call.
  </verify>
  <done>
Tapping "Practice" on a difficulty weak area navigates to `/train?difficulty=2` (for example). Train page reads the param and pre-selects the difficulty, bypassing the auto-recommendation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Smart status suggestion toast on step completion</name>
  <files>
    packages/webapp/src/features/leads/components/LeadDetail.tsx
  </files>
  <action>
Add a smart status suggestion that appears as a toast after completing engagement plan steps:

1. Import `suggestNextStatus` and `LEAD_STATUS_CONFIG` from `../types` (if not already imported).
2. Create a helper function (inside the component or as a module-level utility) that checks if a status suggestion is warranted based on step completion progress:
   ```typescript
   function shouldSuggestStatusChange(
     plan: EngagementPlanStep[] | null,
     currentStatus: string,
   ): string | null {
     if (!plan || plan.length === 0) return null;
     const completed = plan.filter((s) => s.status === 'done' || s.status === 'skipped').length;
     const total = plan.length;
     // Suggest next status when 50%+ of steps are done and there IS a next status
     if (completed / total >= 0.5) {
       return suggestNextStatus(currentStatus);
     }
     return null;
   }
   ```
3. In the component, find where `useUpdatePlanStep` mutation is used. After a successful step update (in the `onSuccess` callback of the step mutation -- likely in a `handleStepUpdate` or similar callback), add the status suggestion check:
   ```typescript
   // After step mutation succeeds, check if we should suggest status progression
   if (lead && newStepStatus === 'done') {
     // Re-read the updated plan from the optimistic cache
     const updatedPlan = [...(lead.engagement_plan ?? [])];
     // Count the step we just completed
     const simulatedPlan = updatedPlan.map(s =>
       s.step_id === stepId ? { ...s, status: 'done' } : s
     );
     const suggestedStatus = shouldSuggestStatusChange(simulatedPlan, lead.status);
     if (suggestedStatus) {
       const statusLabel = LEAD_STATUS_CONFIG[suggestedStatus as LeadStatus]?.label ?? suggestedStatus;
       toast({
         type: 'info',
         message: `Great progress! Move to "${statusLabel}"?`,
         action: {
           label: 'Update',
           onClick: () => handleStatusChange(suggestedStatus as LeadStatus),
         },
       });
     }
   }
   ```
4. The toast includes an "Update" action that directly triggers `handleStatusChange` -- this is the existing function in LeadDetail that fires the status mutation. The user can tap "Update" to progress, or dismiss the toast.
5. Make sure the suggestion only fires when `newStepStatus === 'done'` (not on skip or reset) to avoid noisy suggestions.
6. Import `EngagementPlanStep` type from `@/types/tables` if not already imported.

Note: The existing visual ring suggestion on LeadStatusSelector is NOT removed. This toast is additive -- contextual prompting when outreach work is being done.
  </action>
  <verify>
TypeScript compiles: `cd packages/webapp && npx tsc --noEmit`.
Grep confirms `shouldSuggestStatusChange` function in LeadDetail.tsx.
Grep confirms toast with "Great progress" message.
  </verify>
  <done>
After marking an engagement step as Done, if 50%+ of steps are completed, a toast appears: "Great progress! Move to 'Reached Out'?" with an "Update" action button that triggers the status change. Only fires on 'done' steps (not skip/reset).
  </done>
</task>

</tasks>

<verification>
1. WeakAreasCard.tsx passes difficulty as URL param when navigating to Train
2. Train.tsx reads `?difficulty=N` from URL and pre-selects the difficulty filter
3. LeadDetail.tsx shows a status suggestion toast after completing steps (50%+ threshold)
4. Toast includes an actionable "Update" button that triggers the existing status change flow
5. All files compile without TypeScript errors
</verification>

<success_criteria>
- Weak area Practice button routes to `/train?difficulty=N` for difficulty-based areas
- Train page pre-selects the URL-provided difficulty, overriding auto-recommendation
- Step completion triggers smart status suggestion toast at 50%+ completion
- Toast "Update" action triggers handleStatusChange with the suggested next status
- No regression to existing visual ring suggestion on LeadStatusSelector
</success_criteria>

<output>
After completion, create `.planning/phases/20-quick-wins-by-prody/20-03-SUMMARY.md`
</output>
